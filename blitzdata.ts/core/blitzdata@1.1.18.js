(function(x,T){typeof exports=="object"&&typeof module<"u"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):(x=typeof globalThis<"u"?globalThis:x||self,T(x.BlitzData={}))})(this,function(x){"use strict";var is=Object.defineProperty;var ns=(x,T,Z)=>T in x?is(x,T,{enumerable:!0,configurable:!0,writable:!0,value:Z}):x[T]=Z;var m=(x,T,Z)=>(ns(x,typeof T!="symbol"?T+"":T,Z),Z);const X=class X{constructor(){m(this,"_method");m(this,"_url");m(this,"_headers",{});m(this,"_body");m(this,"_signal")}static create(){const t=new X;return X._globalHeaders&&t.headers(X._globalHeaders),t}static globalHeaders(t){X._globalHeaders=t}method(t){return this._method=t,this}url(t){return this._url=t,this}header(t,e){return this._headers[t]=e,this}headers(t){for(const e in t)this.header(e,t[e]);return this}body(t){return this._body=t,this}signal(t){return this._signal=t,this}async send(){const t=await fetch(this._url,{method:this._method,headers:this._headers,body:this._body?this._body instanceof FormData?this._body:JSON.stringify(this._body):void 0,signal:this._signal?this._signal:void 0});if(!t.ok)throw new Error(`HTTP request failed with status code ${t.status}. Status text: ${t.statusText} and response: ${await t.text()}`);return await t.json()}async get(){return await this.method("GET").send()}async post(){return await this.method("POST").send()}};m(X,"_globalHeaders",{});let T=X;class Z{constructor(t,e){m(this,"name");m(this,"options");m(this,"cursors",{readURL:0});this.name=t,this.options=e}getNextReadURL(){this.cursors.readURL>=this.options.readURL.length&&(this.cursors.readURL=0);const t=this.options.readURL[this.cursors.readURL];return this.cursors.readURL++,t}}class Lt{constructor(){m(this,"clusters",{})}register(t,e){this.clusters[t]=new Z(t,e)}get(t){if(!Array.isArray(t)){if(this.clusters[t]===void 0)throw new Error(`cluster "${t}" not found.`);return this.clusters[t]}const e={};for(const s of t)e[s]=this.get(s);return e}names(){return Object.keys(this.clusters)}all(){return this.clusters}toArray(){return Object.values(this.clusters)}random(){const t=this.names(),e=t[Math.floor(Math.random()*t.length)];return this.get(e)}}const ne=(a,t)=>t.some(e=>a instanceof e);let Ct,Mt;function ae(){return Ct||(Ct=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function oe(){return Mt||(Mt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const kt=new WeakMap,ft=new WeakMap,Ft=new WeakMap,mt=new WeakMap,bt=new WeakMap;function ce(a){const t=new Promise((e,s)=>{const r=()=>{a.removeEventListener("success",i),a.removeEventListener("error",n)},i=()=>{e(q(a.result)),r()},n=()=>{s(a.error),r()};a.addEventListener("success",i),a.addEventListener("error",n)});return t.then(e=>{e instanceof IDBCursor&&kt.set(e,a)}).catch(()=>{}),bt.set(t,a),t}function le(a){if(ft.has(a))return;const t=new Promise((e,s)=>{const r=()=>{a.removeEventListener("complete",i),a.removeEventListener("error",n),a.removeEventListener("abort",n)},i=()=>{e(),r()},n=()=>{s(a.error||new DOMException("AbortError","AbortError")),r()};a.addEventListener("complete",i),a.addEventListener("error",n),a.addEventListener("abort",n)});ft.set(a,t)}let gt={get(a,t,e){if(a instanceof IDBTransaction){if(t==="done")return ft.get(a);if(t==="objectStoreNames")return a.objectStoreNames||Ft.get(a);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return q(a[t])},set(a,t,e){return a[t]=e,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function ue(a){gt=a(gt)}function de(a){return a===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const s=a.call(pt(this),t,...e);return Ft.set(s,t.sort?t.sort():[t]),q(s)}:oe().includes(a)?function(...t){return a.apply(pt(this),t),q(kt.get(this))}:function(...t){return q(a.apply(pt(this),t))}}function he(a){return typeof a=="function"?de(a):(a instanceof IDBTransaction&&le(a),ne(a,ae())?new Proxy(a,gt):a)}function q(a){if(a instanceof IDBRequest)return ce(a);if(mt.has(a))return mt.get(a);const t=he(a);return t!==a&&(mt.set(a,t),bt.set(t,a)),t}const pt=a=>bt.get(a);function yt(a,t,{blocked:e,upgrade:s,blocking:r,terminated:i}={}){const n=indexedDB.open(a,t),o=q(n);return s&&n.addEventListener("upgradeneeded",h=>{s(q(n.result),h.oldVersion,h.newVersion,q(n.transaction),h)}),e&&n.addEventListener("blocked",h=>e(h.oldVersion,h.newVersion,h)),o.then(h=>{i&&h.addEventListener("close",()=>i()),r&&h.addEventListener("versionchange",l=>r(l.oldVersion,l.newVersion,l))}).catch(()=>{}),o}function wt(a,{blocked:t}={}){const e=indexedDB.deleteDatabase(a);return t&&e.addEventListener("blocked",s=>t(s.oldVersion,s)),q(e).then(()=>{})}const fe=["get","getKey","getAll","getAllKeys","count"],me=["put","add","delete","clear"],_t=new Map;function Rt(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(_t.get(t))return _t.get(t);const e=t.replace(/FromIndex$/,""),s=t!==e,r=me.includes(e);if(!(e in(s?IDBIndex:IDBObjectStore).prototype)||!(r||fe.includes(e)))return;const i=async function(n,...o){const h=this.transaction(n,r?"readwrite":"readonly");let l=h.store;return s&&(l=l.index(o.shift())),(await Promise.all([l[e](...o),r&&h.done]))[0]};return _t.set(t,i),i}ue(a=>({...a,get:(t,e,s)=>Rt(t,e)||a.get(t,e,s),has:(t,e)=>!!Rt(t,e)||a.has(t,e)}));const O={name:"bd-queue",store:"jobs",timeIndex:"time",objectIndex:"object"};var I=(a=>(a.Pending="pending",a.Completed="completed",a.Failed="failed",a.Conflict="conflict",a))(I||{}),G=(a=>(a.Success="success",a.Exception="exception",a.Failed="failed",a.Conflict="conflict",a))(G||{}),j=(a=>(a.Add="add",a.Edit="edit",a.Delete="delete",a))(j||{}),H="SharedWorker"in globalThis,be=class{constructor(a){m(this,"ActualWorker");this.ActualWorker=a}get onmessage(){var a;return H?(a=this.ActualWorker)==null?void 0:a.port.onmessage:this.ActualWorker.onmessage}set onmessage(a){H?this.ActualWorker.port.onmessage=a:this.ActualWorker.onmessage=a}get onmessageerror(){var a;return H?(a=this.ActualWorker)==null?void 0:a.port.onmessageerror:this.ActualWorker.onmessageerror}set onmessageerror(a){H?this.ActualWorker.port.onmessageerror=a:this.ActualWorker.onmessageerror=a}start(){var a;if(H)return(a=this.ActualWorker)==null?void 0:a.port.start()}postMessage(a,t){var e;return H?(e=this.ActualWorker)==null?void 0:e.port.postMessage(a,t):this.ActualWorker.postMessage(a,t)}terminate(){var a;return H?(a=this.ActualWorker)==null?void 0:a.port.close():this.ActualWorker.terminate()}close(){return this.terminate()}get port(){return H?this.ActualWorker.port:this.ActualWorker}get onerror(){return this.ActualWorker.onerror}set onerror(a){this.ActualWorker.onerror=a}addEventListener(a,t,e){var s;return H&&a!=="error"?(s=this.ActualWorker)==null?void 0:s.port.addEventListener(a,t,e):this.ActualWorker.addEventListener(a,t,e)}removeEventListener(a,t,e){var s;return H&&a!=="error"?(s=this.ActualWorker)==null?void 0:s.port.removeEventListener(a,t,e):this.ActualWorker.removeEventListener(a,t,e)}dispatchEvent(a){return this.ActualWorker.dispatchEvent(a)}},ge=class extends be{constructor(a,t){let e;H?e=new SharedWorker(a,t):e=new Worker(a,t),super(e)}};function pe(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Pt={};/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */(function(a){(function(t){t(typeof DO_NOT_EXPORT_CRC>"u"?a:{})})(function(t){t.version="1.2.2";function e(){for(var b=0,E=new Array(256),p=0;p!=256;++p)b=p,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,E[p]=b;return typeof Int32Array<"u"?new Int32Array(E):E}var s=e();function r(b){var E=0,p=0,D=0,z=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(D=0;D!=256;++D)z[D]=b[D];for(D=0;D!=256;++D)for(p=b[D],E=256+D;E<4096;E+=256)p=z[E]=p>>>8^b[p&255];var R=[];for(D=1;D!=16;++D)R[D-1]=typeof Int32Array<"u"?z.subarray(D*256,D*256+256):z.slice(D*256,D*256+256);return R}var i=r(s),n=i[0],o=i[1],h=i[2],l=i[3],c=i[4],u=i[5],d=i[6],f=i[7],g=i[8],y=i[9],v=i[10],_=i[11],w=i[12],S=i[13],Q=i[14];function L(b,E){for(var p=E^-1,D=0,z=b.length;D<z;)p=p>>>8^s[(p^b.charCodeAt(D++))&255];return~p}function U(b,E){for(var p=E^-1,D=b.length-15,z=0;z<D;)p=Q[b[z++]^p&255]^S[b[z++]^p>>8&255]^w[b[z++]^p>>16&255]^_[b[z++]^p>>>24]^v[b[z++]]^y[b[z++]]^g[b[z++]]^f[b[z++]]^d[b[z++]]^u[b[z++]]^c[b[z++]]^l[b[z++]]^h[b[z++]]^o[b[z++]]^n[b[z++]]^s[b[z++]];for(D+=15;z<D;)p=p>>>8^s[(p^b[z++])&255];return~p}function C(b,E){for(var p=E^-1,D=0,z=b.length,R=0,Ut=0;D<z;)R=b.charCodeAt(D++),R<128?p=p>>>8^s[(p^R)&255]:R<2048?(p=p>>>8^s[(p^(192|R>>6&31))&255],p=p>>>8^s[(p^(128|R&63))&255]):R>=55296&&R<57344?(R=(R&1023)+64,Ut=b.charCodeAt(D++)&1023,p=p>>>8^s[(p^(240|R>>8&7))&255],p=p>>>8^s[(p^(128|R>>2&63))&255],p=p>>>8^s[(p^(128|Ut>>6&15|(R&3)<<4))&255],p=p>>>8^s[(p^(128|Ut&63))&255]):(p=p>>>8^s[(p^(224|R>>12&15))&255],p=p>>>8^s[(p^(128|R>>6&63))&255],p=p>>>8^s[(p^(128|R&63))&255]);return~p}t.table=s,t.bstr=L,t.buf=U,t.str=C})})(Pt);function ot(){return Math.floor((new Date().getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3)}function vt(a){return ot().toString(36)+"-"+Pt.str(JSON.stringify(a)).toString(36)}function Nt(a){return new Promise(t=>{setTimeout(t,a)})}class W{constructor(t){m(this,"action");m(this,"blitzstamp");m(this,"hash");m(this,"hashAlgo");m(this,"blitzID");m(this,"userhash");m(this,"model");m(this,"data");var e;this.action=t.action,this.blitzstamp=t.blitzstamp??ot(),this.hash=t.hash??vt(t.data===void 0?{blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}:{...t.data,blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}),this.hashAlgo=t.hashAlgo??"b-crc32",this.blitzID=t.blitzID??((e=t.data)==null?void 0:e._blitzID)??this.hash,this.model=t.model,this.data=t.data??{},this.userhash=t.userhash}toObject(){return{action:this.action,blitzstamp:this.blitzstamp,hash:this.hash,hashAlgo:this.hashAlgo,blitzID:this.blitzID,model:this.model,data:this.data,userhash:this.userhash}}clone(){return new W({action:this.action,model:this.model,blitzID:this.blitzID,blitzstamp:this.blitzstamp,data:this.data,hash:this.hash,hashAlgo:this.hashAlgo,userhash:this.userhash})}static fromObject(t){var e;return new W({action:t.action,blitzstamp:t.blitzstamp,hash:t.hash,hashAlgo:t.hashAlgo,blitzID:t.blitzID??((e=t.data)==null?void 0:e._blitzID)??t.blitzID,model:t.model,data:t.data,userhash:t.userhash})}}var M=(a=>(a.Success="success",a.Notice="notice",a.Error="error",a.Exception="exception",a))(M||{});class ${constructor(t,e,s,r=null,i){m(this,"blitzID");m(this,"hash");m(this,"message");m(this,"conflict");m(this,"replicaUrl",null);m(this,"status");this.blitzID=t,this.hash=e,this.status=s,this.message=r,this.conflict=i}setReplicaUrl(t){this.replicaUrl=t}isConflict(){return typeof this.conflict<"u"&&this.conflict!==null}}class ct extends Array{get(t){return this.find(e=>e.hash===t)}has(t){return this.some(e=>e.hash===t)}isSuccessful(t){var e;if(t){const s=(e=this.get(t))==null?void 0:e.status;return s?s==="success"||s==="notice":!1}return this.every(s=>s.status)}isFailed(t){var e;if(t){const s=(e=this.get(t))==null?void 0:e.status;return s?s==="error":!0}return this.every(s=>!s.status)}successful(){return new ct(...this.filter(t=>t.status))}failed(){return new ct(...this.filter(t=>!t.status))}}class N{static createListEndpoint(t,e,s){var n;const r=`${N.sanitizeBaseUrl(t)}api/list/${e}.json`,i=new URLSearchParams;return new URL(t).origin!==window.location.origin&&i.append("enableCors","1"),i.append("fkOptions",JSON.stringify({_userID:"blitzID"})),(n=s.conditions)!=null&&n.length&&i.append("conditions",JSON.stringify(s.conditions)),s.limit&&i.append("limit",s.limit.toString()),s.customSort&&i.append("customSort",s.customSort),s.customSortDirection&&i.append("customSortDirection",s.customSortDirection),s.var&&s.var.length>0&&i.append("var",JSON.stringify(s.var)),s.fks&&i.append("fks",s.fks),s.manyToMany&&i.append("manyToMany",s.manyToMany),`${r}?${i.toString()}`}static createGetEndpoint(t,e,s,r){const i=`${N.sanitizeBaseUrl(t)}api/list/${e}/_blitzID/${s}.json`,n=new URLSearchParams;return new URL(t).origin!==window.location.origin&&n.append("enableCors","1"),n.append("fkOptions",JSON.stringify({_userID:"blitzID"})),r.var&&r.var.length>0&&n.append("var",JSON.stringify(r.var)),r.fks&&n.append("fks",r.fks),r.manyToMany&&n.append("manyToMany",r.manyToMany),`${i}?${n.toString()}`}static createPostEndpoint(t){return`${N.sanitizeBaseUrl(t)}api/post.json`}static createPingEndpoint(t){return`${N.sanitizeBaseUrl(t)}api/ping.json`}static createListLogsEndpoint(t){var i,n;const e=t.type==="delete"?"listDeletedLogs":"listLogs",s=t.model?`${N.sanitizeBaseUrl(t.baseUrl)}api/${e}/${t.model}.json`:`${N.sanitizeBaseUrl(t.baseUrl)}api/${e}.json`,r=new URLSearchParams;return((i=t.query)==null?void 0:i.from)!==void 0&&r.append("from",t.query.from.toString()),(n=t.query)!=null&&n.models&&!t.model&&r.append("models",JSON.stringify(t.query.models)),`${s}?${r.toString()}`}static createUploaderEndpoint(t){const e=new URL(t).origin!==window.location.origin?"?enableCors=1":"";return`${N.sanitizeBaseUrl(t)}uploader/index`+e}static sanitizeBaseUrl(t){const e=new URL(t);if(!e.origin||!e.pathname||!e.protocol.match(/^https?:$/))throw new Error(`Supplied base URL is invalid: ${t}`);return e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),e.toString()}}class et{static async list(t,e){if(!t.endpoint&&!t.fullUrl)throw new Error("Either baseUrl or fullUrl must be provided.");const s=await T.create().url(t.fullUrl?t.fullUrl:N.createListEndpoint(t.endpoint.baseUrl,t.endpoint.modelName,t.endpoint.query)).signal(e).get();if(!Array.isArray(s.items)&&Array.isArray(s.errors))throw new Error(s.errors.map(r=>(r==null?void 0:r.message)??r).join(" | "));return s.items??[]}static async get(t,e){const s=await T.create().url(N.createGetEndpoint(t.baseUrl,t.modelName,t.blitzID,t.query)).signal(e).get();if(!Array.isArray(s.items)&&Array.isArray(s.errors))throw new Error(s.errors.map(r=>(r==null?void 0:r.message)??r).join(" | "));return s.items??[]}static async post(t){const e=await T.create().url(N.createPostEndpoint(t.baseUrl)).body(t.transactions).post();if((typeof e.error=="string"||e.errors instanceof Array)&&!(e.results instanceof Object))throw new Error(e.error??e.errors.join(" | "));return e}static async listLogs(t){const e=await T.create().url(N.createListLogsEndpoint(t)).get();if(!(e.transactions instanceof Array)&&(typeof e.error=="string"||e.errors instanceof Array))throw new Error(e.error??e.errors.map(s=>(s==null?void 0:s.message)??s).join(" | "));return{transactions:e.transactions,userID:e.userID,userhash:e.userhash,lastTimestamp:e.lastTimestamp}}static upload(t){const e=new FormData;return e.append("image",t.image),T.create().url(N.createUploaderEndpoint(t.baseUrl)).body(e).header("Accept","application/json").post()}static async ping({baseUrl:t}){return await T.create().url(N.createPingEndpoint(t)).get()}}class At{constructor(){m(this,"_query");m(this,"_model");m(this,"_type")}static create(){return new At}query(t){return this._query=t,this}model(t){return this._model=t,this}type(t){return this._type=t,this}async perform(){const t=A.clusterManager.toArray().map(r=>r.getNextReadURL()),e=await Promise.all(t.map(r=>et.listLogs({baseUrl:r,query:this._query,model:this._model,type:this._type})));return{transactions:[].concat(...e.map(r=>r.transactions)).filter((r,i,n)=>n.findIndex(o=>o.hash===r.hash)===i).filter(r=>typeof r=="object"&&!Array.isArray(r)),userID:e[0].userID,userhash:e[0].userhash,lastTimestamp:e[0].lastTimestamp}}}class Dt{async ping(){const t=await this.openConnection(),e=["sync_transactions","evaluated_transactions"];for(const s of e)if(!t.objectStoreNames.contains(s))return t.close(),console.log(`There's missing stores, recreating the database. Available stores: ${t.objectStoreNames}`),await wt("db_master"),await this.ping();t.close()}async openConnection(){return await yt("db_master",1,{upgrade:(t,e,s,r,i)=>{s===1&&(t.createObjectStore("sync_transactions",{autoIncrement:!1,keyPath:"hash"}),t.createObjectStore("evaluated_transactions",{autoIncrement:!1,keyPath:"hash"}))}})}}class k{static getKey(t){return`BlitzData.${t}`}static get(t){return localStorage.getItem(this.getKey(t))}static set(t,e){localStorage.setItem(this.getKey(t),e)}static has(t){return Object.hasOwn(localStorage,this.getKey(t))}static remove(t){localStorage.removeItem(this.getKey(t))}static clear(){const t=Object.keys(localStorage);for(const e of t)e.startsWith("BlitzData.")&&localStorage.removeItem(e)}static getLastSyncedAt(t){const e=this.get(t?`${t}.lastSyncedAt`:"lastSyncedAt");return e?parseInt(e):null}static setLastSyncedAt(t,e){this.set(e?`${e}.lastSyncedAt`:"lastSyncedAt",t.toString())}static getCurrentUser(){const t=this.get("currentUser");return t?JSON.parse(t):null}static setCurrentUser(t){t?this.set("currentUser",JSON.stringify(t)):this.remove("currentUser")}static getProjectUsers(t){const e=this.get("projectUsers."+t);return e?JSON.parse(e):null}static setProjectUsers(t,e){const s="projectUsers."+t;e?this.set(s,JSON.stringify(e)):this.remove(s)}static getDatabases(){return JSON.parse(this.get("databases")??"[]")}static setDatabases(t){this.set("databases",JSON.stringify(t))}static getListCallLastTimeStamp(t){const e=this.get(`cache.listCall.${t}.lastTimeStamp`);return e?Number(e):null}static setListCallLastTimeStamp(t,e){this.set(`cache.listCall.${t}.lastTimeStamp`,String(e))}}class lt{constructor(){m(this,"client",new Dt)}static create(){return new lt}async all(){const t=await this.client.openConnection(),e=await t.getAll("sync_transactions");return t.close(),e}async put(t){const e=await this.client.openConnection();await e.put("sync_transactions",t),e.close()}async putMultiple(t){for(const e of t)await this.put(e)}async delete(t){const e=await this.client.openConnection();await e.delete("sync_transactions",t),e.close()}}class st{static create(){return new st}async run(t,e){if(!navigator.onLine)return;const s=A.options.sync.startDate instanceof Date&&t!=="_Model"?Math.floor(A.options.sync.startDate.getTime()/1e3):0,r=k.getLastSyncedAt(t)??s,{transactions:i,lastTimestamp:n}=await At.create().type(e).query({from:r,models:t?[t]:A.options.sync.models??["_Project",...(await J.list()).map(h=>h.getName()).filter(h=>h.startsWith("bdt")&&!["bdt24prszej_appfiles","bdt24prszej_apps"].includes(h))]}).perform(),o=lt.create();await o.putMultiple(i),k.setLastSyncedAt(n??Math.floor(Date.now()/1e3),t),await V.create().run((await o.all()).map(h=>W.fromObject(h))),r!==n&&await this.run(t,e)}async runAtInterval(t){for(;;)await Nt(t),await this.run()}}class V{static create(){return new V}async run(t){const e=new ct,s=lt.create(),r={add:1,edit:2,delete:3},i=await new Dt().openConnection();t=t.sort((n,o)=>r[n.action]-r[o.action]);for(const n of t){let o;n.model==="@Model"?n.model="_Model":n.model==="@Project"&&(n.model="_Project");try{if(n.action==="add")o=await this.processAddTransaction(n);else if(n.action==="edit")o=await this.processEditTransaction(n,i);else if(n.action==="delete")o=await this.processDeleteTransaction(n);else throw new Error(`Unknown action "${n.action}" on transaction ${n.hash}`);await i.put("evaluated_transactions",n.toObject())}catch(h){o=new $(n.blitzID,n.hash,M.Error,h.message)}e.push(o),await s.delete(n.hash)}return i.close(),e}async processAddTransaction(t){const e=await J.get(t.model),s=e.idbClient();if(await s.find(t.hash))return new $(t.hash,t.hash,M.Error,`Object with ${t.hash} already exists on ${t.model} model.`);const r=e.getClusterManager(),i={_blitzID:t.hash,_blitzstamp:t.blitzstamp.toString(),_sort:t.blitzstamp.toString(),_clusters:r.names(),_editURLs:r.toArray().map(n=>n.options.addURL).flat(),...(()=>{const n={};for(const[o,h]of Object.entries(t.data)){const l=e.getAttributeDetails(o);if(l&&Array.isArray(l.type)&&h!==void 0){const c=typeof h=="string"?JSON.parse(h):h;o.endsWith("_mtm")?n[o]=c.map((d,f)=>({_blitzID:typeof d=="string"?d:d._blitzID,_mtmSort:typeof d=="string"?(c.length-f)*15:d._mtmSort})):n[o]=c}else n[o]=h}return n})()};if(e.getAttribute("haspublishingdate").value&&typeof t.data._publishingdate>"u"&&typeof t.blitzstamp=="number"){const n=new Date;n.setTime(t.blitzstamp*1e3+new Date("2021-01-01T00:00:00Z").getTime()),n.setMinutes(n.getMinutes()-n.getTimezoneOffset()),i._publishingdate=n.toISOString().slice(0,19).replace("T"," ")}return!i._userID&&t.userhash&&(i._userID=t.userhash),t.data=i,await s.create(i),new $(t.hash,t.hash,M.Success)}async processEditTransaction(t,e){var l,c,u;const s=await J.get(t.model),r=s.idbClient(),i=Object.keys(t.data);if(i.length!==1)return new $(t.blitzID,t.hash,M.Error,i.length>1?"Can not edit more than one attribute at once.":"Attribute not provided to perform edit.");if(await e.get("evaluated_transactions",t.hash))return new $(t.blitzID,t.hash,M.Notice,`Transaction ${t.hash} already processed.`);const n=await r.find(t.blitzID);if(!n)return new $(t.blitzID,t.hash,M.Notice,`Object with ${t.blitzID} does not exists.`);if(n._savetimestamp&&n._savetimestamp>t.blitzstamp)return new $(t.blitzID,t.hash,M.Notice,"Old transaction.");const o=i.shift(),h=(u=(c=(l=s.getAttribute("attributes"))==null?void 0:l.value)==null?void 0:c[o])==null?void 0:u.type;if(Array.isArray(h))if(Object.hasOwn(t.data[o],"add")){n[o]=n[o]??[];const d=t.data[o].add;o.endsWith("_mtm")?n[o].push({_blitzID:typeof d=="string"?d:d._blitzID,_mtmSort:typeof d=="string"?n[o].length?Math.max(...n[o].map(g=>g._mtmSort))+15:15:d._mtmSort}):n[o].push(d)}else if(Object.hasOwn(t.data[o],"remove")&&Array.isArray(n[o])){const d=t.data[o].remove;o.endsWith("_mtm")?n[o].splice(n[o].findIndex(g=>g._blitzID===d),1):n[o].splice(n[o].findIndex(g=>g===d),1)}else return new $(t.blitzID,t.hash,M.Error,`Invalid operation for array attribute ${o}.`);else{const d=t.data[o];if(n[o]===d.new)return new $(t.blitzID,t.hash,M.Notice,"Conflict");n[o]=d.new}return await r.update(n),new $(t.blitzID,t.hash,M.Success)}async processDeleteTransaction(t){const s=(await J.get(t.model)).idbClient();return await s.find(t.blitzID)?(await s.delete(t.blitzID),new $(t.blitzID,t.hash,M.Success)):new $(t.blitzID,t.hash,M.Error,`Object with ${t.blitzID} does not exists.`)}}class ye{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(O.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(O.store,t.id))}async _getCompletedReplicatedJobs(t){var i;const e=[],s=(i=this._db)==null?void 0:i.transaction(O.store,"readonly").store;let r=await(s==null?void 0:s.openCursor(null,"next"));for(;r;)r.value.status===I.Completed&&r.value.url!==t.url&&r.value.transaction.action===j.Edit&&r.value.transaction.blitzID===t.transaction.blitzID&&r.value.transaction.hash===t.transaction.hash&&e.push(r.value),r=await r.continue();return e}async _getFutureJobs(t,e){var o;const s=[],r=(o=this._db)==null?void 0:o.transaction(O.store,"readonly").store,i=IDBKeyRange.lowerBound(t.createdAt,!0);let n=await(r==null?void 0:r.index(O.timeIndex).openCursor(i,"next"));for(;n;)n.value.status===I.Conflict&&n.value.url===t.url&&n.value.transaction.action===j.Edit&&n.value.transaction.blitzID===t.transaction.blitzID&&Object.keys(n.value.transaction.data)[0]===e&&s.push(n.value),n=await n.continue();return s}async _mergeWithFutureEditJobs(t,e){var i,n;const s=await this._getFutureJobs(t,e);let r=t;if(s.length>0){const o=s[s.length-1];if(o&&((i=o.transaction.data)!=null&&i[e].new)){r=await this._updateJob({...t,transaction:{...t.transaction,data:{[e]:{prev:(n=t.transaction.data)==null?void 0:n[e].prev,new:o.transaction.data[e].new}}}});for(const h of s)await this._deleteJob(h)}}return r}async prompt(t){var i;const e=Object.keys(t.transaction.data)[0];let s=await this._mergeWithFutureEditJobs(t,e);const r=`There was a conflict.
The data got changed to "${s.message}".
Do you still want to perform your change to "${(i=s.transaction.data)==null?void 0:i[e].new}"?`;confirm(r)?s=await this.force(s):await this.revert(s),A.dispatchEvent("queue:conflict",s)}async force(t){var i;const e=Object.keys(t.transaction.data)[0],s=await this._getFutureJobs(t,e),r=await this._updateJob({...t,status:I.Pending,transaction:{...t.transaction,data:{[e]:{prev:t.message,new:(i=t.transaction.data)==null?void 0:i[e].new}}}});for(const n of s)await this._updateJob({...n,status:I.Pending});return r}async revert(t){var n;const e=Object.keys(t.transaction.data)[0],s=new W({action:"edit",model:t.transaction.model,blitzID:t.transaction.blitzID,data:{[e]:{prev:(n=t.transaction.data)==null?void 0:n[e].new,new:t.message}}});await V.create().run([s]);const r=await this._getFutureJobs(t,e),i=await this._getCompletedReplicatedJobs(t);for(const o of[t,...r])await this._deleteJob(o);if(i.length>0){const o=i.map(h=>h.url).filter((h,l,c)=>c.findIndex(u=>u===h)===l);for(const h of o)await A.queue.addJob(h,s.toObject())}}}class we{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(O.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(O.store,t.id))}async _getFutureJobs(t){var n;const e=[],s=(n=this._db)==null?void 0:n.transaction(O.store,"readonly").store,r=IDBKeyRange.lowerBound(t.createdAt,!0);let i=await(s==null?void 0:s.index(O.timeIndex).openCursor(r,"next"));for(;i;)i.value.url===t.url&&i.value.transaction.blitzID===t.transaction.blitzID&&e.push(i.value),i=await i.continue();return e}async retry(t){for(const e of t)await this._updateJob({...e,status:I.Pending})}async revert(t){var s,r;t.sort((i,n)=>i.createdAt-n.createdAt);const e=t[0];if(e){if(e.transaction.action===j.Add){await V.create().run([new W({action:"delete",model:e.transaction.model,blitzID:e.transaction.blitzID})]);const i=await this._getFutureJobs(e);for(const n of[e,...i])await this._deleteJob(n)}else if(e.transaction.action===j.Delete)await this._deleteJob(e),await J.get(e.transaction.model).then(i=>i==null?void 0:i.get(e.transaction.blitzID));else if(e.transaction.action===j.Edit){const i=Object.keys(e.transaction.data??{})[0];if(!i||((s=e.transaction.data)==null?void 0:s[i].new)===void 0||((r=e.transaction.data)==null?void 0:r[i].prev)===void 0)return;const n=new W({action:"edit",model:e.transaction.model,blitzID:e.transaction.blitzID,data:{[i]:{prev:e.transaction.data[i].new,new:e.transaction.data[i].prev}}});await V.create().run([n]);for(const o of t)await this._deleteJob(o)}}}async getAll(){var r;const t={},e=(r=this._db)==null?void 0:r.transaction(O.store,"readonly").store;let s=await(e==null?void 0:e.index(O.timeIndex).openCursor(null,"next"));for(;s;){if(s.value.status!==I.Completed){if(t[s.value.url]||(t[s.value.url]=[]),s.value.transaction.action===j.Add||s.value.transaction.action===j.Delete)t[s.value.url].push([s.value]);else if(s.value.transaction.action===j.Edit){const i=Object.keys(s.value.transaction.data??{})[0],n=s.value.transaction.blitzID,o=t[s.value.url].findIndex(h=>h[0].transaction.action===j.Edit&&h[0].transaction.blitzID===n&&Object.keys(h[0].transaction.data??{})[0]===i);o===-1?t[s.value.url].push([s.value]):t[s.value.url][o].push(s.value)}}s=await s.continue()}return t}}const _e="/queue-worker.js";class ve{constructor(){m(this,"_db",null);m(this,"conflictHandler",null);m(this,"failedHandler",null)}_handleWorkerMessage(t){var s;const e=t.data;e.status===I.Completed?A.dispatchEvent("queue:success",e):e.status===I.Failed?A.dispatchEvent("queue:failure",e):e.status===I.Conflict&&(document.hidden||(s=A.queue.conflictHandler)==null||s.prompt(e)),A._Model.get(e.transaction.model).then(r=>{var i;return(i=r==null?void 0:r.memoryClient().get(e.transaction.blitzID))==null?void 0:i.dispatchEvent("syncStatusChange",e)}),A.queue.updateSyncStatus(e)}async updateSyncStatus(t,e){if(t.transaction.action!==j.Edit)return;const s=await A._Model.get(t.transaction.model),r=s==null?void 0:s.memoryClient().get(t.transaction.blitzID);if(!r)return;const i=Object.keys(t.transaction.data??{})[0];if(!i)return;const n=r.getAttribute(i);if(!(!n||!Object.hasOwn(n,"_syncSignal")))if(e)n._syncSignal.set({status:e});else{const h=(await A.queue.getJobsForObject(t.transaction.blitzID)).filter(d=>{var f;return d.transaction.action===j.Edit&&((f=d.transaction.data)==null?void 0:f[i])!==void 0});let l=I.Pending,c;const u=h.find(d=>d.status===I.Failed);u?(l=I.Failed,c=u.message):h.find(d=>d.status===I.Conflict)?l=I.Conflict:h.every(d=>d.status===I.Completed)&&(l=I.Completed),n._syncSignal.set({status:l,message:c})}}async init(){if(this._db=await yt(O.name,1,{upgrade:e=>{const s=e.createObjectStore(O.store,{keyPath:"id"});s.createIndex(O.timeIndex,"createdAt"),s.createIndex(O.objectIndex,"transaction.blitzID")}}),!this._db.objectStoreNames.contains(O.store))return await wt(O.name),await this.init();this.conflictHandler=new ye(this._db),this.failedHandler=new we(this._db);const t=new ge(A.options.assetsPath+_e,{});return t.port.onmessage=this._handleWorkerMessage,window.addEventListener("beforeunload",()=>t.port.postMessage({type:"close"})),T._globalHeaders&&t.port.postMessage({type:"headers",data:T._globalHeaders}),this}async addJob(t,e){var r;const s={id:crypto.randomUUID(),url:t,transaction:e,status:I.Pending,createdAt:Date.now(),attempts:0,priority:1};await((r=this._db)==null?void 0:r.add(O.store,s)),await this.updateSyncStatus(s,s.status)}async deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(O.store,t.id))}async getJobs(){var t;return await((t=this._db)==null?void 0:t.getAll(O.store))}async getJobsForObject(t){var e;return await((e=this._db)==null?void 0:e.getAllFromIndex(O.store,O.objectIndex,t))}}const rt={a:["à","á","â","ä"],c:["ç"],e:["è","é","ê"],o:["ö","ó","ò","ô","õ"],oe:["œ"],ss:["ß"],u:["ü"]};class ut{constructor(){m(this,"children");m(this,"isEndOfWord");m(this,"items");this.children={},this.isEndOfWord=!1,this.items=[]}}class It{constructor(t,e){m(this,"root");if(this.root=new ut,!e)return;const s=this.getWordFrequency(t,e);for(const r in s)this.insert(r,s[r].items)}_loadFromJson(t,e){Object.keys(t).forEach(s=>{typeof t[s]=="string"||typeof t[s]=="boolean"||(e.children[s]||(e.children[s]=new ut),t[s].hasOwnProperty("isEndOfWord")&&t[s].isEndOfWord&&(e.children[s].isEndOfWord=!0,e.children[s].items=t[s].items),this._loadFromJson(t[s],e.children[s]))})}loadFromJson(t){return this.root=new ut,this._loadFromJson(t,this.root),this}toJson(){const t=e=>{let s={};for(const r in e.children)s[r]=t(e.children[r]);return e.isEndOfWord&&(s.isEndOfWord=!0,s.items=e.items),s};return t(this.root)}getWordFrequency(t,e){const s={},r=t.getAttributes();return e.forEach(i=>{r==null||r.forEach(n=>{if(!i[n])return;i[n].toString().toLowerCase().split(" ").forEach(h=>{h!==""&&(s[h]?s[h].items.push(i._blitzID):s[h]={items:[i._blitzID]})})})}),s}getVariants(t){const e=rt[t],s=[t];return e&&s.push(...e),s}generateAllPermutations(t,e,s,r,i){if(e===s.length){i.push(t);return}const n=s[e],o=e!==s.length-1?n+s[e+1]:void 0;if(!rt[n]&&!(o&&rt[o])){this.generateAllPermutations(t+n,e+1,s,r,i);return}if(rt[n]){const h=r[n];for(const l of h)this.generateAllPermutations(t+l,e+1,s,r,i)}if(o&&rt[o]){const h=r[o];for(const l of h)this.generateAllPermutations(t+l,e+2,s,r,i)}}normalizeQuery(t){const e=/u|e|a|o|c|ss|oe/g,s=t.toLowerCase().match(e);if(!s)return[t.toLowerCase()];const r={};s.forEach(n=>{r[n]=this.getVariants(n)});const i=[];return this.generateAllPermutations("",0,t,r,i),i}insert(t,e){let s=this.root;for(const r of t)s.children[r]||(s.children[r]=new ut),s=s.children[r];s.isEndOfWord=!0,s.items=e}addToSet(t,e){const s=this.normalizeQuery(t);for(const r of s)this._search(r).forEach(n=>{e.add(n)})}search(t){const e=t==null?void 0:t.toLowerCase().split(" ");let s=new Set;return this.addToSet(e[0],s),e.slice(1).forEach(r=>{const i=new Set;this.addToSet(r,i);for(const n of s)i.has(n)||s.delete(n)}),Array.from(s)}_search(t){let e=this.root;for(const r of t){if(!e.children[r])return[];e=e.children[r]}const s=[];return t===""?this.collectWords(e,"",s):this.collectWords(e,t,s),s}collectWords(t,e,s){t.isEndOfWord&&s.push(...t.items);for(const r in t.children){const i=t.children[r],n=e+r;this.collectWords(i,n,s)}}}function Jt(a,t,e){var r;let s=!0;for(const i of t){if(!s)return!1;const[n,o,h]=i,l=(r=e==null?void 0:e[n])==null?void 0:r.type;let c=a[n],u=h;switch(typeof c>"u"||c===null?c=null:(l==="datetime"||l==="date")&&(c=new Date(c).getTime()),typeof u>"u"||u===null?u=null:(l==="datetime"||l==="date")&&(u=new Date(u).getTime()),o){case"LIKE":const d=`${u}`.startsWith("%"),f=`${u}`.endsWith("%"),g=`${u}`.replaceAll("%","");d===f?s=`${c}`.includes(g):d?s=`${c}`.endsWith(g):f&&(s=`${c}`.startsWith(g));break;case"IN":s=(Array.isArray(u)?u:[u]).includes(c);break;case"=":s=c===u;break;case"!=":s=c!==u;break;case">":s=c>u;break;case"<":s=c<u;break;default:s=!0;break}}return s}class Ae{constructor(t){m(this,"model");this.model=t,this.ping()}async ping(){(await this.connect()).close()}async query(t,e){var g,y;const s=await this.connect(),r=s.transaction("objects","readonly").store,i=t.customSort&&Array.from(r.indexNames).includes(t.customSort)?t.customSort:"sorted",n=t.customSortDirection==="ASC"?"next":"prev";let o=await r.index(i).openCursor(null,n);const h=((g=this.model.getAttribute("attributes"))==null?void 0:g.value)??{};let l=[];for(;o;){if(e&&!e.includes(o.value.blitzID)){o=await o.continue();continue}if(Jt(o.value,t.conditions??[],h)&&(l.push(o.value),t.limit&&l.length>=t.limit))break;o=await o.continue()}const c={[this.model.getName()]:{database:s,model:this.model}},u=t.fks==="object",d=t.manyToMany==="object",f=t.var&&t.var.length>0;if(u||d||f){const v=f?["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var]:[];for(const _ of l){if(f)for(const w in _)v.includes(w)||delete _[w];if(u||d)for(const w in _){const S=w.endsWith("_fk"),Q=w.endsWith("_mtm");if(S||Q){let L=(y=h[w])==null?void 0:y.type;if(L=Array.isArray(L)?L[0]:L,L){if(!c[L]){const U=await J.get(L);c[L]={database:await(U==null?void 0:U.idbClient()).connect(),model:U}}if(c[L]&&c[L].database&&c[L].model){if(u&&S&&typeof _[w]=="string"){let U=await c[L].database.get("objects",_[w]);U||(U=await c[L].model.get({blitzID:_[w],raw:!0,forceHttp:!0})),_[w]=U??null}else if(d&&Q&&Array.isArray(_[w])){const U=[];for(const C of _[w]){const b=typeof C=="string"?C:C==null?void 0:C._blitzID;if(!b)continue;let E=await c[L].database.get("objects",b);E||(E=await c[L].model.get({blitzID:b,raw:!0,forceHttp:!0})),E&&U.push(E)}_[w]=U.map((C,b)=>({...C,_mtmSort:C._mtmSort!==void 0?C._mtmSort:(U.length-b)*15}))}}}}}}}for(const v in c)c[v].database.close();return l}async search(t,e){const s=await this.connect(),r=new It(this.model).loadFromJson(s.get("tree",this.model.getName()));s.close();const i=r.search(t);return t!==""&&i.length===0?[]:this.query({conditions:e},i)}async save(t){const e=await this.connect();e.put("tree",{name:this.model.getName(),tree:new It(this.model,t).toJson()});for(const s of t){let r={...s};for(const n of Object.keys(r))n.endsWith("_fk")&&r[n]!==null&&typeof r[n]=="object"&&r[n]._blitzID?r[n]=r[n]._blitzID:n.endsWith("_mtm")&&Array.isArray(r[n])&&(r[n]=r[n].map((o,h)=>({_blitzID:typeof o=="string"?o:o._blitzID,_mtmSort:typeof o=="string"?(r[n].length-h)*15:o._mtmSort})));const i=await e.get("objects",r._blitzID);i&&(r={...i,...r}),r._savetimestamp=ot(),await e.put("objects",r)}e.close()}async connect(){const t=this.model.getAttribute("attributes").value;return await yt(this.model.getName(),1,{upgrade:(s,r,i,n,o)=>{const h=k.getDatabases();if(h.includes(s.name)||(h.push(s.name),k.setDatabases(h)),i!==1)return;s.createObjectStore("tree",{keyPath:"name"});const l=s.createObjectStore("objects",{keyPath:"_blitzID"});for(const c in t)(t[c].type==="date"||c.includes("_fk"))&&l.createIndex(c,c,{unique:!1});l.createIndex("sorted","_blitzstamp")}})}async find(t){const e=await this.connect(),s=e.get("objects",t);return e.close(),s}async create(t){const e=await this.connect();await e.put("objects",t),this.updateTree(),e.close()}async update(t){const e=await this.connect();await e.put("objects",t),this.updateTree(),e.close()}async delete(t){const e=await this.connect();await e.delete("objects",t),this.updateTree(),e.close()}async updateTree(){const t=await this.connect(),e=await t.getAll("objects");await t.put("tree",{name:this.model.getName(),tree:new It(this.model,e).toJson()}),t.close()}}class zt{constructor(){m(this,"_subscribers");m(this,"_cleanUp",()=>{});this._subscribers=new Set}emit(t){for(const e of this._subscribers)e(t)}subscribe(t){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),()=>{this._subscribers.delete(t),this._cleanUp()}}filterPipe(t){const e=new zt;return e._cleanUp=this.subscribe(s=>{t(s)&&e.emit(s)}),e}}const tt=class tt{constructor(t){m(this,"model");this.model=t,A.objects.has(this.model.getName())||A.objects.set(this.model.getName(),new Map)}getAll(){return A.objects.get(this.model.getName())}get(t){return this.getAll().get(t)}update(t){var i;const e=this.getAll();if(!e.has(t.getAttribute("_blitzID").value)){const n=t.clone();return e.set(t.getAttribute("_blitzID").value,n),n}const s=e.get(t.getAttribute("_blitzID").value),r=Object.keys(this.model.getAttribute("attributes").value);for(const n of r){const o=(i=t.getAttribute(n))==null?void 0:i._value;if(o!==void 0){const h=s.getAttribute(n);h&&(h._value=o,Object.hasOwn(h,"_valueSignal")&&h._valueSignal.set(o,!1))}}return s}delete(t){const e=this.getAll();e.has(t)&&e.delete(t)}emit(t){tt.channel.emit(t)}async query(t={}){var u,d,f,g,y,v;const e=[],s=Array.from(this.getAll().values()).map(_=>_.toObject()),r=((u=this.model.getAttribute("attributes"))==null?void 0:u.value)??{},i=Object.keys(r),n=t.customSort&&i.includes(t.customSort)?t.customSort:"_blitzstamp",o=t.customSortDirection??"DESC";s.sort((_,w)=>{try{const S=parseInt(_[n]),Q=parseInt(w[n]);if(S<Q)return o==="ASC"?-1:1;if(S>Q)return o==="ASC"?1:-1}catch{}return 0});for(const _ of s)if(Jt(_,t.conditions??[],r)&&(e.push(_),t.limit&&e.length>=t.limit))break;const h=t.fks==="object",l=t.manyToMany==="object",c=t.var&&t.var.length>0;if(h||l||c){const _=c?["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var]:[];for(const w of e){if(c)for(const S in w)_.includes(S)||delete w[S];if(h||l)for(const S in w){const Q=S.endsWith("_fk"),L=S.endsWith("_mtm");if(h&&Q&&typeof w[S]=="string"){const U=(d=r[S])!=null&&d.type?await J.get(r[S].type):null;let C=U?(f=new tt(U).get(w[S]))==null?void 0:f.toObject():null;!C&&U&&(C=await U.get({blitzID:w[S],raw:!0,skipCacheUpdateIfFound:!0})),w[S]=C??null}if(l&&L&&Array.isArray(w[S])){const U=Array.isArray((g=r[S])==null?void 0:g.type)?r[S].type[0]:(y=r[S])==null?void 0:y.type,C=U?await J.get(U):null,b=C?new tt(C):null,E=[];for(const p of w[S]){const D=typeof p=="string"?p:p==null?void 0:p._blitzID;if(!D)continue;let z=(v=b==null?void 0:b.get(D))==null?void 0:v.toObject();!z&&C&&(z=await C.get({blitzID:D,raw:!0,skipCacheUpdateIfFound:!0})),z&&E.push(z)}w[S]=E.map((p,D)=>({...p,_mtmSort:p._mtmSort!==void 0?p._mtmSort:(E.length-D)*15}))}}}}return e}};m(tt,"channel",new zt);let dt=tt;class De{static async send(t,e){try{const s=new URL(t.url).origin!==self.location.origin?"?enableCors=1":"",r=await globalThis.fetch(t.url+"/api/post.json"+s,{method:"POST",headers:{"Content-Type":"application/json",...e??{}},body:JSON.stringify([t.transaction])});if(!r.ok)throw new Error(`HTTP request failed with status ${r.status}`+(r.statusText?`: ${r.statusText}`:""));const i=await r.json();if(!i||!i.results)throw new Error("No response returned!");const n=i.results[t.transaction.hash];if(!n)throw new Error("No result returned for this job!");if(n.s||n.s0||n.s1||n.n)return{status:G.Success};if(n.conflict){const o=Object.keys(t.transaction.data)[0],h=n.conflict[o];if(!h)throw new Error("No previous value found in conflict result!");return{status:G.Conflict,message:h}}else if(n.e)return{status:G.Failed,message:n.e};return{status:G.Exception,message:i.error??(Array.isArray(i.errors)?i.errors.map(o=>(o==null?void 0:o.message)??o).join(" | "):"Unknown error!")}}catch(s){return{status:G.Exception,message:s.message}}}}class it{constructor(t){m(this,"_value");m(this,"_subscribers");this._value=t,this._subscribers=new Set}get(){return this._value}set(t,e=!0){this._value!==t&&(this._value=t,e&&this.emit())}emit(){for(const t of this._subscribers)t(this._value)}subscribe(t,e=!0){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),e&&t(this._value),()=>this._subscribers.delete(t)}}class P{constructor(t,e,s){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(s),this._valueSignal=new it(this._value),this._syncSignal=new it(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}withValue(t){return this.value=t,this}withObject(t){return this._object=t,this}async edit(t,e){if(!this._object)throw new Error("Can not edit attribute, object is not set.");return this._object.edit(this._name,t,e)}subscribe(t,e=!0){var o,h,l,c;const s=(h=(o=this._object)==null?void 0:o.model)==null?void 0:h.memoryClient().get(this._object.getAttribute("_blitzID").value);if(!s)return()=>{};const r=s.getAttribute(this._name),i=r==null?void 0:r._valueSignal;if(!i)return()=>{};const n=i.subscribe(t,e);return r.value===void 0&&((c=(l=this._object)==null?void 0:l.model)==null||c.get({blitzID:this._object.getAttribute("_blitzID").value,forceHttp:!0}).then(u=>{const d=u==null?void 0:u.getAttribute(this._name);d&&d._value!==void 0&&(this._value=d._value,i.emit())})),n}syncStatus(t){var n,o,h;const e=(o=(n=this._object)==null?void 0:n.model)==null?void 0:o.memoryClient().get(this._object.getAttribute("_blitzID").value);if(!e)return()=>{};const s=e.getAttribute(this._name)._syncSignal,r=s.get()!==null,i=s.subscribe(t,r);return r||A.queue.getJobsForObject((h=this._object)==null?void 0:h.getAttribute("_blitzID").value).then(l=>{let c=I.Pending,u;const d=l.filter(g=>{var y;return g.transaction.action===j.Edit&&((y=g.transaction.data)==null?void 0:y[this._name])!==void 0}),f=d.find(g=>g.status===I.Failed);f?(c=I.Failed,u=f.message):d.find(g=>g.status===I.Conflict)?c=I.Conflict:d.every(g=>g.status===I.Completed)&&(c=I.Completed),s.set({status:c,message:u},!1),t(s.get())}),i}serializeForEdit(){return this.serialize()}}class nt extends P{unserialize(t){return t}serialize(){return this._value}}class Wt extends P{unserialize(t){if(typeof t=="boolean")return t?"1":"0";if(typeof t=="string"&&["0","1"].includes(t))return t;if(t!==void 0)return null}serialize(){return this._value}toJsBoolean(){return this._value==="1"?!0:this._value==="0"?!1:null}}const Ie=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/;class ze extends P{unserialize(t){if(t==="0000-00-00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&Ie.test(e))return e;if(t!==void 0)return null}serialize(){return this._value}serializeForEdit(){return this._value===null?"0000-00-00":this._value}toDateString(t){return!t||!(t instanceof Date)?null:t.toISOString().substring(0,10)}toDateObject(){return this._value?new Date(this._value):null}}class $t extends P{unserialize(t){return t}serialize(){return this._value}}class Se extends P{unserialize(t){return t}serialize(){return this._value}}class Ht extends P{unserialize(t){return typeof t=="number"?t.toString():t}serialize(){return this._value}toJsInt(){return this._value?parseInt(this._value,10):null}}class Te extends $t{}const Oe=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}\s[0-9]{2}\:[0-9]{2}\:[0-9]{2}$/;class je extends P{unserialize(t){if(t==="0000-00-00 00:00:00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&Oe.test(e))return e;if(t!==void 0)return null}serialize(){return this._value}serializeForEdit(){return this._value===null?"0000-00-00 00:00:00":this._value}toDateString(t){if(!t||!(t instanceof Date))return null;const e=new Date(t);e.setMinutes(e.getMinutes()-e.getTimezoneOffset());const s=e.toISOString();return s.substring(0,10)+" "+s.substring(11,19)}toDateObject(){return this._value?new Date(this._value):null}getTimeStamp(){return this._value?new Date(this._value).getTime():null}getBlitzStamp(){return this._value?Math.floor((new Date(this._value).getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3):null}}class Ee extends P{async get(t){const e=this.serialize();return e?await(await A._Model.get(this._type)).get({...t,blitzID:e}):null}unserialize(t){return t}serialize(){var t;return this._value==null||typeof this._value=="string"?this._value:((t=this._value.getAttribute("_blitzID"))==null?void 0:t.value)||null}}class Bt{constructor(t,e,s){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(s),this._valueSignal=new it(this._value),this._syncSignal=new it(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t)||[]:t instanceof Array?t:t===null?[]:void 0}catch{}return e&&(e=e.map(s=>B.createType(this._name,this._type,s)),e.forEach(s=>s.withObject(this._object))),e}serialize(){if(this._value!==void 0)return this._value.map(t=>t.serialize())}async performAction(t){var o,h,l,c,u,d,f,g,y,v,_;const e=new W({action:"edit",data:{[this._name]:{[t.action]:t.value}},model:(h=(o=this._object)==null?void 0:o.model)==null?void 0:h.getName(),blitzID:(l=this._object)==null?void 0:l.getAttribute("_blitzID").value}),s=await V.create().run([e]);if(s[0].status!==M.Success&&s[0].status!==M.Notice)throw new Error(s[0].message??"Unknown Error! Please try again.");for(const w of(c=this._object)==null?void 0:c.getAttribute("_editURLs").value)await A.queue.addJob(w,e.toObject());const r=(d=(u=this._object)==null?void 0:u.model)==null?void 0:d.memoryClient(),i=r==null?void 0:r.get((f=this._object)==null?void 0:f.getAttribute("_blitzID").value),n=await((y=(g=this._object)==null?void 0:g.model)==null?void 0:y.get({blitzID:this._object.getAttribute("_blitzID").value,forceLocal:!0,raw:!0}));if(n&&Array.isArray(n[this._name])){const w=i==null?void 0:i.getAttribute(this._name);w&&(w.value=n[this._name]),this.value=n[this._name]}r==null||r.emit(e),i==null||i.dispatchEvent("edit",e.data),(_=(v=this._object)==null?void 0:v.model)==null||_.setLastTransactionHash(e.hash)}async add(t){await this.performAction({action:"add",value:B.createType(this._name,this._type,t).serialize()})}async remove(t){await this.performAction({action:"remove",value:B.createType(this._name,this._type,t).serialize()})}withObject(t){this._object=t,this._value!==void 0&&this._value.forEach(e=>e.withObject(t))}subscribe(t,e=!0){var o,h,l,c;const s=(h=(o=this._object)==null?void 0:o.model)==null?void 0:h.memoryClient().get(this._object.getAttribute("_blitzID").value);if(!s)return()=>{};const r=s.getAttribute(this._name),i=r==null?void 0:r._valueSignal;if(!i)return()=>{};const n=i.subscribe(t,e);return r.value===void 0&&((c=(l=this._object)==null?void 0:l.model)==null||c.get({blitzID:this._object.getAttribute("_blitzID").value,forceHttp:!0,query:{manyToMany:"object"}}).then(u=>{const d=u==null?void 0:u.getAttribute(this._name);d&&d._value!==void 0&&(this._value=d._value,i.emit())})),n}syncStatus(t){var n,o,h;const e=(o=(n=this._object)==null?void 0:n.model)==null?void 0:o.memoryClient().get(this._object.getAttribute("_blitzID").value);if(!e)return()=>{};const s=e.getAttribute(this._name)._syncSignal,r=s.get()!==null,i=s.subscribe(t,r);return r||A.queue.getJobsForObject((h=this._object)==null?void 0:h.getAttribute("_blitzID").value).then(l=>{let c=I.Pending,u;const d=l.filter(g=>{var y;return g.transaction.action===j.Edit&&((y=g.transaction.data)==null?void 0:y[this._name])!==void 0}),f=d.find(g=>g.status===I.Failed);f?(c=I.Failed,u=f.message):d.find(g=>g.status===I.Conflict)?c=I.Conflict:d.every(g=>g.status===I.Completed)&&(c=I.Completed),s.set({status:c,message:u},!1),t(s.get())}),i}}class xe extends Bt{unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t)||[]:t instanceof Array?t:t===null?[]:void 0}catch{}return e}serialize(){if(this._value!==void 0)return this._value.map(t=>t instanceof K?t.getAttribute("_blitzID").value:typeof t=="string"?t:t==null?void 0:t._blitzID)}async add(t){await this.performAction({action:"add",value:t})}async remove(t){await this.performAction({action:"remove",value:t})}withObject(t){this._object=t}}function Ue(a){return a&&a.constructor&&typeof a.constructor.isBuffer=="function"&&a.constructor.isBuffer(a)}function Le(a){return a}function Ce(a,t){t=t||{};const e=t.delimiter||".",s=t.maxDepth,r=t.transformKey||Le,i={};function n(o,h,l){l=l||1,Object.keys(o).forEach(function(c){const u=o[c],d=t.safe&&Array.isArray(u),f=Object.prototype.toString.call(u),g=Ue(u),y=f==="[object Object]"||f==="[object Array]",v=h?h+e+r(c):r(c);if(!d&&!g&&y&&Object.keys(u).length&&(!t.maxDepth||l<s))return n(u,v,l+1);i[v]=u})}return n(a),i}class Me extends P{unserialize(t){if(t!==null&&typeof t=="object")return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){let e=!0;try{JSON.parse(t)}catch{e=!1}return e}keys(){return Object.keys(this._value??{})}flat(){return Ce(this._value??{})}groupBy(t){if(typeof t!="function")throw new Error("Callback function is not a function!");return Object.groupBy(this._value??{},t)}}class ke extends P{unserialize(t){if(typeof t=="string")return{content:t,language:null};if(t!==null&&typeof t=="object"&&t.content)return{content:t.content,language:t.language??null};if(t!==void 0)return null}serialize(){return this._value}getLanguage(){var t;return((t=this._value)==null?void 0:t.language)||null}getContent(){var t;return((t=this._value)==null?void 0:t.content)||null}}class Fe extends P{unserialize(t){return t}serialize(){return this._value}getOptions(){var t,e,s,r,i;return((i=(r=(s=(e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttribute("attributes"))==null?void 0:s.value)==null?void 0:r[this._name])==null?void 0:i.options)??[]}validate(t){return this.getOptions().includes(t)}}class St extends P{unserialize(t){return typeof t=="number"?t.toString():t}serialize(){return this._value}toJsFloat(){return this._value?parseFloat(this._value):null}}class Re extends Ht{}class Pe extends St{}class Ne extends St{toPercentage(){return this._value?(parseFloat(this._value)*100).toString()+"%":null}}const Qt=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;class Je extends P{unserialize(t){if(t!=null&&Qt.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return Qt.test(t)}}const Vt=/^\+[1-9]{1,3}\-[0-9]{7,14}$/;class We extends P{unserialize(t){if(t!=null&&Vt.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return Vt.test(t)}getCallingCode(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[0].substring(1)}getPhoneNumber(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[1]}}const qt=/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/;class $e extends P{unserialize(t){if(t!=null&&qt.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return qt.test(t)}getUrlObject(){return this._value?new URL(this._value):null}getOrigin(){return this._value?new URL(this._value).origin:null}getProtocol(){return this._value?new URL(this._value).protocol:null}getPathname(){return this._value?new URL(this._value).pathname:null}getHostname(){return this._value?new URL(this._value).hostname:null}getSearch(){return this._value?new URL(this._value).search:null}}class He extends P{unserialize(t){const e=t instanceof Array?t[0]:t;if(e!==null&&typeof e=="object"&&e.base!=null&&e.version!=null)return t;if(e!==void 0)return null}serialize(){return this._value}getUrl(t){const e=this._value instanceof Array?this._value[0]:this._value;return e!==null&&typeof e=="object"&&e.base!=null&&e[t]!=null?e.base+e[t].substring(1):null}}class Be extends P{unserialize(t){if(t!==null&&typeof t=="object"&&t.lat&&t.long)return t;if(t!==void 0)return null}serialize(){return this._value?this._value:null}validate(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!e.lat||!e.long)return!1;const s=parseFloat(e.lat);if(isNaN(s)||s<-90||s>90)return!1;const r=parseFloat(e.long);return!(isNaN(r)||r<-180||r>180)}getFormattedAddress(){if(!this._value)return"";const t=[];this._value.venue&&t.push(this._value.venue),this._value.street&&t.push(this._value.street);const e=[];return this._value.zip&&e.push(this._value.zip),this._value.city&&e.push(this._value.city),e.length>0&&t.push(e.join(" ")),this._value.nation&&t.push(this._value.nation),t.join(", ")}async geocodeAddress(t,e){if(!t)throw new Error("Address is required for geocoding.");if(!e)throw new Error("Google Maps API key is required for geocoding.");try{const r=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(t)}&key=${e}`)).json();if(r.status==="OK"&&r.results&&r.results.length>0){const i=r.results[0].geometry.location;return{lat:i.lat.toString(),long:i.lng.toString()}}return null}catch(s){return console.error("Geocoding error:",s.message),null}}}class B{static createType(t,e,s){return t.endsWith("_fk")?new Ee(t,e,s):e==="int"?new Ht(t,e,s):e==="tinyint"?new Re(t,e,s):e==="double"?new Pe(t,e,s):e==="float"?new St(t,e,s):e==="percentage"?new Ne(t,e,s):e==="varchar"?new Te(t,e,s):e==="text"?new $t(t,e,s):e==="htmlText"?new Se(t,e,s):e==="enum"?new Fe(t,e,s):e==="json"?new Me(t,e,s):e==="boolean"?new Wt(t,e,s):e==="datetime"?new je(t,e,s):e==="date"?new ze(t,e,s):e==="code"?new ke(t,e,s):e==="email"?new Je(t,e,s):e==="phone"?new We(t,e,s):e==="url"?new $e(t,e,s):e==="image"?new He(t,e,s):e==="location"?new Be(t,e,s):new nt(t,e,s)}static createFrom(t,e,s){return Array.isArray(e)?this.createMany(t,e[0],s):this.createType(t,e,s)}static createMany(t,e,s){return t.endsWith("_mtm")?new xe(t,e,s):new Bt(t,e,s)}static unserialize(t,e){var i,n,o;const s={},r=[...Object.keys(t),...Object.keys(e)].filter((h,l,c)=>c.indexOf(h)===l);for(const h of r)Array.isArray((i=t[h])==null?void 0:i.type)?s[h]=B.createMany(h,((n=t[h])==null?void 0:n.type[0])??"anonymous",e[h]):s[h]=B.createType(h,((o=t[h])==null?void 0:o.type)??"anonymous",e[h]);return s}static serialize(t){const e={};for(const s in t)e[s]=t[s].serialize();return e}}const Qe={get(a,t){if(Reflect.has(a,t)){const e=Reflect.get(a,t);return e instanceof Function?e.bind(a):e}return a.getAttribute(t)},set(a,t,e){throw new Error("Setting values directly not supported. Please use `edit` method to change a value for an attribute.")}};class at{static create(t,e,s,r=!0){const i=B.unserialize(e.getAttribute("attributes").value,s),n=new Proxy(new t({model:e,attributes:i}),Qe);for(const o in i)i[o].withObject(n);return r&&e.memoryClient().update(n),n}}class Tt{constructor({model:t,attributes:e}){m(this,"_model");m(this,"attributes");m(this,"listeners",new Map);m(this,"editQueue",Promise.resolve());this._model=t,this.attributes=e}get model(){return this._model}getAttribute(t){return this.attributes[t]}setAttribute(t,e){this.attributes[t]=e}hasAttribute(t){return this.attributes.hasOwnProperty(t)}edit(t,e,s){return this.enqueueEditOperation(async()=>{var d,f,g,y,v,_;const r=(y=(g=(f=(d=this.model)==null?void 0:d.getAttribute("attributes"))==null?void 0:f.value)==null?void 0:g[t])==null?void 0:y.type,i=B.createType(t,r,e).serialize(),n=s?B.createType(t,r,s).serializeForEdit():this.getAttribute(t).serializeForEdit(),o=new W({action:"edit",data:{[t]:{prev:n,new:i}},model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),h=await V.create().run([o]);if(h[0].status!==M.Success&&h[0].status!==M.Notice)throw new Error(h[0].message??"Unknown Error! Please try again.");this.attributes[t].value=i;const l=(v=this.model)==null?void 0:v.memoryClient(),c=l==null?void 0:l.get(this.getAttribute("_blitzID").value),u=c==null?void 0:c.getAttribute(t);u&&(u.value=i);for(const w of this.getAttribute("_editURLs").value)await A.queue.addJob(w,o.toObject());l==null||l.emit(o),c==null||c.dispatchEvent("edit",o.data),(_=this.model)==null||_.setLastTransactionHash(o.hash)})}async delete(){var r,i,n;const t=new W({action:"delete",model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),e=await V.create().run([t]);if(e[0].status!==M.Success)throw new Error(e[0].message??"Unknown Error! Please try again.");const s=(r=this.model)==null?void 0:r.memoryClient();(i=s==null?void 0:s.get(this.getAttribute("_blitzID").value))==null||i.dispatchEvent("delete",null),s==null||s.delete(this.getAttribute("_blitzID").value);for(const o of this.getAttribute("_editURLs").value)await A.queue.addJob(o,t.toObject());s==null||s.emit(t),(n=this.model)==null||n.setLastTransactionHash(t.hash)}async addUserPermission(t){if(!t||t.length===0)throw new Error("Users missing!");const e=this.getAttribute("_blitzID").value,s={blitzIDs:[e],users:t.reduce((o,h)=>({...o,[`#${h.id}`]:h.permission}),{})},r=new W({action:"addObjectUserPermission",model:this.model.getName(),blitzID:e,data:s,hash:vt(s)}),i=[];for(const o of this.getAttribute("_editURLs").value)i.push(await De.send({url:o,transaction:r.toObject()},T._globalHeaders));const n=i.find(o=>o.status!==G.Success);if(n)throw new Error(n.message)}toObject(){const t={};for(const e in this.attributes)t[e]=this.attributes[e].serialize();return t}clone(){return at.create(Tt,this._model,this.toObject(),!1)}addEventListener(t,e){var r,i;const s=(r=this.model)==null?void 0:r.memoryClient().get(this.getAttribute("_blitzID").value);s.listeners.has(t)||s.listeners.set(t,[]),(i=s.listeners.get(t))==null||i.push(e)}removeEventListener(t,e){var r;const s=(r=this.model)==null?void 0:r.memoryClient().get(this.getAttribute("_blitzID").value);s.listeners.has(t)&&s.listeners.set(t,s.listeners.get(t).filter(i=>e!==i))}dispatchEvent(t,e){var r,i;const s=(r=this.model)==null?void 0:r.memoryClient().get(this.getAttribute("_blitzID").value);s.listeners.has(t)&&((i=s.listeners.get(t))==null||i.forEach(n=>n(e)))}enqueueEditOperation(t){return new Promise((e,s)=>{this.editQueue=this.editQueue.then(async()=>{try{const r=await t();e(r)}catch(r){s(r)}})})}}const K=Tt;class Ot{static transformBlitzDataOptions(t){if(typeof t>"u")throw new Error("Configuration is required.");if(typeof t=="string")t={clusters:this.transformClusterOptions(t)};else if(Array.isArray(t))t={clusters:this.transformClusterOptions(t)};else if(typeof t=="object"&&!Array.isArray(t))t.clusters=this.transformClusterOptions(t.clusters);else throw new Error("Unknown configuration type.");if(t.assetsPath||(t.assetsPath=""),t.sync?typeof t.sync=="string"&&(t.sync={level:t.sync}):t.sync={level:"full"},t.sync.level==="partial")throw new Error("Partial sync type not supported yet!");return t.sync.level==="cache"&&(t.sync.ttl||(t.sync.ttl=30*1e3)),t.sync.level==="full"&&(t.sync.interval||(t.sync.interval=30*1e3)),t}static transformClusterOptions(t){if(typeof t>"u")throw new Error("Clusters are required.");if(typeof t=="string")t={default:{readURL:[t],addURL:[t]}};else if(Array.isArray(t))t={default:{readURL:t,addURL:t}};else if(typeof t=="object")for(const e of Object.keys(t)){if(typeof t[e]=="string"||Array.isArray(t[e])){const s=Array.isArray(t[e])?t[e]:[t[e]];t[e]={readURL:s,addURL:s};continue}typeof t[e]=="object"&&(typeof t[e].readURL=="string"&&(t[e].readURL=[t[e].readURL]),typeof t[e].addURL=="string"&&(t[e].addURL=[t[e].addURL]))}else throw new Error("Unknown cluster configuration type.");return t}}class jt extends K{static async model(){if(typeof this.modelName!="string")throw new Error(`${this.name}.modelName is not a string, please provide a valid model name.`);const t=this.modelName==="_Model"?A._Model:await A._Model.get(this.modelName);return t.setReturnType(this),t}static async get(t){return(await this.model()).get(t)}static async exists(t){return(await this.model()).exists(t)}static async add(t,e=[]){return(await this.model()).add(t,e)}static async list(t={}){return(await this.model()).list(t)}}m(jt,"modelName");const ht=class ht extends jt{constructor({model:e,attributes:s}){super({model:e,attributes:s});m(this,"clusterManager");m(this,"lastTransactionHash",null);m(this,"returnType",K);this.clusterManager=A.clusterManager}idbClient(){return new Ae(this)}memoryClient(){return new dt(this)}getName(){return this.attributes._blitzID.value}getLastTransactionHash(){return this.lastTransactionHash}setLastTransactionHash(e){this.lastTransactionHash=e}setReturnType(e){this.returnType=e}async exists(e){return!!await this.get(e)}async add(e,s=[]){const r=this.resolveClusters(s),i=this.getAttribute("attributes").value,n=new W({action:"add",data:B.serialize(B.unserialize(i,e)),model:this.getName()}),o=await A.getCurrentUser(),h=n.clone();h.data={...h.data,_userID:o.id};const l=await V.create().run([h]);if(l[0].status!==M.Success)throw new Error(l[0].message??"Unknown Error! Please try again.");for(const c of r)for(const u of c.options.addURL)await A.queue.addJob(u,n.toObject());return this.memoryClient().emit(n),this.setLastTransactionHash(n.hash),at.create(this.returnType,this,h.data)}async get(e){const s=typeof e=="string"?{blitzID:e}:e,i=(await Y.create().model(this).clusters(this.resolveClusters(s.clusters??[])).raw(s.raw??!1).get(s.blitzID).query({returnType:this.returnType??K}).forceHttp(s.forceHttp??!1).forceLocal(s.forceLocal??!1).skipCacheUpdateIfFound(s.skipCacheUpdateIfFound??!1).getQuery(s.query??{}).perform())[0]??null;if(!i&&this.returnType===ht)throw new Error(`Model with blitzID "${e}" does not exists or you don't have enough permission to view it.`);return i||null}async list(e={}){return await Y.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??K,customSort:e.customSort,customSortDirection:e.customSortDirection,var:e.var,fks:e.fks,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).perform()}subscribeToList(e={},s,r=!1){const i=Y.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??K,customSort:e.customSort,customSortDirection:e.customSortDirection,fks:e.fks,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).performSignal(r),n=i.subscribe(s,i.get()!==null),o=dt.channel.filterPipe(h=>h.model===this.getName()).subscribe(h=>{if(h.action===j.Add)this.list({...e,forceLocal:!0}).then(l=>{const c=e.raw?l.findIndex(u=>u._blitzID===h.blitzID):l.findIndex(u=>u.getAttribute("_blitzID").value===h.blitzID);c>-1&&i.set({items:l,update:{action:j.Add,object:l[c],index:c}})});else if(h.action===j.Edit){const l=i.get();if(!l)return;const c=e.raw?l.items.findIndex(u=>u._blitzID===h.blitzID):l.items.findIndex(u=>u.getAttribute("_blitzID").value===h.blitzID);c>-1&&this.list({...e,forceLocal:!0}).then(u=>{const d=e.raw?u.findIndex(f=>f._blitzID===h.blitzID):u.findIndex(f=>f.getAttribute("_blitzID").value===h.blitzID);i.set({items:u,update:{action:j.Edit,object:d>-1?u[d]:l.items[c],index:d>-1?d:c}})})}else if(h.action===j.Delete){const l=i.get();if(!l)return;if(e.raw){const c=l.items.findIndex(u=>u._blitzID===h.blitzID);c>-1&&i.set({items:l.items.filter(u=>u._blitzID!==h.blitzID),update:{action:j.Delete,object:l.items[c],index:c}})}else{const c=l.items.findIndex(u=>u.getAttribute("_blitzID").value===h.blitzID);c>-1&&i.set({items:l.items.filter(u=>u.getAttribute("_blitzID").value!==h.blitzID),update:{action:j.Delete,object:l.items[c],index:c}})}}});return()=>{n(),o()}}async sync(){const e=this.getName();if(e){const s=Date.now()/1e3,r=k.getLastSyncedAt(e)??0,i=30;s-r>i&&await st.create().run(e)}}getAttributes(){var e;return((e=this.attributes.searchable)==null?void 0:e.value)??[]}getAttributeDetails(e){return this.getAttribute("attributes").value[e]}resolveClusters(e){return Object.values(e.length===0?this.clusterManager.all():this.clusterManager.get(e))}setClusters(e){this.clusterManager=new Lt;const s=Ot.transformClusterOptions(e);for(const r of Object.keys(s))this.clusterManager.register(r,s[r])}getClusterManager(){return this.clusterManager}static async get(e){return super.get(e)}static async list(e={}){return super.list(e)}};m(ht,"modelName","_Model");let J=ht;class Et{static extractModelName(t){const r=new URL(t).pathname.split("/").filter(i=>i!=="").pop();if(!r&&!(r!=null&&r.endsWith(".json")))throw new Error("Model name not found in the URL.");return r.slice(0,r.indexOf(".json"))}static extractConditions(t){const e=new URL(t);return JSON.parse(e.searchParams.get("conditions")||"[]")}}var Kt={exports:{}},Zt={exports:{}};(function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,s){return e<<s|e>>>32-s},rotr:function(e,s){return e<<32-s|e>>>s},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var s=0;s<e.length;s++)e[s]=t.endian(e[s]);return e},randomBytes:function(e){for(var s=[];e>0;e--)s.push(Math.floor(Math.random()*256));return s},bytesToWords:function(e){for(var s=[],r=0,i=0;r<e.length;r++,i+=8)s[i>>>5]|=e[r]<<24-i%32;return s},wordsToBytes:function(e){for(var s=[],r=0;r<e.length*32;r+=8)s.push(e[r>>>5]>>>24-r%32&255);return s},bytesToHex:function(e){for(var s=[],r=0;r<e.length;r++)s.push((e[r]>>>4).toString(16)),s.push((e[r]&15).toString(16));return s.join("")},hexToBytes:function(e){for(var s=[],r=0;r<e.length;r+=2)s.push(parseInt(e.substr(r,2),16));return s},bytesToBase64:function(e){for(var s=[],r=0;r<e.length;r+=3)for(var i=e[r]<<16|e[r+1]<<8|e[r+2],n=0;n<4;n++)r*8+n*6<=e.length*8?s.push(a.charAt(i>>>6*(3-n)&63)):s.push("=");return s.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var s=[],r=0,i=0;r<e.length;i=++r%4)i!=0&&s.push((a.indexOf(e.charAt(r-1))&Math.pow(2,-2*i+8)-1)<<i*2|a.indexOf(e.charAt(r))>>>6-i*2);return s}};Zt.exports=t})();var Ve=Zt.exports,xt={utf8:{stringToBytes:function(a){return xt.bin.stringToBytes(unescape(encodeURIComponent(a)))},bytesToString:function(a){return decodeURIComponent(escape(xt.bin.bytesToString(a)))}},bin:{stringToBytes:function(a){for(var t=[],e=0;e<a.length;e++)t.push(a.charCodeAt(e)&255);return t},bytesToString:function(a){for(var t=[],e=0;e<a.length;e++)t.push(String.fromCharCode(a[e]));return t.join("")}}},Gt=xt;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var qe=function(a){return a!=null&&(Xt(a)||Ke(a)||!!a._isBuffer)};function Xt(a){return!!a.constructor&&typeof a.constructor.isBuffer=="function"&&a.constructor.isBuffer(a)}function Ke(a){return typeof a.readFloatLE=="function"&&typeof a.slice=="function"&&Xt(a.slice(0,0))}(function(){var a=Ve,t=Gt.utf8,e=qe,s=Gt.bin,r=function(i,n){i.constructor==String?n&&n.encoding==="binary"?i=s.stringToBytes(i):i=t.stringToBytes(i):e(i)?i=Array.prototype.slice.call(i,0):!Array.isArray(i)&&i.constructor!==Uint8Array&&(i=i.toString());for(var o=a.bytesToWords(i),h=i.length*8,l=1732584193,c=-271733879,u=-1732584194,d=271733878,f=0;f<o.length;f++)o[f]=(o[f]<<8|o[f]>>>24)&16711935|(o[f]<<24|o[f]>>>8)&4278255360;o[h>>>5]|=128<<h%32,o[(h+64>>>9<<4)+14]=h;for(var g=r._ff,y=r._gg,v=r._hh,_=r._ii,f=0;f<o.length;f+=16){var w=l,S=c,Q=u,L=d;l=g(l,c,u,d,o[f+0],7,-680876936),d=g(d,l,c,u,o[f+1],12,-389564586),u=g(u,d,l,c,o[f+2],17,606105819),c=g(c,u,d,l,o[f+3],22,-1044525330),l=g(l,c,u,d,o[f+4],7,-176418897),d=g(d,l,c,u,o[f+5],12,1200080426),u=g(u,d,l,c,o[f+6],17,-1473231341),c=g(c,u,d,l,o[f+7],22,-45705983),l=g(l,c,u,d,o[f+8],7,1770035416),d=g(d,l,c,u,o[f+9],12,-1958414417),u=g(u,d,l,c,o[f+10],17,-42063),c=g(c,u,d,l,o[f+11],22,-1990404162),l=g(l,c,u,d,o[f+12],7,1804603682),d=g(d,l,c,u,o[f+13],12,-40341101),u=g(u,d,l,c,o[f+14],17,-1502002290),c=g(c,u,d,l,o[f+15],22,1236535329),l=y(l,c,u,d,o[f+1],5,-165796510),d=y(d,l,c,u,o[f+6],9,-1069501632),u=y(u,d,l,c,o[f+11],14,643717713),c=y(c,u,d,l,o[f+0],20,-373897302),l=y(l,c,u,d,o[f+5],5,-701558691),d=y(d,l,c,u,o[f+10],9,38016083),u=y(u,d,l,c,o[f+15],14,-660478335),c=y(c,u,d,l,o[f+4],20,-405537848),l=y(l,c,u,d,o[f+9],5,568446438),d=y(d,l,c,u,o[f+14],9,-1019803690),u=y(u,d,l,c,o[f+3],14,-187363961),c=y(c,u,d,l,o[f+8],20,1163531501),l=y(l,c,u,d,o[f+13],5,-1444681467),d=y(d,l,c,u,o[f+2],9,-51403784),u=y(u,d,l,c,o[f+7],14,1735328473),c=y(c,u,d,l,o[f+12],20,-1926607734),l=v(l,c,u,d,o[f+5],4,-378558),d=v(d,l,c,u,o[f+8],11,-2022574463),u=v(u,d,l,c,o[f+11],16,1839030562),c=v(c,u,d,l,o[f+14],23,-35309556),l=v(l,c,u,d,o[f+1],4,-1530992060),d=v(d,l,c,u,o[f+4],11,1272893353),u=v(u,d,l,c,o[f+7],16,-155497632),c=v(c,u,d,l,o[f+10],23,-1094730640),l=v(l,c,u,d,o[f+13],4,681279174),d=v(d,l,c,u,o[f+0],11,-358537222),u=v(u,d,l,c,o[f+3],16,-722521979),c=v(c,u,d,l,o[f+6],23,76029189),l=v(l,c,u,d,o[f+9],4,-640364487),d=v(d,l,c,u,o[f+12],11,-421815835),u=v(u,d,l,c,o[f+15],16,530742520),c=v(c,u,d,l,o[f+2],23,-995338651),l=_(l,c,u,d,o[f+0],6,-198630844),d=_(d,l,c,u,o[f+7],10,1126891415),u=_(u,d,l,c,o[f+14],15,-1416354905),c=_(c,u,d,l,o[f+5],21,-57434055),l=_(l,c,u,d,o[f+12],6,1700485571),d=_(d,l,c,u,o[f+3],10,-1894986606),u=_(u,d,l,c,o[f+10],15,-1051523),c=_(c,u,d,l,o[f+1],21,-2054922799),l=_(l,c,u,d,o[f+8],6,1873313359),d=_(d,l,c,u,o[f+15],10,-30611744),u=_(u,d,l,c,o[f+6],15,-1560198380),c=_(c,u,d,l,o[f+13],21,1309151649),l=_(l,c,u,d,o[f+4],6,-145523070),d=_(d,l,c,u,o[f+11],10,-1120210379),u=_(u,d,l,c,o[f+2],15,718787259),c=_(c,u,d,l,o[f+9],21,-343485551),l=l+w>>>0,c=c+S>>>0,u=u+Q>>>0,d=d+L>>>0}return a.endian([l,c,u,d])};r._ff=function(i,n,o,h,l,c,u){var d=i+(n&o|~n&h)+(l>>>0)+u;return(d<<c|d>>>32-c)+n},r._gg=function(i,n,o,h,l,c,u){var d=i+(n&h|o&~h)+(l>>>0)+u;return(d<<c|d>>>32-c)+n},r._hh=function(i,n,o,h,l,c,u){var d=i+(n^o^h)+(l>>>0)+u;return(d<<c|d>>>32-c)+n},r._ii=function(i,n,o,h,l,c,u){var d=i+(o^(n|~h))+(l>>>0)+u;return(d<<c|d>>>32-c)+n},r._blocksize=16,r._digestsize=16,Kt.exports=function(i,n){if(i==null)throw new Error("Illegal argument "+i);var o=a.wordsToBytes(r(i,n));return n&&n.asBytes?o:n&&n.asString?s.bytesToString(o):a.bytesToHex(o)}})();var Ze=Kt.exports;const Ge=pe(Ze);class Y{constructor(){m(this,"_clusters");m(this,"_urls");m(this,"_model");m(this,"_query");m(this,"_raw",!1);m(this,"_forceHttp",!1);m(this,"_forceLocal",!1);m(this,"_skipCacheUpdateIfFound",!1);m(this,"_get");m(this,"_getQuery")}static create(){return new Y}model(t){return this._model=t,this}clusters(t){return this._clusters=t,this}urls(t){return this._urls=t,this}query(t){return this._query=t,this}raw(t){return this._raw=t,this}forceHttp(t){return this._forceHttp=t,this}forceLocal(t){return this._forceLocal=t,this}skipCacheUpdateIfFound(t){return this._skipCacheUpdateIfFound=t,this}get(t){return this._get=t,this}getQuery(t){return this._getQuery=t,this}async convertObjects(t){var o,h,l,c,u,d,f;const e=[],s=this._get?((o=this._getQuery)==null?void 0:o.fks)==="object":((h=this._query)==null?void 0:h.fks)==="object",r=this._get?((l=this._getQuery)==null?void 0:l.manyToMany)==="object":((c=this._query)==null?void 0:c.manyToMany)==="object",i=((d=(u=this._model)==null?void 0:u.getAttribute("attributes"))==null?void 0:d.value)??{},n={[this._model.getName()]:this._model};for(const g of t){if(s||r)for(const y in g){const v=y.endsWith("_fk"),_=y.endsWith("_mtm");if(v||_){let w=(f=i[y])==null?void 0:f.type;w=Array.isArray(w)?w[0]:w,w&&(n[w]||(n[w]=await J.get(w)),n[w]&&(s&&v&&typeof g[y]=="object"&&g[y]!==null?g[y]=at.create(K,n[w],g[y]):r&&_&&Array.isArray(g[y])&&(g[y]=g[y].map(S=>at.create(K,n[w],S)))))}}e.push(at.create(this._query.returnType,this._model,g))}return e}async perform(){var e;let t=this._forceHttp&&!this._forceLocal?[]:await this.performIndexedDb();if(!this._forceLocal){if(A.options.sync.level==="full"&&t.length===0)t=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp())),t.length>0&&await this._model.idbClient().save(t);else if(A.options.sync.level==="cache"){const s=this._skipCacheUpdateIfFound&&t.length>0?!1:this.shouldSendHttpRequest();if(s||t.length===0){const r=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));(r.length>0||this._forceHttp)&&(t=r,t.length>0&&await this._model.idbClient().save(t)),s&&((e=this._model)==null?void 0:e.getName())!=="_Model"&&k.setListCallLastTimeStamp(this.hash(),new Date().getTime())}}}return this._raw?t:await this.convertObjects(t)}performSignal(t=!1){const e=new it(null);return(async()=>{var n;if(!t){e.set({items:await this.perform()});return}const s=await this.performMemory();e.set({items:this._raw?s:await this.convertObjects(s),nextSource:"local database"});const r=await this.performIndexedDb();e.set({items:this._raw?r:await this.convertObjects(r),nextSource:"server"});const i=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));i.length>0&&await((n=this._model)==null?void 0:n.idbClient().save(i)),e.set({items:this._raw?i:await this.convertObjects(i)})})(),e}async performHttp(){return(await Promise.all(this._urls?this._urls.map(e=>this.performSingleUrlHttp(e)):this._clusters.map(e=>this.performSingleClusterHttp(e)))).flat()}async performSingleClusterHttp(t){const e={};for(let s=0;s<t.options.readURL.length;s++){const r=t.getNextReadURL();try{return(this._get?await et.get({baseUrl:r,modelName:this._model.getName(),blitzID:this._get,query:this._getQuery}):await et.list({endpoint:{baseUrl:r,modelName:this._model.getName(),query:this._query}})).map(n=>{var o,h;if(n._clusters=[t.name],n._editURLs=JSON.parse(JSON.stringify(t.options.readURL)),((o=this._query)==null?void 0:o.manyToMany)==="object"||((h=this._getQuery)==null?void 0:h.manyToMany)==="object"){for(const l in n)if(l.endsWith("_mtm")&&Array.isArray(n[l]))for(const c of n[l])c._clusters=n._clusters,c._editURLs=n._editURLs}return n})}catch(i){e[r]=(i==null?void 0:i.message)??i}}throw new Error(`All read URLs failed for cluster "${t.name}". Errors: ${JSON.stringify(e)}`)}async performSingleUrlHttp(t){return(await et.list({fullUrl:t})).map(s=>(s.cluster=[],s._editURLs=[t],s))}async performIndexedDb(){var s,r,i;const t=this._model.idbClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(s=this._getQuery)==null?void 0:s.var,fks:(r=this._getQuery)==null?void 0:r.fks,manyToMany:(i=this._getQuery)==null?void 0:i.manyToMany});const e=this._urls?this._urls.map(n=>Et.extractConditions(n)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}async performMemory(){var s,r,i;const t=this._model.memoryClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(s=this._getQuery)==null?void 0:s.var,fks:(r=this._getQuery)==null?void 0:r.fks,manyToMany:(i=this._getQuery)==null?void 0:i.manyToMany});const e=this._urls?this._urls.map(n=>Et.extractConditions(n)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}mergeObjects(t){const e=[];for(const s of t){const r=e.find(i=>i._blitzID===s._blitzID);r?(r._clusters=[...r._clusters,...s._clusters].filter((i,n,o)=>o.indexOf(i)===n),r._editURLs=[...r._editURLs,...s._editURLs].filter((i,n,o)=>o.indexOf(i)===n)):e.push(s)}return e}async filterQueuedObjects(t){var r;const e=await A.queue.getJobs(),s=[];for(const i of t)if(!e.find(n=>n.transaction.action===j.Delete&&n.transaction.blitzID===i._blitzID))if(!e.find(n=>n.transaction.action===j.Edit&&n.transaction.blitzID===i._blitzID&&n.status!==I.Completed))s.push(i);else{const n=await((r=this._model)==null?void 0:r.get({blitzID:i._blitzID,raw:!0,forceLocal:!0}));n?s.push(n):s.push(i)}return s}shouldSendHttpRequest(){var e;if(A.options.sync.level!=="cache"||((e=this._model)==null?void 0:e.getName())==="_Model")return!1;const t=k.getListCallLastTimeStamp(this.hash());return t?new Date().getTime()-t>A.options.sync.ttl:!0}hash(){var t,e;return Ge(JSON.stringify({clusters:((t=this._clusters)==null?void 0:t.map(s=>s.name))??[],blitzId:this._get,urls:this._urls,modelName:(e=this._model)==null?void 0:e.getName(),listQuery:this._query,getQuery:this.getQuery}))}}const Xe=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,Yt=a=>{if(typeof a!="string")throw new TypeError("Invalid argument expected string");const t=a.match(Xe);if(!t)throw new Error(`Invalid argument not valid semver ('${a}' received)`);return t.shift(),t},te=a=>a==="*"||a==="x"||a==="X",ee=a=>{const t=parseInt(a,10);return isNaN(t)?a:t},Ye=(a,t)=>typeof a!=typeof t?[String(a),String(t)]:[a,t],ts=(a,t)=>{if(te(a)||te(t))return 0;const[e,s]=Ye(ee(a),ee(t));return e>s?1:e<s?-1:0},se=(a,t)=>{for(let e=0;e<Math.max(a.length,t.length);e++){const s=ts(a[e]||"0",t[e]||"0");if(s!==0)return s}return 0},es=(a,t)=>{const e=Yt(a),s=Yt(t),r=e.pop(),i=s.pop(),n=se(e,s);return n!==0?n:r&&i?se(r.split("."),i.split(".")):r||i?r?-1:1:0},ss=(a,t,e)=>{rs(e);const s=es(a,t);return re[e].includes(s)},re={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},ie=Object.keys(re),rs=a=>{if(typeof a!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof a}`);if(ie.indexOf(a)===-1)throw new Error(`Invalid operator, expected one of ${ie.join("|")}`)},F=class F{static get VERSION(){return"1.1.18"}static async initialize(t){if(this.initialized){console.log("%c⚠️ Warning: Library has already been initialized! Skipping the initialization steps.","background: #FFF3CD; color: #856404; font-weight: bold;"),console.groupCollapsed("%cStack Trace","background: #FFF3CD; color: #856404; font-weight: bold; font-style: italic;"),console.log("Options",t),console.trace(),console.groupEnd();return}this.initialized=!0;const e=Ot.transformBlitzDataOptions(t);this.options=e,e.clusters&&F.setClusters(e.clusters);const s=k.get("version");if((!s||ss(this.VERSION,s,">"))&&(await this.purge(),k.set("version",this.VERSION.toString()),k.setLastSyncedAt(Math.floor(Date.now()/1e3))),await new Dt().ping(),this.queue=await new ve().init(),F._Model=new J({model:void 0,attributes:{_blitzID:new nt("_blitzID","string","_Model"),searchable:new nt("searchable","json",void 0),attributes:new nt("attributes","json",{name:{label:"Name",type:"varchar"},label:{label:"Label",type:"texti18n"},modelpermission:{label:"Model Permission",type:"tinyint"},hasuserpermissions:{label:"Has User Permissions",type:"boolean"},subscriberemails:{label:"Subscriber Emails",type:"text"},haslogs:{label:"Has Logs",type:"boolean"},cache:{label:"Cache",name:"cache",type:"boolean"},hasprojects:{label:"Has Projects",type:"boolean"},attributes:{label:"Attributes",type:"json"},objectpermissionoptions:{label:"Object Permission Options",type:"int"},haspublishingdate:{label:"Has Publishing Date",type:"boolean"}}),_editURLs:new nt("_editURLs","json",[]),haspublishingdate:new Wt("haspublishingdate","boolean",!1)}}),F._Model.setReturnType(J),t&&typeof t!="string"&&!Array.isArray(t)&&t.uiManager&&(this.ui=new t.uiManager(this)),e.sync.level==="full"){const r=st.create();await r.run(),r.runAtInterval(e.sync.interval)}else e.sync.level==="cache"&&await st.create().run(void 0,"delete")}static async purge(){const e=[...(await indexedDB.databases()).filter(s=>{var r;return(r=s.name)==null?void 0:r.startsWith("bdt")}).map(s=>s.name),...k.getDatabases(),"_Model","_Project","db_master",O.name].filter((s,r,i)=>i.findIndex(n=>n===s)===r);for(const s of e)await wt(s);k.clear()}static purgeLocalStorage(){k.clear()}static setClusters(t){t=Ot.transformClusterOptions(t);for(const e of Object.keys(t))F.clusterManager.register(e,t[e])}static async list(t){const e=Et.extractModelName(t);if(!await F._Model.exists(e))throw new Error(`Model "${e}" does not exist.`);return Y.create().model(await F._Model.get(e)).urls([t]).query({}).perform()}static async uploader(t){return await et.upload({baseUrl:F.clusterManager.toArray()[0].getNextReadURL(),image:t})}static async listProjectUsers(t){if(!t)throw new Error("Project ID required!");const e=k.getProjectUsers(t);if(e!==null&&typeof e=="object"){const o=Date.now(),h=864e5;if(o<e.lastSaved+h)return e.users}const s=N.sanitizeBaseUrl(F.clusterManager.toArray()[0].getNextReadURL()),r=new URL(s).origin!==window.location.origin?"?enableCors=1":"",i=await T.create().url(s+`api/listProjectUsers/${t}.json${r}`).get();if(i.error)throw new Error(i.error);if(i.errors instanceof Array&&i.errors.length>0)throw new Error(i.errors.map(o=>o.message||o).join(" | "));const n={lastSaved:Date.now(),users:(i.users||[]).map(o=>({id:o._blitzID,username:o.username}))};return k.setProjectUsers(t,n),n.users}static async getCurrentUser(){const t=k.getCurrentUser();if(t)return t;const e=N.sanitizeBaseUrl(F.clusterManager.toArray()[0].getNextReadURL()),s=new URL(e).origin!==window.location.origin?"?enableCors=1":"",r=await T.create().url(e+"api/ping.json"+s).get();if(r.error)throw new Error(r.error);if(!r.userhash){const h={id:"public",username:"Public"};return k.setCurrentUser(h),h}const i=await J.get("0BAUsers"),n=await(i==null?void 0:i.get({blitzID:r.userhash,raw:!0}));if(!(n!=null&&n.username))throw new Error("Could not get user object!");const o={id:r.userhash,username:n.username};return k.setCurrentUser(o),o}static addEventListener(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}static hasEventListener(t){return this.listeners.has(t)?this.listeners.get(t).length>0:!1}static removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(s=>e!==s))}static dispatchEvent(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(s=>s(e))}};m(F,"clusterManager",new Lt),m(F,"_Model"),m(F,"objects",new Map),m(F,"options"),m(F,"queue"),m(F,"ui"),m(F,"listeners",new Map),m(F,"initialized",!1);let A=F;x.BDCustomObject=jt,x.BDModel=J,x.BDObject=K,x.BlitzData=A,x.DataType=P,x.HttpRequest=T,x.JobStatus=I,x.LocalStorageRepository=k,x.blitzhash=vt,x.blitzstamp=ot,x.sleep=Nt,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
