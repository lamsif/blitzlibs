(function(O,D){typeof exports=="object"&&typeof module<"u"?D(exports):typeof define=="function"&&define.amd?define(["exports"],D):(O=typeof globalThis<"u"?globalThis:O||self,D(O.BlitzData={}))})(this,function(O){"use strict";var Wr=Object.defineProperty;var Jr=(O,D,z)=>D in O?Wr(O,D,{enumerable:!0,configurable:!0,writable:!0,value:z}):O[D]=z;var p=(O,D,z)=>(Jr(O,typeof D!="symbol"?D+"":D,z),z);const Y=class Y{constructor(){p(this,"_method");p(this,"_url");p(this,"_headers",{});p(this,"_body");p(this,"_signal")}static create(){const t=new Y;return Y._globalHeaders&&t.headers(Y._globalHeaders),t}static globalHeaders(t){Y._globalHeaders=t}method(t){return this._method=t,this}url(t){return this._url=t,this}header(t,e){return this._headers[t]=e,this}headers(t){for(const e in t)this.header(e,t[e]);return this}body(t){return this._body=t,this}signal(t){return this._signal=t,this}async send(){const t=await fetch(this._url,{method:this._method,headers:this._headers,body:this._body?this._body instanceof FormData?this._body:JSON.stringify(this._body):void 0,signal:this._signal?this._signal:void 0});if(!t.ok)throw new Error(`HTTP request failed with status code ${t.status}. Status text: ${t.statusText} and response: ${await t.text()}`);return await t.json()}async get(){return await this.method("GET").send()}async post(){return await this.method("POST").send()}};p(Y,"_globalHeaders",{});let D=Y;class z{static createListEndpoint(t,e,r){var a;const n=`${z.sanitizeBaseUrl(t)}api/list/${e}.json`,i=new URLSearchParams;return i.append("fkOptions",JSON.stringify({_userID:"blitzID"})),(a=r.conditions)!=null&&a.length&&i.append("conditions",JSON.stringify(r.conditions)),r.limit&&i.append("limit",r.limit.toString()),r.customSort&&i.append("customSort",r.customSort),r.customSortDirection&&i.append("customSortDirection",r.customSortDirection),r.fks&&i.append("fks",r.fks),r.manyToMany&&i.append("manyToMany",r.manyToMany),`${n}?${i.toString()}`}static createGetEndpoint(t,e,r,n){const i=`${z.sanitizeBaseUrl(t)}api/list/${e}/_blitzID/${r}.json`,a=new URLSearchParams;return a.append("fkOptions",JSON.stringify({_userID:"blitzID"})),n.fks&&a.append("fks",n.fks),n.manyToMany&&a.append("manyToMany",n.manyToMany),`${i}?${a.toString()}`}static createPostEndpoint(t){return`${z.sanitizeBaseUrl(t)}api/post.json`}static createPingEndpoint(t){return`${z.sanitizeBaseUrl(t)}api/ping.json`}static createListLogsEndpoint(t,e,r){const n=e?`${z.sanitizeBaseUrl(t)}api/listLogs/${e}.json`:`${z.sanitizeBaseUrl(t)}api/listLogs.json`,i=new URLSearchParams;return(r==null?void 0:r.from)!==void 0&&i.append("from",r.from.toString()),r!=null&&r.models&&!e&&i.append("models",JSON.stringify(r.models)),`${n}?${i.toString()}`}static createUploaderEndpoint(t){return`${z.sanitizeBaseUrl(t)}uploader/index`}static sanitizeBaseUrl(t){const e=new URL(t);if(!e.origin||!e.pathname||!e.protocol.match(/^https?:$/))throw new Error(`Supplied base URL is invalid: ${t}`);return e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),e.toString()}}class q{static async list(t,e){if(!t.endpoint&&!t.fullUrl)throw new Error("Either baseUrl or fullUrl must be provided.");const r=await D.create().url(t.fullUrl?t.fullUrl:z.createListEndpoint(t.endpoint.baseUrl,t.endpoint.modelName,t.endpoint.query)).signal(e).get();if(!Array.isArray(r.items)&&Array.isArray(r.errors))throw new Error(r.errors.map(n=>(n==null?void 0:n.message)??n).join(" | "));return r.items??[]}static async get(t,e){const r=await D.create().url(z.createGetEndpoint(t.baseUrl,t.modelName,t.blitzID,t.query)).signal(e).get();if(!Array.isArray(r.items)&&Array.isArray(r.errors))throw new Error(r.errors.map(n=>(n==null?void 0:n.message)??n).join(" | "));return r.items??[]}static async post(t){const e=await D.create().url(z.createPostEndpoint(t.baseUrl)).body(t.transactions).post();if((typeof e.error=="string"||e.errors instanceof Array)&&!(e.results instanceof Object))throw new Error(e.error??e.errors.join(" | "));return e}static async listLogs(t){const e=await D.create().url(z.createListLogsEndpoint(t.baseUrl,t.model,t.query)).get();if(typeof e.error=="string"||e.errors instanceof Array)throw new Error(e.error??e.errors.map(r=>(r==null?void 0:r.message)??r).join(" | "));return{transactions:e.transactions,userID:e.userID,userhash:e.userhash,lastTimestamp:e.lastTimestamp}}static upload(t){const e=new FormData;return e.append("image",t.image),D.create().url(z.createUploaderEndpoint(t.baseUrl)).body(e).header("Accept","application/json").post()}static async ping({baseUrl:t}){return await D.create().url(z.createPingEndpoint(t)).get()}}function ze(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Ht={};/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */(function(s){(function(t){t(typeof DO_NOT_EXPORT_CRC>"u"?s:{})})(function(t){t.version="1.2.2";function e(){for(var b=0,P=new Array(256),m=0;m!=256;++m)b=m,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,b=b&1?-306674912^b>>>1:b>>>1,P[m]=b;return typeof Int32Array<"u"?new Int32Array(P):P}var r=e();function n(b){var P=0,m=0,S=0,A=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(S=0;S!=256;++S)A[S]=b[S];for(S=0;S!=256;++S)for(m=b[S],P=256+S;P<4096;P+=256)m=A[P]=m>>>8^b[m&255];var x=[];for(S=1;S!=16;++S)x[S-1]=typeof Int32Array<"u"?A.subarray(S*256,S*256+256):A.slice(S*256,S*256+256);return x}var i=n(r),a=i[0],o=i[1],d=i[2],l=i[3],c=i[4],u=i[5],h=i[6],f=i[7],y=i[8],g=i[9],w=i[10],v=i[11],Z=i[12],j=i[13],T=i[14];function M(b,P){for(var m=P^-1,S=0,A=b.length;S<A;)m=m>>>8^r[(m^b.charCodeAt(S++))&255];return~m}function V(b,P){for(var m=P^-1,S=b.length-15,A=0;A<S;)m=T[b[A++]^m&255]^j[b[A++]^m>>8&255]^Z[b[A++]^m>>16&255]^v[b[A++]^m>>>24]^w[b[A++]]^g[b[A++]]^y[b[A++]]^f[b[A++]]^h[b[A++]]^u[b[A++]]^c[b[A++]]^l[b[A++]]^d[b[A++]]^o[b[A++]]^a[b[A++]]^r[b[A++]];for(S+=15;A<S;)m=m>>>8^r[(m^b[A++])&255];return~m}function tt(b,P){for(var m=P^-1,S=0,A=b.length,x=0,$t=0;S<A;)x=b.charCodeAt(S++),x<128?m=m>>>8^r[(m^x)&255]:x<2048?(m=m>>>8^r[(m^(192|x>>6&31))&255],m=m>>>8^r[(m^(128|x&63))&255]):x>=55296&&x<57344?(x=(x&1023)+64,$t=b.charCodeAt(S++)&1023,m=m>>>8^r[(m^(240|x>>8&7))&255],m=m>>>8^r[(m^(128|x>>2&63))&255],m=m>>>8^r[(m^(128|$t>>6&15|(x&3)<<4))&255],m=m>>>8^r[(m^(128|$t&63))&255]):(m=m>>>8^r[(m^(224|x>>12&15))&255],m=m>>>8^r[(m^(128|x>>6&63))&255],m=m>>>8^r[(m^(128|x&63))&255]);return~m}t.table=r,t.bstr=M,t.buf=V,t.str=tt})})(Ht);function ot(){return Math.floor((new Date().getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3)}function yt(s){return ot().toString(36)+"-"+Ht.str(JSON.stringify(s)).toString(36)}function wt(s){return new Promise(t=>{setTimeout(t,s)})}class Te{constructor(t,e){p(this,"name");p(this,"options");p(this,"cursors",{readURL:0});p(this,"healthyUrls");this.name=t,this.options=e,this.healthyUrls=e}getNextHealthyReadURL(){this.cursors.readURL>=this.healthyUrls.readURL.length&&(this.cursors.readURL=0);const t=this.healthyUrls.readURL[this.cursors.readURL];return this.cursors.readURL++,t}async healthcheck(){Promise.all([this.healthcheckAddUrls(),this.healthcheckReadUrls()])}async healthcheckAddUrls(){if(!window.navigator.onLine){this.healthyUrls.addURL=[];return}const t=[];for(const e of this.options.addURL)try{const r=await q.ping({baseUrl:e});if(r.mysql&&r.php){t.push(e);continue}}catch{}this.healthyUrls.addURL=t}async healthcheckReadUrls(){const t=[];for(const e of this.options.readURL)try{const r=await q.ping({baseUrl:e});if(r.mysql&&r.php){t.push(e);continue}}catch{}this.healthyUrls.readURL.filter(e=>!t.includes(e)).length!==0&&(this.cursors.readURL=0),this.healthyUrls.readURL=t}}class Bt{constructor(){p(this,"clusters",{});this.healthcheck()}register(t,e){this.clusters[t]=new Te(t,e)}get(t){if(!Array.isArray(t)){if(this.clusters[t]===void 0)throw new Error(`cluster "${t}" not found.`);return this.clusters[t]}const e={};for(const r of t)e[r]=this.get(r);return e}names(){return Object.keys(this.clusters)}all(){return this.clusters}toArray(){return Object.values(this.clusters)}random(){const t=this.names(),e=t[Math.floor(Math.random()*t.length)];return this.get(e)}async healthcheck(){var t;for(;;)await Promise.all(Object.values(this.clusters).map(e=>e.healthcheck())),await wt(((t=_.options)==null?void 0:t.pingInterval)??6e4)}}const Oe=(s,t)=>t.some(e=>s instanceof e);let Vt,Qt;function Ee(){return Vt||(Vt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function xe(){return Qt||(Qt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Kt=new WeakMap,_t=new WeakMap,Zt=new WeakMap,vt=new WeakMap,St=new WeakMap;function Ue(s){const t=new Promise((e,r)=>{const n=()=>{s.removeEventListener("success",i),s.removeEventListener("error",a)},i=()=>{e(Q(s.result)),n()},a=()=>{r(s.error),n()};s.addEventListener("success",i),s.addEventListener("error",a)});return t.then(e=>{e instanceof IDBCursor&&Kt.set(e,s)}).catch(()=>{}),St.set(t,s),t}function je(s){if(_t.has(s))return;const t=new Promise((e,r)=>{const n=()=>{s.removeEventListener("complete",i),s.removeEventListener("error",a),s.removeEventListener("abort",a)},i=()=>{e(),n()},a=()=>{r(s.error||new DOMException("AbortError","AbortError")),n()};s.addEventListener("complete",i),s.addEventListener("error",a),s.addEventListener("abort",a)});_t.set(s,t)}let At={get(s,t,e){if(s instanceof IDBTransaction){if(t==="done")return _t.get(s);if(t==="objectStoreNames")return s.objectStoreNames||Zt.get(s);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Q(s[t])},set(s,t,e){return s[t]=e,!0},has(s,t){return s instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in s}};function Le(s){At=s(At)}function Ce(s){return s===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const r=s.call(Dt(this),t,...e);return Zt.set(r,t.sort?t.sort():[t]),Q(r)}:xe().includes(s)?function(...t){return s.apply(Dt(this),t),Q(Kt.get(this))}:function(...t){return Q(s.apply(Dt(this),t))}}function Me(s){return typeof s=="function"?Ce(s):(s instanceof IDBTransaction&&je(s),Oe(s,Ee())?new Proxy(s,At):s)}function Q(s){if(s instanceof IDBRequest)return Ue(s);if(vt.has(s))return vt.get(s);const t=Me(s);return t!==s&&(vt.set(s,t),St.set(t,s)),t}const Dt=s=>St.get(s);function It(s,t,{blocked:e,upgrade:r,blocking:n,terminated:i}={}){const a=indexedDB.open(s,t),o=Q(a);return r&&a.addEventListener("upgradeneeded",d=>{r(Q(a.result),d.oldVersion,d.newVersion,Q(a.transaction),d)}),e&&a.addEventListener("blocked",d=>e(d.oldVersion,d.newVersion,d)),o.then(d=>{i&&d.addEventListener("close",()=>i()),n&&d.addEventListener("versionchange",l=>n(l.oldVersion,l.newVersion,l))}).catch(()=>{}),o}function zt(s,{blocked:t}={}){const e=indexedDB.deleteDatabase(s);return t&&e.addEventListener("blocked",r=>t(r.oldVersion,r)),Q(e).then(()=>{})}const ke=["get","getKey","getAll","getAllKeys","count"],Fe=["put","add","delete","clear"],Tt=new Map;function qt(s,t){if(!(s instanceof IDBDatabase&&!(t in s)&&typeof t=="string"))return;if(Tt.get(t))return Tt.get(t);const e=t.replace(/FromIndex$/,""),r=t!==e,n=Fe.includes(e);if(!(e in(r?IDBIndex:IDBObjectStore).prototype)||!(n||ke.includes(e)))return;const i=async function(a,...o){const d=this.transaction(a,n?"readwrite":"readonly");let l=d.store;return r&&(l=l.index(o.shift())),(await Promise.all([l[e](...o),n&&d.done]))[0]};return Tt.set(t,i),i}Le(s=>({...s,get:(t,e,r)=>qt(t,e)||s.get(t,e,r),has:(t,e)=>!!qt(t,e)||s.has(t,e)}));const I={name:"bd-queue",store:"jobs",timeIndex:"time",objectIndex:"object"};var F=(s=>(s.Pending="pending",s.Completed="completed",s.Failed="failed",s.Conflict="conflict",s))(F||{}),G=(s=>(s.Success="success",s.Exception="exception",s.Failed="failed",s.Conflict="conflict",s))(G||{}),W=(s=>(s.Add="add",s.Edit="edit",s.Delete="delete",s))(W||{}),$="SharedWorker"in globalThis,Pe=class{constructor(s){p(this,"ActualWorker");this.ActualWorker=s}get onmessage(){var s;return $?(s=this.ActualWorker)==null?void 0:s.port.onmessage:this.ActualWorker.onmessage}set onmessage(s){$?this.ActualWorker.port.onmessage=s:this.ActualWorker.onmessage=s}get onmessageerror(){var s;return $?(s=this.ActualWorker)==null?void 0:s.port.onmessageerror:this.ActualWorker.onmessageerror}set onmessageerror(s){$?this.ActualWorker.port.onmessageerror=s:this.ActualWorker.onmessageerror=s}start(){var s;if($)return(s=this.ActualWorker)==null?void 0:s.port.start()}postMessage(s,t){var e;return $?(e=this.ActualWorker)==null?void 0:e.port.postMessage(s,t):this.ActualWorker.postMessage(s,t)}terminate(){var s;return $?(s=this.ActualWorker)==null?void 0:s.port.close():this.ActualWorker.terminate()}close(){return this.terminate()}get port(){return $?this.ActualWorker.port:this.ActualWorker}get onerror(){return this.ActualWorker.onerror}set onerror(s){this.ActualWorker.onerror=s}addEventListener(s,t,e){var r;return $&&s!=="error"?(r=this.ActualWorker)==null?void 0:r.port.addEventListener(s,t,e):this.ActualWorker.addEventListener(s,t,e)}removeEventListener(s,t,e){var r;return $&&s!=="error"?(r=this.ActualWorker)==null?void 0:r.port.removeEventListener(s,t,e):this.ActualWorker.removeEventListener(s,t,e)}dispatchEvent(s){return this.ActualWorker.dispatchEvent(s)}},Re=class extends Pe{constructor(s,t){let e;$?e=new SharedWorker(s,t):e=new Worker(s,t),super(e)}},Ot=function(s,t){return Ot=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])},Ot(s,t)};function et(s,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Ot(s,t);function e(){this.constructor=s}s.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}function Et(s){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&s[t],r=0;if(e)return e.call(s);if(s&&typeof s.length=="number")return{next:function(){return s&&r>=s.length&&(s=void 0),{value:s&&s[r++],done:!s}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function ct(s,t){var e=typeof Symbol=="function"&&s[Symbol.iterator];if(!e)return s;var r=e.call(s),n,i=[],a;try{for(;(t===void 0||t-- >0)&&!(n=r.next()).done;)i.push(n.value)}catch(o){a={error:o}}finally{try{n&&!n.done&&(e=r.return)&&e.call(r)}finally{if(a)throw a.error}}return i}function lt(s,t,e){if(e||arguments.length===2)for(var r=0,n=t.length,i;r<n;r++)(i||!(r in t))&&(i||(i=Array.prototype.slice.call(t,0,r)),i[r]=t[r]);return s.concat(i||Array.prototype.slice.call(t))}typeof SuppressedError=="function"&&SuppressedError;function H(s){return typeof s=="function"}function Gt(s){var t=function(r){Error.call(r),r.stack=new Error().stack},e=s(t);return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e,e}var xt=Gt(function(s){return function(e){s(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(r,n){return n+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function Ut(s,t){if(s){var e=s.indexOf(t);0<=e&&s.splice(e,1)}}var ut=function(){function s(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return s.prototype.unsubscribe=function(){var t,e,r,n,i;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var o=Et(a),d=o.next();!d.done;d=o.next()){var l=d.value;l.remove(this)}}catch(g){t={error:g}}finally{try{d&&!d.done&&(e=o.return)&&e.call(o)}finally{if(t)throw t.error}}else a.remove(this);var c=this.initialTeardown;if(H(c))try{c()}catch(g){i=g instanceof xt?g.errors:[g]}var u=this._finalizers;if(u){this._finalizers=null;try{for(var h=Et(u),f=h.next();!f.done;f=h.next()){var y=f.value;try{te(y)}catch(g){i=i??[],g instanceof xt?i=lt(lt([],ct(i)),ct(g.errors)):i.push(g)}}}catch(g){r={error:g}}finally{try{f&&!f.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}}if(i)throw new xt(i)}},s.prototype.add=function(t){var e;if(t&&t!==this)if(this.closed)te(t);else{if(t instanceof s){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(e=this._finalizers)!==null&&e!==void 0?e:[]).push(t)}},s.prototype._hasParent=function(t){var e=this._parentage;return e===t||Array.isArray(e)&&e.includes(t)},s.prototype._addParent=function(t){var e=this._parentage;this._parentage=Array.isArray(e)?(e.push(t),e):e?[e,t]:t},s.prototype._removeParent=function(t){var e=this._parentage;e===t?this._parentage=null:Array.isArray(e)&&Ut(e,t)},s.prototype.remove=function(t){var e=this._finalizers;e&&Ut(e,t),t instanceof s&&t._removeParent(this)},s.EMPTY=function(){var t=new s;return t.closed=!0,t}(),s}(),Yt=ut.EMPTY;function Xt(s){return s instanceof ut||s&&"closed"in s&&H(s.remove)&&H(s.add)&&H(s.unsubscribe)}function te(s){H(s)?s():s.unsubscribe()}var ee={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},jt={setTimeout:function(s,t){for(var e=[],r=2;r<arguments.length;r++)e[r-2]=arguments[r];var n=jt.delegate;return n!=null&&n.setTimeout?n.setTimeout.apply(n,lt([s,t],ct(e))):setTimeout.apply(void 0,lt([s,t],ct(e)))},clearTimeout:function(s){var t=jt.delegate;return((t==null?void 0:t.clearTimeout)||clearTimeout)(s)},delegate:void 0};function Ne(s){jt.setTimeout(function(){throw s})}function re(){}function ht(s){s()}var Lt=function(s){et(t,s);function t(e){var r=s.call(this)||this;return r.isStopped=!1,e?(r.destination=e,Xt(e)&&e.add(r)):r.destination=He,r}return t.create=function(e,r,n){return new Mt(e,r,n)},t.prototype.next=function(e){this.isStopped||this._next(e)},t.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,s.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(e){this.destination.next(e)},t.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(ut),We=Function.prototype.bind;function Ct(s,t){return We.call(s,t)}var Je=function(){function s(t){this.partialObserver=t}return s.prototype.next=function(t){var e=this.partialObserver;if(e.next)try{e.next(t)}catch(r){dt(r)}},s.prototype.error=function(t){var e=this.partialObserver;if(e.error)try{e.error(t)}catch(r){dt(r)}else dt(t)},s.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(e){dt(e)}},s}(),Mt=function(s){et(t,s);function t(e,r,n){var i=s.call(this)||this,a;if(H(e)||!e)a={next:e??void 0,error:r??void 0,complete:n??void 0};else{var o;i&&ee.useDeprecatedNextContext?(o=Object.create(e),o.unsubscribe=function(){return i.unsubscribe()},a={next:e.next&&Ct(e.next,o),error:e.error&&Ct(e.error,o),complete:e.complete&&Ct(e.complete,o)}):a=e}return i.destination=new Je(a),i}return t}(Lt);function dt(s){Ne(s)}function $e(s){throw s}var He={closed:!0,next:re,error:$e,complete:re},Be=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function Ve(s){return s}function Qe(s){return s.length===0?Ve:s.length===1?s[0]:function(e){return s.reduce(function(r,n){return n(r)},e)}}var kt=function(){function s(t){t&&(this._subscribe=t)}return s.prototype.lift=function(t){var e=new s;return e.source=this,e.operator=t,e},s.prototype.subscribe=function(t,e,r){var n=this,i=Ze(t)?t:new Mt(t,e,r);return ht(function(){var a=n,o=a.operator,d=a.source;i.add(o?o.call(i,d):d?n._subscribe(i):n._trySubscribe(i))}),i},s.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},s.prototype.forEach=function(t,e){var r=this;return e=se(e),new e(function(n,i){var a=new Mt({next:function(o){try{t(o)}catch(d){i(d),a.unsubscribe()}},error:i,complete:n});r.subscribe(a)})},s.prototype._subscribe=function(t){var e;return(e=this.source)===null||e===void 0?void 0:e.subscribe(t)},s.prototype[Be]=function(){return this},s.prototype.pipe=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Qe(t)(this)},s.prototype.toPromise=function(t){var e=this;return t=se(t),new t(function(r,n){var i;e.subscribe(function(a){return i=a},function(a){return n(a)},function(){return r(i)})})},s.create=function(t){return new s(t)},s}();function se(s){var t;return(t=s??ee.Promise)!==null&&t!==void 0?t:Promise}function Ke(s){return s&&H(s.next)&&H(s.error)&&H(s.complete)}function Ze(s){return s&&s instanceof Lt||Ke(s)&&Xt(s)}function qe(s){return H(s==null?void 0:s.lift)}function Ge(s){return function(t){if(qe(t))return t.lift(function(e){try{return s(e,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}function Ye(s,t,e,r,n){return new Xe(s,t,e,r,n)}var Xe=function(s){et(t,s);function t(e,r,n,i,a,o){var d=s.call(this,e)||this;return d.onFinalize=a,d.shouldUnsubscribe=o,d._next=r?function(l){try{r(l)}catch(c){e.error(c)}}:s.prototype._next,d._error=i?function(l){try{i(l)}catch(c){e.error(c)}finally{this.unsubscribe()}}:s.prototype._error,d._complete=n?function(){try{n()}catch(l){e.error(l)}finally{this.unsubscribe()}}:s.prototype._complete,d}return t.prototype.unsubscribe=function(){var e;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;s.prototype.unsubscribe.call(this),!r&&((e=this.onFinalize)===null||e===void 0||e.call(this))}},t}(Lt),tr=Gt(function(s){return function(){s(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),ne=function(s){et(t,s);function t(){var e=s.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}return t.prototype.lift=function(e){var r=new ie(this,this);return r.operator=e,r},t.prototype._throwIfClosed=function(){if(this.closed)throw new tr},t.prototype.next=function(e){var r=this;ht(function(){var n,i;if(r._throwIfClosed(),!r.isStopped){r.currentObservers||(r.currentObservers=Array.from(r.observers));try{for(var a=Et(r.currentObservers),o=a.next();!o.done;o=a.next()){var d=o.value;d.next(e)}}catch(l){n={error:l}}finally{try{o&&!o.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}}})},t.prototype.error=function(e){var r=this;ht(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=e;for(var n=r.observers;n.length;)n.shift().error(e)}})},t.prototype.complete=function(){var e=this;ht(function(){if(e._throwIfClosed(),!e.isStopped){e.isStopped=!0;for(var r=e.observers;r.length;)r.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var e;return((e=this.observers)===null||e===void 0?void 0:e.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(e){return this._throwIfClosed(),s.prototype._trySubscribe.call(this,e)},t.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},t.prototype._innerSubscribe=function(e){var r=this,n=this,i=n.hasError,a=n.isStopped,o=n.observers;return i||a?Yt:(this.currentObservers=null,o.push(e),new ut(function(){r.currentObservers=null,Ut(o,e)}))},t.prototype._checkFinalizedStatuses=function(e){var r=this,n=r.hasError,i=r.thrownError,a=r.isStopped;n?e.error(i):a&&e.complete()},t.prototype.asObservable=function(){var e=new kt;return e.source=this,e},t.create=function(e,r){return new ie(e,r)},t}(kt),ie=function(s){et(t,s);function t(e,r){var n=s.call(this)||this;return n.destination=e,n.source=r,n}return t.prototype.next=function(e){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.next)===null||n===void 0||n.call(r,e)},t.prototype.error=function(e){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.error)===null||n===void 0||n.call(r,e)},t.prototype.complete=function(){var e,r;(r=(e=this.destination)===null||e===void 0?void 0:e.complete)===null||r===void 0||r.call(e)},t.prototype._subscribe=function(e){var r,n;return(n=(r=this.source)===null||r===void 0?void 0:r.subscribe(e))!==null&&n!==void 0?n:Yt},t}(ne);function er(s,t){return Ge(function(e,r){var n=0;e.subscribe(Ye(r,function(i){return s.call(t,i,n++)&&r.next(i)}))})}class R{constructor(t){p(this,"action");p(this,"blitzstamp");p(this,"hash");p(this,"hashAlgo");p(this,"blitzID");p(this,"userhash");p(this,"model");p(this,"data");var e;this.action=t.action,this.blitzstamp=t.blitzstamp??ot(),this.hash=t.hash??yt(t.data===void 0?{blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}:{...t.data,blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}),this.hashAlgo=t.hashAlgo??"b-crc32",this.blitzID=t.blitzID??((e=t.data)==null?void 0:e._blitzID)??this.hash,this.model=t.model,this.data=t.data??{},this.userhash=t.userhash}toObject(){return{action:this.action,blitzstamp:this.blitzstamp,hash:this.hash,hashAlgo:this.hashAlgo,blitzID:this.blitzID,model:this.model,data:this.data,userhash:this.userhash}}clone(){return new R({action:this.action,model:this.model,blitzID:this.blitzID,blitzstamp:this.blitzstamp,data:this.data,hash:this.hash,hashAlgo:this.hashAlgo,userhash:this.userhash})}static fromObject(t){var e;return new R({action:t.action,blitzstamp:t.blitzstamp,hash:t.hash,hashAlgo:t.hashAlgo,blitzID:t.blitzID??((e=t.data)==null?void 0:e._blitzID)??t.blitzID,model:t.model,data:t.data,userhash:t.userhash})}}var k=(s=>(s.Success="success",s.Notice="notice",s.Error="error",s.Exception="exception",s))(k||{});class N{constructor(t,e,r,n=null,i){p(this,"blitzID");p(this,"hash");p(this,"message");p(this,"conflict");p(this,"replicaUrl",null);p(this,"status");this.blitzID=t,this.hash=e,this.status=r,this.message=n,this.conflict=i}setReplicaUrl(t){this.replicaUrl=t}isConflict(){return typeof this.conflict<"u"&&this.conflict!==null}}class ft extends Array{get(t){return this.find(e=>e.hash===t)}has(t){return this.some(e=>e.hash===t)}isSuccessful(t){var e;if(t){const r=(e=this.get(t))==null?void 0:e.status;return r?r==="success"||r==="notice":!1}return this.every(r=>r.status)}isFailed(t){var e;if(t){const r=(e=this.get(t))==null?void 0:e.status;return r?r==="error":!0}return this.every(r=>!r.status)}successful(){return new ft(...this.filter(t=>t.status))}failed(){return new ft(...this.filter(t=>!t.status))}}class pt{constructor(){p(this,"_query",{});p(this,"_model")}static create(){return new pt}query(t){return this._query=t,this}model(t){return this._model=t,this}async perform(){const t=_.clusterManager.toArray().map(n=>n.getNextHealthyReadURL()),e=await Promise.all(t.map(async n=>await q.listLogs({baseUrl:n,model:this._model,query:this._query})));return{transactions:[].concat(...e.map(n=>n.transactions)).filter((n,i,a)=>i===a.findIndex(o=>o.hash===n.hash)).filter(n=>typeof n=="object"&&!Array.isArray(n)),userID:e[0].userID,userhash:e[0].userhash,lastTimestamp:e[0].lastTimestamp}}}class Ft{constructor(){this.ping()}async ping(){const t=await this.openConnection(),e=["sync_transactions","evaluated_transactions"];for(const r of e)if(!t.objectStoreNames.contains(r))return t.close(),console.log(`There's missing stores, recreating the database. Available stores: ${t.objectStoreNames}`),await zt("db_master"),await this.ping()}async openConnection(){return await It("db_master",1,{upgrade:(t,e,r,n,i)=>{r===1&&(t.createObjectStore("sync_transactions",{autoIncrement:!1,keyPath:"hash"}),t.createObjectStore("evaluated_transactions",{autoIncrement:!1,keyPath:"hash"}))}})}}class E{static getKey(t){return`BlitzData.${t}`}static get(t){return localStorage.getItem(this.getKey(t))}static set(t,e){localStorage.setItem(this.getKey(t),e)}static has(t){return Object.hasOwn(localStorage,this.getKey(t))}static remove(t){localStorage.removeItem(this.getKey(t))}static clear(){const t=Object.keys(localStorage);for(const e of t)e.startsWith("BlitzData.")&&localStorage.removeItem(e)}static getLastSyncedAt(t){const e=this.get(t?`${t}.lastSyncedAt`:"lastSyncedAt");return e?parseInt(e,10):null}static setLastSyncedAt(t,e){this.set(e?`${e}.lastSyncedAt`:"lastSyncedAt",String(t))}static getLastSyncedUserID(){return this.get("lastSyncedUserID")}static setLastSyncedUserID(t){this.set("lastSyncedUserID",t)}static getCurrentUser(){const t=this.get("currentUser");return t?JSON.parse(t):null}static setCurrentUser(t){t?this.set("currentUser",JSON.stringify(t)):this.remove("currentUser")}static getDatabases(){return JSON.parse(this.get("databases")??"[]")}static setDatabases(t){this.set("databases",JSON.stringify(t))}static getListCallLastTimeStamp(t){const e=this.get(`cache.listCall.${t}.lastTimeStamp`);return e?Number(e):null}static setListCallLastTimeStamp(t,e){this.set(`cache.listCall.${t}.lastTimeStamp`,String(e))}}class rt{constructor(){p(this,"client",new Ft)}static create(){return new rt}async all(){const t=await this.client.openConnection(),e=await t.getAll("sync_transactions");return t.close(),e}async put(t){const e=await this.client.openConnection();await e.put("sync_transactions",t),e.close()}async putMultiple(t){for(const e of t)await this.put(e)}async delete(t){const e=await this.client.openConnection();await e.delete("sync_transactions",t),e.close()}}class bt{static create(){return new bt}constructor(){}async run(){if(!navigator.onLine)return;const t=_.options.sync.startDate instanceof Date?Math.floor(_.options.sync.startDate.getTime()/1e3):0,e=E.getLastSyncedAt()??t,{transactions:r,userhash:n,lastTimestamp:i}=await pt.create().query({from:e,models:_.options.sync.models??["_Project",...(await C.list()).map(o=>o.getName()).filter(o=>o.startsWith("bdt")&&!["bdt24prszej_appfiles","bdt24prszej_apps"].includes(o))]}).perform(),a=rt.create();await a.putMultiple(r),E.setLastSyncedAt(i??Date.now()/1e3),n&&E.setLastSyncedUserID(n),await J.create().run((await a.all()).map(o=>R.fromObject(o))),e!==i&&await this.run()}async runAtInterval(t){for(;;)await wt(t),await this.run()}async syncModel(t){if(!navigator.onLine)return;const e=_.options.sync.startDate instanceof Date&&t!=="_Model"?Math.floor(_.options.sync.startDate.getTime()/1e3):0,r=E.getLastSyncedAt(t)??e,{transactions:n,userhash:i,lastTimestamp:a}=await pt.create().query({from:r,models:[t]}).perform(),o=rt.create();await o.putMultiple(n),E.setLastSyncedAt(a??Date.now()/1e3,t),i&&E.setLastSyncedUserID(i),await J.create().run((await o.all()).map(d=>R.fromObject(d))),r!==a&&await this.syncModel(t)}}const it=class it{static create(){return new it}async run(t){const e=new ft,r={add:1,edit:2,delete:3},n=await new Ft().openConnection();t=t.sort((i,a)=>r[i.action]-r[a.action]);for(const i of t){let a;i.model==="@Model"?i.model="_Model":i.model==="@Project"&&(i.model="_Project");try{if(i.action==="add")a=await this.processAddTransaction(i);else if(i.action==="edit")a=await this.processEditTransaction(i,n);else if(i.action==="delete")a=await this.processDeleteTransaction(i);else throw new Error(`Unknown action "${i.action}" on transaction ${i.hash}`);await n.put("evaluated_transactions",i.toObject())}catch(o){a=new N(i.blitzID,i.hash,k.Error,o.message)}e.push(a),await rt.create().delete(i.hash)}return it.transactionChannel.next({transactions:t,results:e}),n.close(),e}async processAddTransaction(t){const e=await _._Model.get(t.model),r=e.idbClient();if(await r.find(t.hash))return new N(t.hash,t.hash,k.Error,`Object with ${t.hash} already exists on ${t.model} model.`);const n=(await C.get(t.model)).getClusterManager(),i={_blitzID:t.hash,_blitzstamp:t.blitzstamp.toString(),_sort:t.blitzstamp.toString(),_clusters:n.names(),_editURLs:n.toArray().map(a=>a.options.addURL).flat(),...(()=>{const a={};for(const[o,d]of Object.entries(t.data)){const l=e.getAttributeDetails(o);if(l&&Array.isArray(l.type)){const c=o.endsWith("_mtm"),u=typeof d=="string"?JSON.parse(d):d;c?a[o]=u.map((h,f)=>({_blitzID:typeof h=="string"?h:h._blitzID,_mtmSort:typeof h=="string"?(u.length-f)*10:h._mtmSort})):a[o]=u}else a[o]=d}return a})()};if(e.getAttribute("haspublishingdate").value&&typeof t.data._publishingdate>"u"&&typeof t.blitzstamp=="number"){const a=new Date;a.setTime(t.blitzstamp*1e3+new Date("2021-01-01T00:00:00Z").getTime()),a.setMinutes(a.getMinutes()-a.getTimezoneOffset()),i._publishingdate=a.toISOString().slice(0,19).replace("T"," ")}return!i._userID&&t.userhash&&(i._userID=t.userhash),t.data=i,await r.create(i),new N(t.hash,t.hash,k.Success)}async processEditTransaction(t,e){var l,c,u,h;const r=await _._Model.get(t.model),n=r.idbClient(),i=Object.keys(t.data);if(i.length!==1)return new N(t.blitzID,t.hash,k.Error,i.length<1?"Can not edit more than one attribute at once.":"Attribute not provided to perform edit.");if(await e.get("evaluated_transactions",t.hash))return new N(t.blitzID,t.hash,k.Error,`Transaction ${t.hash} already processed.`);const a=await n.find(t.blitzID);if(!a)return new N(t.blitzID,t.hash,k.Error,`Object with ${t.blitzID} does not exists.`);if(a._savetimestamp&&a._savetimestamp>t.blitzstamp)return new N(t.blitzID,t.hash,k.Notice,"Old transaction.");const o=i.shift(),d=(u=(c=(l=r.getAttribute("attributes"))==null?void 0:l.value)==null?void 0:c[o])==null?void 0:u.type;if(Array.isArray(d))if(Object.hasOwn(t.data[o],"add")){a[o]=a[o]??[];const f=t.data[o].add;o.endsWith("_mtm")?a[o].push({_blitzID:typeof f=="string"?f:f._blitzID,_mtmSort:typeof f=="string"?a[o].length?Math.max(...a[o].map(g=>g._mtmSort))+15:15:f._mtmSort}):a[o].push(f)}else if(Object.hasOwn(t.data[o],"remove")){const f=t.data[o].remove;if(!Array.isArray(f))a[o].splice((h=a[o])==null?void 0:h.findIndex(y=>y._blitzID===f),1);else{const[y,g]=f;if(a[o][y]!==g)return new N(t.blitzID,t.hash,k.Error,`Conflict while removing item from array at index ${y}.`);a[o].splice(y,1)}}else return new N(t.blitzID,t.hash,k.Error,`Invalid operation for array attribute ${o}.`);else{const f=t.data[o];if(a[o]===f.new)return new N(t.blitzID,t.hash,k.Notice,"Conflict");a[o]=f.new}return await n.update(a),r.objects.has(a._blitzID)&&r.objects.get(a._blitzID).dispatchEvent("edit",{attribute:o,prev:t.data[o].prev,new:t.data[o].new}),new N(t.blitzID,t.hash,k.Success)}async processDeleteTransaction(t){const e=await _._Model.get(t.model),r=e.idbClient();return await r.find(t.blitzID)?(await r.delete(t.blitzID),e.objects.has(t.blitzID)&&e.objects.get(t.blitzID).dispatchEvent("delete",null),new N(t.blitzID,t.hash,k.Success)):new N(t.blitzID,t.hash,k.Error,`Object with ${t.blitzID} does not exists.`)}};p(it,"transactionChannel",new ne);let J=it;class rr{constructor(t){p(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(I.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(I.store,t.id))}async _getCompletedReplicatedJobs(t){var i;const e=[],r=(i=this._db)==null?void 0:i.transaction(I.store,"readonly").store;let n=await(r==null?void 0:r.openCursor(null,"next"));for(;n;)n.value.status===F.Completed&&n.value.url!==t.url&&n.value.transaction.action===W.Edit&&n.value.transaction.blitzID===t.transaction.blitzID&&n.value.transaction.hash===t.transaction.hash&&e.push(n.value),n=await n.continue();return e}async _getFutureJobs(t,e){var o;const r=[],n=(o=this._db)==null?void 0:o.transaction(I.store,"readonly").store,i=IDBKeyRange.lowerBound(t.createdAt,!0);let a=await(n==null?void 0:n.index(I.timeIndex).openCursor(i,"next"));for(;a;)a.value.status===F.Conflict&&a.value.url===t.url&&a.value.transaction.action===W.Edit&&a.value.transaction.blitzID===t.transaction.blitzID&&Object.keys(a.value.transaction.data)[0]===e&&r.push(a.value),a=await a.continue();return r}async _mergeWithFutureEditJobs(t,e){var i,a;const r=await this._getFutureJobs(t,e);let n=t;if(r.length>0){const o=r[r.length-1];if(o&&((i=o.transaction.data)!=null&&i[e].new)){n=await this._updateJob({...t,transaction:{...t.transaction,data:{[e]:{prev:(a=t.transaction.data)==null?void 0:a[e].prev,new:o.transaction.data[e].new}}}});for(const d of r)await this._deleteJob(d)}}return n}async prompt(t){var i;const e=Object.keys(t.transaction.data)[0];let r=await this._mergeWithFutureEditJobs(t,e);const n=`There was a conflict.
The data got changed to "${r.message}".
Do you still want to perform your change to "${(i=r.transaction.data)==null?void 0:i[e].new}"?`;confirm(n)?r=await this.force(r):await this.revert(r),_.dispatchEvent("queue:conflict",r)}async force(t){var i;const e=Object.keys(t.transaction.data)[0],r=await this._getFutureJobs(t,e),n=await this._updateJob({...t,status:F.Pending,transaction:{...t.transaction,data:{[e]:{prev:t.message,new:(i=t.transaction.data)==null?void 0:i[e].new}}}});for(const a of r)await this._updateJob({...a,status:F.Pending});return n}async revert(t){var a;const e=Object.keys(t.transaction.data)[0],r=new R({action:"edit",model:t.transaction.model,blitzID:t.transaction.blitzID,data:{[e]:{prev:(a=t.transaction.data)==null?void 0:a[e].new,new:t.message}}});await J.create().run([r]);const n=await this._getFutureJobs(t,e),i=await this._getCompletedReplicatedJobs(t);for(const o of[t,...n])await this._deleteJob(o);if(i.length>0){const o=i.map(d=>d.url).filter((d,l,c)=>c.findIndex(u=>u===d)===l);for(const d of o)await _.queue.addJob(d,r.toObject())}}}class sr{constructor(t){p(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(I.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(I.store,t.id))}async _getFutureJobs(t){var a;const e=[],r=(a=this._db)==null?void 0:a.transaction(I.store,"readonly").store,n=IDBKeyRange.lowerBound(t.createdAt,!0);let i=await(r==null?void 0:r.index(I.timeIndex).openCursor(n,"next"));for(;i;)i.value.url===t.url&&i.value.transaction.blitzID===t.transaction.blitzID&&e.push(i.value),i=await i.continue();return e}async retry(t){for(const e of t)await this._updateJob({...e,status:F.Pending})}async revert(t){var r,n;t.sort((i,a)=>i.createdAt-a.createdAt);const e=t[0];if(e){if(e.transaction.action===W.Add){await J.create().run([new R({action:"delete",model:e.transaction.model,blitzID:e.transaction.blitzID})]);const i=await this._getFutureJobs(e);for(const a of[e,...i])await this._deleteJob(a)}else if(e.transaction.action===W.Delete)await this._deleteJob(e),await C.get(e.transaction.model).then(i=>i==null?void 0:i.get(e.transaction.blitzID));else if(e.transaction.action===W.Edit){const i=Object.keys(e.transaction.data)[0],a=new R({action:"edit",model:e.transaction.model,blitzID:e.transaction.blitzID,data:{[i]:{prev:(r=e.transaction.data)==null?void 0:r[i].new,new:(n=e.transaction.data)==null?void 0:n[i].prev}}});await J.create().run([a]);for(const o of t)await this._deleteJob(o)}}}async getAll(){var n;const t={},e=(n=this._db)==null?void 0:n.transaction(I.store,"readonly").store;let r=await(e==null?void 0:e.index(I.timeIndex).openCursor(null,"next"));for(;r;){if(r.value.status===F.Failed||r.value.status===F.Conflict){if(t[r.value.url]||(t[r.value.url]=[]),r.value.transaction.action===W.Add||r.value.transaction.action===W.Delete)t[r.value.url].push([r.value]);else if(r.value.transaction.action===W.Edit){const i=Object.keys(r.value.transaction.data)[0],a=r.value.transaction.blitzID,o=t[r.value.url].findIndex(d=>d[0].transaction.action===W.Edit&&d[0].transaction.blitzID===a&&Object.keys(d[0].transaction.data)[0]===i);o===-1?t[r.value.url].push([r.value]):t[r.value.url][o].push(r.value)}}r=await r.continue()}return t}}const nr="/queue-worker.js";class ir{constructor(){p(this,"_db",null);p(this,"conflictHandler",null);p(this,"failedHandler",null)}_handleWorkerMessage(t){var r;const e=t.data;e.status===F.Completed?_.dispatchEvent("queue:success",e):e.status===F.Failed?_.dispatchEvent("queue:failure",e):e.status===F.Conflict&&(document.hidden||(r=_.queue.conflictHandler)==null||r.prompt(e)),_._Model.get(e.transaction.model).then(n=>{var i;n&&n.objects.has(e.transaction.blitzID)&&((i=n.objects.get(e.transaction.blitzID))==null||i.dispatchEvent("syncStatusChange",e))})}async init(){if(this._db=await It(I.name,1,{upgrade:e=>{const r=e.createObjectStore(I.store,{keyPath:"id"});r.createIndex(I.timeIndex,"createdAt"),r.createIndex(I.objectIndex,"transaction.blitzID")}}),!this._db.objectStoreNames.contains(I.store))return await zt(I.name),await this.init();this.conflictHandler=new rr(this._db),this.failedHandler=new sr(this._db);const t=new Re(_.options.assetsPath+nr,{});return t.port.onmessage=this._handleWorkerMessage,window.addEventListener("beforeunload",()=>t.port.postMessage({type:"close"})),D._globalHeaders&&t.port.postMessage({type:"headers",data:D._globalHeaders}),this}async addJob(t,e){var r;await((r=this._db)==null?void 0:r.add(I.store,{id:crypto.randomUUID(),url:t,transaction:e,status:F.Pending,createdAt:Date.now(),attempts:0,priority:1}))}async deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(I.store,t.id))}async getJobs(){var t;return await((t=this._db)==null?void 0:t.getAll(I.store))}async getJobsForObject(t){var e;return await((e=this._db)==null?void 0:e.getAllFromIndex(I.store,I.objectIndex,t))}}const st={a:["à","á","â","ä"],c:["ç"],e:["è","é","ê"],o:["ö","ó","ò","ô","õ"],oe:["œ"],ss:["ß"],u:["ü"]};class mt{constructor(){p(this,"children");p(this,"isEndOfWord");p(this,"items");this.children={},this.isEndOfWord=!1,this.items=[]}}class Pt{constructor(t,e){p(this,"root");if(this.root=new mt,!e)return;const r=this.getWordFrequency(t,e);for(const n in r)this.insert(n,r[n].items)}_loadFromJson(t,e){Object.keys(t).forEach(r=>{typeof t[r]=="string"||typeof t[r]=="boolean"||(e.children[r]||(e.children[r]=new mt),t[r].hasOwnProperty("isEndOfWord")&&t[r].isEndOfWord&&(e.children[r].isEndOfWord=!0,e.children[r].items=t[r].items),this._loadFromJson(t[r],e.children[r]))})}loadFromJson(t){return this.root=new mt,this._loadFromJson(t,this.root),this}toJson(){const t=e=>{let r={};for(const n in e.children)r[n]=t(e.children[n]);return e.isEndOfWord&&(r.isEndOfWord=!0,r.items=e.items),r};return t(this.root)}getWordFrequency(t,e){const r={},n=t.getAttributes();return e.forEach(i=>{n==null||n.forEach(a=>{if(!i[a])return;i[a].toString().toLowerCase().split(" ").forEach(d=>{d!==""&&(r[d]?r[d].items.push(i._blitzID):r[d]={items:[i._blitzID]})})})}),r}getVariants(t){const e=st[t],r=[t];return e&&r.push(...e),r}generateAllPermutations(t,e,r,n,i){if(e===r.length){i.push(t);return}const a=r[e],o=e!==r.length-1?a+r[e+1]:void 0;if(!st[a]&&!(o&&st[o])){this.generateAllPermutations(t+a,e+1,r,n,i);return}if(st[a]){const d=n[a];for(const l of d)this.generateAllPermutations(t+l,e+1,r,n,i)}if(o&&st[o]){const d=n[o];for(const l of d)this.generateAllPermutations(t+l,e+2,r,n,i)}}normalizeQuery(t){const e=/u|e|a|o|c|ss|oe/g,r=t.toLowerCase().match(e);if(!r)return[t.toLowerCase()];const n={};r.forEach(a=>{n[a]=this.getVariants(a)});const i=[];return this.generateAllPermutations("",0,t,n,i),i}insert(t,e){let r=this.root;for(const n of t)r.children[n]||(r.children[n]=new mt),r=r.children[n];r.isEndOfWord=!0,r.items=e}addToSet(t,e){const r=this.normalizeQuery(t);for(const n of r)this._search(n).forEach(a=>{e.add(a)})}search(t){const e=t==null?void 0:t.toLowerCase().split(" ");let r=new Set;return this.addToSet(e[0],r),e.slice(1).forEach(n=>{const i=new Set;this.addToSet(n,i);for(const a of r)i.has(a)||r.delete(a)}),Array.from(r)}_search(t){let e=this.root;for(const n of t){if(!e.children[n])return[];e=e.children[n]}const r=[];return t===""?this.collectWords(e,"",r):this.collectWords(e,t,r),r}collectWords(t,e,r){t.isEndOfWord&&r.push(...t.items);for(const n in t.children){const i=t.children[n],a=e+n;this.collectWords(i,a,r)}}}class ae{constructor(t){p(this,"model");this.model=t,this.ping()}async ping(){(await this.connect()).close()}isMatchingConditions(t,e){var n,i;let r=!0;for(const a of e){if(!r)return!1;const[o,d,l]=a;let c=l,u=t[o];const h=((i=(n=this.model.getAttribute("attributes").value)==null?void 0:n[o])==null?void 0:i.type)??"string";switch((h==="datetime"||h==="date")&&(c=new Date(l).getTime(),u=new Date(u).getTime()),(typeof l>"u"||l===null)&&(c=null,u=typeof t[o]>"u"||t[o]===null?null:t[o]),d){case"LIKE":const f=`${c}`.startsWith("%"),y=`${c}`.endsWith("%"),g=`${c}`.replaceAll("%","");f===y?r=`${u}`.includes(g):f?r=`${u}`.toString().endsWith(g):y&&(r=`${u}`.toString().startsWith(g));break;case"IN":r=(Array.isArray(c)?c:[c]).includes(u);break;case"=":r=u===c;break;case"!=":r=u!==c;break;case">":r=u>c;break;case"<":r=u<c;break;default:r=!0;break}}return r}async query(t,e,r){var f,y;const n=await this.connect(),i=n.transaction("objects","readonly").store,a=t.customSort&&Array.from(i.indexNames).includes(t.customSort)?t.customSort:"sorted",o=t.customSortDirection==="ASC"?"next":"prev";let d=await i.index(a).openCursor(null,o),l=[];for(;d;){if(r&&r.aborted)throw new DOMException("The operation was aborted.","AbortError");if(e&&!e.includes(d.value.blitzID)){d=await d.continue();continue}if(this.isMatchingConditions(d.value,t.conditions??[])&&(l.push(d.value),t.limit&&l.length>=t.limit))break;d=await d.continue()}const c={[this.model.getName()]:{database:n,model:this.model}},u=t.fks==="object",h=t.manyToMany==="object";if(u||h){const g=(f=this.model.getAttribute("attributes"))==null?void 0:f.value;for(const w of l)for(const v in w){const Z=v.endsWith("_fk"),j=v.endsWith("_mtm");if(Z||j){let T=(y=g[v])==null?void 0:y.type;if(T=Array.isArray(T)?T[0]:T,T){if(!c[T]){const M=await C.get(T);c[T]={database:await(M==null?void 0:M.idbClient()).connect(),model:M}}if(c[T]&&c[T].database&&c[T].model){if(u&&Z&&typeof w[v]=="string"){let M=await c[T].database.get("objects",w[v]);M||(M=await c[T].model.get({blitzID:w[v],raw:!0,forceHttp:!0})),w[v]=M??null}else if(h&&j&&Array.isArray(w[v])){const M=[];for(const V of w[v]){const tt=(V==null?void 0:V._blitzID)||V;let b=await c[T].database.get("objects",tt);b||(b=await c[T].model.get({blitzID:tt,raw:!0,forceHttp:!0})),b&&M.push(b)}w[v]=M.map((V,tt)=>({...V,_mtmSort:V._mtmSort!==void 0?V._mtmSort:(M.length-tt)*10}))}}}}}}for(const g in c)c[g].database.close();return l}async search(t,e){const r=await this.connect(),n=new Pt(this.model).loadFromJson(r.get("tree",this.model.getName()));r.close();const i=n.search(t);return t!==""&&i.length===0?[]:this.query({conditions:e},i)}async save(t){const e=await this.connect();e.put("tree",{name:this.model.getName(),tree:new Pt(this.model,t).toJson()});for(const r of t){const n={...r};for(const i of Object.keys(n))i.endsWith("_fk")&&n[i]!=null&&typeof n[i]!="string"&&n[i]._blitzID?n[i]=n[i]._blitzID:i.endsWith("_mtm")&&Array.isArray(n[i])&&(n[i]=n[i].map((a,o)=>({_blitzID:typeof a=="string"?a:a._blitzID,_mtmSort:a._mtmSort!==void 0?a._mtmSort:(n[i].length-o)*10})));e.put("objects",{_savetimestamp:ot(),...n})}e.close()}async connect(){const t=this.model.getAttribute("attributes").value;return await It(this.model.getName(),1,{upgrade:(r,n,i,a,o)=>{const d=E.getDatabases();if(d.includes(r.name)||(d.push(r.name),E.setDatabases(d)),i!==1)return;r.createObjectStore("tree",{keyPath:"name"});const l=r.createObjectStore("objects",{keyPath:"_blitzID"});for(const c in t)(t[c].type==="date"||c.includes("_fk"))&&l.createIndex(c,c,{unique:!1});l.createIndex("sorted","_blitzstamp")}})}async find(t){const e=await this.connect(),r=e.get("objects",t);return e.close(),r}async create(t){const e=await this.connect();await e.put("objects",t),this.updateTree(),e.close()}async update(t){const e=await this.connect();await e.put("objects",t),this.updateTree(),e.close()}async delete(t){const e=await this.connect();await e.delete("objects",t),this.updateTree(),e.close()}async updateTree(){const t=await this.connect(),e=await t.getAll("objects");await t.put("tree",{name:this.model.getName(),tree:new Pt(this.model,e).toJson()}),t.close()}}class ar{static async send(t,e){try{const r=await globalThis.fetch(t.url+"/api/post.json",{method:"POST",headers:{"Content-Type":"application/json",...e??{}},body:JSON.stringify([t.transaction])});if(!r.ok)throw new Error(`HTTP request failed with status ${r.status}`+(r.statusText?`: ${r.statusText}`:""));const n=await r.json();if(!n||!n.results)throw new Error("No response returned!");const i=n.results[t.transaction.hash];if(!i)throw new Error("No result returned for this job!");if(i.s||i.s0||i.s1||i.n)return{status:G.Success};if(i.conflict){const a=Object.keys(t.transaction.data)[0],o=i.conflict[a];if(!o)throw new Error("No previous value found in conflict result!");return{status:G.Conflict,message:o}}else if(i.e)return{status:G.Failed,message:i.e};return{status:G.Exception,message:n.error??(Array.isArray(n.errors)?n.errors.map(a=>(a==null?void 0:a.message)??a).join(" | "):"Unknown error!")}}catch(r){return{status:G.Exception,message:r.message}}}}class L{constructor(t,e,r){p(this,"_object");p(this,"_name");p(this,"_type");p(this,"_value");this._name=t,this._type=e,this._value=this.unserialize(r)}get value(){return this._value}set value(t){this._value=this.unserialize(t)}withObject(t){return this._object=t,this}withValue(t){return this._value=this.unserialize(t),this}async edit(t,e){if(!this._object)throw new Error("Can not edit attribute, object is not set.");return this._object.edit(this._name,t,e)}}class X extends L{unserialize(t){return t}serialize(){return this._value}}class oe extends L{unserialize(t){return typeof t=="boolean"?t?"1":"0":typeof t=="string"&&["0","1"].includes(t)?t:null}serialize(){return this._value}toJsBoolean(){return this._value==="1"?!0:this._value==="0"?!1:null}}const or=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/;class cr extends L{unserialize(t){if(!t||t==="0000-00-00")return null;const e=t instanceof Date?this.toDateString(t):t;return!e||!or.test(e)?null:e}serialize(){return this._value}toDateString(t){return!t||!(t instanceof Date)?null:t.toISOString().substring(0,10)}toDateObject(){return this._value?new Date(this._value):null}}class ce extends L{unserialize(t){return t}serialize(){return this._value}}class lr extends L{unserialize(t){return t}serialize(){return this._value}}class le extends L{unserialize(t){return typeof t=="number"?t.toString():t}serialize(){return this._value}toJsInt(){return this._value?parseInt(this._value,10):null}}class ur extends ce{}const hr=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}\s[0-9]{2}\:[0-9]{2}\:[0-9]{2}$/;class dr extends L{unserialize(t){if(!t||t==="0000-00-00 00:00:00")return null;const e=t instanceof Date?this.toDateString(t):t;return!e||!hr.test(e)?null:e}serialize(){return this._value}toDateString(t){if(!t||!(t instanceof Date))return null;const e=new Date(t);e.setMinutes(e.getMinutes()-e.getTimezoneOffset());const r=e.toISOString();return r.substring(0,10)+" "+r.substring(11,19)}toDateObject(){return this._value?new Date(this._value):null}getTimeStamp(){return this._value?new Date(this._value).getTime():null}getBlitzStamp(){return this._value?Math.floor((new Date(this._value).getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3):null}}class fr extends L{async get(t){const e=this.serialize();return e?await(await _._Model.get(this._type)).get({...t,blitzID:e}):null}unserialize(t){return t}serialize(){var t,e;return this._value?typeof this._value=="string"?this._value:((e=(t=this._value)==null?void 0:t.getAttribute("_blitzID"))==null?void 0:e.value)||null:null}}class ue{constructor(t,e,r){p(this,"_object");p(this,"_name");p(this,"_type");p(this,"_value",[]);this._name=t,this._type=e,this._value=r??[]}get value(){return this._value}set value(t){this._value=this.unserialize(t)}unserialize(t){return t}serialize(){return this._value}async performAction(t){var r;const e=new R({action:"edit",data:{[this._name]:{[t.action]:t.value()}},model:this._object.model.getName(),blitzID:this._object.getAttribute("_blitzID").value});await J.create().run([e]);for(const n of(r=this._object)==null?void 0:r.getAttribute("_editURLs").value)await _.queue.addJob(n,e.toObject());this._object.model instanceof C&&this._object.model.setLastTransactionHash(e.hash),await this._object.refresh(this._name)}}class he extends ue{async add(t){await this.performAction({action:"add",value:()=>K.createType(this._name,this._type,t).serialize()})}async remove(t){if(t<0||t>=this._value.length)throw new Error("Index out of bounds");await this.performAction({action:"remove",value:()=>[t,this._value[t].serialize()]})}withObject(t){this._object=t,this.value.forEach(e=>{e.withObject(t)})}}class pr extends ue{async add(t,e){await this.performAction({action:"add",value:()=>({_blitzID:t,_mtmSort:e??(this._value.length+1)*10})})}async remove(t){await this.performAction({action:"remove",value:()=>t})}withObject(t){this._object=t}async get(t){var r;const e=await(await _._Model.get(this._type)).list({...t??{},conditions:[...(t==null?void 0:t.conditions)??[],["_blitzID","IN",this._value.map(n=>n._blitzID)]]});for(const n of e){const i=(r=this._value.find(a=>a._blitzID===n._blitzID))==null?void 0:r._mtmSort;n instanceof B?n.setAttribute("_mtmSort",new X("_mtmSort","unknown",i).withObject(n)):n._mtmSort=i}return e.sort((n,i)=>{const a=n instanceof B?n._mtmSort.value:n._mtmSort;return(i instanceof B?i._mtmSort.value:i._mtmSort)-a})}}function br(s){return s&&s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function mr(s){return s}function gr(s,t){t=t||{};const e=t.delimiter||".",r=t.maxDepth,n=t.transformKey||mr,i={};function a(o,d,l){l=l||1,Object.keys(o).forEach(function(c){const u=o[c],h=t.safe&&Array.isArray(u),f=Object.prototype.toString.call(u),y=br(u),g=f==="[object Object]"||f==="[object Array]",w=d?d+e+n(c):n(c);if(!h&&!y&&g&&Object.keys(u).length&&(!t.maxDepth||l<r))return a(u,w,l+1);i[w]=u})}return a(s),i}class yr extends L{unserialize(t){return typeof t!="object"?null:t}serialize(){return this._value}validate(t){let e=!0;try{JSON.parse(t)}catch{e=!1}return e}keys(){return Object.keys(this._value??{})}flat(){return gr(this._value??{})}groupBy(t){if(typeof t!="function")throw new Error("Callback function is not a function!");return Object.groupBy(this._value??{},t)}}class wr extends L{unserialize(t){return typeof t=="string"?{content:t,language:null}:typeof t=="object"&&t!=null&&(t!=null&&t.content)?{content:t.content,language:t.language||null}:null}serialize(){return this._value}getLanguage(){var t;return((t=this._value)==null?void 0:t.language)||null}getContent(){var t;return((t=this._value)==null?void 0:t.content)||null}}class _r extends L{unserialize(t){return t||null}serialize(){return this._value}getOptions(){var t,e,r,n,i;return((i=(n=(r=(e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttribute("attributes"))==null?void 0:r.value)==null?void 0:n[this._name])==null?void 0:i.options)??[]}validate(t){return this.getOptions().includes(t)}}class Rt extends L{unserialize(t){return typeof t=="number"?t.toString():t}serialize(){return this._value}toJsFloat(){return this._value?parseFloat(this._value):null}}class vr extends le{}class Sr extends Rt{}class Ar extends Rt{toPercentage(){return this._value?(parseFloat(this._value)*100).toString()+"%":null}}const de=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;class Dr extends L{unserialize(t){return!t||!de.test(t)?null:t}serialize(){return this._value}validate(t){return de.test(t)}}const fe=/^\+[1-9]{1,3}\-[0-9]{7,14}$/;class Ir extends L{unserialize(t){return!t||!fe.test(t)?null:t}serialize(){return this._value}validate(t){return fe.test(t)}getCallingCode(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[0].substring(1)}getPhoneNumber(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[1]}}const pe=/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/;class zr extends L{unserialize(t){return!t||!pe.test(t)?null:t}serialize(){return this._value}validate(t){return pe.test(t)}getUrlObject(){return this._value?new URL(this._value):null}getOrigin(){return this._value?new URL(this._value).origin:null}getProtocol(){return this._value?new URL(this._value).protocol:null}getPathname(){return this._value?new URL(this._value).pathname:null}getHostname(){return this._value?new URL(this._value).hostname:null}getSearch(){return this._value?new URL(this._value).search:null}}class Tr extends L{unserialize(t){var e;return Array.isArray(t)&&((e=t[0])!=null&&e.base)?t:null}serialize(){return this._value}getUrl(t){var e,r;return!this._value||!((e=this._value[0])!=null&&e.base)||!((r=this._value[0])!=null&&r[t])?null:this._value[0].base+this._value[0][t].substring(1)}}class K{static createType(t,e,r){return t.endsWith("_fk")?new fr(t,e,r):e==="int"?new le(t,e,r):e==="tinyint"?new vr(t,e,r):e==="double"?new Sr(t,e,r):e==="float"?new Rt(t,e,r):e==="percentage"?new Ar(t,e,r):e==="varchar"?new ur(t,e,r):e==="text"?new ce(t,e,r):e==="htmlText"?new lr(t,e,r):e==="enum"?new _r(t,e,r):e==="json"?new yr(t,e,r):e==="boolean"?new oe(t,e,r):e==="datetime"?new dr(t,e,r):e==="date"?new cr(t,e,r):e==="code"?new wr(t,e,r):e==="email"?new Dr(t,e,r):e==="phone"?new Ir(t,e,r):e==="url"?new zr(t,e,r):e==="image"?new Tr(t,e,r):new X(t,e,r)}static createFrom(t,e,r){return Array.isArray(e)?this.createMany(t,e[0],r):this.createType(t,e,r)}static createMany(t,e,r){var n;return t.endsWith("_mtm")?new pr(t,e,r):new he(t,e,(n=typeof r=="string"?JSON.parse(r):r)==null?void 0:n.map(i=>this.createType(t,e,i)))}static unserialize(t,e){var i,a,o;const r={},n=[Object.keys(t),Object.keys(e)].flat().filter(function(d,l,c){return c.indexOf(d)===l});for(const d of n)Array.isArray((i=t[d])==null?void 0:i.type)?r[d]=K.createMany(d,((a=t[d])==null?void 0:a.type[0])??"anonymous",e[d]):r[d]=K.createType(d,((o=t[d])==null?void 0:o.type)??"anonymous",e[d]??void 0);return r}static serialize(t){const e={};for(const r in t)e[r]=t[r].serialize();return e}}class Or{constructor({model:t,attributes:e}){p(this,"_model");p(this,"attributes");p(this,"listeners",new Map);p(this,"editQueue",Promise.resolve());this._model=t,this.attributes=e}get model(){return this._model}getAttribute(t){return this.attributes[t]}setAttribute(t,e){this.attributes[t]=e}hasAttribute(t){return this.attributes.hasOwnProperty(t)}async edit(t,e,r){this.enqueueEditOperation(async()=>{var a,o,d,l;const n=K.createType(t,r??((l=(d=(o=(a=this.model)==null?void 0:a.getAttribute("attributes"))==null?void 0:o.value)==null?void 0:d[t])==null?void 0:l.type),e).withObject(this).withValue(e).serialize(),i=new R({action:"edit",data:{[t]:{prev:this.getAttribute(t).serialize(),new:n}},model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value});this.attributes[t].value=n,await J.create().run([i]),await _.queue.addJob("https://alpha.blitzdata.com",i.toObject()),this.model instanceof C&&this.model.setLastTransactionHash(i.hash)})}async delete(){const t=new R({action:"delete",model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value});await J.create().run([t]),await _.queue.addJob("https://alpha.blitzdata.com",t.toObject()),this.model instanceof C&&this.model.setLastTransactionHash(t.hash)}async addUserPermission(t){if(!t||t.length===0)throw new Error("Users missing!");const e=this.getAttribute("_blitzID").value,r={blitzIDs:[e],users:t.reduce((o,d)=>({...o,[`#${d.id}`]:d.permission}),{})},n=new R({action:"addObjectUserPermission",model:this.model.getName(),blitzID:e,data:r,hash:yt(r)}),i=[];for(const o of this.getAttribute("_editURLs").value)i.push(await ar.send({url:o,transaction:n.toObject()},D._globalHeaders));const a=i.find(o=>o.status!==G.Success);if(a)throw new Error(a.message)}toObject(){const t={};for(const e in this.attributes){const r=this.attributes[e];r instanceof L?t[e]=r.serialize():r instanceof he&&(t[e]=r.value.map(n=>n.serialize()))}return t}async syncStatus(){return(await _.queue.getJobsForObject(this.getAttribute("_blitzID").value)).every(e=>e.status===F.Completed)}async refresh(...t){const e=await this._model.get({blitzID:this.getAttribute("_blitzID").value,raw:!0}),r=this.model.getAttribute("attributes").value;t=t.length>0?t:Object.keys(this.attributes);for(const n of t){const i=K.createFrom(n,r[n].type,e[n]);i.withObject(this),this.attributes[n]=i}}addEventListener(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(r=>e!==r))}dispatchEvent(t,e){this.listeners.has(t)&&(this.listeners.get(t).forEach(r=>{this.model instanceof C&&r.call(this.model.objects.get(this.getAttribute("_blitzID").value),e)}),t==="delete"&&(this.listeners.clear(),this.model.objects.delete(this.getAttribute("_blitzID").value)))}enqueueEditOperation(t){return new Promise((e,r)=>{this.editQueue=this.editQueue.then(async()=>{try{const n=await t();e(n)}catch(n){r(n)}})})}}const B=Or;class Nt{static transformBlitzDataOptions(t){if(typeof t>"u")throw new Error("Configuration is required.");if(typeof t=="string")t={clusters:this.transformClusterOptions(t)};else if(Array.isArray(t))t={clusters:this.transformClusterOptions(t)};else if(typeof t=="object"&&!Array.isArray(t))t.clusters=this.transformClusterOptions(t.clusters);else throw new Error("Unknown configuration type.");if(t.pingInterval||(t.pingInterval=6e4),t.assetsPath||(t.assetsPath=""),t.sync?typeof t.sync=="string"&&(t.sync={level:t.sync}):t.sync={level:"full"},t.sync.level==="partial")throw new Error("Partial sync type not supported yet!");return t.sync.level==="cache"&&(t.sync.ttl||(t.sync.ttl=30*1e3)),t.sync.level==="full"&&(t.sync.interval||(t.sync.interval=30*1e3)),t}static transformClusterOptions(t){if(typeof t>"u")throw new Error("Clusters are required.");if(typeof t=="string")t={default:{readURL:[t],addURL:[t]}};else if(Array.isArray(t))t={default:{readURL:t,addURL:t}};else if(typeof t=="object")for(const e of Object.keys(t)){if(typeof t[e]=="string"||Array.isArray(t[e])){const r=Array.isArray(t[e])?t[e]:[t[e]];t[e]={readURL:r,addURL:r};continue}typeof t[e]=="object"&&(typeof t[e].readURL=="string"&&(t[e].readURL=[t[e].readURL]),typeof t[e].addURL=="string"&&(t[e].addURL=[t[e].addURL]))}else throw new Error("Unknown cluster configuration type.");return t}}const Er={get(s,t){if(Reflect.has(s,t)){const e=Reflect.get(s,t);return e instanceof Function?e.bind(s):e}return s.getAttribute(t)},set(s,t,e){throw new Error("Setting values directly not supported. Please use `edit` method to change a value for an attribute.")}};class gt{static create(t,e,r){const n=K.unserialize(e.getAttribute("attributes").value,r),i=new Proxy(new t({model:e,attributes:n}),Er);for(const a in n)n[a].withObject(i);return e instanceof C&&e.objects.set(r._blitzID,i),i}}class Wt extends B{static async model(){if(typeof this.modelName!="string")throw new Error(`${this.name}.modelName is not a string, please provide a valid model name.`);const t=this.modelName==="_Model"?_._Model:await _._Model.get(this.modelName);return t.setReturnType(this),t}static async get(t){return(await this.model()).get(t)}static async exists(t){return(await this.model()).exists(t)}static async add(t,e=[]){return(await this.model()).add(t,e)}static async list(t={}){return(await this.model()).list(t)}}p(Wt,"modelName");const at=class at extends Wt{constructor({model:e,attributes:r}){super({model:e,attributes:r});p(this,"indexedDBConnection");p(this,"clusterManager");p(this,"objects",new Map);p(this,"lastTransactionHash",null);p(this,"returnType",B);this.indexedDBConnection=new ae(this),this.clusterManager=_.clusterManager,this.model instanceof at&&this.model.objects.set(this.getName(),this)}idbClient(){return new ae(this)}getName(){return this.attributes._blitzID.value}getLastTransactionHash(){return this.lastTransactionHash}setLastTransactionHash(e){this.lastTransactionHash=e}setReturnType(e){this.returnType=e}async exists(e){return!!await this.get(e)}async add(e,r=[]){this.resolveClusters(r);const n=this.getAttribute("attributes").value,i=new R({action:"add",data:K.serialize(K.unserialize(n,e)),model:this.getName()}),a=await _.getCurrentUser(),o=i.clone();return o.data={...o.data,_userID:a.id},await J.create().run([o]),await _.queue.addJob("https://alpha.blitzdata.com",i.toObject()),this.setLastTransactionHash(i.hash),gt.create(this.returnType,this,o.data)}async get(e){const r=typeof e=="string"?{blitzID:e}:e,i=(await nt.create().model(this).clusters(this.resolveClusters(r.clusters??[])).raw(r.raw??!1).get(r.blitzID).query({returnType:this.returnType??B}).forceHttp(r.forceHttp??!1).forceLocal(r.forceLocal??!1).skipCacheUpdateIfFound(r.skipCacheUpdateIfFound??!1).getQuery(r.query??{}).signal(r.signal).perform())[0]??null;if(!i&&this.returnType===at)throw new Error(`Model with blitzID "${e}" does not exists or you don't have enough permission to view it.`);return i||null}async list(e={}){return await nt.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??B,customSort:e.customSort,customSortDirection:e.customSortDirection,fks:e.fks,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).signal(e.signal).perform()}async subscribeToList(e={}){const r=await this.list(e);return new kt(n=>{n.next(r);const i=J.transactionChannel.pipe(er(({transactions:a,results:o})=>a.some(d=>d.model===this.getName())&&o.some(d=>d.status===k.Success))).subscribe(()=>{this.list({...e,forceLocal:!0}).then(a=>n.next(a))});return()=>i.unsubscribe()})}async sync(){const e=this.getName();if(e){const r=Date.now()/1e3,n=E.getLastSyncedAt(e)??0,i=30;r-n>i&&await bt.create().syncModel(e)}}getAttributes(){var e;return((e=this.attributes.searchable)==null?void 0:e.value)??[]}getAttributeDetails(e){return this.getAttribute("attributes").value[e]}resolveClusters(e){return Object.values(e.length===0?this.clusterManager.all():this.clusterManager.get(e))}setClusters(e){this.clusterManager=new Bt;const r=Nt.transformClusterOptions(e);for(const n of Object.keys(r))this.clusterManager.register(n,r[n])}getClusterManager(){return this.clusterManager}static async get(e){return super.get(e)}static async list(e={}){return super.list(e)}};p(at,"modelName","_Model");let C=at;class be{static extractModelName(t){const n=new URL(t).pathname.split("/").filter(i=>i!=="").pop();if(!n&&!(n!=null&&n.endsWith(".json")))throw new Error("Model name not found in the URL.");return n.slice(0,n.indexOf(".json"))}static extractConditions(t){const e=new URL(t);return JSON.parse(e.searchParams.get("conditions")||"[]")}}var me={exports:{}},ge={exports:{}};(function(){var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,r){return e<<r|e>>>32-r},rotr:function(e,r){return e<<32-r|e>>>r},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var r=0;r<e.length;r++)e[r]=t.endian(e[r]);return e},randomBytes:function(e){for(var r=[];e>0;e--)r.push(Math.floor(Math.random()*256));return r},bytesToWords:function(e){for(var r=[],n=0,i=0;n<e.length;n++,i+=8)r[i>>>5]|=e[n]<<24-i%32;return r},wordsToBytes:function(e){for(var r=[],n=0;n<e.length*32;n+=8)r.push(e[n>>>5]>>>24-n%32&255);return r},bytesToHex:function(e){for(var r=[],n=0;n<e.length;n++)r.push((e[n]>>>4).toString(16)),r.push((e[n]&15).toString(16));return r.join("")},hexToBytes:function(e){for(var r=[],n=0;n<e.length;n+=2)r.push(parseInt(e.substr(n,2),16));return r},bytesToBase64:function(e){for(var r=[],n=0;n<e.length;n+=3)for(var i=e[n]<<16|e[n+1]<<8|e[n+2],a=0;a<4;a++)n*8+a*6<=e.length*8?r.push(s.charAt(i>>>6*(3-a)&63)):r.push("=");return r.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var r=[],n=0,i=0;n<e.length;i=++n%4)i!=0&&r.push((s.indexOf(e.charAt(n-1))&Math.pow(2,-2*i+8)-1)<<i*2|s.indexOf(e.charAt(n))>>>6-i*2);return r}};ge.exports=t})();var xr=ge.exports,Jt={utf8:{stringToBytes:function(s){return Jt.bin.stringToBytes(unescape(encodeURIComponent(s)))},bytesToString:function(s){return decodeURIComponent(escape(Jt.bin.bytesToString(s)))}},bin:{stringToBytes:function(s){for(var t=[],e=0;e<s.length;e++)t.push(s.charCodeAt(e)&255);return t},bytesToString:function(s){for(var t=[],e=0;e<s.length;e++)t.push(String.fromCharCode(s[e]));return t.join("")}}},ye=Jt;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var Ur=function(s){return s!=null&&(we(s)||jr(s)||!!s._isBuffer)};function we(s){return!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s)}function jr(s){return typeof s.readFloatLE=="function"&&typeof s.slice=="function"&&we(s.slice(0,0))}(function(){var s=xr,t=ye.utf8,e=Ur,r=ye.bin,n=function(i,a){i.constructor==String?a&&a.encoding==="binary"?i=r.stringToBytes(i):i=t.stringToBytes(i):e(i)?i=Array.prototype.slice.call(i,0):!Array.isArray(i)&&i.constructor!==Uint8Array&&(i=i.toString());for(var o=s.bytesToWords(i),d=i.length*8,l=1732584193,c=-271733879,u=-1732584194,h=271733878,f=0;f<o.length;f++)o[f]=(o[f]<<8|o[f]>>>24)&16711935|(o[f]<<24|o[f]>>>8)&4278255360;o[d>>>5]|=128<<d%32,o[(d+64>>>9<<4)+14]=d;for(var y=n._ff,g=n._gg,w=n._hh,v=n._ii,f=0;f<o.length;f+=16){var Z=l,j=c,T=u,M=h;l=y(l,c,u,h,o[f+0],7,-680876936),h=y(h,l,c,u,o[f+1],12,-389564586),u=y(u,h,l,c,o[f+2],17,606105819),c=y(c,u,h,l,o[f+3],22,-1044525330),l=y(l,c,u,h,o[f+4],7,-176418897),h=y(h,l,c,u,o[f+5],12,1200080426),u=y(u,h,l,c,o[f+6],17,-1473231341),c=y(c,u,h,l,o[f+7],22,-45705983),l=y(l,c,u,h,o[f+8],7,1770035416),h=y(h,l,c,u,o[f+9],12,-1958414417),u=y(u,h,l,c,o[f+10],17,-42063),c=y(c,u,h,l,o[f+11],22,-1990404162),l=y(l,c,u,h,o[f+12],7,1804603682),h=y(h,l,c,u,o[f+13],12,-40341101),u=y(u,h,l,c,o[f+14],17,-1502002290),c=y(c,u,h,l,o[f+15],22,1236535329),l=g(l,c,u,h,o[f+1],5,-165796510),h=g(h,l,c,u,o[f+6],9,-1069501632),u=g(u,h,l,c,o[f+11],14,643717713),c=g(c,u,h,l,o[f+0],20,-373897302),l=g(l,c,u,h,o[f+5],5,-701558691),h=g(h,l,c,u,o[f+10],9,38016083),u=g(u,h,l,c,o[f+15],14,-660478335),c=g(c,u,h,l,o[f+4],20,-405537848),l=g(l,c,u,h,o[f+9],5,568446438),h=g(h,l,c,u,o[f+14],9,-1019803690),u=g(u,h,l,c,o[f+3],14,-187363961),c=g(c,u,h,l,o[f+8],20,1163531501),l=g(l,c,u,h,o[f+13],5,-1444681467),h=g(h,l,c,u,o[f+2],9,-51403784),u=g(u,h,l,c,o[f+7],14,1735328473),c=g(c,u,h,l,o[f+12],20,-1926607734),l=w(l,c,u,h,o[f+5],4,-378558),h=w(h,l,c,u,o[f+8],11,-2022574463),u=w(u,h,l,c,o[f+11],16,1839030562),c=w(c,u,h,l,o[f+14],23,-35309556),l=w(l,c,u,h,o[f+1],4,-1530992060),h=w(h,l,c,u,o[f+4],11,1272893353),u=w(u,h,l,c,o[f+7],16,-155497632),c=w(c,u,h,l,o[f+10],23,-1094730640),l=w(l,c,u,h,o[f+13],4,681279174),h=w(h,l,c,u,o[f+0],11,-358537222),u=w(u,h,l,c,o[f+3],16,-722521979),c=w(c,u,h,l,o[f+6],23,76029189),l=w(l,c,u,h,o[f+9],4,-640364487),h=w(h,l,c,u,o[f+12],11,-421815835),u=w(u,h,l,c,o[f+15],16,530742520),c=w(c,u,h,l,o[f+2],23,-995338651),l=v(l,c,u,h,o[f+0],6,-198630844),h=v(h,l,c,u,o[f+7],10,1126891415),u=v(u,h,l,c,o[f+14],15,-1416354905),c=v(c,u,h,l,o[f+5],21,-57434055),l=v(l,c,u,h,o[f+12],6,1700485571),h=v(h,l,c,u,o[f+3],10,-1894986606),u=v(u,h,l,c,o[f+10],15,-1051523),c=v(c,u,h,l,o[f+1],21,-2054922799),l=v(l,c,u,h,o[f+8],6,1873313359),h=v(h,l,c,u,o[f+15],10,-30611744),u=v(u,h,l,c,o[f+6],15,-1560198380),c=v(c,u,h,l,o[f+13],21,1309151649),l=v(l,c,u,h,o[f+4],6,-145523070),h=v(h,l,c,u,o[f+11],10,-1120210379),u=v(u,h,l,c,o[f+2],15,718787259),c=v(c,u,h,l,o[f+9],21,-343485551),l=l+Z>>>0,c=c+j>>>0,u=u+T>>>0,h=h+M>>>0}return s.endian([l,c,u,h])};n._ff=function(i,a,o,d,l,c,u){var h=i+(a&o|~a&d)+(l>>>0)+u;return(h<<c|h>>>32-c)+a},n._gg=function(i,a,o,d,l,c,u){var h=i+(a&d|o&~d)+(l>>>0)+u;return(h<<c|h>>>32-c)+a},n._hh=function(i,a,o,d,l,c,u){var h=i+(a^o^d)+(l>>>0)+u;return(h<<c|h>>>32-c)+a},n._ii=function(i,a,o,d,l,c,u){var h=i+(o^(a|~d))+(l>>>0)+u;return(h<<c|h>>>32-c)+a},n._blocksize=16,n._digestsize=16,me.exports=function(i,a){if(i==null)throw new Error("Illegal argument "+i);var o=s.wordsToBytes(n(i,a));return a&&a.asBytes?o:a&&a.asString?r.bytesToString(o):s.bytesToHex(o)}})();var Lr=me.exports;const Cr=ze(Lr);class nt{constructor(){p(this,"_clusters");p(this,"_urls");p(this,"_model");p(this,"_query");p(this,"_raw",!1);p(this,"_signal");p(this,"_forceHttp",!1);p(this,"_forceLocal",!1);p(this,"_skipCacheUpdateIfFound",!1);p(this,"_get");p(this,"_getQuery")}static create(){return new nt}model(t){return this._model=t,this}clusters(t){return this._clusters=t,this}urls(t){return this._urls=t,this}query(t){return this._query=t,this}raw(t){return this._raw=t,this}signal(t){return this._signal=t,this}forceHttp(t){return this._forceHttp=t,this}forceLocal(t){return this._forceLocal=t,this}skipCacheUpdateIfFound(t){return this._skipCacheUpdateIfFound=t,this}get(t){return this._get=t,this}getQuery(t){return this._getQuery=t,this}async perform(){var e,r,n,i,a,o,d,l;let t=this._forceHttp&&!this._forceLocal?[]:await this.performIndexedDb();if(!this._forceLocal){if(_.options.sync.level==="full"&&t.length===0)t=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp())),t.length>0&&this._model.idbClient().save(t);else if(_.options.sync.level==="cache"){const c=this._skipCacheUpdateIfFound&&t.length>0?!1:this.shouldSendHttpRequest();if(c||t.length===0){const u=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));(u.length>0||this._forceHttp)&&(t=u,t.length>0&&this._model.idbClient().save(t)),c&&((e=this._model)==null?void 0:e.getName())!=="_Model"&&E.setListCallLastTimeStamp(this.hash(),new Date().getTime())}}}if(!this._raw){const c=[],u=this._get?((r=this._getQuery)==null?void 0:r.fks)==="object":((n=this._query)==null?void 0:n.fks)==="object",h=this._get?((i=this._getQuery)==null?void 0:i.manyToMany)==="object":((a=this._query)==null?void 0:a.manyToMany)==="object",f=((d=(o=this._model)==null?void 0:o.getAttribute("attributes"))==null?void 0:d.value)??{},y={[this._model.getName()]:this._model};for(const g of t){if(u||h)for(const w in g){const v=w.endsWith("_fk"),Z=w.endsWith("_mtm");if(v||Z){let j=(l=f[w])==null?void 0:l.type;j=Array.isArray(j)?j[0]:j,j&&(y[j]||(y[j]=await C.get(j)),y[j]&&(u&&v&&g[w]&&typeof g[w]=="object"?g[w]=gt.create(B,y[j],g[w]):h&&Z&&Array.isArray(g[w])&&(g[w]=g[w].map(T=>gt.create(B,y[j],T)))))}}c.push(gt.create(this._query.returnType,this._model,g))}return c}return t}async performHttp(){return(await Promise.all(this._urls?this._urls.map(e=>this.performSingleUrlHttp(e)):this._clusters.map(e=>this.performSingleClusterHttp(e)))).flat()}async performSingleClusterHttp(t){const e={};for(let r=0;r<t.options.readURL.length;r++){const n=t.getNextHealthyReadURL();try{return(this._get?await q.get({baseUrl:n,modelName:this._model.getName(),blitzID:this._get,query:this._getQuery},this._signal):await q.list({endpoint:{baseUrl:n,modelName:this._model.getName(),query:this._query}},this._signal)).map(a=>(a._clusters=[t.name],a._editURLs=JSON.parse(JSON.stringify(t.options.readURL)),a))}catch(i){if(i instanceof DOMException&&i.name==="AbortError")throw i;e[n]=(i==null?void 0:i.message)??i}}throw console.log("Passed cluster read urls:",t.options.readURL.length),console.log("Passed cluster healthy urls:",t.healthyUrls.readURL.length),console.log("List call clusters read urls:",(this._clusters??[]).map(r=>r.options.readURL.length).join(", ")),console.log("List call clusters healthy urls:",(this._clusters??[]).map(r=>r.healthyUrls.readURL.length).join(", ")),console.log("ClusterManager read urls:",_.clusterManager.toArray().map(r=>r.options.readURL.length).join(", ")),console.log("ClusterManager healthy urls:",_.clusterManager.toArray().map(r=>r.healthyUrls.readURL.length).join(", ")),console.log("BlitzData cluster options:",_.options.clusters),new Error(`All read URLs failed for cluster "${t.name}". Errors: ${JSON.stringify(e)}`)}async performSingleUrlHttp(t){return(await q.list({fullUrl:t},this._signal)).map(r=>(r.cluster=[],r._editURLs=[t],r))}async performIndexedDb(){if(this._get)return await this._model.idbClient().query({conditions:[["_blitzID","=",this._get]],limit:1,fks:this._getQuery.fks,manyToMany:this._getQuery.manyToMany});const t=this._urls?this._urls.map(e=>be.extractConditions(e)).flat():this._query.conditions;return await this._model.idbClient().query({...this._query,conditions:t},void 0,this._signal)}mergeObjects(t){const e=[];for(const r of t){const n=e.find(i=>i._blitzID===r._blitzID);n?(n._clusters=[...n._clusters,...r._clusters].filter((i,a,o)=>o.indexOf(i)===a),n._editURLs=[...n._editURLs,...r._editURLs].filter((i,a,o)=>o.indexOf(i)===a)):e.push(r)}return e}async filterQueuedObjects(t){var n;const e=await _.queue.getJobs(),r=[];for(const i of t)if(!e.find(a=>a.transaction.action===W.Delete&&a.transaction.blitzID===i._blitzID))if(!e.find(a=>a.transaction.action===W.Edit&&a.transaction.blitzID===i._blitzID&&a.status!==F.Completed))r.push(i);else{const a=await((n=this._model)==null?void 0:n.get({blitzID:i._blitzID,raw:!0,forceLocal:!0}));a?r.push(a):r.push(i)}return r}shouldSendHttpRequest(){var e;if(_.options.sync.level!=="cache"||((e=this._model)==null?void 0:e.getName())==="_Model")return!1;const t=E.getListCallLastTimeStamp(this.hash());return t?new Date().getTime()-t>_.options.sync.ttl:!0}hash(){var t,e;return Cr(JSON.stringify({clusters:((t=this._clusters)==null?void 0:t.map(r=>r.name))??[],blitzId:this._get,urls:this._urls,modelName:(e=this._model)==null?void 0:e.getName(),listQuery:this._query,getQuery:this.getQuery}))}}const Mr=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,_e=s=>{if(typeof s!="string")throw new TypeError("Invalid argument expected string");const t=s.match(Mr);if(!t)throw new Error(`Invalid argument not valid semver ('${s}' received)`);return t.shift(),t},ve=s=>s==="*"||s==="x"||s==="X",Se=s=>{const t=parseInt(s,10);return isNaN(t)?s:t},kr=(s,t)=>typeof s!=typeof t?[String(s),String(t)]:[s,t],Fr=(s,t)=>{if(ve(s)||ve(t))return 0;const[e,r]=kr(Se(s),Se(t));return e>r?1:e<r?-1:0},Ae=(s,t)=>{for(let e=0;e<Math.max(s.length,t.length);e++){const r=Fr(s[e]||"0",t[e]||"0");if(r!==0)return r}return 0},Pr=(s,t)=>{const e=_e(s),r=_e(t),n=e.pop(),i=r.pop(),a=Ae(e,r);return a!==0?a:n&&i?Ae(n.split("."),i.split(".")):n||i?n?-1:1:0},Rr=(s,t,e)=>{Nr(e);const r=Pr(s,t);return De[e].includes(r)},De={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},Ie=Object.keys(De),Nr=s=>{if(typeof s!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof s}`);if(Ie.indexOf(s)===-1)throw new Error(`Invalid operator, expected one of ${Ie.join("|")}`)},U=class U{static get VERSION(){return"1.1.15"}static async initialize(t){if(this.initialized){console.log("%c⚠️ Warning: Library has already been initialized! Skipping the initialization steps.","background: #FFF3CD; color: #856404; font-weight: bold;"),console.groupCollapsed("%cStack Trace","background: #FFF3CD; color: #856404; font-weight: bold; font-style: italic;"),console.log("Options",t),console.trace(),console.groupEnd();return}this.initialized=!0;const e=Nt.transformBlitzDataOptions(t);this.options=e,e.clusters&&U.setClusters(e.clusters);const r=E.get("version");if((!r||Rr(this.VERSION,r,">"))&&(await this.purge(),E.set("version",this.VERSION.toString())),await new Ft().ping(),this.queue=await new ir().init(),U._Model=new C({model:void 0,attributes:{_blitzID:new X("_blitzID","string","_Model"),searchable:new X("searchable","json",void 0),attributes:new X("attributes","json",{name:{label:"Name",type:"varchar"},label:{label:"Label",type:"texti18n"},modelpermission:{label:"Model Permission",type:"tinyint"},hasuserpermissions:{label:"Has User Permissions",type:"boolean"},subscriberemails:{label:"Subscriber Emails",type:"text"},haslogs:{label:"Has Logs",type:"boolean"},cache:{label:"Cache",name:"cache",type:"boolean"},hasprojects:{label:"Has Projects",type:"boolean"},attributes:{label:"Attributes",type:"json"},objectpermissionoptions:{label:"Object Permission Options",type:"int"},haspublishingdate:{label:"Has Publishing Date",type:"boolean"}}),_editURLs:new X("_editURLs","json",[]),haspublishingdate:new oe("haspublishingdate","boolean",!1)}}),U._Model.setReturnType(C),t&&typeof t!="string"&&!Array.isArray(t)&&t.uiManager&&(this.ui=new t.uiManager(this,D._globalHeaders)),e.sync.level==="full"){const n=bt.create();await n.run(),n.runAtInterval(e.sync.interval)}}static async purge(){const e=[...(await indexedDB.databases()).filter(r=>{var n;return(n=r.name)==null?void 0:n.startsWith("bdt")}).map(r=>r.name),...E.getDatabases(),"_Model","_Project","db_master",I.name].filter((r,n,i)=>i.findIndex(a=>a===r)===n);for(const r of e)await zt(r);E.clear()}static purgeLocalStorage(){E.clear()}static setClusters(t){t=Nt.transformClusterOptions(t);for(const e of Object.keys(t))U.clusterManager.register(e,t[e])}static async list(t){const e=be.extractModelName(t);if(!await U._Model.exists(e))throw new Error(`Model "${e}" does not exist.`);return nt.create().model(await U._Model.get(e)).urls([t]).query({}).perform()}static async uploader(t){return await q.upload({baseUrl:U.clusterManager.toArray()[0].getNextHealthyReadURL(),image:t})}static async listProjectUsers(t){if(!t)throw new Error("Project ID required!");const e=z.sanitizeBaseUrl(U.clusterManager.toArray()[0].getNextHealthyReadURL()),r=await D.create().url(e+`api/listProjectUsers/${t}.json`).get();if(r.error)throw new Error(r.error);if(r.errors instanceof Array&&r.errors.length>0)throw new Error(r.errors.map(n=>n.message||n).join(" | "));return(r.users||[]).map(n=>({id:n._blitzID,username:n.username}))}static async getCurrentUser(){const t=E.getCurrentUser();if(t)return t;const e=z.sanitizeBaseUrl(U.clusterManager.toArray()[0].getNextHealthyReadURL()),r=await D.create().url(e+"api/ping.json").get();if(r.error)throw new Error(r.error);if(!r.userhash){const o={id:"public",username:"Public"};return E.setCurrentUser(o),o}const n=await C.get("0BAUsers"),i=await(n==null?void 0:n.get({blitzID:r.userhash,raw:!0}));if(!(i!=null&&i.username))throw new Error("Could not get user object!");const a={id:r.userhash,username:i.username};return E.setCurrentUser(a),a}static addEventListener(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}static hasEventListener(t){return this.listeners.has(t)?this.listeners.get(t).length>0:!1}static removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(r=>e!==r))}static dispatchEvent(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(r=>r(e))}};p(U,"clusterManager",new Bt),p(U,"_Model"),p(U,"options"),p(U,"queue"),p(U,"ui"),p(U,"listeners",new Map),p(U,"initialized",!1);let _=U;O.BDCustomObject=Wt,O.BDModel=C,O.BDObject=B,O.BlitzData=_,O.HttpRequest=D,O.blitzhash=yt,O.blitzstamp=ot,O.sleep=wt,Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})});
