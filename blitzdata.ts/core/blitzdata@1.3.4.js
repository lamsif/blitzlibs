(function(T,S){typeof exports=="object"&&typeof module<"u"?S(exports):typeof define=="function"&&define.amd?define(["exports"],S):(T=typeof globalThis<"u"?globalThis:T||self,S(T.BlitzData={}))})(this,function(T){"use strict";var ss=Object.defineProperty;var is=(T,S,tt)=>S in T?ss(T,S,{enumerable:!0,configurable:!0,writable:!0,value:tt}):T[S]=tt;var m=(T,S,tt)=>(is(T,typeof S!="symbol"?S+"":S,tt),tt);const st=class st{constructor(){m(this,"_method");m(this,"_url");m(this,"_headers",{});m(this,"_body");m(this,"_signal")}static create(){const t=new st;return st._globalHeaders&&t.headers(st._globalHeaders),t}static globalHeaders(t){st._globalHeaders=t}method(t){return this._method=t,this}url(t){return this._url=t,this}header(t,e){return this._headers[t]=e,this}headers(t){for(const e in t)this.header(e,t[e]);return this}body(t){return this._body=t,this}signal(t){return this._signal=t,this}async send(){const t=await fetch(this._url,{method:this._method,headers:this._headers,body:this._body?this._body instanceof FormData?this._body:JSON.stringify(this._body):void 0,signal:this._signal?this._signal:void 0});if(!t.ok)throw new Error(`HTTP request failed with status code ${t.status}. Status text: ${t.statusText} and response: ${await t.text()}`);return await t.json()}async get(){return await this.method("GET").send()}async post(){return await this.method("POST").send()}};m(st,"_globalHeaders",{});let S=st;class tt{constructor(t,e){m(this,"name");m(this,"options");m(this,"cursors",{readURL:0});this.name=t,this.options=e}getNextReadURL(){this.cursors.readURL>=this.options.readURL.length&&(this.cursors.readURL=0);const t=this.options.readURL[this.cursors.readURL];return this.cursors.readURL++,t}}class te{constructor(){m(this,"clusters",{})}register(t,e){this.clusters[t]=new tt(t,e)}get(t){if(!Array.isArray(t)){if(this.clusters[t]===void 0)throw new Error(`cluster "${t}" not found.`);return this.clusters[t]}const e={};for(const r of t)e[r]=this.get(r);return e}names(){return Object.keys(this.clusters)}all(){return this.clusters}toArray(){return Object.values(this.clusters)}random(){const t=this.names(),e=t[Math.floor(Math.random()*t.length)];return this.get(e)}}const $e=(n,t)=>t.some(e=>n instanceof e);let ee,re;function He(){return ee||(ee=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Be(){return re||(re=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ne=new WeakMap,Et=new WeakMap,ae=new WeakMap,kt=new WeakMap,Ct=new WeakMap;function Ye(n){const t=new Promise((e,r)=>{const a=()=>{n.removeEventListener("success",s),n.removeEventListener("error",i)},s=()=>{e(Q(n.result)),a()},i=()=>{r(n.error),a()};n.addEventListener("success",s),n.addEventListener("error",i)});return t.then(e=>{e instanceof IDBCursor&&ne.set(e,n)}).catch(()=>{}),Ct.set(t,n),t}function qe(n){if(Et.has(n))return;const t=new Promise((e,r)=>{const a=()=>{n.removeEventListener("complete",s),n.removeEventListener("error",i),n.removeEventListener("abort",i)},s=()=>{e(),a()},i=()=>{r(n.error||new DOMException("AbortError","AbortError")),a()};n.addEventListener("complete",s),n.addEventListener("error",i),n.addEventListener("abort",i)});Et.set(n,t)}let Wt={get(n,t,e){if(n instanceof IDBTransaction){if(t==="done")return Et.get(n);if(t==="objectStoreNames")return n.objectStoreNames||ae.get(n);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return Q(n[t])},set(n,t,e){return n[t]=e,!0},has(n,t){return n instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in n}};function Ve(n){Wt=n(Wt)}function Qe(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const r=n.call(Ft(this),t,...e);return ae.set(r,t.sort?t.sort():[t]),Q(r)}:Be().includes(n)?function(...t){return n.apply(Ft(this),t),Q(ne.get(this))}:function(...t){return Q(n.apply(Ft(this),t))}}function Xe(n){return typeof n=="function"?Qe(n):(n instanceof IDBTransaction&&qe(n),$e(n,He())?new Proxy(n,Wt):n)}function Q(n){if(n instanceof IDBRequest)return Ye(n);if(kt.has(n))return kt.get(n);const t=Xe(n);return t!==n&&(kt.set(n,t),Ct.set(t,n)),t}const Ft=n=>Ct.get(n);function lt(n,t,{blocked:e,upgrade:r,blocking:a,terminated:s}={}){const i=indexedDB.open(n,t),o=Q(i);return r&&i.addEventListener("upgradeneeded",l=>{r(Q(i.result),l.oldVersion,l.newVersion,Q(i.transaction),l)}),e&&i.addEventListener("blocked",l=>e(l.oldVersion,l.newVersion,l)),o.then(l=>{s&&l.addEventListener("close",()=>s()),a&&l.addEventListener("versionchange",c=>a(c.oldVersion,c.newVersion,c))}).catch(()=>{}),o}function Ut(n,{blocked:t}={}){const e=indexedDB.deleteDatabase(n);return t&&e.addEventListener("blocked",r=>t(r.oldVersion,r)),Q(e).then(()=>{})}const Ke=["get","getKey","getAll","getAllKeys","count"],Ge=["put","add","delete","clear"],Jt=new Map;function se(n,t){if(!(n instanceof IDBDatabase&&!(t in n)&&typeof t=="string"))return;if(Jt.get(t))return Jt.get(t);const e=t.replace(/FromIndex$/,""),r=t!==e,a=Ge.includes(e);if(!(e in(r?IDBIndex:IDBObjectStore).prototype)||!(a||Ke.includes(e)))return;const s=async function(i,...o){const l=this.transaction(i,a?"readwrite":"readonly");let c=l.store;return r&&(c=c.index(o.shift())),(await Promise.all([c[e](...o),a&&l.done]))[0]};return Jt.set(t,s),s}Ve(n=>({...n,get:(t,e,r)=>se(t,e)||n.get(t,e,r),has:(t,e)=>!!se(t,e)||n.has(t,e)}));const D={name:"bd-queue",store:"jobs",timeIndex:"time",objectIndex:"object"};var y=(n=>(n.Pending="pending",n.Completed="completed",n.Failed="failed",n.Conflict="conflict",n))(y||{}),J=(n=>(n.Success="success",n.Exception="exception",n.Failed="failed",n.Conflict="conflict",n))(J||{}),_=(n=>(n.Add="add",n.Edit="edit",n.Delete="delete",n))(_||{}),q="SharedWorker"in globalThis,Ze=class{constructor(n){m(this,"ActualWorker");this.ActualWorker=n}get onmessage(){var n;return q?(n=this.ActualWorker)==null?void 0:n.port.onmessage:this.ActualWorker.onmessage}set onmessage(n){q?this.ActualWorker.port.onmessage=n:this.ActualWorker.onmessage=n}get onmessageerror(){var n;return q?(n=this.ActualWorker)==null?void 0:n.port.onmessageerror:this.ActualWorker.onmessageerror}set onmessageerror(n){q?this.ActualWorker.port.onmessageerror=n:this.ActualWorker.onmessageerror=n}start(){var n;if(q)return(n=this.ActualWorker)==null?void 0:n.port.start()}postMessage(n,t){var e;return q?(e=this.ActualWorker)==null?void 0:e.port.postMessage(n,t):this.ActualWorker.postMessage(n,t)}terminate(){var n;return q?(n=this.ActualWorker)==null?void 0:n.port.close():this.ActualWorker.terminate()}close(){return this.terminate()}get port(){return q?this.ActualWorker.port:this.ActualWorker}get onerror(){return this.ActualWorker.onerror}set onerror(n){this.ActualWorker.onerror=n}addEventListener(n,t,e){var r;return q&&n!=="error"?(r=this.ActualWorker)==null?void 0:r.port.addEventListener(n,t,e):this.ActualWorker.addEventListener(n,t,e)}removeEventListener(n,t,e){var r;return q&&n!=="error"?(r=this.ActualWorker)==null?void 0:r.port.removeEventListener(n,t,e):this.ActualWorker.removeEventListener(n,t,e)}dispatchEvent(n){return this.ActualWorker.dispatchEvent(n)}},tr=class extends Ze{constructor(n,t){let e;q?e=new SharedWorker(n,t):e=new Worker(n,t),super(e)}};function er(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ie={};/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */(function(n){(function(t){t(typeof DO_NOT_EXPORT_CRC>"u"?n:{})})(function(t){t.version="1.2.2";function e(){for(var w=0,$=new Array(256),b=0;b!=256;++b)w=b,w=w&1?-306674912^w>>>1:w>>>1,w=w&1?-306674912^w>>>1:w>>>1,w=w&1?-306674912^w>>>1:w>>>1,w=w&1?-306674912^w>>>1:w>>>1,w=w&1?-306674912^w>>>1:w>>>1,w=w&1?-306674912^w>>>1:w>>>1,w=w&1?-306674912^w>>>1:w>>>1,w=w&1?-306674912^w>>>1:w>>>1,$[b]=w;return typeof Int32Array<"u"?new Int32Array($):$}var r=e();function a(w){var $=0,b=0,O=0,z=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(O=0;O!=256;++O)z[O]=w[O];for(O=0;O!=256;++O)for(b=w[O],$=256+O;$<4096;$+=256)b=z[$]=b>>>8^w[b&255];var W=[];for(O=1;O!=16;++O)W[O-1]=typeof Int32Array<"u"?z.subarray(O*256,O*256+256):z.slice(O*256,O*256+256);return W}var s=a(r),i=s[0],o=s[1],l=s[2],c=s[3],u=s[4],d=s[5],h=s[6],f=s[7],g=s[8],v=s[9],M=s[10],x=s[11],j=s[12],U=s[13],it=s[14];function Gt(w,$){for(var b=$^-1,O=0,z=w.length;O<z;)b=b>>>8^r[(b^w.charCodeAt(O++))&255];return~b}function ns(w,$){for(var b=$^-1,O=w.length-15,z=0;z<O;)b=it[w[z++]^b&255]^U[w[z++]^b>>8&255]^j[w[z++]^b>>16&255]^x[w[z++]^b>>>24]^M[w[z++]]^v[w[z++]]^g[w[z++]]^f[w[z++]]^h[w[z++]]^d[w[z++]]^u[w[z++]]^c[w[z++]]^l[w[z++]]^o[w[z++]]^i[w[z++]]^r[w[z++]];for(O+=15;z<O;)b=b>>>8^r[(b^w[z++])&255];return~b}function as(w,$){for(var b=$^-1,O=0,z=w.length,W=0,Zt=0;O<z;)W=w.charCodeAt(O++),W<128?b=b>>>8^r[(b^W)&255]:W<2048?(b=b>>>8^r[(b^(192|W>>6&31))&255],b=b>>>8^r[(b^(128|W&63))&255]):W>=55296&&W<57344?(W=(W&1023)+64,Zt=w.charCodeAt(O++)&1023,b=b>>>8^r[(b^(240|W>>8&7))&255],b=b>>>8^r[(b^(128|W>>2&63))&255],b=b>>>8^r[(b^(128|Zt>>6&15|(W&3)<<4))&255],b=b>>>8^r[(b^(128|Zt&63))&255]):(b=b>>>8^r[(b^(224|W>>12&15))&255],b=b>>>8^r[(b^(128|W>>6&63))&255],b=b>>>8^r[(b^(128|W&63))&255]);return~b}t.table=r,t.bstr=Gt,t.buf=ns,t.str=as})})(ie);function G(){return Math.floor((new Date().getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3)}function et(n){return G().toString(36)+"-"+ie.str(JSON.stringify(n)).toString(36)}function oe(n){return new Promise(t=>{setTimeout(t,n)})}class jt{static async send(t,e){try{const r=new URL(t.url).origin!==self.location.origin?"?enableCors=1":"",a=await globalThis.fetch(t.url+"/api/post.json"+r,{method:"POST",headers:{"Content-Type":"application/json",...e??{}},body:JSON.stringify([t.transaction])});if(!a.ok)throw new Error(`HTTP request failed with status ${a.status}`+(a.statusText?`: ${a.statusText}`:""));const s=await a.json();if(!s||!s.results)throw new Error("No response returned!");const i=s.results[t.transaction.hash];if(!i)throw new Error("No result returned for this job!");if(i.s||i.s0||i.s1||i.n)return{status:J.Success};if(i.conflict){const o=Object.keys(t.transaction.data)[0],l=i.conflict[o];if(!l)throw new Error("No previous value found in conflict result!");return{status:J.Conflict,message:l}}else if(i.e)return{status:J.Failed,message:i.e};return{status:J.Exception,message:s.error??(Array.isArray(s.errors)?s.errors.map(o=>(o==null?void 0:o.message)??o).join(" | "):"Unknown error!")}}catch(r){return{status:J.Exception,message:r.message}}}}var bt=[],yt;class ce{constructor(t,e){m(this,"_db",null);m(this,"_currentTimestamp",null);m(this,"_localHeaders");m(this,"_postMessage");this._postMessage=t,this._localHeaders=e}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(D.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(D.store,t.id))}_sendJobEvent(t){if(typeof this._postMessage=="function")this._postMessage({data:{job:t}});else for(const e of bt)e==null||e.postMessage({job:t})}async _getNextJob(){var s;let t=null;const e=(s=this._db)==null?void 0:s.transaction(D.store,"readonly").store,r=this._currentTimestamp?IDBKeyRange.lowerBound(this._currentTimestamp,!0):null;let a=await(e==null?void 0:e.index(D.timeIndex).openCursor(r,"next"));for(;a;){if(a.value.status===y.Pending){t=a.value;break}a=await a.continue()}return this._currentTimestamp=(t==null?void 0:t.createdAt)??null,t}async _checkPriority(t){let e=!1;return t.attempts&&t.priority&&t.priority>1&&(e=t.attempts%t.priority!==0,e&&await this._updateJob({...t,attempts:t.attempts+1})),e}async _getPrecedingUnresolvedJobs(t){var o;const e=[],r=t.transaction.action===_.Edit?Object.keys(t.transaction.data)[0]:null,a=(o=this._db)==null?void 0:o.transaction(D.store,"readonly").store,s=IDBKeyRange.upperBound(t.createdAt,!0);let i=await(a==null?void 0:a.index(D.timeIndex).openCursor(s,"next"));for(;i;)i.value.status!==y.Completed&&i.value.url===t.url&&i.value.transaction.blitzID===t.transaction.blitzID&&(i.value.transaction.action!==_.Edit||t.transaction.action!==_.Edit||Object.keys(i.value.transaction.data)[0]===r)&&e.push(i.value),i=await i.continue();return e}async _checkPrecedingUnresolvedAddJob(t,e){let r=!1;if(e.length>0&&e[0].transaction.action===_.Add&&(r=!0,t.transaction.action===_.Delete))for(const a of[t,...e])await this._deleteJob(a);return r}async _checkPrecedingConflictEditJobs(t,e){let r=!1;if(e.find(s=>s.transaction.action===_.Edit&&s.status===y.Conflict)){r=!0;const s=await this._updateJob({...t,status:y.Conflict});this._sendJobEvent(s)}return r}async _checkPrecedingFailedEditJobs(t,e){var o,l;let r=!1;const a=e.filter(c=>c.transaction.action===_.Edit&&(c.status===y.Pending||c.status===y.Failed)),s=Object.keys(t.transaction.data)[0],i=((o=t.transaction.data)==null?void 0:o[s].new)!==void 0&&((l=t.transaction.data)==null?void 0:l[s].prev)!==void 0;return a.length>0&&i&&(r=!0,t.attempts||await this._editAttemptHandler(t,a)),r}async _mergeWithFutureEditJobs(t){var l,c,u;const e=[],r=Object.keys(t.transaction.data)[0],a=(l=this._db)==null?void 0:l.transaction(D.store,"readonly").store,s=IDBKeyRange.lowerBound(t.createdAt,!0);let i=await(a==null?void 0:a.index(D.timeIndex).openCursor(s,"next"));for(;i;)(i.value.status===y.Pending||i.value.status===y.Failed)&&i.value.url===t.url&&i.value.transaction.action===_.Edit&&i.value.transaction.blitzID===t.transaction.blitzID&&Object.keys(i.value.transaction.data)[0]===r&&e.push(i.value),i=await i.continue();var o=t;if(e.length>0){const d=e[e.length-1];if(d&&((c=d.transaction.data)==null?void 0:c[r].new)!==void 0&&((u=t.transaction.data)==null?void 0:u[r].prev)!==void 0){const h={[r]:{prev:t.transaction.data[r].prev,new:d.transaction.data[r].new}},f=new Date().getTime();o=await this._updateJob({...t,transaction:{...t.transaction,data:h,blitzstamp:G(),hash:et({...h,blitzID:t.transaction.blitzID,timestamp:f})},dataHistory:[...t.dataHistory??[],{timestamp:f,type:"worker-succeeding",data:t.transaction.data}]});for(const g of e)await this._deleteJob(g)}}return o}async _statusHandler(t,e){var r,a,s;if(e.status===J.Success){const i=await this._updateJob({...t,status:y.Completed});this._sendJobEvent(i)}else if(e.status===J.Exception)await this._updateJob({...t,status:y.Pending,attempts:t.attempts+1,priority:t.priority<5?t.priority+1:t.priority,message:e.message});else if(e.status===J.Failed)if(t.attempts>0){const i=await this._updateJob({...t,status:y.Failed,message:e.message});this._sendJobEvent(i)}else await this._updateJob({...t,status:y.Pending,attempts:t.attempts+1,message:e.message});else if(e.status===J.Conflict){const i=Object.keys(t.transaction.data)[0];if(((r=t.transaction.data)==null?void 0:r[i].prev)===((a=t.transaction.data)==null?void 0:a[i].new)||e.message===((s=t.transaction.data)==null?void 0:s[i].new)){const o=await this._updateJob({...t,status:y.Completed});this._sendJobEvent(o)}else{const o=await this._updateJob({...t,status:y.Conflict,message:e.message});this._sendJobEvent(o)}}}async _editAttemptHandler(t,e){var c,u,d,h,f;const r=Object.keys(t.transaction.data)[0],a=e[0];if(((c=a.transaction.data)==null?void 0:c[r].prev)===void 0)return;const s={[r]:{prev:a.transaction.data[r].prev,new:(u=t.transaction.data)==null?void 0:u[r].new}},i=new Date().getTime();var o={...t,transaction:{...t.transaction,data:s,blitzstamp:G(),hash:et({...s,blitzID:t.transaction.blitzID,timestamp:i})},dataHistory:[...t.dataHistory??[],{timestamp:i,type:"worker-attempt",data:t.transaction.data}]};let l;if(s[r].prev===s[r].new?l={status:J.Success}:l=await jt.send(o,this._localHeaders??yt),l.status===J.Success){o=await this._updateJob({...o,status:y.Completed});for(const g of e)await this._updateJob({...g,status:y.Completed});this._sendJobEvent(o)}else if(l.status===J.Exception||l.status===J.Failed)await this._updateJob({...t,status:a.status,attempts:t.attempts+1,message:l.message});else if(l.status===J.Conflict)if(((d=o.transaction.data)==null?void 0:d[r].prev)===((h=o.transaction.data)==null?void 0:h[r].new)||l.message===((f=o.transaction.data)==null?void 0:f[r].new)){o=await this._updateJob({...o,status:y.Completed});for(const g of e)await this._updateJob({...g,status:y.Completed});this._sendJobEvent(o)}else{o=await this._updateJob({...o,status:y.Conflict,message:l.message});for(const g of e)await this._deleteJob(g);this._sendJobEvent(o)}}async start(){var r,a;for(this._db=await lt(D.name,1);;){try{var t=await this._getNextJob();if(!t)throw new Error("SKIP");if(await this._checkPriority(t))throw new Error("SKIP");var e=[];if((t.transaction.action===_.Edit||t.transaction.action===_.Delete)&&(e=await this._getPrecedingUnresolvedJobs(t),await this._checkPrecedingUnresolvedAddJob(t,e)))throw new Error("SKIP");if(t.transaction.action===_.Edit){if(await this._checkPrecedingConflictEditJobs(t,e))throw new Error("SKIP");if(await this._checkPrecedingFailedEditJobs(t,e))throw new Error("SKIP");t=await this._mergeWithFutureEditJobs(t);const c=Object.keys(t.transaction.data)[0];if(((r=t.transaction.data)==null?void 0:r[c].prev)!==void 0&&((a=t.transaction.data)==null?void 0:a[c].new)!==void 0&&t.transaction.data[c].prev===t.transaction.data[c].new){const u={status:J.Success};throw await this._statusHandler(t,u),new Error("SKIP")}}const i=await jt.send(t,this._localHeaders??yt);await this._statusHandler(t,i)}catch(s){if(s.message!=="SKIP"){console.error(s.stack);break}}await new Promise(s=>setTimeout(s,1e3))}this._db&&this._db.close(),this.start()}}function ue(n){bt.push(n),n.onmessage=function(t){t.data.type==="close"?bt=bt.filter(e=>e!==n):t.data.type==="headers"&&!yt&&t.data.data&&(yt=t.data.data)}}("SharedWorkerGlobalScope"in self||"WorkerGlobalScope"in self)&&("SharedWorkerGlobalScope"in self?self.onconnect=n=>ue(n.ports[0]):ue(self),new ce().start());class H{constructor(t){m(this,"action");m(this,"blitzstamp");m(this,"hash");m(this,"hashAlgo");m(this,"blitzID");m(this,"userhash");m(this,"model");m(this,"data");var e;this.action=t.action,this.blitzstamp=t.blitzstamp??G(),this.hash=t.hash??et(t.data===void 0?{blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}:{...t.data,blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}),this.hashAlgo=t.hashAlgo??"b-crc32",this.blitzID=t.blitzID??((e=t.data)==null?void 0:e._blitzID)??this.hash,this.model=t.model,this.data=t.data??{},this.userhash=t.userhash}toObject(){return{action:this.action,blitzstamp:this.blitzstamp,hash:this.hash,hashAlgo:this.hashAlgo,blitzID:this.blitzID,model:this.model,data:this.data,userhash:this.userhash}}clone(){return new H({action:this.action,model:this.model,blitzID:this.blitzID,blitzstamp:this.blitzstamp,data:this.data,hash:this.hash,hashAlgo:this.hashAlgo,userhash:this.userhash})}static fromObject(t){var e;return new H({action:t.action,blitzstamp:t.blitzstamp,hash:t.hash,hashAlgo:t.hashAlgo,blitzID:t.blitzID??((e=t.data)==null?void 0:e._blitzID)??t.blitzID,model:t.model,data:t.data,userhash:t.userhash})}}var C=(n=>(n.Success="success",n.Notice="notice",n.Error="error",n.Exception="exception",n))(C||{});class Y{constructor(t,e,r,a=null,s){m(this,"blitzID");m(this,"hash");m(this,"message");m(this,"conflict");m(this,"replicaUrl",null);m(this,"status");this.blitzID=t,this.hash=e,this.status=r,this.message=a,this.conflict=s}setReplicaUrl(t){this.replicaUrl=t}isConflict(){return typeof this.conflict<"u"&&this.conflict!==null}}class pt extends Array{get(t){return this.find(e=>e.hash===t)}has(t){return this.some(e=>e.hash===t)}isSuccessful(t){var e;if(t){const r=(e=this.get(t))==null?void 0:e.status;return r?r==="success"||r==="notice":!1}return this.every(r=>r.status)}isFailed(t){var e;if(t){const r=(e=this.get(t))==null?void 0:e.status;return r?r==="error":!0}return this.every(r=>!r.status)}successful(){return new pt(...this.filter(t=>t.status))}failed(){return new pt(...this.filter(t=>!t.status))}}class k{static createListEndpoint(t,e,r){var i;const a=`${k.sanitizeBaseUrl(t)}api/list/${e}.json`,s=new URLSearchParams;return new URL(t).origin!==window.location.origin&&s.append("enableCors","1"),s.append("fkOptions",JSON.stringify({_userID:"blitzID"})),(i=r.conditions)!=null&&i.length&&s.append("conditions",JSON.stringify(r.conditions)),r.limit&&s.append("limit",r.limit.toString()),r.customSort&&s.append("customSort",r.customSort),r.customSortDirection&&s.append("customSortDirection",r.customSortDirection),r.pagination&&s.append("pagination",r.pagination.toString()),r.var&&r.var.length>0&&s.append("var",JSON.stringify(r.var)),r.manyToMany&&s.append("manyToMany",r.manyToMany),`${a}?${s.toString()}`}static createGetEndpoint(t,e,r,a){const s=`${k.sanitizeBaseUrl(t)}api/list/${e}/_blitzID/${r}.json`,i=new URLSearchParams;return new URL(t).origin!==window.location.origin&&i.append("enableCors","1"),i.append("fkOptions",JSON.stringify({_userID:"blitzID"})),a.var&&a.var.length>0&&i.append("var",JSON.stringify(a.var)),a.manyToMany&&i.append("manyToMany",a.manyToMany),`${s}?${i.toString()}`}static createPostEndpoint(t){return`${k.sanitizeBaseUrl(t)}api/post.json`}static createPingEndpoint(t){return`${k.sanitizeBaseUrl(t)}api/ping.json`}static createListLogsEndpoint(t){var s,i;const e=t.type==="delete"?"listDeletedLogs":"listLogs",r=t.model?`${k.sanitizeBaseUrl(t.baseUrl)}api/${e}/${t.model}.json`:`${k.sanitizeBaseUrl(t.baseUrl)}api/${e}.json`,a=new URLSearchParams;return((s=t.query)==null?void 0:s.from)!==void 0&&a.append("from",t.query.from.toString()),(i=t.query)!=null&&i.models&&!t.model&&a.append("models",JSON.stringify(t.query.models)),`${r}?${a.toString()}`}static createUploaderEndpoint(t){const e=new URL(t).origin!==window.location.origin?"?enableCors=1":"";return`${k.sanitizeBaseUrl(t)}uploader/index`+e}static createVideoUploaderEndpoint(t,e){const r=new URL(t).origin!==window.location.origin?"?enableCors=1":"",a=(r?r+"&":"?")+`filename=${e}`;return`${k.sanitizeBaseUrl(t)}uploadervideo/index`+a}static createFileUploaderEndpoint(t){const e=new URL(t).origin!==window.location.origin?"?enableCors=1":"";return`${k.sanitizeBaseUrl(t)}uploaderfile/index`+e}static sanitizeBaseUrl(t){const e=new URL(t);if(!e.origin||!e.pathname||!e.protocol.match(/^https?:$/))throw new Error(`Supplied base URL is invalid: ${t}`);return e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),e.toString()}}class rt{static async list(t,e){if(!t.endpoint&&!t.fullUrl)throw new Error("Either baseUrl or fullUrl must be provided.");const r=await S.create().url(t.fullUrl?t.fullUrl:k.createListEndpoint(t.endpoint.baseUrl,t.endpoint.modelName,t.endpoint.query)).signal(e).get();if(!Array.isArray(r.items)&&Array.isArray(r.errors))throw new Error(r.errors.map(a=>(a==null?void 0:a.message)??a).join(" | "));return r.items??[]}static async get(t,e){const r=await S.create().url(k.createGetEndpoint(t.baseUrl,t.modelName,t.blitzID,t.query)).signal(e).get();if(!Array.isArray(r.items)&&Array.isArray(r.errors))throw new Error(r.errors.map(a=>(a==null?void 0:a.message)??a).join(" | "));return r.items??[]}static async post(t){const e=await S.create().url(k.createPostEndpoint(t.baseUrl)).body(t.transactions).post();if((typeof e.error=="string"||e.errors instanceof Array)&&!(e.results instanceof Object))throw new Error(e.error??e.errors.join(" | "));return e}static async listLogs(t){const e=await S.create().url(k.createListLogsEndpoint(t)).get();if(!(e.transactions instanceof Array)&&(typeof e.error=="string"||e.errors instanceof Array))throw new Error(e.error??e.errors.map(r=>(r==null?void 0:r.message)??r).join(" | "));return{transactions:e.transactions,userID:e.userID,userhash:e.userhash,lastTimestamp:e.lastTimestamp}}static upload(t){const e=new FormData;return e.append("image",t.image),S.create().url(k.createUploaderEndpoint(t.baseUrl)).body(e).header("Accept","application/json").post()}static async uploadVideo(t){const e=new FormData;e.append("fileToUpload",t.video);const r=t.video.name.split("."),a=r.length>1?"."+r.pop():"",s=crypto.randomUUID()+a,i=await S.create().url(k.createVideoUploaderEndpoint(t.baseUrl,s)).body(e).header("Accept","application/json").post();if(!i||!i.s)throw new Error("Video upload failed: "+((i==null?void 0:i.error)??"Unknown error!"));return{url:i.url.video,thumbnail:i.url.thumb,"tn-oq":i.url.tnoq}}static async uploadFile(t){const e=new FormData;e.append("files[]",t.file);const r=await S.create().url(k.createFileUploaderEndpoint(t.baseUrl)).body(e).header("Accept","application/json").post();if(!r||!r.s)throw new Error("File upload failed: "+((r==null?void 0:r.error)??"Unknown error!"));return{url:r.files.url}}static async ping({baseUrl:t}){return await S.create().url(k.createPingEndpoint(t)).get()}}class Lt{constructor(){m(this,"_query");m(this,"_model");m(this,"_type")}static create(){return new Lt}query(t){return this._query=t,this}model(t){return this._model=t,this}type(t){return this._type=t,this}async perform(){const t=p.clusterManager.toArray().map(a=>a.getNextReadURL()),e=await Promise.all(t.map(a=>rt.listLogs({baseUrl:a,query:this._query,model:this._model,type:this._type})));return{transactions:[].concat(...e.map(a=>a.transactions)).filter((a,s,i)=>i.findIndex(o=>o.hash===a.hash)===s).filter(a=>typeof a=="object"&&!Array.isArray(a)),userID:e[0].userID,userhash:e[0].userhash,lastTimestamp:e[0].lastTimestamp}}}class Nt{async ping(){const t=await this.openConnection(),e=["sync_transactions","evaluated_transactions"];for(const r of e)if(!t.objectStoreNames.contains(r))return t.close(),console.log(`There's missing stores, recreating the database. Available stores: ${t.objectStoreNames}`),await Ut("db_master"),await this.ping();t.close()}async openConnection(){return await lt("db_master",1,{upgrade:(t,e,r,a,s)=>{r===1&&(t.createObjectStore("sync_transactions",{autoIncrement:!1,keyPath:"hash"}),t.createObjectStore("evaluated_transactions",{autoIncrement:!1,keyPath:"hash"}))}})}}class P{static getKey(t){return`BlitzData.${t}`}static get(t){return localStorage.getItem(this.getKey(t))}static set(t,e){localStorage.setItem(this.getKey(t),e)}static has(t){return Object.hasOwn(localStorage,this.getKey(t))}static remove(t){localStorage.removeItem(this.getKey(t))}static clear(){const t=Object.keys(localStorage);for(const e of t)e.startsWith("BlitzData.")&&localStorage.removeItem(e)}static getLastSyncedAt(t){const e=this.get(t?`${t}.lastSyncedAt`:"lastSyncedAt");return e?parseInt(e):null}static setLastSyncedAt(t,e){this.set(e?`${e}.lastSyncedAt`:"lastSyncedAt",t.toString())}static getCurrentUser(){const t=this.get("currentUser");return t?JSON.parse(t):null}static setCurrentUser(t){t?this.set("currentUser",JSON.stringify(t)):this.remove("currentUser")}static getProjectUsers(t){const e=this.get("projectUsers."+t);return e?JSON.parse(e):null}static setProjectUsers(t,e){const r="projectUsers."+t;e?this.set(r,JSON.stringify(e)):this.remove(r)}static getDatabases(){return JSON.parse(this.get("databases")??"[]")}static setDatabases(t){this.set("databases",JSON.stringify(t))}static getListCallLastTimeStamp(t){const e=this.get(`cache.listCall.${t}.lastTimeStamp`);return e?Number(e):null}static setListCallLastTimeStamp(t,e){this.set(`cache.listCall.${t}.lastTimeStamp`,String(e))}}class vt{constructor(){m(this,"client",new Nt)}static create(){return new vt}async all(){const t=await this.client.openConnection(),e=await t.getAll("sync_transactions");return t.close(),e}async put(t){const e=await this.client.openConnection();await e.put("sync_transactions",t),e.close()}async putMultiple(t){for(const e of t)await this.put(e)}async delete(t){const e=await this.client.openConnection();await e.delete("sync_transactions",t),e.close()}}class dt{static create(){return new dt}async run(t,e){if(!navigator.onLine)return;const r=p.options.sync.startDate instanceof Date&&t!=="_Model"?Math.floor(p.options.sync.startDate.getTime()/1e3):0,a=P.getLastSyncedAt(t)??r,{transactions:s,lastTimestamp:i}=await Lt.create().type(e).query({from:a,models:t?[t]:p.options.sync.models??["_Project",...(await R.list()).map(l=>l.getName()).filter(l=>l.startsWith("bdt")&&!["bdt24prszej_appfiles","bdt24prszej_apps"].includes(l))]}).perform(),o=vt.create();await o.putMultiple(s),P.setLastSyncedAt(i??Math.floor(Date.now()/1e3),t),await V.create().run((await o.all()).map(l=>H.fromObject(l))),a!==i&&await this.run(t,e)}async runAtInterval(t){for(;;)await oe(t),await this.run()}}class V{static create(){return new V}async run(t){const e=new pt,r=vt.create(),a={add:1,edit:2,delete:3},s=await new Nt().openConnection();t=t.sort((i,o)=>a[i.action]-a[o.action]);for(const i of t){let o;i.model==="@Model"?i.model="_Model":i.model==="@Project"&&(i.model="_Project");try{if(i.action==="add")o=await this.processAddTransaction(i);else if(i.action==="edit")o=await this.processEditTransaction(i,s);else if(i.action==="delete")o=await this.processDeleteTransaction(i);else throw new Error(`Unknown action "${i.action}" on transaction ${i.hash}`);await s.put("evaluated_transactions",i.toObject())}catch(l){o=new Y(i.blitzID,i.hash,C.Error,l.message)}e.push(o),await r.delete(i.hash)}return s.close(),e}async processAddTransaction(t){var i;const e=await R.get(t.model),r=e.idbClient();if(await r.find(t.hash))return new Y(t.hash,t.hash,C.Error,`Object with ${t.hash} already exists on ${t.model} model.`);const a=e.getClusterManager(),s={_blitzID:t.hash,_blitzstamp:t.blitzstamp.toString(),_sort:t.blitzstamp.toString(),_clusters:a.names(),_editURLs:a.toArray().map(o=>o.options.addURL).flat(),...(()=>{const o={};for(const[l,c]of Object.entries(t.data)){const u=e.getAttributeDetails(l);if(u&&Array.isArray(u.type)&&c!==void 0){const d=typeof c=="string"?JSON.parse(c):c;l.endsWith("_mtm")?o[l]=d.map((f,g)=>({_blitzID:typeof f=="string"?f:f._blitzID,_mtmSort:typeof f=="string"?(d.length-g)*15:f._mtmSort})):o[l]=d}else o[l]=c}return o})()};if(((i=e.haspublishingdate)==null?void 0:i.value)==="1"&&typeof t.data._publishingdate>"u"&&typeof t.blitzstamp=="number"){const o=new Date;o.setTime(t.blitzstamp*1e3+new Date("2021-01-01T00:00:00Z").getTime()),o.setMinutes(o.getMinutes()-o.getTimezoneOffset()),s._publishingdate=o.toISOString().slice(0,19).replace("T"," ")}return!s._userID&&t.userhash&&(s._userID=t.userhash),t.data=s,await r.create(s),new Y(t.hash,t.hash,C.Success)}async processEditTransaction(t,e){var c;const r=await R.get(t.model),a=r.idbClient(),s=Object.keys(t.data);if(s.length!==1)return new Y(t.blitzID,t.hash,C.Error,s.length>1?"Can not edit more than one attribute at once.":"Attribute not provided to perform edit.");if(await e.get("evaluated_transactions",t.hash))return new Y(t.blitzID,t.hash,C.Notice,`Transaction ${t.hash} already processed.`);const i=await a.find(t.blitzID);if(!i)return new Y(t.blitzID,t.hash,C.Notice,`Object with ${t.blitzID} does not exists.`);if(i._savetimestamp&&i._savetimestamp>t.blitzstamp)return new Y(t.blitzID,t.hash,C.Notice,"Old transaction.");const o=s.shift(),l=(c=r.getAttributeDetails(o))==null?void 0:c.type;if(Array.isArray(l))if(Object.hasOwn(t.data[o],"add")){i[o]=Array.isArray(i[o])?i[o]:[];const u=t.data[o].add;o.endsWith("_mtm")?i[o].push({_blitzID:typeof u=="string"?u:u._blitzID,_mtmSort:typeof u=="string"?i[o].length?Math.max(...i[o].map(h=>h._mtmSort))+15:15:u._mtmSort}):i[o].push(u)}else if(Object.hasOwn(t.data[o],"remove")&&Array.isArray(i[o])){const u=t.data[o].remove;o.endsWith("_mtm")?i[o].splice(i[o].findIndex(h=>h._blitzID===u),1):i[o].splice(i[o].findIndex(h=>h===u),1)}else return new Y(t.blitzID,t.hash,C.Error,`Invalid operation for array attribute ${o}.`);else{const u=t.data[o];if(i[o]===u.new)return new Y(t.blitzID,t.hash,C.Notice,"Conflict");i[o]=u.new}return await a.update(i),new Y(t.blitzID,t.hash,C.Success)}async processDeleteTransaction(t){const r=(await R.get(t.model)).idbClient();return await r.find(t.blitzID)?(await r.delete(t.blitzID),new Y(t.blitzID,t.hash,C.Success)):new Y(t.blitzID,t.hash,C.Error,`Object with ${t.blitzID} does not exists.`)}}class rr{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(D.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(D.store,t.id))}async _getCompletedReplicatedJobs(t){var s;const e=[],r=(s=this._db)==null?void 0:s.transaction(D.store,"readonly").store;let a=await(r==null?void 0:r.openCursor(null,"next"));for(;a;)a.value.status===y.Completed&&a.value.url!==t.url&&a.value.transaction.action===_.Edit&&a.value.transaction.blitzID===t.transaction.blitzID&&a.value.transaction.hash===t.transaction.hash&&e.push(a.value),a=await a.continue();return e}async _getFutureJobs(t,e){var o;const r=[],a=(o=this._db)==null?void 0:o.transaction(D.store,"readonly").store,s=IDBKeyRange.lowerBound(t.createdAt,!0);let i=await(a==null?void 0:a.index(D.timeIndex).openCursor(s,"next"));for(;i;)i.value.status===y.Conflict&&i.value.url===t.url&&i.value.transaction.action===_.Edit&&i.value.transaction.blitzID===t.transaction.blitzID&&Object.keys(i.value.transaction.data)[0]===e&&r.push(i.value),i=await i.continue();return r}async _mergeWithFutureEditJobs(t,e){var s,i;const r=await this._getFutureJobs(t,e);let a=t;if(r.length>0){const o=r[r.length-1];if(o&&((s=o.transaction.data)==null?void 0:s[e].new)!==void 0&&((i=t.transaction.data)==null?void 0:i[e].prev)!==void 0){const l={[e]:{prev:t.transaction.data[e].prev,new:o.transaction.data[e].new}},c=new Date().getTime();a=await this._updateJob({...t,transaction:{...t.transaction,data:l,blitzstamp:G(),hash:et({...l,blitzID:t.transaction.blitzID,timestamp:c})},dataHistory:[...t.dataHistory??[],{timestamp:c,type:"conflict-succeeding",data:t.transaction.data}]});for(const u of r)await this._deleteJob(u)}}return a}async prompt(t){var s;if(t.message===void 0)return;const e=Object.keys(t.transaction.data)[0];let r=await this._mergeWithFutureEditJobs(t,e);const a=`There was a conflict.
The data got changed to "${r.message}".
Do you still want to perform your change to "${(s=r.transaction.data)==null?void 0:s[e].new}"?`;confirm(a)?(r=await this.force(r),await p.queue.updateSyncStatus(r,y.Pending)):(await this.revert(r),await p.queue.updateSyncStatus(r,y.Completed)),p.dispatchEvent("queue:conflict",r)}async force(t){var o;const e=Object.keys(t.transaction.data)[0],r=await this._getFutureJobs(t,e),a={[e]:{prev:t.message,new:(o=t.transaction.data)==null?void 0:o[e].new}},s=new Date().getTime(),i=await this._updateJob({...t,status:y.Pending,transaction:{...t.transaction,data:a,blitzstamp:G(),hash:et({...a,blitzID:t.transaction.blitzID,timestamp:s})},dataHistory:[...t.dataHistory??[],{timestamp:s,type:"conflict-force",data:t.transaction.data}]});await V.create().run([new H({action:"edit",model:i.transaction.model,blitzID:i.transaction.blitzID,data:i.transaction.data})]);for(const l of r)await this._updateJob({...l,status:y.Pending});return i}async revert(t){var i;const e=Object.keys(t.transaction.data)[0],r=new H({action:"edit",model:t.transaction.model,blitzID:t.transaction.blitzID,data:{[e]:{prev:(i=t.transaction.data)==null?void 0:i[e].new,new:t.message}}});await V.create().run([r]);const a=await this._getFutureJobs(t,e),s=await this._getCompletedReplicatedJobs(t);for(const o of[t,...a])await this._deleteJob(o);if(s.length>0){const o=s.map(l=>l.url).filter((l,c,u)=>u.findIndex(d=>d===l)===c);for(const l of o)await p.queue.addJob(l,r.toObject())}}}class nr{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(D.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(D.store,t.id))}async _getFutureJobs(t){var i;const e=[],r=(i=this._db)==null?void 0:i.transaction(D.store,"readonly").store,a=IDBKeyRange.lowerBound(t.createdAt,!0);let s=await(r==null?void 0:r.index(D.timeIndex).openCursor(a,"next"));for(;s;)s.value.url===t.url&&s.value.transaction.blitzID===t.transaction.blitzID&&e.push(s.value),s=await s.continue();return e}async retry(t){for(const e of t)await this._updateJob({...e,status:y.Pending})}async revert(t){var r,a;t.sort((s,i)=>s.createdAt-i.createdAt);const e=t[0];if(e){if(e.transaction.action===_.Add){await V.create().run([new H({action:"delete",model:e.transaction.model,blitzID:e.transaction.blitzID})]);const s=await this._getFutureJobs(e);for(const i of[e,...s])await this._deleteJob(i)}else if(e.transaction.action===_.Delete)await this._deleteJob(e),await R.get(e.transaction.model).then(s=>s==null?void 0:s.get(e.transaction.blitzID));else if(e.transaction.action===_.Edit){const s=Object.keys(e.transaction.data??{})[0];if(!s||((r=e.transaction.data)==null?void 0:r[s].new)===void 0||((a=e.transaction.data)==null?void 0:a[s].prev)===void 0)return;const i=new H({action:"edit",model:e.transaction.model,blitzID:e.transaction.blitzID,data:{[s]:{prev:e.transaction.data[s].new,new:e.transaction.data[s].prev}}});await V.create().run([i]);for(const o of t)await this._deleteJob(o)}}}async getAll(){var a;const t={},e=(a=this._db)==null?void 0:a.transaction(D.store,"readonly").store;let r=await(e==null?void 0:e.index(D.timeIndex).openCursor(null,"next"));for(;r;){if(r.value.status!==y.Completed){if(t[r.value.url]||(t[r.value.url]=[]),r.value.transaction.action===_.Add||r.value.transaction.action===_.Delete)t[r.value.url].push([r.value]);else if(r.value.transaction.action===_.Edit){const s=Object.keys(r.value.transaction.data??{})[0],i=r.value.transaction.blitzID,o=t[r.value.url].findIndex(l=>l[0].transaction.action===_.Edit&&l[0].transaction.blitzID===i&&Object.keys(l[0].transaction.data??{})[0]===s);o===-1?t[r.value.url].push([r.value]):t[r.value.url][o].push(r.value)}}r=await r.continue()}return t}}class ar{constructor(){m(this,"_db",null);m(this,"conflictHandler",null);m(this,"failedHandler",null)}_handleWorkerMessage(t){var r;const e=t.data.job;e.status===y.Completed?p.dispatchEvent("queue:success",e):e.status===y.Failed?p.dispatchEvent("queue:failure",e):e.status===y.Conflict&&(document.hidden||(r=p.queue.conflictHandler)==null||r.prompt(e)),p._Model.get(e.transaction.model).then(a=>{var s;return(s=a==null?void 0:a.memoryClient().get(e.transaction.blitzID))==null?void 0:s.dispatchEvent("syncStatusChange",e)}),p.queue.updateSyncStatus(e)}async updateSyncStatus(t,e){if(t.transaction.action!==_.Edit)return;const r=await p._Model.get(t.transaction.model),a=r==null?void 0:r.memoryClient().get(t.transaction.blitzID);if(!a)return;const s=Object.keys(t.transaction.data??{})[0];if(!s)return;const i=a[s];if(!(!i||!Object.hasOwn(i,"_syncSignal")))if(e)i._syncSignal.set({status:e});else{const l=(await p.queue.getJobsForObject(t.transaction.blitzID)).filter(f=>{var g;return f.transaction.action===_.Edit&&((g=f.transaction.data)==null?void 0:g[s])!==void 0});let c=y.Pending,u;const d=l.find(f=>f.status===y.Failed),h=l.find(f=>f.status===y.Conflict);d?(c=y.Failed,u=d):h?(c=y.Conflict,u=h):l.every(f=>f.status===y.Completed)&&(c=y.Completed),i._syncSignal.set({status:c,job:u})}}async init(){if(this._db=await lt(D.name,1,{upgrade:e=>{const r=e.createObjectStore(D.store,{keyPath:"id"});r.createIndex(D.timeIndex,"createdAt"),r.createIndex(D.objectIndex,"transaction.blitzID")}}),!this._db.objectStoreNames.contains(D.store))return await Ut(D.name),await this.init();this.conflictHandler=new rr(this._db),this.failedHandler=new nr(this._db);const t=new tr(p.options.queue.workerPath,{name:"bd-queue-worker"});return t.onerror=()=>{console.warn("⚠️ Failed to run the queue's shared worker, please check that the worker path is correct, falling back to running on the same thread!"),new ce(e=>this._handleWorkerMessage(e),S._globalHeaders).start()},t.port.onmessage=this._handleWorkerMessage,window.addEventListener("beforeunload",()=>t.port.postMessage({type:"close"})),S._globalHeaders&&t.port.postMessage({type:"headers",data:S._globalHeaders}),this}async addJob(t,e){var a;const r={id:crypto.randomUUID(),url:t,transaction:e,status:y.Pending,createdAt:Date.now(),attempts:0,priority:1};await((a=this._db)==null?void 0:a.add(D.store,r)),await this.updateSyncStatus(r,r.status)}async deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(D.store,t.id))}async getJobs(){var t;return await((t=this._db)==null?void 0:t.getAll(D.store))}async getJobsForObject(t){var r;const e=await((r=this._db)==null?void 0:r.getAllFromIndex(D.store,D.objectIndex,t));return e.sort((a,s)=>a.createdAt-s.createdAt),e}}const ht={a:["à","á","â","ä"],c:["ç"],e:["è","é","ê"],o:["ö","ó","ò","ô","õ"],oe:["œ"],ss:["ß"],u:["ü"]};class _t{constructor(){m(this,"children");m(this,"isEndOfWord");m(this,"items");this.children={},this.isEndOfWord=!1,this.items=[]}}class sr{constructor(t,e){m(this,"root");if(this.root=new _t,!e)return;const r=this.getWordFrequency(t,e);for(const a in r)this.insert(a,r[a].items)}_loadFromJson(t,e){Object.keys(t).forEach(r=>{typeof t[r]=="string"||typeof t[r]=="boolean"||(e.children[r]||(e.children[r]=new _t),t[r].hasOwnProperty("isEndOfWord")&&t[r].isEndOfWord&&(e.children[r].isEndOfWord=!0,e.children[r].items=t[r].items),this._loadFromJson(t[r],e.children[r]))})}loadFromJson(t){return this.root=new _t,this._loadFromJson(t,this.root),this}toJson(){const t=e=>{let r={};for(const a in e.children)r[a]=t(e.children[a]);return e.isEndOfWord&&(r.isEndOfWord=!0,r.items=e.items),r};return t(this.root)}getWordFrequency(t,e){const r={},a=t.getAttributes();return e.forEach(s=>{a==null||a.forEach(i=>{if(!s[i])return;s[i].toString().toLowerCase().split(" ").forEach(l=>{l!==""&&(r[l]?r[l].items.push(s._blitzID):r[l]={items:[s._blitzID]})})})}),r}getVariants(t){const e=ht[t],r=[t];return e&&r.push(...e),r}generateAllPermutations(t,e,r,a,s){if(e===r.length){s.push(t);return}const i=r[e],o=e!==r.length-1?i+r[e+1]:void 0;if(!ht[i]&&!(o&&ht[o])){this.generateAllPermutations(t+i,e+1,r,a,s);return}if(ht[i]){const l=a[i];for(const c of l)this.generateAllPermutations(t+c,e+1,r,a,s)}if(o&&ht[o]){const l=a[o];for(const c of l)this.generateAllPermutations(t+c,e+2,r,a,s)}}normalizeQuery(t){const e=/u|e|a|o|c|ss|oe/g,r=t.toLowerCase().match(e);if(!r)return[t.toLowerCase()];const a={};r.forEach(i=>{a[i]=this.getVariants(i)});const s=[];return this.generateAllPermutations("",0,t,a,s),s}insert(t,e){let r=this.root;for(const a of t)r.children[a]||(r.children[a]=new _t),r=r.children[a];r.isEndOfWord=!0,r.items=e}addToSet(t,e){const r=this.normalizeQuery(t);for(const a of r)this._search(a).forEach(i=>{e.add(i)})}search(t){const e=t==null?void 0:t.toLowerCase().split(" ");let r=new Set;return this.addToSet(e[0],r),e.slice(1).forEach(a=>{const s=new Set;this.addToSet(a,s);for(const i of r)s.has(i)||r.delete(i)}),Array.from(r)}_search(t){let e=this.root;for(const a of t){if(!e.children[a])return[];e=e.children[a]}const r=[];return t===""?this.collectWords(e,"",r):this.collectWords(e,t,r),r}collectWords(t,e,r){t.isEndOfWord&&r.push(...t.items);for(const a in t.children){const s=t.children[a],i=e+a;this.collectWords(s,i,r)}}}function le(n,t,e){var a;let r=!0;for(const s of t){if(!r)return!1;const[i,o,l]=s,c=(a=e==null?void 0:e[i])==null?void 0:a.type;let u=n[i],d=l;switch(typeof u=="string"&&(c==="datetime"||c==="date"||i==="_publishingdate")&&(u=new Date(u).getTime()),typeof d=="string"&&(c==="datetime"||c==="date"||i==="_publishingdate")&&(d=new Date(d).getTime()),o){case"LIKE":const h=`${d}`.startsWith("%"),f=`${d}`.endsWith("%"),g=`${d}`.replaceAll("%","");h===f?r=`${u}`.includes(g):h?r=`${u}`.endsWith(g):f&&(r=`${u}`.startsWith(g));break;case"IN":r=(Array.isArray(d)?d:[d]).includes(u);break;case"=":r=u===d;break;case"!=":r=u!==d;break;case">":r=u>d;break;case"<":r=u<d;break;case">=":r=u>=d;break;case"<=":r=u<=d;break;default:r=!0;break}}return r}class ir{constructor(t){m(this,"model");this.model=t,this.ping()}async ping(){(await this.connect()).close()}async query(t,e){const r=await this.connect(),a=r.transaction("objects","readonly").store,s=Array.from(a.indexNames),i=t.customSort&&s.includes(t.customSort)?t.customSort:s.includes("_projectsort")&&(t.conditions??[]).find(f=>f[0]==="project_fk"&&f[1]==="=")?"_projectsort":s.includes("_sort")?"_sort":"_blitzstamp",o=t.customSortDirection==="ASC"?"next":"prev",l=t.pagination!==void 0?o==="next"?IDBKeyRange.lowerBound(t.pagination.toString(),!0):IDBKeyRange.upperBound(t.pagination.toString(),!0):null;let c=await a.index(i).openCursor(l,o);const u=this.model.getAttributesDetails()??void 0;let d=[];for(;c;){if(e&&!e.includes(c.value.blitzID)){c=await c.continue();continue}if(le(c.value,t.conditions??[],u)&&(d.push(c.value),t.limit&&d.length>=t.limit))break;c=await c.continue()}if(r.close(),t.var&&t.var.length>0){const f=["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var];for(const g of d)for(const v in g)f.includes(v)||delete g[v]}return d}async search(t,e){const r=await this.connect(),a=new sr(this.model).loadFromJson(r.get("tree",this.model.getName()));r.close();const s=a.search(t);return t!==""&&s.length===0?[]:this.query({conditions:e},s)}async save(t,e=!1){const r=await this.connect();for(const a of t){let s={...a};const i=await r.get("objects",s._blitzID);if(i)s={...i,...s};else if(e)continue;s._savetimestamp=G(),await r.put("objects",s)}r.close()}async connect(){var s,i;const t=this.model.getAttributesDetails(),e=["1",!0].includes((s=this.model._attributes.hassort)==null?void 0:s.value),r=e&&["1",!0].includes((i=this.model._attributes.hasprojects)==null?void 0:i.value);return await lt(this.model.getName(),1,{upgrade:(o,l,c,u,d)=>{const h=P.getDatabases();if(h.includes(o.name)||(h.push(o.name),P.setDatabases(h)),c!==1)return;o.createObjectStore("tree",{keyPath:"name"});const f=o.createObjectStore("objects",{keyPath:"_blitzID"});if(t)for(const g in t)(t[g].type==="date"||g.includes("_fk"))&&f.createIndex(g,g,{unique:!1});f.createIndex("_blitzstamp","_blitzstamp"),e&&f.createIndex("_sort","_sort"),r&&f.createIndex("_projectsort","_projectsort")}})}async find(t){const e=await this.connect(),r=e.get("objects",t);return e.close(),r}async create(t){const e=await this.connect();await e.put("objects",t),e.close()}async update(t){const e=await this.connect();await e.put("objects",t),e.close()}async delete(t){const e=await this.connect();await e.delete("objects",t),e.close()}}class Rt{constructor(){m(this,"_subscribers");m(this,"_cleanUp",()=>{});this._subscribers=new Set}emit(t){for(const e of this._subscribers)e(t)}subscribe(t){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),()=>{this._subscribers.delete(t),this._cleanUp()}}filterPipe(t){const e=new Rt;return e._cleanUp=this.subscribe(r=>{t(r)&&e.emit(r)}),e}}const xt=class xt{constructor(t){m(this,"model");this.model=t,p.objects.has(this.model.getName())||p.objects.set(this.model.getName(),new Map)}getAll(){return p.objects.get(this.model.getName())}get(t){return this.getAll().get(t)}update(t){var s;const e=this.getAll();if(!e.has(t._blitzID.value))return e.set(t._blitzID.value,t),t;const r=e.get(t._blitzID.value),a=Object.keys(this.model.getAttributesDetails()??{});for(const i of a){const o=(s=t[i])==null?void 0:s._value;if(o!==void 0){const l=r[i];l&&(l._value=o,l._valueSignal.set(o,!1))}}return r}delete(t){const e=this.getAll();e.has(t)&&e.delete(t)}emit(t){xt.channel.emit(t)}async query(t={}){var d,h;const e=[],r=Array.from(this.getAll().values()).map(f=>f.toObject()),a=this.model.getAttributesDetails()??void 0,s=Object.keys(a??{}),i=["1",!0].includes((d=this.model._attributes.hassort)==null?void 0:d.value),o=i&&["1",!0].includes((h=this.model._attributes.hasprojects)==null?void 0:h.value),l=t.customSort&&s.includes(t.customSort)?t.customSort:o&&(t.conditions??[]).find(f=>f[0]==="project_fk"&&f[1]==="=")?"_projectsort":i?"_sort":"_blitzstamp",c=t.customSortDirection??"DESC";r.sort((f,g)=>{try{const v=parseInt(f[l]),M=parseInt(g[l]);if(v<M)return c==="ASC"?-1:1;if(v>M)return c==="ASC"?1:-1}catch{}return 0});for(const f of r){if(t.pagination!==void 0)try{const g=parseInt(f[l]);if(typeof g!="number"||(c==="ASC"?t.pagination>=g:t.pagination<=g))continue}catch{}if(le(f,t.conditions??[],a)&&(e.push(f),t.limit&&e.length>=t.limit))break}if(t.var&&t.var.length>0){const f=["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var];for(const g of e)for(const v in g)f.includes(v)||delete g[v]}return e}};m(xt,"channel",new Rt);let Dt=xt;class ft{constructor(t){m(this,"_value");m(this,"_subscribers");this._value=t,this._subscribers=new Set}get(){return this._value}set(t,e=!0){this._value!==t&&(this._value=t,e&&this.emit())}emit(){for(const t of this._subscribers)t(this._value)}subscribe(t,e=!0){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),e&&t(this._value),()=>this._subscribers.delete(t)}}class E{constructor(t,e,r){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(r),this._valueSignal=new ft(this._value),this._syncSignal=new ft(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}withValue(t){return this.value=t,this}withObject(t){return this._object=t,this}async edit(t,e){if(!this._object)throw new Error("Can not edit attribute, object is not set.");return this._object.edit(this._name,t,e)}subscribe(t,e=!0){var a,s;const r=this._valueSignal.subscribe(t,e);return this._value===void 0&&((s=(a=this._object)==null?void 0:a.model)==null||s.get({blitzID:this._object._blitzID.value,forceHttp:!0}).then(i=>{(i==null?void 0:i[this._name]._value)!==void 0&&this._valueSignal.emit()})),r}syncStatus(t){var a;const e=this._syncSignal.get()!==null,r=this._syncSignal.subscribe(t,e);return e||p.queue.getJobsForObject((a=this._object)==null?void 0:a._blitzID.value).then(s=>{const i=s.filter(d=>{var h;return d.transaction.action===_.Edit&&((h=d.transaction.data)==null?void 0:h[this._name])!==void 0});let o=y.Pending,l;const c=i.find(d=>d.status===y.Failed),u=i.find(d=>d.status===y.Conflict);c?(o=y.Failed,l=c):u?(o=y.Conflict,l=u):i.every(d=>d.status===y.Completed)&&(o=y.Completed),this._syncSignal.set({status:o,job:l},!1),t(this._syncSignal.get())}),r}getDetails(){var t,e;return((e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttributeDetails(this._name))||null}}class mt extends E{unserialize(t){return t}serialize(){return this._value}}class de extends E{unserialize(t){if(typeof t=="boolean")return t;if(typeof t=="string"&&["0","1"].includes(t))return t==="1";if(typeof t=="number"&&[0,1].includes(t))return t===1;if(t!==void 0)return null}serialize(){return typeof this._value=="boolean"?this._value?"1":"0":this._value}}const he=6048e5,or=864e5,Mt=43200,fe=1440,me=Symbol.for("constructDateFrom");function X(n,t){return typeof n=="function"?n(t):n&&typeof n=="object"&&me in n?n[me](t):n instanceof Date?new n.constructor(t):new Date(t)}function F(n,t){return X(t||n,n)}let cr={};function gt(){return cr}function wt(n,t){var o,l,c,u;const e=gt(),r=(t==null?void 0:t.weekStartsOn)??((l=(o=t==null?void 0:t.locale)==null?void 0:o.options)==null?void 0:l.weekStartsOn)??e.weekStartsOn??((u=(c=e.locale)==null?void 0:c.options)==null?void 0:u.weekStartsOn)??0,a=F(n,t==null?void 0:t.in),s=a.getDay(),i=(s<r?7:0)+s-r;return a.setDate(a.getDate()-i),a.setHours(0,0,0,0),a}function St(n,t){return wt(n,{...t,weekStartsOn:1})}function ge(n,t){const e=F(n,t==null?void 0:t.in),r=e.getFullYear(),a=X(e,0);a.setFullYear(r+1,0,4),a.setHours(0,0,0,0);const s=St(a),i=X(e,0);i.setFullYear(r,0,4),i.setHours(0,0,0,0);const o=St(i);return e.getTime()>=s.getTime()?r+1:e.getTime()>=o.getTime()?r:r-1}function It(n){const t=F(n),e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return e.setUTCFullYear(t.getFullYear()),+n-+e}function Ot(n,...t){const e=X.bind(null,n||t.find(r=>typeof r=="object"));return t.map(e)}function we(n,t){const e=F(n,t==null?void 0:t.in);return e.setHours(0,0,0,0),e}function ur(n,t,e){const[r,a]=Ot(e==null?void 0:e.in,n,t),s=we(r),i=we(a),o=+s-It(s),l=+i-It(i);return Math.round((o-l)/or)}function lr(n,t){const e=ge(n,t),r=X((t==null?void 0:t.in)||n,0);return r.setFullYear(e,0,4),r.setHours(0,0,0,0),St(r)}function Pt(n,t){const e=+F(n)-+F(t);return e<0?-1:e>0?1:e}function dr(n){return X(n,Date.now())}function hr(n){return n instanceof Date||typeof n=="object"&&Object.prototype.toString.call(n)==="[object Date]"}function fr(n){return!(!hr(n)&&typeof n!="number"||isNaN(+F(n)))}function mr(n,t,e){const[r,a]=Ot(e==null?void 0:e.in,n,t),s=r.getFullYear()-a.getFullYear(),i=r.getMonth()-a.getMonth();return s*12+i}function gr(n){return t=>{const r=(n?Math[n]:Math.trunc)(t);return r===0?0:r}}function wr(n,t){return+F(n)-+F(t)}function br(n,t){const e=F(n,t==null?void 0:t.in);return e.setHours(23,59,59,999),e}function yr(n,t){const e=F(n,t==null?void 0:t.in),r=e.getMonth();return e.setFullYear(e.getFullYear(),r+1,0),e.setHours(23,59,59,999),e}function pr(n,t){const e=F(n,t==null?void 0:t.in);return+br(e,t)==+yr(e,t)}function vr(n,t,e){const[r,a,s]=Ot(e==null?void 0:e.in,n,n,t),i=Pt(a,s),o=Math.abs(mr(a,s));if(o<1)return 0;a.getMonth()===1&&a.getDate()>27&&a.setDate(30),a.setMonth(a.getMonth()-i*o);let l=Pt(a,s)===-i;pr(r)&&o===1&&Pt(r,s)===1&&(l=!1);const c=i*(o-+l);return c===0?0:c}function _r(n,t,e){const r=wr(n,t)/1e3;return gr(e==null?void 0:e.roundingMethod)(r)}function Dr(n,t){const e=F(n,t==null?void 0:t.in);return e.setFullYear(e.getFullYear(),0,1),e.setHours(0,0,0,0),e}const Mr={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Sr=(n,t,e)=>{let r;const a=Mr[n];return typeof a=="string"?r=a:t===1?r=a.one:r=a.other.replace("{{count}}",t.toString()),e!=null&&e.addSuffix?e.comparison&&e.comparison>0?"in "+r:r+" ago":r};function K(n){return(t={})=>{const e=t.width?String(t.width):n.defaultWidth;return n.formats[e]||n.formats[n.defaultWidth]}}const Ir={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Or={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},Pr={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},zr={date:K({formats:Ir,defaultWidth:"full"}),time:K({formats:Or,defaultWidth:"full"}),dateTime:K({formats:Pr,defaultWidth:"full"})},Tr={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},xr=(n,t,e,r)=>Tr[n];function L(n){return(t,e)=>{const r=e!=null&&e.context?String(e.context):"standalone";let a;if(r==="formatting"&&n.formattingValues){const i=n.defaultFormattingWidth||n.defaultWidth,o=e!=null&&e.width?String(e.width):i;a=n.formattingValues[o]||n.formattingValues[i]}else{const i=n.defaultWidth,o=e!=null&&e.width?String(e.width):n.defaultWidth;a=n.values[o]||n.values[i]}const s=n.argumentCallback?n.argumentCallback(t):t;return a[s]}}const Ar={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Er={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},kr={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Cr={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Wr={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},Fr={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},Ur={ordinalNumber:(n,t)=>{const e=Number(n),r=e%100;if(r>20||r<10)switch(r%10){case 1:return e+"st";case 2:return e+"nd";case 3:return e+"rd"}return e+"th"},era:L({values:Ar,defaultWidth:"wide"}),quarter:L({values:Er,defaultWidth:"wide",argumentCallback:n=>n-1}),month:L({values:kr,defaultWidth:"wide"}),day:L({values:Cr,defaultWidth:"wide"}),dayPeriod:L({values:Wr,defaultWidth:"wide",formattingValues:Fr,defaultFormattingWidth:"wide"})};function N(n){return(t,e={})=>{const r=e.width,a=r&&n.matchPatterns[r]||n.matchPatterns[n.defaultMatchWidth],s=t.match(a);if(!s)return null;const i=s[0],o=r&&n.parsePatterns[r]||n.parsePatterns[n.defaultParseWidth],l=Array.isArray(o)?jr(o,d=>d.test(i)):Jr(o,d=>d.test(i));let c;c=n.valueCallback?n.valueCallback(l):l,c=e.valueCallback?e.valueCallback(c):c;const u=t.slice(i.length);return{value:c,rest:u}}}function Jr(n,t){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e)&&t(n[e]))return e}function jr(n,t){for(let e=0;e<n.length;e++)if(t(n[e]))return e}function $t(n){return(t,e={})=>{const r=t.match(n.matchPattern);if(!r)return null;const a=r[0],s=t.match(n.parsePattern);if(!s)return null;let i=n.valueCallback?n.valueCallback(s[0]):s[0];i=e.valueCallback?e.valueCallback(i):i;const o=t.slice(a.length);return{value:i,rest:o}}}const Lr=/^(\d+)(th|st|nd|rd)?/i,Nr=/\d+/i,Rr={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},$r={any:[/^b/i,/^(a|c)/i]},Hr={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},Br={any:[/1/i,/2/i,/3/i,/4/i]},Yr={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},qr={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},Vr={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},Qr={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},Xr={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},Kr={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},Gr={ordinalNumber:$t({matchPattern:Lr,parsePattern:Nr,valueCallback:n=>parseInt(n,10)}),era:N({matchPatterns:Rr,defaultMatchWidth:"wide",parsePatterns:$r,defaultParseWidth:"any"}),quarter:N({matchPatterns:Hr,defaultMatchWidth:"wide",parsePatterns:Br,defaultParseWidth:"any",valueCallback:n=>n+1}),month:N({matchPatterns:Yr,defaultMatchWidth:"wide",parsePatterns:qr,defaultParseWidth:"any"}),day:N({matchPatterns:Vr,defaultMatchWidth:"wide",parsePatterns:Qr,defaultParseWidth:"any"}),dayPeriod:N({matchPatterns:Xr,defaultMatchWidth:"any",parsePatterns:Kr,defaultParseWidth:"any"})},ot={code:"en-US",formatDistance:Sr,formatLong:zr,formatRelative:xr,localize:Ur,match:Gr,options:{weekStartsOn:0,firstWeekContainsDate:1}};function Zr(n,t){const e=F(n,t==null?void 0:t.in);return ur(e,Dr(e))+1}function tn(n,t){const e=F(n,t==null?void 0:t.in),r=+St(e)-+lr(e);return Math.round(r/he)+1}function be(n,t){var u,d,h,f;const e=F(n,t==null?void 0:t.in),r=e.getFullYear(),a=gt(),s=(t==null?void 0:t.firstWeekContainsDate)??((d=(u=t==null?void 0:t.locale)==null?void 0:u.options)==null?void 0:d.firstWeekContainsDate)??a.firstWeekContainsDate??((f=(h=a.locale)==null?void 0:h.options)==null?void 0:f.firstWeekContainsDate)??1,i=X((t==null?void 0:t.in)||n,0);i.setFullYear(r+1,0,s),i.setHours(0,0,0,0);const o=wt(i,t),l=X((t==null?void 0:t.in)||n,0);l.setFullYear(r,0,s),l.setHours(0,0,0,0);const c=wt(l,t);return+e>=+o?r+1:+e>=+c?r:r-1}function en(n,t){var o,l,c,u;const e=gt(),r=(t==null?void 0:t.firstWeekContainsDate)??((l=(o=t==null?void 0:t.locale)==null?void 0:o.options)==null?void 0:l.firstWeekContainsDate)??e.firstWeekContainsDate??((u=(c=e.locale)==null?void 0:c.options)==null?void 0:u.firstWeekContainsDate)??1,a=be(n,t),s=X((t==null?void 0:t.in)||n,0);return s.setFullYear(a,0,r),s.setHours(0,0,0,0),wt(s,t)}function rn(n,t){const e=F(n,t==null?void 0:t.in),r=+wt(e,t)-+en(e,t);return Math.round(r/he)+1}function I(n,t){const e=n<0?"-":"",r=Math.abs(n).toString().padStart(t,"0");return e+r}const Z={y(n,t){const e=n.getFullYear(),r=e>0?e:1-e;return I(t==="yy"?r%100:r,t.length)},M(n,t){const e=n.getMonth();return t==="M"?String(e+1):I(e+1,2)},d(n,t){return I(n.getDate(),t.length)},a(n,t){const e=n.getHours()/12>=1?"pm":"am";switch(t){case"a":case"aa":return e.toUpperCase();case"aaa":return e;case"aaaaa":return e[0];case"aaaa":default:return e==="am"?"a.m.":"p.m."}},h(n,t){return I(n.getHours()%12||12,t.length)},H(n,t){return I(n.getHours(),t.length)},m(n,t){return I(n.getMinutes(),t.length)},s(n,t){return I(n.getSeconds(),t.length)},S(n,t){const e=t.length,r=n.getMilliseconds(),a=Math.trunc(r*Math.pow(10,e-3));return I(a,t.length)}},ct={am:"am",pm:"pm",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},ye={G:function(n,t,e){const r=n.getFullYear()>0?1:0;switch(t){case"G":case"GG":case"GGG":return e.era(r,{width:"abbreviated"});case"GGGGG":return e.era(r,{width:"narrow"});case"GGGG":default:return e.era(r,{width:"wide"})}},y:function(n,t,e){if(t==="yo"){const r=n.getFullYear(),a=r>0?r:1-r;return e.ordinalNumber(a,{unit:"year"})}return Z.y(n,t)},Y:function(n,t,e,r){const a=be(n,r),s=a>0?a:1-a;if(t==="YY"){const i=s%100;return I(i,2)}return t==="Yo"?e.ordinalNumber(s,{unit:"year"}):I(s,t.length)},R:function(n,t){const e=ge(n);return I(e,t.length)},u:function(n,t){const e=n.getFullYear();return I(e,t.length)},Q:function(n,t,e){const r=Math.ceil((n.getMonth()+1)/3);switch(t){case"Q":return String(r);case"QQ":return I(r,2);case"Qo":return e.ordinalNumber(r,{unit:"quarter"});case"QQQ":return e.quarter(r,{width:"abbreviated",context:"formatting"});case"QQQQQ":return e.quarter(r,{width:"narrow",context:"formatting"});case"QQQQ":default:return e.quarter(r,{width:"wide",context:"formatting"})}},q:function(n,t,e){const r=Math.ceil((n.getMonth()+1)/3);switch(t){case"q":return String(r);case"qq":return I(r,2);case"qo":return e.ordinalNumber(r,{unit:"quarter"});case"qqq":return e.quarter(r,{width:"abbreviated",context:"standalone"});case"qqqqq":return e.quarter(r,{width:"narrow",context:"standalone"});case"qqqq":default:return e.quarter(r,{width:"wide",context:"standalone"})}},M:function(n,t,e){const r=n.getMonth();switch(t){case"M":case"MM":return Z.M(n,t);case"Mo":return e.ordinalNumber(r+1,{unit:"month"});case"MMM":return e.month(r,{width:"abbreviated",context:"formatting"});case"MMMMM":return e.month(r,{width:"narrow",context:"formatting"});case"MMMM":default:return e.month(r,{width:"wide",context:"formatting"})}},L:function(n,t,e){const r=n.getMonth();switch(t){case"L":return String(r+1);case"LL":return I(r+1,2);case"Lo":return e.ordinalNumber(r+1,{unit:"month"});case"LLL":return e.month(r,{width:"abbreviated",context:"standalone"});case"LLLLL":return e.month(r,{width:"narrow",context:"standalone"});case"LLLL":default:return e.month(r,{width:"wide",context:"standalone"})}},w:function(n,t,e,r){const a=rn(n,r);return t==="wo"?e.ordinalNumber(a,{unit:"week"}):I(a,t.length)},I:function(n,t,e){const r=tn(n);return t==="Io"?e.ordinalNumber(r,{unit:"week"}):I(r,t.length)},d:function(n,t,e){return t==="do"?e.ordinalNumber(n.getDate(),{unit:"date"}):Z.d(n,t)},D:function(n,t,e){const r=Zr(n);return t==="Do"?e.ordinalNumber(r,{unit:"dayOfYear"}):I(r,t.length)},E:function(n,t,e){const r=n.getDay();switch(t){case"E":case"EE":case"EEE":return e.day(r,{width:"abbreviated",context:"formatting"});case"EEEEE":return e.day(r,{width:"narrow",context:"formatting"});case"EEEEEE":return e.day(r,{width:"short",context:"formatting"});case"EEEE":default:return e.day(r,{width:"wide",context:"formatting"})}},e:function(n,t,e,r){const a=n.getDay(),s=(a-r.weekStartsOn+8)%7||7;switch(t){case"e":return String(s);case"ee":return I(s,2);case"eo":return e.ordinalNumber(s,{unit:"day"});case"eee":return e.day(a,{width:"abbreviated",context:"formatting"});case"eeeee":return e.day(a,{width:"narrow",context:"formatting"});case"eeeeee":return e.day(a,{width:"short",context:"formatting"});case"eeee":default:return e.day(a,{width:"wide",context:"formatting"})}},c:function(n,t,e,r){const a=n.getDay(),s=(a-r.weekStartsOn+8)%7||7;switch(t){case"c":return String(s);case"cc":return I(s,t.length);case"co":return e.ordinalNumber(s,{unit:"day"});case"ccc":return e.day(a,{width:"abbreviated",context:"standalone"});case"ccccc":return e.day(a,{width:"narrow",context:"standalone"});case"cccccc":return e.day(a,{width:"short",context:"standalone"});case"cccc":default:return e.day(a,{width:"wide",context:"standalone"})}},i:function(n,t,e){const r=n.getDay(),a=r===0?7:r;switch(t){case"i":return String(a);case"ii":return I(a,t.length);case"io":return e.ordinalNumber(a,{unit:"day"});case"iii":return e.day(r,{width:"abbreviated",context:"formatting"});case"iiiii":return e.day(r,{width:"narrow",context:"formatting"});case"iiiiii":return e.day(r,{width:"short",context:"formatting"});case"iiii":default:return e.day(r,{width:"wide",context:"formatting"})}},a:function(n,t,e){const a=n.getHours()/12>=1?"pm":"am";switch(t){case"a":case"aa":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"aaa":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return e.dayPeriod(a,{width:"narrow",context:"formatting"});case"aaaa":default:return e.dayPeriod(a,{width:"wide",context:"formatting"})}},b:function(n,t,e){const r=n.getHours();let a;switch(r===12?a=ct.noon:r===0?a=ct.midnight:a=r/12>=1?"pm":"am",t){case"b":case"bb":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"bbb":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return e.dayPeriod(a,{width:"narrow",context:"formatting"});case"bbbb":default:return e.dayPeriod(a,{width:"wide",context:"formatting"})}},B:function(n,t,e){const r=n.getHours();let a;switch(r>=17?a=ct.evening:r>=12?a=ct.afternoon:r>=4?a=ct.morning:a=ct.night,t){case"B":case"BB":case"BBB":return e.dayPeriod(a,{width:"abbreviated",context:"formatting"});case"BBBBB":return e.dayPeriod(a,{width:"narrow",context:"formatting"});case"BBBB":default:return e.dayPeriod(a,{width:"wide",context:"formatting"})}},h:function(n,t,e){if(t==="ho"){let r=n.getHours()%12;return r===0&&(r=12),e.ordinalNumber(r,{unit:"hour"})}return Z.h(n,t)},H:function(n,t,e){return t==="Ho"?e.ordinalNumber(n.getHours(),{unit:"hour"}):Z.H(n,t)},K:function(n,t,e){const r=n.getHours()%12;return t==="Ko"?e.ordinalNumber(r,{unit:"hour"}):I(r,t.length)},k:function(n,t,e){let r=n.getHours();return r===0&&(r=24),t==="ko"?e.ordinalNumber(r,{unit:"hour"}):I(r,t.length)},m:function(n,t,e){return t==="mo"?e.ordinalNumber(n.getMinutes(),{unit:"minute"}):Z.m(n,t)},s:function(n,t,e){return t==="so"?e.ordinalNumber(n.getSeconds(),{unit:"second"}):Z.s(n,t)},S:function(n,t){return Z.S(n,t)},X:function(n,t,e){const r=n.getTimezoneOffset();if(r===0)return"Z";switch(t){case"X":return ve(r);case"XXXX":case"XX":return nt(r);case"XXXXX":case"XXX":default:return nt(r,":")}},x:function(n,t,e){const r=n.getTimezoneOffset();switch(t){case"x":return ve(r);case"xxxx":case"xx":return nt(r);case"xxxxx":case"xxx":default:return nt(r,":")}},O:function(n,t,e){const r=n.getTimezoneOffset();switch(t){case"O":case"OO":case"OOO":return"GMT"+pe(r,":");case"OOOO":default:return"GMT"+nt(r,":")}},z:function(n,t,e){const r=n.getTimezoneOffset();switch(t){case"z":case"zz":case"zzz":return"GMT"+pe(r,":");case"zzzz":default:return"GMT"+nt(r,":")}},t:function(n,t,e){const r=Math.trunc(+n/1e3);return I(r,t.length)},T:function(n,t,e){return I(+n,t.length)}};function pe(n,t=""){const e=n>0?"-":"+",r=Math.abs(n),a=Math.trunc(r/60),s=r%60;return s===0?e+String(a):e+String(a)+t+I(s,2)}function ve(n,t){return n%60===0?(n>0?"-":"+")+I(Math.abs(n)/60,2):nt(n,t)}function nt(n,t=""){const e=n>0?"-":"+",r=Math.abs(n),a=I(Math.trunc(r/60),2),s=I(r%60,2);return e+a+t+s}const _e=(n,t)=>{switch(n){case"P":return t.date({width:"short"});case"PP":return t.date({width:"medium"});case"PPP":return t.date({width:"long"});case"PPPP":default:return t.date({width:"full"})}},De=(n,t)=>{switch(n){case"p":return t.time({width:"short"});case"pp":return t.time({width:"medium"});case"ppp":return t.time({width:"long"});case"pppp":default:return t.time({width:"full"})}},nn={p:De,P:(n,t)=>{const e=n.match(/(P+)(p+)?/)||[],r=e[1],a=e[2];if(!a)return _e(n,t);let s;switch(r){case"P":s=t.dateTime({width:"short"});break;case"PP":s=t.dateTime({width:"medium"});break;case"PPP":s=t.dateTime({width:"long"});break;case"PPPP":default:s=t.dateTime({width:"full"});break}return s.replace("{{date}}",_e(r,t)).replace("{{time}}",De(a,t))}},an=/^D+$/,sn=/^Y+$/,on=["D","DD","YY","YYYY"];function cn(n){return an.test(n)}function un(n){return sn.test(n)}function ln(n,t,e){const r=dn(n,t,e);if(console.warn(r),on.includes(n))throw new RangeError(r)}function dn(n,t,e){const r=n[0]==="Y"?"years":"days of the month";return`Use \`${n.toLowerCase()}\` instead of \`${n}\` (in \`${t}\`) for formatting ${r} to the input \`${e}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}const hn=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,fn=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,mn=/^'([^]*?)'?$/,gn=/''/g,wn=/[a-zA-Z]/;function Me(n,t,e){var u,d,h,f,g,v,M,x;const r=gt(),a=(e==null?void 0:e.locale)??r.locale??ot,s=(e==null?void 0:e.firstWeekContainsDate)??((d=(u=e==null?void 0:e.locale)==null?void 0:u.options)==null?void 0:d.firstWeekContainsDate)??r.firstWeekContainsDate??((f=(h=r.locale)==null?void 0:h.options)==null?void 0:f.firstWeekContainsDate)??1,i=(e==null?void 0:e.weekStartsOn)??((v=(g=e==null?void 0:e.locale)==null?void 0:g.options)==null?void 0:v.weekStartsOn)??r.weekStartsOn??((x=(M=r.locale)==null?void 0:M.options)==null?void 0:x.weekStartsOn)??0,o=F(n,e==null?void 0:e.in);if(!fr(o))throw new RangeError("Invalid time value");let l=t.match(fn).map(j=>{const U=j[0];if(U==="p"||U==="P"){const it=nn[U];return it(j,a.formatLong)}return j}).join("").match(hn).map(j=>{if(j==="''")return{isToken:!1,value:"'"};const U=j[0];if(U==="'")return{isToken:!1,value:bn(j)};if(ye[U])return{isToken:!0,value:j};if(U.match(wn))throw new RangeError("Format string contains an unescaped latin alphabet character `"+U+"`");return{isToken:!1,value:j}});a.localize.preprocessor&&(l=a.localize.preprocessor(o,l));const c={firstWeekContainsDate:s,weekStartsOn:i,locale:a};return l.map(j=>{if(!j.isToken)return j.value;const U=j.value;(!(e!=null&&e.useAdditionalWeekYearTokens)&&un(U)||!(e!=null&&e.useAdditionalDayOfYearTokens)&&cn(U))&&ln(U,t,String(n));const it=ye[U[0]];return it(o,U,a.localize,c)}).join("")}function bn(n){const t=n.match(mn);return t?t[1].replace(gn,"'"):n}function yn(n,t,e){const r=gt(),a=(e==null?void 0:e.locale)??r.locale??ot,s=2520,i=Pt(n,t);if(isNaN(i))throw new RangeError("Invalid time value");const o=Object.assign({},e,{addSuffix:e==null?void 0:e.addSuffix,comparison:i}),[l,c]=Ot(e==null?void 0:e.in,...i>0?[t,n]:[n,t]),u=_r(c,l),d=(It(c)-It(l))/1e3,h=Math.round((u-d)/60);let f;if(h<2)return e!=null&&e.includeSeconds?u<5?a.formatDistance("lessThanXSeconds",5,o):u<10?a.formatDistance("lessThanXSeconds",10,o):u<20?a.formatDistance("lessThanXSeconds",20,o):u<40?a.formatDistance("halfAMinute",0,o):u<60?a.formatDistance("lessThanXMinutes",1,o):a.formatDistance("xMinutes",1,o):h===0?a.formatDistance("lessThanXMinutes",1,o):a.formatDistance("xMinutes",h,o);if(h<45)return a.formatDistance("xMinutes",h,o);if(h<90)return a.formatDistance("aboutXHours",1,o);if(h<fe){const g=Math.round(h/60);return a.formatDistance("aboutXHours",g,o)}else{if(h<s)return a.formatDistance("xDays",1,o);if(h<Mt){const g=Math.round(h/fe);return a.formatDistance("xDays",g,o)}else if(h<Mt*2)return f=Math.round(h/Mt),a.formatDistance("aboutXMonths",f,o)}if(f=vr(c,l),f<12){const g=Math.round(h/Mt);return a.formatDistance("xMonths",g,o)}else{const g=f%12,v=Math.trunc(f/12);return g<3?a.formatDistance("aboutXYears",v,o):g<9?a.formatDistance("overXYears",v,o):a.formatDistance("almostXYears",v+1,o)}}function Se(n,t){return yn(n,dr(n),t)}const Ie={lessThanXSeconds:{standalone:{one:"weniger als 1 Sekunde",other:"weniger als {{count}} Sekunden"},withPreposition:{one:"weniger als 1 Sekunde",other:"weniger als {{count}} Sekunden"}},xSeconds:{standalone:{one:"1 Sekunde",other:"{{count}} Sekunden"},withPreposition:{one:"1 Sekunde",other:"{{count}} Sekunden"}},halfAMinute:{standalone:"eine halbe Minute",withPreposition:"einer halben Minute"},lessThanXMinutes:{standalone:{one:"weniger als 1 Minute",other:"weniger als {{count}} Minuten"},withPreposition:{one:"weniger als 1 Minute",other:"weniger als {{count}} Minuten"}},xMinutes:{standalone:{one:"1 Minute",other:"{{count}} Minuten"},withPreposition:{one:"1 Minute",other:"{{count}} Minuten"}},aboutXHours:{standalone:{one:"etwa 1 Stunde",other:"etwa {{count}} Stunden"},withPreposition:{one:"etwa 1 Stunde",other:"etwa {{count}} Stunden"}},xHours:{standalone:{one:"1 Stunde",other:"{{count}} Stunden"},withPreposition:{one:"1 Stunde",other:"{{count}} Stunden"}},xDays:{standalone:{one:"1 Tag",other:"{{count}} Tage"},withPreposition:{one:"1 Tag",other:"{{count}} Tagen"}},aboutXWeeks:{standalone:{one:"etwa 1 Woche",other:"etwa {{count}} Wochen"},withPreposition:{one:"etwa 1 Woche",other:"etwa {{count}} Wochen"}},xWeeks:{standalone:{one:"1 Woche",other:"{{count}} Wochen"},withPreposition:{one:"1 Woche",other:"{{count}} Wochen"}},aboutXMonths:{standalone:{one:"etwa 1 Monat",other:"etwa {{count}} Monate"},withPreposition:{one:"etwa 1 Monat",other:"etwa {{count}} Monaten"}},xMonths:{standalone:{one:"1 Monat",other:"{{count}} Monate"},withPreposition:{one:"1 Monat",other:"{{count}} Monaten"}},aboutXYears:{standalone:{one:"etwa 1 Jahr",other:"etwa {{count}} Jahre"},withPreposition:{one:"etwa 1 Jahr",other:"etwa {{count}} Jahren"}},xYears:{standalone:{one:"1 Jahr",other:"{{count}} Jahre"},withPreposition:{one:"1 Jahr",other:"{{count}} Jahren"}},overXYears:{standalone:{one:"mehr als 1 Jahr",other:"mehr als {{count}} Jahre"},withPreposition:{one:"mehr als 1 Jahr",other:"mehr als {{count}} Jahren"}},almostXYears:{standalone:{one:"fast 1 Jahr",other:"fast {{count}} Jahre"},withPreposition:{one:"fast 1 Jahr",other:"fast {{count}} Jahren"}}},pn=(n,t,e)=>{let r;const a=e!=null&&e.addSuffix?Ie[n].withPreposition:Ie[n].standalone;return typeof a=="string"?r=a:t===1?r=a.one:r=a.other.replace("{{count}}",String(t)),e!=null&&e.addSuffix?e.comparison&&e.comparison>0?"in "+r:"vor "+r:r},vn={full:"EEEE, do MMMM y",long:"do MMMM y",medium:"do MMM y",short:"dd.MM.y"},_n={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},Dn={full:"{{date}} 'um' {{time}}",long:"{{date}} 'um' {{time}}",medium:"{{date}} {{time}}",short:"{{date}} {{time}}"},Mn={date:K({formats:vn,defaultWidth:"full"}),time:K({formats:_n,defaultWidth:"full"}),dateTime:K({formats:Dn,defaultWidth:"full"})},Sn={lastWeek:"'letzten' eeee 'um' p",yesterday:"'gestern um' p",today:"'heute um' p",tomorrow:"'morgen um' p",nextWeek:"eeee 'um' p",other:"P"},In=(n,t,e,r)=>Sn[n],On={narrow:["v.Chr.","n.Chr."],abbreviated:["v.Chr.","n.Chr."],wide:["vor Christus","nach Christus"]},Pn={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1. Quartal","2. Quartal","3. Quartal","4. Quartal"]},Ht={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],wide:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"]},zn={narrow:Ht.narrow,abbreviated:["Jan.","Feb.","März","Apr.","Mai","Juni","Juli","Aug.","Sep.","Okt.","Nov.","Dez."],wide:Ht.wide},Tn={narrow:["S","M","D","M","D","F","S"],short:["So","Mo","Di","Mi","Do","Fr","Sa"],abbreviated:["So.","Mo.","Di.","Mi.","Do.","Fr.","Sa."],wide:["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"]},xn={narrow:{am:"vm.",pm:"nm.",midnight:"Mitternacht",noon:"Mittag",morning:"Morgen",afternoon:"Nachm.",evening:"Abend",night:"Nacht"},abbreviated:{am:"vorm.",pm:"nachm.",midnight:"Mitternacht",noon:"Mittag",morning:"Morgen",afternoon:"Nachmittag",evening:"Abend",night:"Nacht"},wide:{am:"vormittags",pm:"nachmittags",midnight:"Mitternacht",noon:"Mittag",morning:"Morgen",afternoon:"Nachmittag",evening:"Abend",night:"Nacht"}},An={narrow:{am:"vm.",pm:"nm.",midnight:"Mitternacht",noon:"Mittag",morning:"morgens",afternoon:"nachm.",evening:"abends",night:"nachts"},abbreviated:{am:"vorm.",pm:"nachm.",midnight:"Mitternacht",noon:"Mittag",morning:"morgens",afternoon:"nachmittags",evening:"abends",night:"nachts"},wide:{am:"vormittags",pm:"nachmittags",midnight:"Mitternacht",noon:"Mittag",morning:"morgens",afternoon:"nachmittags",evening:"abends",night:"nachts"}},En={ordinalNumber:n=>Number(n)+".",era:L({values:On,defaultWidth:"wide"}),quarter:L({values:Pn,defaultWidth:"wide",argumentCallback:n=>n-1}),month:L({values:Ht,formattingValues:zn,defaultWidth:"wide"}),day:L({values:Tn,defaultWidth:"wide"}),dayPeriod:L({values:xn,defaultWidth:"wide",formattingValues:An,defaultFormattingWidth:"wide"})},kn=/^(\d+)(\.)?/i,Cn=/\d+/i,Wn={narrow:/^(v\.? ?Chr\.?|n\.? ?Chr\.?)/i,abbreviated:/^(v\.? ?Chr\.?|n\.? ?Chr\.?)/i,wide:/^(vor Christus|vor unserer Zeitrechnung|nach Christus|unserer Zeitrechnung)/i},Fn={any:[/^v/i,/^n/i]},Un={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](\.)? Quartal/i},Jn={any:[/1/i,/2/i,/3/i,/4/i]},jn={narrow:/^[jfmasond]/i,abbreviated:/^(j[aä]n|feb|mär[z]?|apr|mai|jun[i]?|jul[i]?|aug|sep|okt|nov|dez)\.?/i,wide:/^(januar|februar|märz|april|mai|juni|juli|august|september|oktober|november|dezember)/i},Ln={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^j[aä]/i,/^f/i,/^mär/i,/^ap/i,/^mai/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},Nn={narrow:/^[smdmf]/i,short:/^(so|mo|di|mi|do|fr|sa)/i,abbreviated:/^(son?|mon?|die?|mit?|don?|fre?|sam?)\.?/i,wide:/^(sonntag|montag|dienstag|mittwoch|donnerstag|freitag|samstag)/i},Rn={any:[/^so/i,/^mo/i,/^di/i,/^mi/i,/^do/i,/^f/i,/^sa/i]},$n={narrow:/^(vm\.?|nm\.?|Mitternacht|Mittag|morgens|nachm\.?|abends|nachts)/i,abbreviated:/^(vorm\.?|nachm\.?|Mitternacht|Mittag|morgens|nachm\.?|abends|nachts)/i,wide:/^(vormittags|nachmittags|Mitternacht|Mittag|morgens|nachmittags|abends|nachts)/i},Hn={any:{am:/^v/i,pm:/^n/i,midnight:/^Mitte/i,noon:/^Mitta/i,morning:/morgens/i,afternoon:/nachmittags/i,evening:/abends/i,night:/nachts/i}},Bn={ordinalNumber:$t({matchPattern:kn,parsePattern:Cn,valueCallback:n=>parseInt(n)}),era:N({matchPatterns:Wn,defaultMatchWidth:"wide",parsePatterns:Fn,defaultParseWidth:"any"}),quarter:N({matchPatterns:Un,defaultMatchWidth:"wide",parsePatterns:Jn,defaultParseWidth:"any",valueCallback:n=>n+1}),month:N({matchPatterns:jn,defaultMatchWidth:"wide",parsePatterns:Ln,defaultParseWidth:"any"}),day:N({matchPatterns:Nn,defaultMatchWidth:"wide",parsePatterns:Rn,defaultParseWidth:"any"}),dayPeriod:N({matchPatterns:$n,defaultMatchWidth:"wide",parsePatterns:Hn,defaultParseWidth:"any"})},zt={code:"de",formatDistance:pn,formatLong:Mn,formatRelative:In,localize:En,match:Bn,options:{weekStartsOn:1,firstWeekContainsDate:4}},Yn={lessThanXSeconds:{one:"moins d’une seconde",other:"moins de {{count}} secondes"},xSeconds:{one:"1 seconde",other:"{{count}} secondes"},halfAMinute:"30 secondes",lessThanXMinutes:{one:"moins d’une minute",other:"moins de {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"environ 1 heure",other:"environ {{count}} heures"},xHours:{one:"1 heure",other:"{{count}} heures"},xDays:{one:"1 jour",other:"{{count}} jours"},aboutXWeeks:{one:"environ 1 semaine",other:"environ {{count}} semaines"},xWeeks:{one:"1 semaine",other:"{{count}} semaines"},aboutXMonths:{one:"environ 1 mois",other:"environ {{count}} mois"},xMonths:{one:"1 mois",other:"{{count}} mois"},aboutXYears:{one:"environ 1 an",other:"environ {{count}} ans"},xYears:{one:"1 an",other:"{{count}} ans"},overXYears:{one:"plus d’un an",other:"plus de {{count}} ans"},almostXYears:{one:"presqu’un an",other:"presque {{count}} ans"}},qn=(n,t,e)=>{let r;const a=Yn[n];return typeof a=="string"?r=a:t===1?r=a.one:r=a.other.replace("{{count}}",String(t)),e!=null&&e.addSuffix?e.comparison&&e.comparison>0?"dans "+r:"il y a "+r:r},Vn={full:"EEEE d MMMM y",long:"d MMMM y",medium:"d MMM y",short:"dd/MM/y"},Qn={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},Xn={full:"{{date}} 'à' {{time}}",long:"{{date}} 'à' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Kn={date:K({formats:Vn,defaultWidth:"full"}),time:K({formats:Qn,defaultWidth:"full"}),dateTime:K({formats:Xn,defaultWidth:"full"})},Gn={lastWeek:"eeee 'dernier à' p",yesterday:"'hier à' p",today:"'aujourd’hui à' p",tomorrow:"'demain à' p'",nextWeek:"eeee 'prochain à' p",other:"P"},Zn=(n,t,e,r)=>Gn[n],ta={narrow:["av. J.-C","ap. J.-C"],abbreviated:["av. J.-C","ap. J.-C"],wide:["avant Jésus-Christ","après Jésus-Christ"]},ea={narrow:["T1","T2","T3","T4"],abbreviated:["1er trim.","2ème trim.","3ème trim.","4ème trim."],wide:["1er trimestre","2ème trimestre","3ème trimestre","4ème trimestre"]},ra={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["janv.","févr.","mars","avr.","mai","juin","juil.","août","sept.","oct.","nov.","déc."],wide:["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"]},na={narrow:["D","L","M","M","J","V","S"],short:["di","lu","ma","me","je","ve","sa"],abbreviated:["dim.","lun.","mar.","mer.","jeu.","ven.","sam."],wide:["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"]},aa={narrow:{am:"AM",pm:"PM",midnight:"minuit",noon:"midi",morning:"mat.",afternoon:"ap.m.",evening:"soir",night:"mat."},abbreviated:{am:"AM",pm:"PM",midnight:"minuit",noon:"midi",morning:"matin",afternoon:"après-midi",evening:"soir",night:"matin"},wide:{am:"AM",pm:"PM",midnight:"minuit",noon:"midi",morning:"du matin",afternoon:"de l’après-midi",evening:"du soir",night:"du matin"}},sa=(n,t)=>{const e=Number(n),r=t==null?void 0:t.unit;if(e===0)return"0";const a=["year","week","hour","minute","second"];let s;return e===1?s=r&&a.includes(r)?"ère":"er":s="ème",e+s},ia=["MMM","MMMM"],oa={preprocessor:(n,t)=>n.getDate()===1||!t.some(r=>r.isToken&&ia.includes(r.value))?t:t.map(r=>r.isToken&&r.value==="do"?{isToken:!0,value:"d"}:r),ordinalNumber:sa,era:L({values:ta,defaultWidth:"wide"}),quarter:L({values:ea,defaultWidth:"wide",argumentCallback:n=>n-1}),month:L({values:ra,defaultWidth:"wide"}),day:L({values:na,defaultWidth:"wide"}),dayPeriod:L({values:aa,defaultWidth:"wide"})},ca=/^(\d+)(ième|ère|ème|er|e)?/i,ua=/\d+/i,la={narrow:/^(av\.J\.C|ap\.J\.C|ap\.J\.-C)/i,abbreviated:/^(av\.J\.-C|av\.J-C|apr\.J\.-C|apr\.J-C|ap\.J-C)/i,wide:/^(avant Jésus-Christ|après Jésus-Christ)/i},da={any:[/^av/i,/^ap/i]},ha={narrow:/^T?[1234]/i,abbreviated:/^[1234](er|ème|e)? trim\.?/i,wide:/^[1234](er|ème|e)? trimestre/i},fa={any:[/1/i,/2/i,/3/i,/4/i]},ma={narrow:/^[jfmasond]/i,abbreviated:/^(janv|févr|mars|avr|mai|juin|juill|juil|août|sept|oct|nov|déc)\.?/i,wide:/^(janvier|février|mars|avril|mai|juin|juillet|août|septembre|octobre|novembre|décembre)/i},ga={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^av/i,/^ma/i,/^juin/i,/^juil/i,/^ao/i,/^s/i,/^o/i,/^n/i,/^d/i]},wa={narrow:/^[lmjvsd]/i,short:/^(di|lu|ma|me|je|ve|sa)/i,abbreviated:/^(dim|lun|mar|mer|jeu|ven|sam)\.?/i,wide:/^(dimanche|lundi|mardi|mercredi|jeudi|vendredi|samedi)/i},ba={narrow:[/^d/i,/^l/i,/^m/i,/^m/i,/^j/i,/^v/i,/^s/i],any:[/^di/i,/^lu/i,/^ma/i,/^me/i,/^je/i,/^ve/i,/^sa/i]},ya={narrow:/^(a|p|minuit|midi|mat\.?|ap\.?m\.?|soir|nuit)/i,any:/^([ap]\.?\s?m\.?|du matin|de l'après[-\s]midi|du soir|de la nuit)/i},pa={any:{am:/^a/i,pm:/^p/i,midnight:/^min/i,noon:/^mid/i,morning:/mat/i,afternoon:/ap/i,evening:/soir/i,night:/nuit/i}},va={ordinalNumber:$t({matchPattern:ca,parsePattern:ua,valueCallback:n=>parseInt(n)}),era:N({matchPatterns:la,defaultMatchWidth:"wide",parsePatterns:da,defaultParseWidth:"any"}),quarter:N({matchPatterns:ha,defaultMatchWidth:"wide",parsePatterns:fa,defaultParseWidth:"any",valueCallback:n=>n+1}),month:N({matchPatterns:ma,defaultMatchWidth:"wide",parsePatterns:ga,defaultParseWidth:"any"}),day:N({matchPatterns:wa,defaultMatchWidth:"wide",parsePatterns:ba,defaultParseWidth:"any"}),dayPeriod:N({matchPatterns:ya,defaultMatchWidth:"any",parsePatterns:pa,defaultParseWidth:"any"})},Tt={code:"fr",formatDistance:qn,formatLong:Kn,formatRelative:Zn,localize:oa,match:va,options:{weekStartsOn:1,firstWeekContainsDate:4}},_a=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/;class Da extends E{unserialize(t){if(t==="0000-00-00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&_a.test(e))return e;if(t!==void 0)return null}serialize(){return this._value===null?"0000-00-00":this._value}toDateString(t){return!t||!(t instanceof Date)?null:t.toISOString().substring(0,10)}toDateObject(){return this._value?new Date(this._value):null}toFormatted(t="en"){if(!this._value)return null;const e=t==="fr"?Tt:t==="de"?zt:ot;return Me(new Date(this._value),t==="de"?"dd. MMMM yyyy":"dd MMMM yyyy",{locale:e})}toRelative(t="en"){if(!this._value)return null;const e=t==="fr"?Tt:t==="de"?zt:ot;return Se(new Date(this._value),{addSuffix:!0,locale:e})}}class Bt extends E{unserialize(t){return t}serialize(){return this._value}}class Ma extends E{unserialize(t){return t}serialize(){return this._value}}class Oe extends E{unserialize(t){if(typeof t=="number")return t;if(typeof t=="string")return parseInt(t,10);if(t!==void 0)return null}serialize(){return typeof this._value=="number"?this._value.toString():this._value}}class Sa extends Bt{}const Ia=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}\s[0-9]{2}\:[0-9]{2}\:[0-9]{2}$/;class Oa extends E{unserialize(t){if(t==="0000-00-00 00:00:00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&Ia.test(e))return e;if(t!==void 0)return null}serialize(){return this._value===null?"0000-00-00 00:00:00":this._value}toDateString(t){if(!t||!(t instanceof Date))return null;const e=new Date(t);e.setMinutes(e.getMinutes()-e.getTimezoneOffset());const r=e.toISOString();return r.substring(0,10)+" "+r.substring(11,19)}toDateObject(){return this._value?new Date(this._value):null}toFormatted(t="en"){if(!this._value)return null;const e=t==="fr"?Tt:t==="de"?zt:ot;return Me(new Date(this._value),t==="de"?"dd. MMMM yyyy":"dd MMMM yyyy",{locale:e})}toRelative(t="en"){if(!this._value)return null;const e=t==="fr"?Tt:t==="de"?zt:ot;return Se(new Date(this._value),{addSuffix:!0,locale:e})}getTimeStamp(){return this._value?new Date(this._value).getTime():null}getBlitzStamp(){return this._value?Math.floor((new Date(this._value).getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3):null}}class Pa extends E{async getObject(t){const e=this.serialize();if(!e)return null;const r=await R.get(this._type),a=r==null?void 0:r.memoryClient().get(e);return a||(await(r==null?void 0:r.get({skipCacheUpdateIfFound:!0,...t,raw:!1,blitzID:e}))??null)}unserialize(t){return t!=null&&typeof t!="string"?null:t}serialize(){return this._value}}class za extends E{async toUser(){const t=this.serialize();if(!t)return null;const e=await R.get("0BAUsers"),r=await(e==null?void 0:e.get({blitzID:t,skipCacheUpdateIfFound:!0}));return r?{id:t,username:r.username.value}:null}unserialize(t){return t}serialize(){return this._value}}class Yt{constructor(t,e,r){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(r),this._valueSignal=new ft(this._value),this._syncSignal=new ft(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t):t instanceof Array?t:t===void 0?void 0:[],e!==void 0&&!Array.isArray(e)&&(e=[])}catch{e=[]}return e&&(e=e.map(r=>B.createType(this._name,this._type,r)),e.forEach(r=>r.withObject(this._object))),e}serialize(){if(this._value!==void 0)return this._value.map(t=>t.serialize())}async performAction(t){var s,i,o,l,c,u,d,h,f,g,v,M;const e=new H({action:"edit",data:{[this._name]:{[t.action]:t.value}},model:(i=(s=this._object)==null?void 0:s.model)==null?void 0:i.getName(),blitzID:(o=this._object)==null?void 0:o._blitzID.value}),r=await V.create().run([e]);if(r[0].status!==C.Success&&r[0].status!==C.Notice)throw new Error(r[0].message??"Unknown Error! Please try again.");for(const x of((c=(l=this._object)==null?void 0:l._editURLs)==null?void 0:c.value)??[])await p.queue.addJob(x,e.toObject());const a=await((d=(u=this._object)==null?void 0:u.model)==null?void 0:d.get({blitzID:this._object._blitzID.value,forceLocal:!0,raw:!0}));a&&Array.isArray(a[this._name])&&(this.value=a[this._name]),(f=(h=this._object)==null?void 0:h.model)==null||f.memoryClient().emit(e),(g=this._object)==null||g.dispatchEvent("edit",e.data),(M=(v=this._object)==null?void 0:v.model)==null||M.setLastTransactionHash(e.hash)}async add(t){await this.performAction({action:"add",value:B.createType(this._name,this._type,t).serialize()})}async remove(t){await this.performAction({action:"remove",value:B.createType(this._name,this._type,t).serialize()})}withObject(t){this._object=t,this._value!==void 0&&this._value.forEach(e=>e.withObject(t))}subscribe(t,e=!0){var a,s;const r=this._valueSignal.subscribe(t,e);return this._value===void 0&&((s=(a=this._object)==null?void 0:a.model)==null||s.get({blitzID:this._object._blitzID.value,forceHttp:!0,query:{manyToMany:"object"}}).then(i=>{(i==null?void 0:i[this._name]._value)!==void 0&&this._valueSignal.emit()})),r}syncStatus(t){var a;const e=this._syncSignal.get()!==null,r=this._syncSignal.subscribe(t,e);return e||p.queue.getJobsForObject((a=this._object)==null?void 0:a._blitzID.value).then(s=>{const i=s.filter(d=>{var h;return d.transaction.action===_.Edit&&((h=d.transaction.data)==null?void 0:h[this._name])!==void 0});let o=y.Pending,l;const c=i.find(d=>d.status===y.Failed),u=i.find(d=>d.status===y.Conflict);c?(o=y.Failed,l=c):u?(o=y.Conflict,l=u):i.every(d=>d.status===y.Completed)&&(o=y.Completed),this._syncSignal.set({status:o,job:l},!1),t(this._syncSignal.get())}),r}getDetails(){var t,e;return((e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttributeDetails(this._name))||null}}class Pe extends Yt{unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t):t instanceof Array?t:t===null?[]:void 0,e!==void 0&&!Array.isArray(e)&&(e=[])}catch{}return e}serialize(){return this._value}async add(t){await this.performAction({action:"add",value:t})}async remove(t){await this.performAction({action:"remove",value:t})}withObject(t){this._object=t}async getObjects(t){const e=this.serialize();if(!Array.isArray(e))return[];const r=await R.get(this._type),a=r==null?void 0:r.memoryClient(),s=[];for(const i of e){if(!i._blitzID)continue;const o=a==null?void 0:a.get(i._blitzID);if(o){s.push(o);continue}const l=await(r==null?void 0:r.get({skipCacheUpdateIfFound:!0,...t,raw:!1,blitzID:i._blitzID}));l&&s.push(l)}return s}}function Ta(n){return n&&n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n)}function xa(n){return n}function Aa(n,t){t=t||{};const e=t.delimiter||".",r=t.maxDepth,a=t.transformKey||xa,s={};function i(o,l,c){c=c||1,Object.keys(o).forEach(function(u){const d=o[u],h=t.safe&&Array.isArray(d),f=Object.prototype.toString.call(d),g=Ta(d),v=f==="[object Object]"||f==="[object Array]",M=l?l+e+a(u):a(u);if(!h&&!g&&v&&Object.keys(d).length&&(!t.maxDepth||c<r))return i(d,M,c+1);s[M]=d})}return i(n),s}class Ea extends E{unserialize(t){if(t!==null&&typeof t=="object")return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){let e=!0;try{JSON.parse(t)}catch{e=!1}return e}keys(){return Object.keys(this._value??{})}flat(){return Aa(this._value??{})}groupBy(t){if(typeof t!="function")throw new Error("Callback function is not a function!");return Object.groupBy(this._value??{},t)}}class ka extends E{unserialize(t){if(typeof t=="string")return{content:t,language:null};if(t!==null&&typeof t=="object"&&t.content)return{content:t.content,language:t.language??null};if(t!==void 0)return null}serialize(){return this._value}getLanguage(){var t;return((t=this._value)==null?void 0:t.language)||null}getContent(){var t;return((t=this._value)==null?void 0:t.content)||null}}class Ca extends E{unserialize(t){return t}serialize(){return this._value}getOptions(){var t,e,r;return((r=(e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttributeDetails(this._name))==null?void 0:r.options)??[]}validate(t){return this.getOptions().includes(t)}}class qt extends E{unserialize(t){if(typeof t=="number")return t;if(typeof t=="string")return parseFloat(t);if(t!==void 0)return null}serialize(){return typeof this._value=="number"?this._value.toString():this._value}}class Wa extends Oe{}class Fa extends qt{}class Ua extends qt{toPercentage(){return this._value!=null?(this._value*100).toString()+"%":null}}const ze=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;class Ja extends E{unserialize(t){if(t!=null&&ze.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return ze.test(t)}}const Te=/^\+[1-9]{1,3}\-[0-9]{7,14}$/;class ja extends E{unserialize(t){if(t!=null&&Te.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return Te.test(t)}getCallingCode(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[0].substring(1)}getPhoneNumber(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[1]}}const xe=/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/;class La extends E{unserialize(t){if(t!=null&&xe.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return xe.test(t)}getUrlObject(){return this._value?new URL(this._value):null}getOrigin(){return this._value?new URL(this._value).origin:null}getProtocol(){return this._value?new URL(this._value).protocol:null}getPathname(){return this._value?new URL(this._value).pathname:null}getHostname(){return this._value?new URL(this._value).hostname:null}getSearch(){return this._value?new URL(this._value).search:null}}class Na extends E{unserialize(t){const e=t instanceof Array?t[0]:t;if(e!==null&&typeof e=="object"&&e.base!=null&&e.version!=null)return t;if(e!==void 0)return null}serialize(){return this._value}getUrl(t){const e=this._value instanceof Array?this._value[0]:this._value;return e!==null&&typeof e=="object"&&e.base!=null&&e[t]!=null?e.base+e[t].substring(1):null}}class Ra extends E{unserialize(t){if(t!==null&&typeof t=="object"&&t.url!=null)return t;if(t!==void 0)return null}serialize(){return this._value}getUrl(){var t;return((t=this._value)==null?void 0:t.url)??null}}class $a extends E{unserialize(t){if(t!==null&&typeof t=="object"&&t.url!=null)return t;if(t!==void 0)return null}serialize(){return this._value}getUrl(){var t;return((t=this._value)==null?void 0:t.url)??null}}class Ha extends E{unserialize(t){if(t!==null&&typeof t=="object"&&t.lat&&t.long)return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!e.lat||!e.long)return!1;const r=parseFloat(e.lat);if(isNaN(r)||r<-90||r>90)return!1;const a=parseFloat(e.long);return!(isNaN(a)||a<-180||a>180)}getFormattedAddress(){if(!this._value)return"";const t=[];this._value.venue&&t.push(this._value.venue),this._value.street&&t.push(this._value.street);const e=[];return this._value.zip&&e.push(this._value.zip),this._value.city&&e.push(this._value.city),e.length>0&&t.push(e.join(" ")),this._value.nation&&t.push(this._value.nation),t.join(", ")}async geocodeAddress(t,e){if(!t)throw new Error("Address is required for geocoding.");if(!e)throw new Error("Google Maps API key is required for geocoding.");try{const a=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(t)}&key=${e}`)).json();if(a.status==="OK"&&a.results&&a.results.length>0){const s=a.results[0].geometry.location;return{lat:s.lat.toString(),long:s.lng.toString()}}return null}catch(r){return console.error("Geocoding error:",r.message),null}}}class B{static createType(t,e,r){return t.endsWith("_fk")?new Pa(t,e,r):t==="_userID"?new za(t,e,r):e==="int"||["_blitzstamp"].includes(t)?new Oe(t,"int",r):e==="tinyint"?new Wa(t,e,r):e==="double"?new Fa(t,e,r):e==="float"?new qt(t,e,r):e==="percentage"?new Ua(t,e,r):e==="varchar"?new Sa(t,e,r):e==="text"?new Bt(t,e,r):e==="htmlText"?new Ma(t,e,r):e==="enum"?new Ca(t,e,r):e==="json"?new Ea(t,e,r):e==="boolean"?new de(t,e,r):e==="datetime"||["_publishingdate","_modified","_expiration"].includes(t)?new Oa(t,"datetime",r):e==="date"?new Da(t,e,r):e==="code"?new ka(t,e,r):e==="email"?new Ja(t,e,r):e==="phone"?new ja(t,e,r):e==="url"?new La(t,e,r):e==="image"?new Na(t,e,r):e==="video"?new Ra(t,e,r):e==="file"?new $a(t,e,r):e==="location"?new Ha(t,e,r):new mt(t,e,r)}static createFrom(t,e,r){return Array.isArray(e)?this.createMany(t,e[0],r):this.createType(t,e,r)}static createMany(t,e,r){return t.endsWith("_mtm")?new Pe(t,e,r):new Yt(t,e,r)}static unserialize(t,e){var s,i,o;const r={},a=[...Object.keys(t),...Object.keys(e)].filter((l,c,u)=>u.indexOf(l)===c);for(const l of a)Array.isArray((s=t[l])==null?void 0:s.type)?r[l]=B.createMany(l,((i=t[l])==null?void 0:i.type[0])??"anonymous",e[l]):r[l]=B.createType(l,((o=t[l])==null?void 0:o.type)??"anonymous",e[l]);return r}static serialize(t){const e={};for(const r in t)e[r]=t[r].serialize();return e}}class at{constructor({model:t,attributes:e}){m(this,"_model");m(this,"_attributes");m(this,"listeners",new Map);m(this,"editQueue",Promise.resolve());this._model=t,this._attributes=e}get model(){return this._model}getAttribute(t){return this._attributes[t]}hasAttribute(t){return this._attributes.hasOwnProperty(t)}edit(t,e,r){return this.enqueueEditOperation(async()=>{var c,u,d,h;const a=(u=(c=this.model)==null?void 0:c.getAttributeDetails(t))==null?void 0:u.type,s=B.createType(t,a,e).serialize(),i=r?B.createType(t,a,r).serialize():this.getAttribute(t).serialize(),o=new H({action:"edit",data:{[t]:{prev:i,new:s}},model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),l=await V.create().run([o]);if(l[0].status!==C.Success&&l[0].status!==C.Notice)throw new Error(l[0].message??"Unknown Error! Please try again.");this._attributes[t].value=s;for(const f of this.getAttribute("_editURLs").value)await p.queue.addJob(f,o.toObject());(d=this.model)==null||d.memoryClient().emit(o),this.dispatchEvent("edit",o.data),(h=this.model)==null||h.setLastTransactionHash(o.hash)})}async delete(){var a,s;const t=new H({action:"delete",model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),e=await V.create().run([t]);if(e[0].status!==C.Success)throw new Error(e[0].message??"Unknown Error! Please try again.");const r=(a=this.model)==null?void 0:a.memoryClient();r==null||r.delete(this.getAttribute("_blitzID").value);for(const i of this.getAttribute("_editURLs").value)await p.queue.addJob(i,t.toObject());r==null||r.emit(t),this.dispatchEvent("delete",null),(s=this.model)==null||s.setLastTransactionHash(t.hash)}async addUserPermission(t){if(!t||t.length===0)throw new Error("Users missing!");const e=this.getAttribute("_blitzID").value,r={blitzIDs:[e],users:t.reduce((o,l)=>({...o,[`#${l.id}`]:l.permission}),{})},a=new H({action:"addObjectUserPermission",model:this.model.getName(),blitzID:e,data:r,hash:et(r)}),s=[];for(const o of this.getAttribute("_editURLs").value)s.push(await jt.send({url:o,transaction:a.toObject()},S._globalHeaders));const i=s.find(o=>o.status!==J.Success);if(i)throw new Error(i.message)}toObject(){const t={};for(const e in this._attributes)t[e]=this._attributes[e].serialize();return t}addEventListener(t,e){var r;this.listeners.has(t)||this.listeners.set(t,[]),(r=this.listeners.get(t))==null||r.push(e)}removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(r=>e!==r))}dispatchEvent(t,e){var r;this.listeners.has(t)&&((r=this.listeners.get(t))==null||r.forEach(a=>a(e)))}enqueueEditOperation(t){return new Promise((e,r)=>{this.editQueue=this.editQueue.then(async()=>{try{const a=await t();e(a)}catch(a){r(a)}})})}}class Vt{static transformBlitzDataOptions(t){if(typeof t>"u")throw new Error("Configuration is required.");if(typeof t=="string")t={clusters:this.transformClusterOptions(t)};else if(Array.isArray(t))t={clusters:this.transformClusterOptions(t)};else if(typeof t=="object"&&!Array.isArray(t))t.clusters=this.transformClusterOptions(t.clusters);else throw new Error("Unknown configuration type.");if(!t.queue||typeof t.queue!="object"?t.queue={workerPath:"/queue-worker.js"}:t.queue.workerPath||(t.queue.workerPath="/queue-worker.js"),t.sync?typeof t.sync=="string"&&(t.sync={level:t.sync}):t.sync={level:"full"},t.sync.level==="partial")throw new Error("Partial sync type not supported yet!");return t.sync.level==="cache"&&(t.sync.ttl||(t.sync.ttl=30*1e3)),t.sync.level==="full"&&(t.sync.interval||(t.sync.interval=30*1e3)),t.flush||(t.flush={type:["version"]}),t.flush.type.includes("interval")&&(t.flush.interval||(t.flush.interval=30)),t.flush.type.includes("size")&&(t.flush.size||(t.flush.size=128)),t}static transformClusterOptions(t){if(typeof t>"u")throw new Error("Clusters are required.");if(typeof t=="string")t={default:{readURL:[t],addURL:[t]}};else if(Array.isArray(t))t={default:{readURL:t,addURL:t}};else if(typeof t=="object")for(const e of Object.keys(t)){if(typeof t[e]=="string"||Array.isArray(t[e])){const r=Array.isArray(t[e])?t[e]:[t[e]];t[e]={readURL:r,addURL:r};continue}typeof t[e]=="object"&&(typeof t[e].readURL=="string"&&(t[e].readURL=[t[e].readURL]),typeof t[e].addURL=="string"&&(t[e].addURL=[t[e].addURL]))}else throw new Error("Unknown cluster configuration type.");return t}}const Ba={get(n,t){if(Reflect.has(n,t)){const e=Reflect.get(n,t);return e instanceof Function?e.bind(n):e}return n._attributes[t]},set(n,t,e){throw new Error("Setting values directly not supported. Please use `edit` method to change a value for an attribute.")}};class Ae{static create(t,e,r){const a=e.getAttributesDetails()??{},s=B.unserialize(a,r),i=new Proxy(new t({model:e,attributes:s}),Ba);for(const o in s)s[o].withObject(i);return e.memoryClient().update(i)}}class Qt extends at{static async model(){if(typeof this.modelName!="string")throw new Error(`${this.name}.modelName is not a string, please provide a valid model name.`);const t=this.modelName==="_Model"?p._Model:await p._Model.get(this.modelName);return t.setReturnType(this),t}static async get(t){return(await this.model()).get(t)}static async exists(t){return(await this.model()).exists(t)}static async add(t,e=[]){return(await this.model()).add(t,e)}static async list(t={}){return(await this.model()).list(t)}}m(Qt,"modelName");const At=class At extends Qt{constructor({model:e,attributes:r}){super({model:e,attributes:r});m(this,"clusterManager");m(this,"lastTransactionHash",null);m(this,"returnType",at);this.clusterManager=p.clusterManager}idbClient(){return new ir(this)}memoryClient(){return new Dt(this)}getName(){return this._attributes._blitzID.value}getLastTransactionHash(){return this.lastTransactionHash}setLastTransactionHash(e){this.lastTransactionHash=e}setReturnType(e){this.returnType=e}async exists(e){return!!await this.get(e)}async add(e,r=[]){const a=this.resolveClusters(r),s=this.getAttributesDetails()??{},i=new H({action:"add",data:B.serialize(B.unserialize(s,e)),model:this.getName()}),o=await p.getCurrentUser(),l=i.clone();l.data={...l.data,_userID:o.id};const c=await V.create().run([l]);if(c[0].status!==C.Success)throw new Error(c[0].message??"Unknown Error! Please try again.");for(const u of a)for(const d of u.options.addURL)await p.queue.addJob(d,i.toObject());return this.memoryClient().emit(i),this.setLastTransactionHash(i.hash),Ae.create(this.returnType,this,l.data)}async get(e){const r=typeof e=="string"?{blitzID:e}:e,s=(await ut.create().model(this).clusters(this.resolveClusters(r.clusters??[])).raw(r.raw??!1).get(r.blitzID).query({returnType:this.returnType??at}).forceHttp(r.forceHttp??!1).forceLocal(r.forceLocal??!1).skipCacheUpdateIfFound(r.skipCacheUpdateIfFound??!1).signal(r.signal).getQuery(r.query??{}).perform())[0]??null;if(!s&&this.returnType===At)throw new Error(`Model with blitzID "${e}" does not exists or you don't have enough permission to view it.`);return s||null}async list(e={}){return await ut.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??at,customSort:e.customSort,customSortDirection:e.customSortDirection,pagination:e.pagination,var:e.var,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).signal(e.signal).perform()}subscribeToList(e={},r,a=!1){const s=ut.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??at,customSort:e.customSort,customSortDirection:e.customSortDirection,var:e.var,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).performSignal(a),i=s.subscribe(r,s.get()!==null),o=Dt.channel.filterPipe(l=>l.model===this.getName()).subscribe(l=>{if(l.action===_.Add)this.list({...e,forceLocal:!0}).then(c=>{const u=e.raw?c.findIndex(d=>d._blitzID===l.blitzID):c.findIndex(d=>d.getAttribute("_blitzID").value===l.blitzID);u>-1&&s.set({items:c,update:{action:_.Add,object:c[u],index:u}})});else if(l.action===_.Edit){const c=s.get();if(!c)return;const u=e.raw?c.items.findIndex(d=>d._blitzID===l.blitzID):c.items.findIndex(d=>d.getAttribute("_blitzID").value===l.blitzID);u>-1&&this.list({...e,forceLocal:!0}).then(d=>{const h=e.raw?d.findIndex(f=>f._blitzID===l.blitzID):d.findIndex(f=>f.getAttribute("_blitzID").value===l.blitzID);s.set({items:d,update:{action:_.Edit,object:h>-1?d[h]:c.items[u],index:h>-1?h:u}})})}else if(l.action===_.Delete){const c=s.get();if(!c)return;if(e.raw){const u=c.items.findIndex(d=>d._blitzID===l.blitzID);u>-1&&s.set({items:c.items.filter(d=>d._blitzID!==l.blitzID),update:{action:_.Delete,object:c.items[u],index:u}})}else{const u=c.items.findIndex(d=>d.getAttribute("_blitzID").value===l.blitzID);u>-1&&s.set({items:c.items.filter(d=>d.getAttribute("_blitzID").value!==l.blitzID),update:{action:_.Delete,object:c.items[u],index:u}})}}});return()=>{i(),o()}}async sync(){const e=this.getName();if(e){const r=Date.now()/1e3,a=P.getLastSyncedAt(e)??0,s=30;r-a>s&&await dt.create().run(e)}}getAttributesDetails(){var e;return((e=this._attributes.attributes)==null?void 0:e.value)??null}getAttributeDetails(e){var r,a;return((a=(r=this._attributes.attributes)==null?void 0:r.value)==null?void 0:a[e])??null}resolveClusters(e){return Object.values(e.length===0?this.clusterManager.all():this.clusterManager.get(e))}setClusters(e){this.clusterManager=new te;const r=Vt.transformClusterOptions(e);for(const a of Object.keys(r))this.clusterManager.register(a,r[a])}getClusterManager(){return this.clusterManager}static async get(e){return super.get(e)}static async list(e={}){return super.list(e)}};m(At,"modelName","_Model");let R=At;class Xt{static extractModelName(t){const a=new URL(t).pathname.split("/").filter(s=>s!=="").pop();if(!a&&!(a!=null&&a.endsWith(".json")))throw new Error("Model name not found in the URL.");return a.slice(0,a.indexOf(".json"))}static extractConditions(t){const e=new URL(t);return JSON.parse(e.searchParams.get("conditions")||"[]")}}var Ee={exports:{}},ke={exports:{}};(function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,r){return e<<r|e>>>32-r},rotr:function(e,r){return e<<32-r|e>>>r},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var r=0;r<e.length;r++)e[r]=t.endian(e[r]);return e},randomBytes:function(e){for(var r=[];e>0;e--)r.push(Math.floor(Math.random()*256));return r},bytesToWords:function(e){for(var r=[],a=0,s=0;a<e.length;a++,s+=8)r[s>>>5]|=e[a]<<24-s%32;return r},wordsToBytes:function(e){for(var r=[],a=0;a<e.length*32;a+=8)r.push(e[a>>>5]>>>24-a%32&255);return r},bytesToHex:function(e){for(var r=[],a=0;a<e.length;a++)r.push((e[a]>>>4).toString(16)),r.push((e[a]&15).toString(16));return r.join("")},hexToBytes:function(e){for(var r=[],a=0;a<e.length;a+=2)r.push(parseInt(e.substr(a,2),16));return r},bytesToBase64:function(e){for(var r=[],a=0;a<e.length;a+=3)for(var s=e[a]<<16|e[a+1]<<8|e[a+2],i=0;i<4;i++)a*8+i*6<=e.length*8?r.push(n.charAt(s>>>6*(3-i)&63)):r.push("=");return r.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var r=[],a=0,s=0;a<e.length;s=++a%4)s!=0&&r.push((n.indexOf(e.charAt(a-1))&Math.pow(2,-2*s+8)-1)<<s*2|n.indexOf(e.charAt(a))>>>6-s*2);return r}};ke.exports=t})();var Ya=ke.exports,Kt={utf8:{stringToBytes:function(n){return Kt.bin.stringToBytes(unescape(encodeURIComponent(n)))},bytesToString:function(n){return decodeURIComponent(escape(Kt.bin.bytesToString(n)))}},bin:{stringToBytes:function(n){for(var t=[],e=0;e<n.length;e++)t.push(n.charCodeAt(e)&255);return t},bytesToString:function(n){for(var t=[],e=0;e<n.length;e++)t.push(String.fromCharCode(n[e]));return t.join("")}}},Ce=Kt;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var qa=function(n){return n!=null&&(We(n)||Va(n)||!!n._isBuffer)};function We(n){return!!n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n)}function Va(n){return typeof n.readFloatLE=="function"&&typeof n.slice=="function"&&We(n.slice(0,0))}(function(){var n=Ya,t=Ce.utf8,e=qa,r=Ce.bin,a=function(s,i){s.constructor==String?i&&i.encoding==="binary"?s=r.stringToBytes(s):s=t.stringToBytes(s):e(s)?s=Array.prototype.slice.call(s,0):!Array.isArray(s)&&s.constructor!==Uint8Array&&(s=s.toString());for(var o=n.bytesToWords(s),l=s.length*8,c=1732584193,u=-271733879,d=-1732584194,h=271733878,f=0;f<o.length;f++)o[f]=(o[f]<<8|o[f]>>>24)&16711935|(o[f]<<24|o[f]>>>8)&4278255360;o[l>>>5]|=128<<l%32,o[(l+64>>>9<<4)+14]=l;for(var g=a._ff,v=a._gg,M=a._hh,x=a._ii,f=0;f<o.length;f+=16){var j=c,U=u,it=d,Gt=h;c=g(c,u,d,h,o[f+0],7,-680876936),h=g(h,c,u,d,o[f+1],12,-389564586),d=g(d,h,c,u,o[f+2],17,606105819),u=g(u,d,h,c,o[f+3],22,-1044525330),c=g(c,u,d,h,o[f+4],7,-176418897),h=g(h,c,u,d,o[f+5],12,1200080426),d=g(d,h,c,u,o[f+6],17,-1473231341),u=g(u,d,h,c,o[f+7],22,-45705983),c=g(c,u,d,h,o[f+8],7,1770035416),h=g(h,c,u,d,o[f+9],12,-1958414417),d=g(d,h,c,u,o[f+10],17,-42063),u=g(u,d,h,c,o[f+11],22,-1990404162),c=g(c,u,d,h,o[f+12],7,1804603682),h=g(h,c,u,d,o[f+13],12,-40341101),d=g(d,h,c,u,o[f+14],17,-1502002290),u=g(u,d,h,c,o[f+15],22,1236535329),c=v(c,u,d,h,o[f+1],5,-165796510),h=v(h,c,u,d,o[f+6],9,-1069501632),d=v(d,h,c,u,o[f+11],14,643717713),u=v(u,d,h,c,o[f+0],20,-373897302),c=v(c,u,d,h,o[f+5],5,-701558691),h=v(h,c,u,d,o[f+10],9,38016083),d=v(d,h,c,u,o[f+15],14,-660478335),u=v(u,d,h,c,o[f+4],20,-405537848),c=v(c,u,d,h,o[f+9],5,568446438),h=v(h,c,u,d,o[f+14],9,-1019803690),d=v(d,h,c,u,o[f+3],14,-187363961),u=v(u,d,h,c,o[f+8],20,1163531501),c=v(c,u,d,h,o[f+13],5,-1444681467),h=v(h,c,u,d,o[f+2],9,-51403784),d=v(d,h,c,u,o[f+7],14,1735328473),u=v(u,d,h,c,o[f+12],20,-1926607734),c=M(c,u,d,h,o[f+5],4,-378558),h=M(h,c,u,d,o[f+8],11,-2022574463),d=M(d,h,c,u,o[f+11],16,1839030562),u=M(u,d,h,c,o[f+14],23,-35309556),c=M(c,u,d,h,o[f+1],4,-1530992060),h=M(h,c,u,d,o[f+4],11,1272893353),d=M(d,h,c,u,o[f+7],16,-155497632),u=M(u,d,h,c,o[f+10],23,-1094730640),c=M(c,u,d,h,o[f+13],4,681279174),h=M(h,c,u,d,o[f+0],11,-358537222),d=M(d,h,c,u,o[f+3],16,-722521979),u=M(u,d,h,c,o[f+6],23,76029189),c=M(c,u,d,h,o[f+9],4,-640364487),h=M(h,c,u,d,o[f+12],11,-421815835),d=M(d,h,c,u,o[f+15],16,530742520),u=M(u,d,h,c,o[f+2],23,-995338651),c=x(c,u,d,h,o[f+0],6,-198630844),h=x(h,c,u,d,o[f+7],10,1126891415),d=x(d,h,c,u,o[f+14],15,-1416354905),u=x(u,d,h,c,o[f+5],21,-57434055),c=x(c,u,d,h,o[f+12],6,1700485571),h=x(h,c,u,d,o[f+3],10,-1894986606),d=x(d,h,c,u,o[f+10],15,-1051523),u=x(u,d,h,c,o[f+1],21,-2054922799),c=x(c,u,d,h,o[f+8],6,1873313359),h=x(h,c,u,d,o[f+15],10,-30611744),d=x(d,h,c,u,o[f+6],15,-1560198380),u=x(u,d,h,c,o[f+13],21,1309151649),c=x(c,u,d,h,o[f+4],6,-145523070),h=x(h,c,u,d,o[f+11],10,-1120210379),d=x(d,h,c,u,o[f+2],15,718787259),u=x(u,d,h,c,o[f+9],21,-343485551),c=c+j>>>0,u=u+U>>>0,d=d+it>>>0,h=h+Gt>>>0}return n.endian([c,u,d,h])};a._ff=function(s,i,o,l,c,u,d){var h=s+(i&o|~i&l)+(c>>>0)+d;return(h<<u|h>>>32-u)+i},a._gg=function(s,i,o,l,c,u,d){var h=s+(i&l|o&~l)+(c>>>0)+d;return(h<<u|h>>>32-u)+i},a._hh=function(s,i,o,l,c,u,d){var h=s+(i^o^l)+(c>>>0)+d;return(h<<u|h>>>32-u)+i},a._ii=function(s,i,o,l,c,u,d){var h=s+(o^(i|~l))+(c>>>0)+d;return(h<<u|h>>>32-u)+i},a._blocksize=16,a._digestsize=16,Ee.exports=function(s,i){if(s==null)throw new Error("Illegal argument "+s);var o=n.wordsToBytes(a(s,i));return i&&i.asBytes?o:i&&i.asString?r.bytesToString(o):n.bytesToHex(o)}})();var Qa=Ee.exports;const Xa=er(Qa);class ut{constructor(){m(this,"_clusters");m(this,"_urls");m(this,"_model");m(this,"_query");m(this,"_raw",!1);m(this,"_forceHttp",!1);m(this,"_forceLocal",!1);m(this,"_skipCacheUpdateIfFound",!1);m(this,"_get");m(this,"_getQuery");m(this,"_signal")}static create(){return new ut}model(t){return this._model=t,this}clusters(t){return this._clusters=t,this}signal(t){return this._signal=t,this}urls(t){return this._urls=t,this}query(t){var r,a;this._query=t;const e=(r=this._model)==null?void 0:r.getAttributesDetails();if((a=this._query)!=null&&a.conditions&&e)for(const s of this._query.conditions){const i=s[0];s.length===3&&e[i]!==void 0&&typeof e[i].type=="string"&&(s[1]==="IN"&&Array.isArray(s[2])?s[2]=s[2].map(o=>B.createType(i,e[i].type,o).serialize()):s[2]=B.createType(i,e[i].type,s[2]).serialize())}return this}raw(t){return this._raw=t,this}forceHttp(t){return this._forceHttp=t,this}forceLocal(t){return this._forceLocal=t,this}skipCacheUpdateIfFound(t){return this._skipCacheUpdateIfFound=t,this}get(t){return this._get=t,this}getQuery(t){return this._getQuery=t,this}convertObjects(t){var r;const e=[];for(const a of t)e.push(Ae.create(((r=this._query)==null?void 0:r.returnType)??at,this._model,a));return e}async perform(){var e;let t=this._forceHttp&&!this._forceLocal?[]:await this.performIndexedDb();if(!this._forceLocal){if(p.options.sync.level==="full"&&t.length===0)t=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp())),t=await this.filterExpiredObjects(t),t.length>0&&await this._model.idbClient().save(t);else if(p.options.sync.level==="cache"){const r=this._skipCacheUpdateIfFound&&t.length>0?!1:this.shouldSendHttpRequest();if(r||t.length===0){const a=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));(a.length>0||this._forceHttp)&&(t=await this.filterExpiredObjects(a),t.length>0&&await this._model.idbClient().save(t)),r&&((e=this._model)==null?void 0:e.getName())!=="_Model"&&P.setListCallLastTimeStamp(this.hash(),new Date().getTime())}}}return this._raw?t:this.convertObjects(t)}performSignal(t=!1){const e=new ft(null);return(async()=>{var i;if(!t){e.set({items:await this.perform()});return}const r=await this.performMemory();e.set({items:this._raw?r:this.convertObjects(r),nextSource:"local database"});const a=await this.performIndexedDb();e.set({items:this._raw?a:this.convertObjects(a),nextSource:"server"});let s=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));s=await this.filterExpiredObjects(s),s.length>0&&await((i=this._model)==null?void 0:i.idbClient().save(s)),e.set({items:this._raw?s:this.convertObjects(s)})})(),e}async performHttp(){return(await Promise.all(this._urls?this._urls.map(e=>this.performSingleUrlHttp(e)):this._clusters.map(e=>this.performSingleClusterHttp(e)))).flat()}async performSingleClusterHttp(t){var r,a;const e={};for(let s=0;s<t.options.readURL.length;s++){const i=t.getNextReadURL();try{const o=this._get?await rt.get({baseUrl:i,modelName:this._model.getName(),blitzID:this._get,query:this._getQuery},this._signal):await rt.list({endpoint:{baseUrl:i,modelName:this._model.getName(),query:this._query}},this._signal);for(const l of o){l._clusters=[t.name],l._editURLs=JSON.parse(JSON.stringify(t.options.readURL));for(const c in l)if(c.endsWith("_fk")&&l[c]!==null&&typeof l[c]=="object"&&l[c]._blitzID){const u=(a=(r=this._model)==null?void 0:r.getAttributeDetails(c))==null?void 0:a.type;if(u&&u!=="_Model"){const d=await R.get(u);d&&await d.idbClient().save([l[c]],!0)}l[c]=l[c]._blitzID}else c.endsWith("_mtm")&&Array.isArray(l[c])&&(l[c]=l[c].map((u,d)=>({_blitzID:typeof u=="string"?u:u._blitzID,_mtmSort:typeof u=="string"?(l[c].length-d)*15:u._mtmSort})))}return o}catch(o){e[i]=(o==null?void 0:o.stack)??(o==null?void 0:o.message)??o}}throw new Error(`All read URLs failed for cluster "${t.name}". Errors: ${JSON.stringify(e)}`)}async performSingleUrlHttp(t){return(await rt.list({fullUrl:t},this._signal)).map(r=>(r.cluster=[],r._editURLs=[t],r))}async performIndexedDb(){var r,a;const t=this._model.idbClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(r=this._getQuery)==null?void 0:r.var,manyToMany:(a=this._getQuery)==null?void 0:a.manyToMany});const e=this._urls?this._urls.map(s=>Xt.extractConditions(s)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}async performMemory(){var r,a;const t=this._model.memoryClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(r=this._getQuery)==null?void 0:r.var,manyToMany:(a=this._getQuery)==null?void 0:a.manyToMany});const e=this._urls?this._urls.map(s=>Xt.extractConditions(s)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}mergeObjects(t){const e=[];for(const r of t){const a=e.find(s=>s._blitzID===r._blitzID);a?(a._clusters=[...a._clusters,...r._clusters].filter((s,i,o)=>o.indexOf(s)===i),a._editURLs=[...a._editURLs,...r._editURLs].filter((s,i,o)=>o.indexOf(s)===i)):e.push(r)}return e}async filterQueuedObjects(t){var a;const e=await p.queue.getJobs(),r=[];for(const s of t)if(!e.find(i=>i.transaction.action===_.Delete&&i.transaction.blitzID===s._blitzID))if(!e.find(i=>i.transaction.action===_.Edit&&i.transaction.blitzID===s._blitzID&&i.status!==y.Completed))r.push(s);else{const i=await((a=this._model)==null?void 0:a.get({blitzID:s._blitzID,raw:!0,forceLocal:!0}));i?r.push(i):r.push(s)}return r}async filterExpiredObjects(t){var a;const e=P.getCurrentUser();if(!e||!e.id)return t;const r=[];try{for(const s of t){if(typeof s._expiration=="string"&&s._expiration!==""&&s._expiration!=="0000-00-00 00:00:00"&&e.id!==s._userID){const i=Date.now(),o=new Date(s._expiration).getTime();if(i>o){await((a=this._model)==null?void 0:a.idbClient().delete(s._blitzID));continue}}r.push(s)}}catch(s){return console.error("Error handling expired objects:",s.stack),t}return r}shouldSendHttpRequest(){var e;if(p.options.sync.level!=="cache"||((e=this._model)==null?void 0:e.getName())==="_Model")return!1;const t=P.getListCallLastTimeStamp(this.hash());return t?new Date().getTime()-t>p.options.sync.ttl:!0}hash(){var t,e;return Xa(JSON.stringify({clusters:((t=this._clusters)==null?void 0:t.map(r=>r.name))??[],blitzId:this._get,urls:this._urls,modelName:(e=this._model)==null?void 0:e.getName(),listQuery:this._query,getQuery:this._getQuery}))}}const Ka=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,Fe=n=>{if(typeof n!="string")throw new TypeError("Invalid argument expected string");const t=n.match(Ka);if(!t)throw new Error(`Invalid argument not valid semver ('${n}' received)`);return t.shift(),t},Ue=n=>n==="*"||n==="x"||n==="X",Je=n=>{const t=parseInt(n,10);return isNaN(t)?n:t},Ga=(n,t)=>typeof n!=typeof t?[String(n),String(t)]:[n,t],Za=(n,t)=>{if(Ue(n)||Ue(t))return 0;const[e,r]=Ga(Je(n),Je(t));return e>r?1:e<r?-1:0},je=(n,t)=>{for(let e=0;e<Math.max(n.length,t.length);e++){const r=Za(n[e]||"0",t[e]||"0");if(r!==0)return r}return 0},ts=(n,t)=>{const e=Fe(n),r=Fe(t),a=e.pop(),s=r.pop(),i=je(e,r);return i!==0?i:a&&s?je(a.split("."),s.split(".")):a||s?a?-1:1:0},Le=(n,t,e)=>{es(e);const r=ts(n,t);return Ne[e].includes(r)},Ne={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},Re=Object.keys(Ne),es=n=>{if(typeof n!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof n}`);if(Re.indexOf(n)===-1)throw new Error(`Invalid operator, expected one of ${Re.join("|")}`)};class rs{constructor(t){m(this,"options");this.options=t}async perform(){if(this.options.type.includes("version")){const t=P.get("version");if(!t||Le(p.VERSION,t,">")){const e=p.VERSION.split(".")[1],r=t==null?void 0:t.split(".")[1];if(r&&Le(e,r,">")){await this.flush(),P.setLastSyncedAt(Math.floor(Date.now()/1e3)),P.set("version",p.VERSION);return}else P.set("version",p.VERSION)}}if(this.options.type.includes("interval")&&this.options.interval){const t=P.get("lastFlush");if(!t)P.set("lastFlush",Date.now().toString());else if(Math.floor((Date.now()-parseInt(t))/864e5)>=this.options.interval){await this.flush(),P.set("lastFlush",Date.now().toString()),P.setLastSyncedAt(Math.floor(Date.now()/1e3)),P.set("version",p.VERSION);return}}if(this.options.type.includes("size")&&this.options.size&&navigator.storage&&navigator.storage.estimate)try{const t=await navigator.storage.estimate();if(t.usage&&Math.floor(t.usage/1e6)>=this.options.size){await this.flush(),P.setLastSyncedAt(Math.floor(Date.now()/1e3)),P.set("version",p.VERSION);return}}catch(t){console.error("Error getting storage estimate:",t.message)}}async flush(){const t=[...(await indexedDB.databases()).filter(r=>{var a;return(a=r.name)==null?void 0:a.startsWith("bdt")}).map(r=>r.name),...P.getDatabases(),"_Model","_Project","0BAUsers","db_master"].filter((r,a,s)=>s.findIndex(i=>i===r)===a);for(const r of t)await Ut(r);const e=await lt(D.name,1);await e.clear(D.store),e.close(),P.clear()}}const A=class A{static get VERSION(){return"1.3.4"}static async initialize(t){if(this.initialized){console.log("%c⚠️ Warning: Library has already been initialized! Skipping the initialization steps.","background: #FFF3CD; color: #856404; font-weight: bold;"),console.groupCollapsed("%cStack Trace","background: #FFF3CD; color: #856404; font-weight: bold; font-style: italic;"),console.log("Options",t),console.trace(),console.groupEnd();return}this.initialized=!0;const e=Vt.transformBlitzDataOptions(t);this.options=e,e.clusters&&A.setClusters(e.clusters),await new rs(this.options.flush).perform(),await new Nt().ping(),this.queue=await new ar().init(),A._Model=new R({model:void 0,attributes:{_blitzID:new mt("_blitzID","string","_Model"),searchable:new mt("searchable","json",void 0),attributes:new mt("attributes","json",{name:{label:"Name",type:"varchar"},label:{label:"Label",type:"texti18n"},modelpermission:{label:"Model Permission",type:"tinyint"},hasuserpermissions:{label:"Has User Permissions",type:"boolean"},subscriberemails:{label:"Subscriber Emails",type:"text"},haslogs:{label:"Has Logs",type:"boolean"},cache:{label:"Cache",name:"cache",type:"boolean"},hasprojects:{label:"Has Projects",type:"boolean"},attributes:{label:"Attributes",type:"json"},objectpermissionoptions:{label:"Object Permission Options",type:"int"},haspublishingdate:{label:"Has Publishing Date",type:"boolean"}}),_editURLs:new mt("_editURLs","json",[]),haspublishingdate:new de("haspublishingdate","boolean",!1)}}),A._Model.setReturnType(R),t&&typeof t!="string"&&!Array.isArray(t)&&t.uiManager&&(this.ui=new t.uiManager(this,t.uiManagerSettings));try{await A.getCurrentUser()}catch(r){console.error("Error fetching current user:",r.stack)}if(e.sync.level==="full"){const r=dt.create();await r.run(),r.runAtInterval(e.sync.interval)}else e.sync.level==="cache"&&await dt.create().run(void 0,"delete")}static setClusters(t){t=Vt.transformClusterOptions(t);for(const e of Object.keys(t))A.clusterManager.register(e,t[e])}static async list(t){const e=Xt.extractModelName(t);if(!await A._Model.exists(e))throw new Error(`Model "${e}" does not exist.`);return ut.create().model(await A._Model.get(e)).urls([t]).query({}).perform()}static async uploader(t){return await rt.upload({baseUrl:A.clusterManager.toArray()[0].getNextReadURL(),image:t})}static async uploaderVideo(t){return await rt.uploadVideo({baseUrl:A.clusterManager.toArray()[0].getNextReadURL(),video:t})}static async uploaderFile(t){return await rt.uploadFile({baseUrl:A.clusterManager.toArray()[0].getNextReadURL(),file:t})}static async listProjectUsers(t){if(!t)throw new Error("Project ID required!");const e=P.getProjectUsers(t);if(e!==null&&typeof e=="object"){const o=Date.now(),l=864e5;if(o<e.lastSaved+l)return e.users}const r=k.sanitizeBaseUrl(A.clusterManager.toArray()[0].getNextReadURL()),a=new URL(r).origin!==window.location.origin?"?enableCors=1":"",s=await S.create().url(r+`api/listProjectUsers/${t}.json${a}`).get();if(s.error)throw new Error(s.error);if(s.errors instanceof Array&&s.errors.length>0)throw new Error(s.errors.map(o=>o.message||o).join(" | "));const i={lastSaved:Date.now(),users:(s.users||[]).map(o=>({id:o._blitzID,username:o.username}))};return P.setProjectUsers(t,i),i.users}static async getCurrentUser(){var l;const t=P.getCurrentUser();if(t)return t;const e=k.sanitizeBaseUrl(A.clusterManager.toArray()[0].getNextReadURL()),r=new URL(e).origin!==window.location.origin?"?enableCors=1":"",a=await S.create().url(e+"api/ping.json"+r).get();if(a.error)throw new Error(a.error);if(!a.userhash){const c={id:"public",username:"Public"};return P.setCurrentUser(c),c}const s=await R.get("0BAUsers"),i=await(s==null?void 0:s.get(a.userhash));if(!i||!((l=i.username)!=null&&l.value))throw new Error("Could not get user object!");const o={id:a.userhash,username:i.username.value};return P.setCurrentUser(o),o}static refreshCurrentUser(){P.setCurrentUser(null)}static addEventListener(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}static hasEventListener(t){return this.listeners.has(t)?this.listeners.get(t).length>0:!1}static removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(r=>e!==r))}static dispatchEvent(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(r=>r(e))}};m(A,"clusterManager",new te),m(A,"_Model"),m(A,"objects",new Map),m(A,"options"),m(A,"queue"),m(A,"ui"),m(A,"listeners",new Map),m(A,"initialized",!1);let p=A;T.BDCustomObject=Qt,T.BDModel=R,T.BDObject=at,T.BlitzData=p,T.DataType=E,T.HttpRequest=S,T.JobStatus=y,T.LocalStorageRepository=P,T.ManyForeignKeyType=Pe,T.ManyType=Yt,T.TextType=Bt,T.blitzhash=et,T.blitzstamp=G,T.sleep=oe,Object.defineProperty(T,Symbol.toStringTag,{value:"Module"})});
