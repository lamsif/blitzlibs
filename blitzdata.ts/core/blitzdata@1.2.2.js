(function(z,_){typeof exports=="object"&&typeof module<"u"?_(exports):typeof define=="function"&&define.amd?define(["exports"],_):(z=typeof globalThis<"u"?globalThis:z||self,_(z.BlitzData={}))})(this,function(z){"use strict";var bs=Object.defineProperty;var ps=(z,_,q)=>_ in z?bs(z,_,{enumerable:!0,configurable:!0,writable:!0,value:q}):z[_]=q;var m=(z,_,q)=>(ps(z,typeof _!="symbol"?_+"":_,q),q);const K=class K{constructor(){m(this,"_method");m(this,"_url");m(this,"_headers",{});m(this,"_body");m(this,"_signal")}static create(){const t=new K;return K._globalHeaders&&t.headers(K._globalHeaders),t}static globalHeaders(t){K._globalHeaders=t}method(t){return this._method=t,this}url(t){return this._url=t,this}header(t,e){return this._headers[t]=e,this}headers(t){for(const e in t)this.header(e,t[e]);return this}body(t){return this._body=t,this}signal(t){return this._signal=t,this}async send(){const t=await fetch(this._url,{method:this._method,headers:this._headers,body:this._body?this._body instanceof FormData?this._body:JSON.stringify(this._body):void 0,signal:this._signal?this._signal:void 0});if(!t.ok)throw new Error(`HTTP request failed with status code ${t.status}. Status text: ${t.statusText} and response: ${await t.text()}`);return await t.json()}async get(){return await this.method("GET").send()}async post(){return await this.method("POST").send()}};m(K,"_globalHeaders",{});let _=K;class q{constructor(t,e){m(this,"name");m(this,"options");m(this,"cursors",{readURL:0});this.name=t,this.options=e}getNextReadURL(){this.cursors.readURL>=this.options.readURL.length&&(this.cursors.readURL=0);const t=this.options.readURL[this.cursors.readURL];return this.cursors.readURL++,t}}class Nt{constructor(){m(this,"clusters",{})}register(t,e){this.clusters[t]=new q(t,e)}get(t){if(!Array.isArray(t)){if(this.clusters[t]===void 0)throw new Error(`cluster "${t}" not found.`);return this.clusters[t]}const e={};for(const r of t)e[r]=this.get(r);return e}names(){return Object.keys(this.clusters)}all(){return this.clusters}toArray(){return Object.values(this.clusters)}random(){const t=this.names(),e=t[Math.floor(Math.random()*t.length)];return this.get(e)}}const _e=(n,t)=>t.some(e=>n instanceof e);let $t,Rt;function De(){return $t||($t=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function Me(){return Rt||(Rt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Ht=new WeakMap,ft=new WeakMap,Vt=new WeakMap,mt=new WeakMap,gt=new WeakMap;function Se(n){const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("success",a),n.removeEventListener("error",i)},a=()=>{e(H(n.result)),s()},i=()=>{r(n.error),s()};n.addEventListener("success",a),n.addEventListener("error",i)});return t.then(e=>{e instanceof IDBCursor&&Ht.set(e,n)}).catch(()=>{}),gt.set(t,n),t}function ze(n){if(ft.has(n))return;const t=new Promise((e,r)=>{const s=()=>{n.removeEventListener("complete",a),n.removeEventListener("error",i),n.removeEventListener("abort",i)},a=()=>{e(),s()},i=()=>{r(n.error||new DOMException("AbortError","AbortError")),s()};n.addEventListener("complete",a),n.addEventListener("error",i),n.addEventListener("abort",i)});ft.set(n,t)}let bt={get(n,t,e){if(n instanceof IDBTransaction){if(t==="done")return ft.get(n);if(t==="objectStoreNames")return n.objectStoreNames||Vt.get(n);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return H(n[t])},set(n,t,e){return n[t]=e,!0},has(n,t){return n instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in n}};function Ie(n){bt=n(bt)}function Ae(n){return n===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const r=n.call(pt(this),t,...e);return Vt.set(r,t.sort?t.sort():[t]),H(r)}:Me().includes(n)?function(...t){return n.apply(pt(this),t),H(Ht.get(this))}:function(...t){return H(n.apply(pt(this),t))}}function Te(n){return typeof n=="function"?Ae(n):(n instanceof IDBTransaction&&ze(n),_e(n,De())?new Proxy(n,bt):n)}function H(n){if(n instanceof IDBRequest)return Se(n);if(mt.has(n))return mt.get(n);const t=Te(n);return t!==n&&(mt.set(n,t),gt.set(t,n)),t}const pt=n=>gt.get(n);function wt(n,t,{blocked:e,upgrade:r,blocking:s,terminated:a}={}){const i=indexedDB.open(n,t),o=H(i);return r&&i.addEventListener("upgradeneeded",d=>{r(H(i.result),d.oldVersion,d.newVersion,H(i.transaction),d)}),e&&i.addEventListener("blocked",d=>e(d.oldVersion,d.newVersion,d)),o.then(d=>{a&&d.addEventListener("close",()=>a()),s&&d.addEventListener("versionchange",c=>s(c.oldVersion,c.newVersion,c))}).catch(()=>{}),o}function yt(n,{blocked:t}={}){const e=indexedDB.deleteDatabase(n);return t&&e.addEventListener("blocked",r=>t(r.oldVersion,r)),H(e).then(()=>{})}const Pe=["get","getKey","getAll","getAllKeys","count"],je=["put","add","delete","clear"],vt=new Map;function Bt(n,t){if(!(n instanceof IDBDatabase&&!(t in n)&&typeof t=="string"))return;if(vt.get(t))return vt.get(t);const e=t.replace(/FromIndex$/,""),r=t!==e,s=je.includes(e);if(!(e in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Pe.includes(e)))return;const a=async function(i,...o){const d=this.transaction(i,s?"readwrite":"readonly");let c=d.store;return r&&(c=c.index(o.shift())),(await Promise.all([c[e](...o),s&&d.done]))[0]};return vt.set(t,a),a}Ie(n=>({...n,get:(t,e,r)=>Bt(t,e)||n.get(t,e,r),has:(t,e)=>!!Bt(t,e)||n.has(t,e)}));const A={name:"bd-queue",store:"jobs",timeIndex:"time",objectIndex:"object"};var y=(n=>(n.Pending="pending",n.Completed="completed",n.Failed="failed",n.Conflict="conflict",n))(y||{}),Q=(n=>(n.Success="success",n.Exception="exception",n.Failed="failed",n.Conflict="conflict",n))(Q||{}),T=(n=>(n.Add="add",n.Edit="edit",n.Delete="delete",n))(T||{}),$="SharedWorker"in globalThis,Oe=class{constructor(n){m(this,"ActualWorker");this.ActualWorker=n}get onmessage(){var n;return $?(n=this.ActualWorker)==null?void 0:n.port.onmessage:this.ActualWorker.onmessage}set onmessage(n){$?this.ActualWorker.port.onmessage=n:this.ActualWorker.onmessage=n}get onmessageerror(){var n;return $?(n=this.ActualWorker)==null?void 0:n.port.onmessageerror:this.ActualWorker.onmessageerror}set onmessageerror(n){$?this.ActualWorker.port.onmessageerror=n:this.ActualWorker.onmessageerror=n}start(){var n;if($)return(n=this.ActualWorker)==null?void 0:n.port.start()}postMessage(n,t){var e;return $?(e=this.ActualWorker)==null?void 0:e.port.postMessage(n,t):this.ActualWorker.postMessage(n,t)}terminate(){var n;return $?(n=this.ActualWorker)==null?void 0:n.port.close():this.ActualWorker.terminate()}close(){return this.terminate()}get port(){return $?this.ActualWorker.port:this.ActualWorker}get onerror(){return this.ActualWorker.onerror}set onerror(n){this.ActualWorker.onerror=n}addEventListener(n,t,e){var r;return $&&n!=="error"?(r=this.ActualWorker)==null?void 0:r.port.addEventListener(n,t,e):this.ActualWorker.addEventListener(n,t,e)}removeEventListener(n,t,e){var r;return $&&n!=="error"?(r=this.ActualWorker)==null?void 0:r.port.removeEventListener(n,t,e):this.ActualWorker.removeEventListener(n,t,e)}dispatchEvent(n){return this.ActualWorker.dispatchEvent(n)}},xe=class extends Oe{constructor(n,t){let e;$?e=new SharedWorker(n,t):e=new Worker(n,t),super(e)}};function Ce(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var qt={};/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */(function(n){(function(t){t(typeof DO_NOT_EXPORT_CRC>"u"?n:{})})(function(t){t.version="1.2.2";function e(){for(var g=0,F=new Array(256),b=0;b!=256;++b)g=b,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,F[b]=g;return typeof Int32Array<"u"?new Int32Array(F):F}var r=e();function s(g){var F=0,b=0,v=0,M=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(v=0;v!=256;++v)M[v]=g[v];for(v=0;v!=256;++v)for(b=g[v],F=256+v;F<4096;F+=256)b=M[F]=b>>>8^g[b&255];var E=[];for(v=1;v!=16;++v)E[v-1]=typeof Int32Array<"u"?M.subarray(v*256,v*256+256):M.slice(v*256,v*256+256);return E}var a=s(r),i=a[0],o=a[1],d=a[2],c=a[3],l=a[4],u=a[5],h=a[6],f=a[7],w=a[8],S=a[9],I=a[10],x=a[11],Lt=a[12],kt=a[13],Ft=a[14];function Wt(g,F){for(var b=F^-1,v=0,M=g.length;v<M;)b=b>>>8^r[(b^g.charCodeAt(v++))&255];return~b}function ms(g,F){for(var b=F^-1,v=g.length-15,M=0;M<v;)b=Ft[g[M++]^b&255]^kt[g[M++]^b>>8&255]^Lt[g[M++]^b>>16&255]^x[g[M++]^b>>>24]^I[g[M++]]^S[g[M++]]^w[g[M++]]^f[g[M++]]^h[g[M++]]^u[g[M++]]^l[g[M++]]^c[g[M++]]^d[g[M++]]^o[g[M++]]^i[g[M++]]^r[g[M++]];for(v+=15;M<v;)b=b>>>8^r[(b^g[M++])&255];return~b}function gs(g,F){for(var b=F^-1,v=0,M=g.length,E=0,Jt=0;v<M;)E=g.charCodeAt(v++),E<128?b=b>>>8^r[(b^E)&255]:E<2048?(b=b>>>8^r[(b^(192|E>>6&31))&255],b=b>>>8^r[(b^(128|E&63))&255]):E>=55296&&E<57344?(E=(E&1023)+64,Jt=g.charCodeAt(v++)&1023,b=b>>>8^r[(b^(240|E>>8&7))&255],b=b>>>8^r[(b^(128|E>>2&63))&255],b=b>>>8^r[(b^(128|Jt>>6&15|(E&3)<<4))&255],b=b>>>8^r[(b^(128|Jt&63))&255]):(b=b>>>8^r[(b^(224|E>>12&15))&255],b=b>>>8^r[(b^(128|E>>6&63))&255],b=b>>>8^r[(b^(128|E&63))&255]);return~b}t.table=r,t.bstr=Wt,t.buf=ms,t.str=gs})})(qt);function Z(){return Math.floor((new Date().getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3)}function tt(n){return Z().toString(36)+"-"+qt.str(JSON.stringify(n)).toString(36)}function Qt(n){return new Promise(t=>{setTimeout(t,n)})}class W{constructor(t){m(this,"action");m(this,"blitzstamp");m(this,"hash");m(this,"hashAlgo");m(this,"blitzID");m(this,"userhash");m(this,"model");m(this,"data");var e;this.action=t.action,this.blitzstamp=t.blitzstamp??Z(),this.hash=t.hash??tt(t.data===void 0?{blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}:{...t.data,blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}),this.hashAlgo=t.hashAlgo??"b-crc32",this.blitzID=t.blitzID??((e=t.data)==null?void 0:e._blitzID)??this.hash,this.model=t.model,this.data=t.data??{},this.userhash=t.userhash}toObject(){return{action:this.action,blitzstamp:this.blitzstamp,hash:this.hash,hashAlgo:this.hashAlgo,blitzID:this.blitzID,model:this.model,data:this.data,userhash:this.userhash}}clone(){return new W({action:this.action,model:this.model,blitzID:this.blitzID,blitzstamp:this.blitzstamp,data:this.data,hash:this.hash,hashAlgo:this.hashAlgo,userhash:this.userhash})}static fromObject(t){var e;return new W({action:t.action,blitzstamp:t.blitzstamp,hash:t.hash,hashAlgo:t.hashAlgo,blitzID:t.blitzID??((e=t.data)==null?void 0:e._blitzID)??t.blitzID,model:t.model,data:t.data,userhash:t.userhash})}}var C=(n=>(n.Success="success",n.Notice="notice",n.Error="error",n.Exception="exception",n))(C||{});class N{constructor(t,e,r,s=null,a){m(this,"blitzID");m(this,"hash");m(this,"message");m(this,"conflict");m(this,"replicaUrl",null);m(this,"status");this.blitzID=t,this.hash=e,this.status=r,this.message=s,this.conflict=a}setReplicaUrl(t){this.replicaUrl=t}isConflict(){return typeof this.conflict<"u"&&this.conflict!==null}}class at extends Array{get(t){return this.find(e=>e.hash===t)}has(t){return this.some(e=>e.hash===t)}isSuccessful(t){var e;if(t){const r=(e=this.get(t))==null?void 0:e.status;return r?r==="success"||r==="notice":!1}return this.every(r=>r.status)}isFailed(t){var e;if(t){const r=(e=this.get(t))==null?void 0:e.status;return r?r==="error":!0}return this.every(r=>!r.status)}successful(){return new at(...this.filter(t=>t.status))}failed(){return new at(...this.filter(t=>!t.status))}}class O{static createListEndpoint(t,e,r){var i;const s=`${O.sanitizeBaseUrl(t)}api/list/${e}.json`,a=new URLSearchParams;return new URL(t).origin!==window.location.origin&&a.append("enableCors","1"),a.append("fkOptions",JSON.stringify({_userID:"blitzID"})),(i=r.conditions)!=null&&i.length&&a.append("conditions",JSON.stringify(r.conditions)),r.limit&&a.append("limit",r.limit.toString()),r.customSort&&a.append("customSort",r.customSort),r.customSortDirection&&a.append("customSortDirection",r.customSortDirection),r.var&&r.var.length>0&&a.append("var",JSON.stringify(r.var)),r.manyToMany&&a.append("manyToMany",r.manyToMany),`${s}?${a.toString()}`}static createGetEndpoint(t,e,r,s){const a=`${O.sanitizeBaseUrl(t)}api/list/${e}/_blitzID/${r}.json`,i=new URLSearchParams;return new URL(t).origin!==window.location.origin&&i.append("enableCors","1"),i.append("fkOptions",JSON.stringify({_userID:"blitzID"})),s.var&&s.var.length>0&&i.append("var",JSON.stringify(s.var)),s.manyToMany&&i.append("manyToMany",s.manyToMany),`${a}?${i.toString()}`}static createPostEndpoint(t){return`${O.sanitizeBaseUrl(t)}api/post.json`}static createPingEndpoint(t){return`${O.sanitizeBaseUrl(t)}api/ping.json`}static createListLogsEndpoint(t){var a,i;const e=t.type==="delete"?"listDeletedLogs":"listLogs",r=t.model?`${O.sanitizeBaseUrl(t.baseUrl)}api/${e}/${t.model}.json`:`${O.sanitizeBaseUrl(t.baseUrl)}api/${e}.json`,s=new URLSearchParams;return((a=t.query)==null?void 0:a.from)!==void 0&&s.append("from",t.query.from.toString()),(i=t.query)!=null&&i.models&&!t.model&&s.append("models",JSON.stringify(t.query.models)),`${r}?${s.toString()}`}static createUploaderEndpoint(t){const e=new URL(t).origin!==window.location.origin?"?enableCors=1":"";return`${O.sanitizeBaseUrl(t)}uploader/index`+e}static createVideoUploaderEndpoint(t,e){const r=new URL(t).origin!==window.location.origin?"?enableCors=1":"",s=(r?r+"&":"?")+`filename=${e}`;return`${O.sanitizeBaseUrl(t)}uploadervideo/index`+s}static createFileUploaderEndpoint(t){const e=new URL(t).origin!==window.location.origin?"?enableCors=1":"";return`${O.sanitizeBaseUrl(t)}uploaderfile/index`+e}static sanitizeBaseUrl(t){const e=new URL(t);if(!e.origin||!e.pathname||!e.protocol.match(/^https?:$/))throw new Error(`Supplied base URL is invalid: ${t}`);return e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),e.toString()}}class X{static async list(t,e){if(!t.endpoint&&!t.fullUrl)throw new Error("Either baseUrl or fullUrl must be provided.");const r=await _.create().url(t.fullUrl?t.fullUrl:O.createListEndpoint(t.endpoint.baseUrl,t.endpoint.modelName,t.endpoint.query)).signal(e).get();if(!Array.isArray(r.items)&&Array.isArray(r.errors))throw new Error(r.errors.map(s=>(s==null?void 0:s.message)??s).join(" | "));return r.items??[]}static async get(t,e){const r=await _.create().url(O.createGetEndpoint(t.baseUrl,t.modelName,t.blitzID,t.query)).signal(e).get();if(!Array.isArray(r.items)&&Array.isArray(r.errors))throw new Error(r.errors.map(s=>(s==null?void 0:s.message)??s).join(" | "));return r.items??[]}static async post(t){const e=await _.create().url(O.createPostEndpoint(t.baseUrl)).body(t.transactions).post();if((typeof e.error=="string"||e.errors instanceof Array)&&!(e.results instanceof Object))throw new Error(e.error??e.errors.join(" | "));return e}static async listLogs(t){const e=await _.create().url(O.createListLogsEndpoint(t)).get();if(!(e.transactions instanceof Array)&&(typeof e.error=="string"||e.errors instanceof Array))throw new Error(e.error??e.errors.map(r=>(r==null?void 0:r.message)??r).join(" | "));return{transactions:e.transactions,userID:e.userID,userhash:e.userhash,lastTimestamp:e.lastTimestamp}}static upload(t){const e=new FormData;return e.append("image",t.image),_.create().url(O.createUploaderEndpoint(t.baseUrl)).body(e).header("Accept","application/json").post()}static async uploadVideo(t){const e=new FormData;e.append("fileToUpload",t.video);const r=t.video.name.split("."),s=r.length>1?"."+r.pop():"",a=crypto.randomUUID()+s,i=await _.create().url(O.createVideoUploaderEndpoint(t.baseUrl,a)).body(e).header("Accept","application/json").post();if(!i||!i.s)throw new Error("Video upload failed: "+((i==null?void 0:i.error)??"Unknown error!"));return{url:i.url.video,thumbnail:i.url.thumb,"tn-oq":i.url.tnoq}}static async uploadFile(t){const e=new FormData;e.append("files[]",t.file);const r=await _.create().url(O.createFileUploaderEndpoint(t.baseUrl)).body(e).header("Accept","application/json").post();if(!r||!r.s)throw new Error("File upload failed: "+((r==null?void 0:r.error)??"Unknown error!"));return{url:r.files.url}}static async ping({baseUrl:t}){return await _.create().url(O.createPingEndpoint(t)).get()}}class _t{constructor(){m(this,"_query");m(this,"_model");m(this,"_type")}static create(){return new _t}query(t){return this._query=t,this}model(t){return this._model=t,this}type(t){return this._type=t,this}async perform(){const t=p.clusterManager.toArray().map(s=>s.getNextReadURL()),e=await Promise.all(t.map(s=>X.listLogs({baseUrl:s,query:this._query,model:this._model,type:this._type})));return{transactions:[].concat(...e.map(s=>s.transactions)).filter((s,a,i)=>i.findIndex(o=>o.hash===s.hash)===a).filter(s=>typeof s=="object"&&!Array.isArray(s)),userID:e[0].userID,userhash:e[0].userhash,lastTimestamp:e[0].lastTimestamp}}}class Dt{async ping(){const t=await this.openConnection(),e=["sync_transactions","evaluated_transactions"];for(const r of e)if(!t.objectStoreNames.contains(r))return t.close(),console.log(`There's missing stores, recreating the database. Available stores: ${t.objectStoreNames}`),await yt("db_master"),await this.ping();t.close()}async openConnection(){return await wt("db_master",1,{upgrade:(t,e,r,s,a)=>{r===1&&(t.createObjectStore("sync_transactions",{autoIncrement:!1,keyPath:"hash"}),t.createObjectStore("evaluated_transactions",{autoIncrement:!1,keyPath:"hash"}))}})}}class D{static getKey(t){return`BlitzData.${t}`}static get(t){return localStorage.getItem(this.getKey(t))}static set(t,e){localStorage.setItem(this.getKey(t),e)}static has(t){return Object.hasOwn(localStorage,this.getKey(t))}static remove(t){localStorage.removeItem(this.getKey(t))}static clear(){const t=Object.keys(localStorage);for(const e of t)e.startsWith("BlitzData.")&&localStorage.removeItem(e)}static getLastSyncedAt(t){const e=this.get(t?`${t}.lastSyncedAt`:"lastSyncedAt");return e?parseInt(e):null}static setLastSyncedAt(t,e){this.set(e?`${e}.lastSyncedAt`:"lastSyncedAt",t.toString())}static getCurrentUser(){const t=this.get("currentUser");return t?JSON.parse(t):null}static setCurrentUser(t){t?this.set("currentUser",JSON.stringify(t)):this.remove("currentUser")}static getProjectUsers(t){const e=this.get("projectUsers."+t);return e?JSON.parse(e):null}static setProjectUsers(t,e){const r="projectUsers."+t;e?this.set(r,JSON.stringify(e)):this.remove(r)}static getDatabases(){return JSON.parse(this.get("databases")??"[]")}static setDatabases(t){this.set("databases",JSON.stringify(t))}static getListCallLastTimeStamp(t){const e=this.get(`cache.listCall.${t}.lastTimeStamp`);return e?Number(e):null}static setListCallLastTimeStamp(t,e){this.set(`cache.listCall.${t}.lastTimeStamp`,String(e))}}class it{constructor(){m(this,"client",new Dt)}static create(){return new it}async all(){const t=await this.client.openConnection(),e=await t.getAll("sync_transactions");return t.close(),e}async put(t){const e=await this.client.openConnection();await e.put("sync_transactions",t),e.close()}async putMultiple(t){for(const e of t)await this.put(e)}async delete(t){const e=await this.client.openConnection();await e.delete("sync_transactions",t),e.close()}}class et{static create(){return new et}async run(t,e){if(!navigator.onLine)return;const r=p.options.sync.startDate instanceof Date&&t!=="_Model"?Math.floor(p.options.sync.startDate.getTime()/1e3):0,s=D.getLastSyncedAt(t)??r,{transactions:a,lastTimestamp:i}=await _t.create().type(e).query({from:s,models:t?[t]:p.options.sync.models??["_Project",...(await k.list()).map(d=>d.getName()).filter(d=>d.startsWith("bdt")&&!["bdt24prszej_appfiles","bdt24prszej_apps"].includes(d))]}).perform(),o=it.create();await o.putMultiple(a),D.setLastSyncedAt(i??Math.floor(Date.now()/1e3),t),await R.create().run((await o.all()).map(d=>W.fromObject(d))),s!==i&&await this.run(t,e)}async runAtInterval(t){for(;;)await Qt(t),await this.run()}}class R{static create(){return new R}async run(t){const e=new at,r=it.create(),s={add:1,edit:2,delete:3},a=await new Dt().openConnection();t=t.sort((i,o)=>s[i.action]-s[o.action]);for(const i of t){let o;i.model==="@Model"?i.model="_Model":i.model==="@Project"&&(i.model="_Project");try{if(i.action==="add")o=await this.processAddTransaction(i);else if(i.action==="edit")o=await this.processEditTransaction(i,a);else if(i.action==="delete")o=await this.processDeleteTransaction(i);else throw new Error(`Unknown action "${i.action}" on transaction ${i.hash}`);await a.put("evaluated_transactions",i.toObject())}catch(d){o=new N(i.blitzID,i.hash,C.Error,d.message)}e.push(o),await r.delete(i.hash)}return a.close(),e}async processAddTransaction(t){var i;const e=await k.get(t.model),r=e.idbClient();if(await r.find(t.hash))return new N(t.hash,t.hash,C.Error,`Object with ${t.hash} already exists on ${t.model} model.`);const s=e.getClusterManager(),a={_blitzID:t.hash,_blitzstamp:t.blitzstamp.toString(),_sort:t.blitzstamp.toString(),_clusters:s.names(),_editURLs:s.toArray().map(o=>o.options.addURL).flat(),...(()=>{const o={};for(const[d,c]of Object.entries(t.data)){const l=e.getAttributeDetails(d);if(l&&Array.isArray(l.type)&&c!==void 0){const u=typeof c=="string"?JSON.parse(c):c;d.endsWith("_mtm")?o[d]=u.map((f,w)=>({_blitzID:typeof f=="string"?f:f._blitzID,_mtmSort:typeof f=="string"?(u.length-w)*15:f._mtmSort})):o[d]=u}else o[d]=c}return o})()};if(((i=e.haspublishingdate)==null?void 0:i.value)==="1"&&typeof t.data._publishingdate>"u"&&typeof t.blitzstamp=="number"){const o=new Date;o.setTime(t.blitzstamp*1e3+new Date("2021-01-01T00:00:00Z").getTime()),o.setMinutes(o.getMinutes()-o.getTimezoneOffset()),a._publishingdate=o.toISOString().slice(0,19).replace("T"," ")}return!a._userID&&t.userhash&&(a._userID=t.userhash),t.data=a,await r.create(a),new N(t.hash,t.hash,C.Success)}async processEditTransaction(t,e){var c;const r=await k.get(t.model),s=r.idbClient(),a=Object.keys(t.data);if(a.length!==1)return new N(t.blitzID,t.hash,C.Error,a.length>1?"Can not edit more than one attribute at once.":"Attribute not provided to perform edit.");if(await e.get("evaluated_transactions",t.hash))return new N(t.blitzID,t.hash,C.Notice,`Transaction ${t.hash} already processed.`);const i=await s.find(t.blitzID);if(!i)return new N(t.blitzID,t.hash,C.Notice,`Object with ${t.blitzID} does not exists.`);if(i._savetimestamp&&i._savetimestamp>t.blitzstamp)return new N(t.blitzID,t.hash,C.Notice,"Old transaction.");const o=a.shift(),d=(c=r.getAttributeDetails(o))==null?void 0:c.type;if(Array.isArray(d))if(Object.hasOwn(t.data[o],"add")){i[o]=i[o]??[];const l=t.data[o].add;o.endsWith("_mtm")?i[o].push({_blitzID:typeof l=="string"?l:l._blitzID,_mtmSort:typeof l=="string"?i[o].length?Math.max(...i[o].map(h=>h._mtmSort))+15:15:l._mtmSort}):i[o].push(l)}else if(Object.hasOwn(t.data[o],"remove")&&Array.isArray(i[o])){const l=t.data[o].remove;o.endsWith("_mtm")?i[o].splice(i[o].findIndex(h=>h._blitzID===l),1):i[o].splice(i[o].findIndex(h=>h===l),1)}else return new N(t.blitzID,t.hash,C.Error,`Invalid operation for array attribute ${o}.`);else{const l=t.data[o];if(i[o]===l.new)return new N(t.blitzID,t.hash,C.Notice,"Conflict");i[o]=l.new}return await s.update(i),new N(t.blitzID,t.hash,C.Success)}async processDeleteTransaction(t){const r=(await k.get(t.model)).idbClient();return await r.find(t.blitzID)?(await r.delete(t.blitzID),new N(t.blitzID,t.hash,C.Success)):new N(t.blitzID,t.hash,C.Error,`Object with ${t.blitzID} does not exists.`)}}class Ee{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(A.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(A.store,t.id))}async _getCompletedReplicatedJobs(t){var a;const e=[],r=(a=this._db)==null?void 0:a.transaction(A.store,"readonly").store;let s=await(r==null?void 0:r.openCursor(null,"next"));for(;s;)s.value.status===y.Completed&&s.value.url!==t.url&&s.value.transaction.action===T.Edit&&s.value.transaction.blitzID===t.transaction.blitzID&&s.value.transaction.hash===t.transaction.hash&&e.push(s.value),s=await s.continue();return e}async _getFutureJobs(t,e){var o;const r=[],s=(o=this._db)==null?void 0:o.transaction(A.store,"readonly").store,a=IDBKeyRange.lowerBound(t.createdAt,!0);let i=await(s==null?void 0:s.index(A.timeIndex).openCursor(a,"next"));for(;i;)i.value.status===y.Conflict&&i.value.url===t.url&&i.value.transaction.action===T.Edit&&i.value.transaction.blitzID===t.transaction.blitzID&&Object.keys(i.value.transaction.data)[0]===e&&r.push(i.value),i=await i.continue();return r}async _mergeWithFutureEditJobs(t,e){var a,i;const r=await this._getFutureJobs(t,e);let s=t;if(r.length>0){const o=r[r.length-1];if(o&&((a=o.transaction.data)==null?void 0:a[e].new)!==void 0&&((i=t.transaction.data)==null?void 0:i[e].prev)!==void 0){const d={[e]:{prev:t.transaction.data[e].prev,new:o.transaction.data[e].new}},c=new Date().getTime();s=await this._updateJob({...t,transaction:{...t.transaction,data:d,blitzstamp:Z(),hash:tt({...d,blitzID:t.transaction.blitzID,timestamp:c})},dataHistory:[...t.dataHistory??[],{timestamp:c,type:"conflict-succeeding",data:t.transaction.data}]});for(const l of r)await this._deleteJob(l)}}return s}async prompt(t){var a;if(t.message===void 0)return;const e=Object.keys(t.transaction.data)[0];let r=await this._mergeWithFutureEditJobs(t,e);const s=`There was a conflict.
The data got changed to "${r.message}".
Do you still want to perform your change to "${(a=r.transaction.data)==null?void 0:a[e].new}"?`;confirm(s)?(r=await this.force(r),await p.queue.updateSyncStatus(r,y.Pending)):(await this.revert(r),await p.queue.updateSyncStatus(r,y.Completed)),p.dispatchEvent("queue:conflict",r)}async force(t){var o;const e=Object.keys(t.transaction.data)[0],r=await this._getFutureJobs(t,e),s={[e]:{prev:t.message,new:(o=t.transaction.data)==null?void 0:o[e].new}},a=new Date().getTime(),i=await this._updateJob({...t,status:y.Pending,transaction:{...t.transaction,data:s,blitzstamp:Z(),hash:tt({...s,blitzID:t.transaction.blitzID,timestamp:a})},dataHistory:[...t.dataHistory??[],{timestamp:a,type:"conflict-force",data:t.transaction.data}]});await R.create().run([new W({action:"edit",model:i.transaction.model,blitzID:i.transaction.blitzID,data:i.transaction.data})]);for(const d of r)await this._updateJob({...d,status:y.Pending});return i}async revert(t){var i;const e=Object.keys(t.transaction.data)[0],r=new W({action:"edit",model:t.transaction.model,blitzID:t.transaction.blitzID,data:{[e]:{prev:(i=t.transaction.data)==null?void 0:i[e].new,new:t.message}}});await R.create().run([r]);const s=await this._getFutureJobs(t,e),a=await this._getCompletedReplicatedJobs(t);for(const o of[t,...s])await this._deleteJob(o);if(a.length>0){const o=a.map(d=>d.url).filter((d,c,l)=>l.findIndex(u=>u===d)===c);for(const d of o)await p.queue.addJob(d,r.toObject())}}}class Ue{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(A.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(A.store,t.id))}async _getFutureJobs(t){var i;const e=[],r=(i=this._db)==null?void 0:i.transaction(A.store,"readonly").store,s=IDBKeyRange.lowerBound(t.createdAt,!0);let a=await(r==null?void 0:r.index(A.timeIndex).openCursor(s,"next"));for(;a;)a.value.url===t.url&&a.value.transaction.blitzID===t.transaction.blitzID&&e.push(a.value),a=await a.continue();return e}async retry(t){for(const e of t)await this._updateJob({...e,status:y.Pending})}async revert(t){var r,s;t.sort((a,i)=>a.createdAt-i.createdAt);const e=t[0];if(e){if(e.transaction.action===T.Add){await R.create().run([new W({action:"delete",model:e.transaction.model,blitzID:e.transaction.blitzID})]);const a=await this._getFutureJobs(e);for(const i of[e,...a])await this._deleteJob(i)}else if(e.transaction.action===T.Delete)await this._deleteJob(e),await k.get(e.transaction.model).then(a=>a==null?void 0:a.get(e.transaction.blitzID));else if(e.transaction.action===T.Edit){const a=Object.keys(e.transaction.data??{})[0];if(!a||((r=e.transaction.data)==null?void 0:r[a].new)===void 0||((s=e.transaction.data)==null?void 0:s[a].prev)===void 0)return;const i=new W({action:"edit",model:e.transaction.model,blitzID:e.transaction.blitzID,data:{[a]:{prev:e.transaction.data[a].new,new:e.transaction.data[a].prev}}});await R.create().run([i]);for(const o of t)await this._deleteJob(o)}}}async getAll(){var s;const t={},e=(s=this._db)==null?void 0:s.transaction(A.store,"readonly").store;let r=await(e==null?void 0:e.index(A.timeIndex).openCursor(null,"next"));for(;r;){if(r.value.status!==y.Completed){if(t[r.value.url]||(t[r.value.url]=[]),r.value.transaction.action===T.Add||r.value.transaction.action===T.Delete)t[r.value.url].push([r.value]);else if(r.value.transaction.action===T.Edit){const a=Object.keys(r.value.transaction.data??{})[0],i=r.value.transaction.blitzID,o=t[r.value.url].findIndex(d=>d[0].transaction.action===T.Edit&&d[0].transaction.blitzID===i&&Object.keys(d[0].transaction.data??{})[0]===a);o===-1?t[r.value.url].push([r.value]):t[r.value.url][o].push(r.value)}}r=await r.continue()}return t}}const Le="/queue-worker.js";class ke{constructor(){m(this,"_db",null);m(this,"conflictHandler",null);m(this,"failedHandler",null)}_handleWorkerMessage(t){var r;const e=t.data.job;e.status===y.Completed?p.dispatchEvent("queue:success",e):e.status===y.Failed?p.dispatchEvent("queue:failure",e):e.status===y.Conflict&&(document.hidden||(r=p.queue.conflictHandler)==null||r.prompt(e)),p._Model.get(e.transaction.model).then(s=>{var a;return(a=s==null?void 0:s.memoryClient().get(e.transaction.blitzID))==null?void 0:a.dispatchEvent("syncStatusChange",e)}),p.queue.updateSyncStatus(e)}async updateSyncStatus(t,e){if(t.transaction.action!==T.Edit)return;const r=await p._Model.get(t.transaction.model),s=r==null?void 0:r.memoryClient().get(t.transaction.blitzID);if(!s)return;const a=Object.keys(t.transaction.data??{})[0];if(!a)return;const i=s[a];if(!(!i||!Object.hasOwn(i,"_syncSignal")))if(e)i._syncSignal.set({status:e});else{const d=(await p.queue.getJobsForObject(t.transaction.blitzID)).filter(f=>{var w;return f.transaction.action===T.Edit&&((w=f.transaction.data)==null?void 0:w[a])!==void 0});let c=y.Pending,l;const u=d.find(f=>f.status===y.Failed),h=d.find(f=>f.status===y.Conflict);u?(c=y.Failed,l=u):h?(c=y.Conflict,l=h):d.every(f=>f.status===y.Completed)&&(c=y.Completed),i._syncSignal.set({status:c,job:l})}}async init(){if(this._db=await wt(A.name,1,{upgrade:e=>{const r=e.createObjectStore(A.store,{keyPath:"id"});r.createIndex(A.timeIndex,"createdAt"),r.createIndex(A.objectIndex,"transaction.blitzID")}}),!this._db.objectStoreNames.contains(A.store))return await yt(A.name),await this.init();this.conflictHandler=new Ee(this._db),this.failedHandler=new Ue(this._db);const t=new xe(p.options.assetsPath+Le,{});return t.port.onmessage=this._handleWorkerMessage,window.addEventListener("beforeunload",()=>t.port.postMessage({type:"close"})),_._globalHeaders&&t.port.postMessage({type:"headers",data:_._globalHeaders}),this}async addJob(t,e){var s;const r={id:crypto.randomUUID(),url:t,transaction:e,status:y.Pending,createdAt:Date.now(),attempts:0,priority:1};await((s=this._db)==null?void 0:s.add(A.store,r)),await this.updateSyncStatus(r,r.status)}async deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(A.store,t.id))}async getJobs(){var t;return await((t=this._db)==null?void 0:t.getAll(A.store))}async getJobsForObject(t){var r;const e=await((r=this._db)==null?void 0:r.getAllFromIndex(A.store,A.objectIndex,t));return e.sort((s,a)=>s.createdAt-a.createdAt),e}}const rt={a:["à","á","â","ä"],c:["ç"],e:["è","é","ê"],o:["ö","ó","ò","ô","õ"],oe:["œ"],ss:["ß"],u:["ü"]};class ot{constructor(){m(this,"children");m(this,"isEndOfWord");m(this,"items");this.children={},this.isEndOfWord=!1,this.items=[]}}class Fe{constructor(t,e){m(this,"root");if(this.root=new ot,!e)return;const r=this.getWordFrequency(t,e);for(const s in r)this.insert(s,r[s].items)}_loadFromJson(t,e){Object.keys(t).forEach(r=>{typeof t[r]=="string"||typeof t[r]=="boolean"||(e.children[r]||(e.children[r]=new ot),t[r].hasOwnProperty("isEndOfWord")&&t[r].isEndOfWord&&(e.children[r].isEndOfWord=!0,e.children[r].items=t[r].items),this._loadFromJson(t[r],e.children[r]))})}loadFromJson(t){return this.root=new ot,this._loadFromJson(t,this.root),this}toJson(){const t=e=>{let r={};for(const s in e.children)r[s]=t(e.children[s]);return e.isEndOfWord&&(r.isEndOfWord=!0,r.items=e.items),r};return t(this.root)}getWordFrequency(t,e){const r={},s=t.getAttributes();return e.forEach(a=>{s==null||s.forEach(i=>{if(!a[i])return;a[i].toString().toLowerCase().split(" ").forEach(d=>{d!==""&&(r[d]?r[d].items.push(a._blitzID):r[d]={items:[a._blitzID]})})})}),r}getVariants(t){const e=rt[t],r=[t];return e&&r.push(...e),r}generateAllPermutations(t,e,r,s,a){if(e===r.length){a.push(t);return}const i=r[e],o=e!==r.length-1?i+r[e+1]:void 0;if(!rt[i]&&!(o&&rt[o])){this.generateAllPermutations(t+i,e+1,r,s,a);return}if(rt[i]){const d=s[i];for(const c of d)this.generateAllPermutations(t+c,e+1,r,s,a)}if(o&&rt[o]){const d=s[o];for(const c of d)this.generateAllPermutations(t+c,e+2,r,s,a)}}normalizeQuery(t){const e=/u|e|a|o|c|ss|oe/g,r=t.toLowerCase().match(e);if(!r)return[t.toLowerCase()];const s={};r.forEach(i=>{s[i]=this.getVariants(i)});const a=[];return this.generateAllPermutations("",0,t,s,a),a}insert(t,e){let r=this.root;for(const s of t)r.children[s]||(r.children[s]=new ot),r=r.children[s];r.isEndOfWord=!0,r.items=e}addToSet(t,e){const r=this.normalizeQuery(t);for(const s of r)this._search(s).forEach(i=>{e.add(i)})}search(t){const e=t==null?void 0:t.toLowerCase().split(" ");let r=new Set;return this.addToSet(e[0],r),e.slice(1).forEach(s=>{const a=new Set;this.addToSet(s,a);for(const i of r)a.has(i)||r.delete(i)}),Array.from(r)}_search(t){let e=this.root;for(const s of t){if(!e.children[s])return[];e=e.children[s]}const r=[];return t===""?this.collectWords(e,"",r):this.collectWords(e,t,r),r}collectWords(t,e,r){t.isEndOfWord&&r.push(...t.items);for(const s in t.children){const a=t.children[s],i=e+s;this.collectWords(a,i,r)}}}function Xt(n,t,e){var s;let r=!0;for(const a of t){if(!r)return!1;const[i,o,d]=a,c=(s=e==null?void 0:e[i])==null?void 0:s.type;let l=n[i],u=d;switch(typeof l=="string"&&(c==="datetime"||c==="date"||i==="_publishingdate")&&(l=new Date(l).getTime()),typeof u=="string"&&(c==="datetime"||c==="date"||i==="_publishingdate")&&(u=new Date(u).getTime()),o){case"LIKE":const h=`${u}`.startsWith("%"),f=`${u}`.endsWith("%"),w=`${u}`.replaceAll("%","");h===f?r=`${l}`.includes(w):h?r=`${l}`.endsWith(w):f&&(r=`${l}`.startsWith(w));break;case"IN":r=(Array.isArray(u)?u:[u]).includes(l);break;case"=":r=l===u;break;case"!=":r=l!==u;break;case">":r=l>u;break;case"<":r=l<u;break;case">=":r=l>=u;break;case"<=":r=l<=u;break;default:r=!0;break}}return r}class We{constructor(t){m(this,"model");this.model=t,this.ping()}async ping(){(await this.connect()).close()}async query(t,e){const r=await this.connect(),s=r.transaction("objects","readonly").store,a=t.customSort&&Array.from(s.indexNames).includes(t.customSort)?t.customSort:"sorted",i=t.customSortDirection==="ASC"?"next":"prev";let o=await s.index(a).openCursor(null,i);const d=this.model.getAttributesDetails()??void 0;let c=[];for(;o;){if(e&&!e.includes(o.value.blitzID)){o=await o.continue();continue}if(Xt(o.value,t.conditions??[],d)&&(c.push(o.value),t.limit&&c.length>=t.limit))break;o=await o.continue()}if(r.close(),t.var&&t.var.length>0){const u=["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var];for(const h of c)for(const f in h)u.includes(f)||delete h[f]}return c}async search(t,e){const r=await this.connect(),s=new Fe(this.model).loadFromJson(r.get("tree",this.model.getName()));r.close();const a=s.search(t);return t!==""&&a.length===0?[]:this.query({conditions:e},a)}async save(t,e=!1){const r=await this.connect();for(const s of t){let a={...s};const i=await r.get("objects",a._blitzID);if(i)a={...i,...a};else if(e)continue;a._savetimestamp=Z(),await r.put("objects",a)}r.close()}async connect(){const t=this.model.getAttributesDetails();return await wt(this.model.getName(),1,{upgrade:(r,s,a,i,o)=>{const d=D.getDatabases();if(d.includes(r.name)||(d.push(r.name),D.setDatabases(d)),a!==1)return;r.createObjectStore("tree",{keyPath:"name"});const c=r.createObjectStore("objects",{keyPath:"_blitzID"});if(t)for(const l in t)(t[l].type==="date"||l.includes("_fk"))&&c.createIndex(l,l,{unique:!1});c.createIndex("sorted","_blitzstamp")}})}async find(t){const e=await this.connect(),r=e.get("objects",t);return e.close(),r}async create(t){const e=await this.connect();await e.put("objects",t),e.close()}async update(t){const e=await this.connect();await e.put("objects",t),e.close()}async delete(t){const e=await this.connect();await e.delete("objects",t),e.close()}}class Mt{constructor(){m(this,"_subscribers");m(this,"_cleanUp",()=>{});this._subscribers=new Set}emit(t){for(const e of this._subscribers)e(t)}subscribe(t){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),()=>{this._subscribers.delete(t),this._cleanUp()}}filterPipe(t){const e=new Mt;return e._cleanUp=this.subscribe(r=>{t(r)&&e.emit(r)}),e}}const dt=class dt{constructor(t){m(this,"model");this.model=t,p.objects.has(this.model.getName())||p.objects.set(this.model.getName(),new Map)}getAll(){return p.objects.get(this.model.getName())}get(t){return this.getAll().get(t)}update(t){var a;const e=this.getAll();if(!e.has(t._blitzID.value))return e.set(t._blitzID.value,t),t;const r=e.get(t._blitzID.value),s=Object.keys(this.model.getAttributesDetails()??{});for(const i of s){const o=(a=t[i])==null?void 0:a._value;if(o!==void 0){const d=r[i];d&&(d._value=o,d._valueSignal.set(o,!1))}}return r}delete(t){const e=this.getAll();e.has(t)&&e.delete(t)}emit(t){dt.channel.emit(t)}async query(t={}){const e=[],r=Array.from(this.getAll().values()).map(c=>c.toObject()),s=this.model.getAttributesDetails()??void 0,a=Object.keys(s??{}),i=t.customSort&&a.includes(t.customSort)?t.customSort:"_blitzstamp",o=t.customSortDirection??"DESC";r.sort((c,l)=>{try{const u=parseInt(c[i]),h=parseInt(l[i]);if(u<h)return o==="ASC"?-1:1;if(u>h)return o==="ASC"?1:-1}catch{}return 0});for(const c of r)if(Xt(c,t.conditions??[],s)&&(e.push(c),t.limit&&e.length>=t.limit))break;if(t.var&&t.var.length>0){const c=["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var];for(const l of e)for(const u in l)c.includes(u)||delete l[u]}return e}};m(dt,"channel",new Mt);let ct=dt;class Je{static async send(t,e){try{const r=new URL(t.url).origin!==self.location.origin?"?enableCors=1":"",s=await globalThis.fetch(t.url+"/api/post.json"+r,{method:"POST",headers:{"Content-Type":"application/json",...e??{}},body:JSON.stringify([t.transaction])});if(!s.ok)throw new Error(`HTTP request failed with status ${s.status}`+(s.statusText?`: ${s.statusText}`:""));const a=await s.json();if(!a||!a.results)throw new Error("No response returned!");const i=a.results[t.transaction.hash];if(!i)throw new Error("No result returned for this job!");if(i.s||i.s0||i.s1||i.n)return{status:Q.Success};if(i.conflict){const o=Object.keys(t.transaction.data)[0],d=i.conflict[o];if(!d)throw new Error("No previous value found in conflict result!");return{status:Q.Conflict,message:d}}else if(i.e)return{status:Q.Failed,message:i.e};return{status:Q.Exception,message:a.error??(Array.isArray(a.errors)?a.errors.map(o=>(o==null?void 0:o.message)??o).join(" | "):"Unknown error!")}}catch(r){return{status:Q.Exception,message:r.message}}}}class nt{constructor(t){m(this,"_value");m(this,"_subscribers");this._value=t,this._subscribers=new Set}get(){return this._value}set(t,e=!0){this._value!==t&&(this._value=t,e&&this.emit())}emit(){for(const t of this._subscribers)t(this._value)}subscribe(t,e=!0){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),e&&t(this._value),()=>this._subscribers.delete(t)}}class j{constructor(t,e,r){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(r),this._valueSignal=new nt(this._value),this._syncSignal=new nt(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}withValue(t){return this.value=t,this}withObject(t){return this._object=t,this}async edit(t,e){if(!this._object)throw new Error("Can not edit attribute, object is not set.");return this._object.edit(this._name,t,e)}subscribe(t,e=!0){var s,a;const r=this._valueSignal.subscribe(t,e);return this._value===void 0&&((a=(s=this._object)==null?void 0:s.model)==null||a.get({blitzID:this._object._blitzID.value,forceHttp:!0}).then(i=>{(i==null?void 0:i[this._name]._value)!==void 0&&this._valueSignal.emit()})),r}syncStatus(t){var s;const e=this._syncSignal.get()!==null,r=this._syncSignal.subscribe(t,e);return e||p.queue.getJobsForObject((s=this._object)==null?void 0:s._blitzID.value).then(a=>{const i=a.filter(u=>{var h;return u.transaction.action===T.Edit&&((h=u.transaction.data)==null?void 0:h[this._name])!==void 0});let o=y.Pending,d;const c=i.find(u=>u.status===y.Failed),l=i.find(u=>u.status===y.Conflict);c?(o=y.Failed,d=c):l?(o=y.Conflict,d=l):i.every(u=>u.status===y.Completed)&&(o=y.Completed),this._syncSignal.set({status:o,job:d},!1),t(this._syncSignal.get())}),r}getDetails(){var t,e;return((e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttributeDetails(this._name))||null}}class st extends j{unserialize(t){return t}serialize(){return this._value}}class Yt extends j{unserialize(t){if(typeof t=="boolean")return t;if(typeof t=="string"&&["0","1"].includes(t))return t==="1";if(typeof t=="number"&&[0,1].includes(t))return t===1;if(t!==void 0)return null}serialize(){return typeof this._value=="boolean"?this._value?"1":"0":this._value}}const lt=43200,Kt=1440,Zt=Symbol.for("constructDateFrom");function St(n,t){return typeof n=="function"?n(t):n&&typeof n=="object"&&Zt in n?n[Zt](t):n instanceof Date?new n.constructor(t):new Date(t)}function B(n,t){return St(t||n,n)}let Ne={};function $e(){return Ne}function Gt(n){const t=B(n),e=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return e.setUTCFullYear(t.getFullYear()),+n-+e}function zt(n,...t){const e=St.bind(null,n||t.find(r=>typeof r=="object"));return t.map(e)}function ut(n,t){const e=+B(n)-+B(t);return e<0?-1:e>0?1:e}function Re(n){return St(n,Date.now())}function He(n,t,e){const[r,s]=zt(e==null?void 0:e.in,n,t),a=r.getFullYear()-s.getFullYear(),i=r.getMonth()-s.getMonth();return a*12+i}function Ve(n){return t=>{const r=(n?Math[n]:Math.trunc)(t);return r===0?0:r}}function Be(n,t){return+B(n)-+B(t)}function qe(n,t){const e=B(n,t==null?void 0:t.in);return e.setHours(23,59,59,999),e}function Qe(n,t){const e=B(n,t==null?void 0:t.in),r=e.getMonth();return e.setFullYear(e.getFullYear(),r+1,0),e.setHours(23,59,59,999),e}function Xe(n,t){const e=B(n,t==null?void 0:t.in);return+qe(e,t)==+Qe(e,t)}function Ye(n,t,e){const[r,s,a]=zt(e==null?void 0:e.in,n,n,t),i=ut(s,a),o=Math.abs(He(s,a));if(o<1)return 0;s.getMonth()===1&&s.getDate()>27&&s.setDate(30),s.setMonth(s.getMonth()-i*o);let d=ut(s,a)===-i;Xe(r)&&o===1&&ut(r,a)===1&&(d=!1);const c=i*(o-+d);return c===0?0:c}function Ke(n,t,e){const r=Be(n,t)/1e3;return Ve(e==null?void 0:e.roundingMethod)(r)}const Ze={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Ge=(n,t,e)=>{let r;const s=Ze[n];return typeof s=="string"?r=s:t===1?r=s.one:r=s.other.replace("{{count}}",t.toString()),e!=null&&e.addSuffix?e.comparison&&e.comparison>0?"in "+r:r+" ago":r};function V(n){return(t={})=>{const e=t.width?String(t.width):n.defaultWidth;return n.formats[e]||n.formats[n.defaultWidth]}}const tr={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},er={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},rr={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},nr={date:V({formats:tr,defaultWidth:"full"}),time:V({formats:er,defaultWidth:"full"}),dateTime:V({formats:rr,defaultWidth:"full"})},sr={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},ar=(n,t,e,r)=>sr[n];function U(n){return(t,e)=>{const r=e!=null&&e.context?String(e.context):"standalone";let s;if(r==="formatting"&&n.formattingValues){const i=n.defaultFormattingWidth||n.defaultWidth,o=e!=null&&e.width?String(e.width):i;s=n.formattingValues[o]||n.formattingValues[i]}else{const i=n.defaultWidth,o=e!=null&&e.width?String(e.width):n.defaultWidth;s=n.values[o]||n.values[i]}const a=n.argumentCallback?n.argumentCallback(t):t;return s[a]}}const ir={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},or={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},cr={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},lr={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},ur={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},dr={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},hr={ordinalNumber:(n,t)=>{const e=Number(n),r=e%100;if(r>20||r<10)switch(r%10){case 1:return e+"st";case 2:return e+"nd";case 3:return e+"rd"}return e+"th"},era:U({values:ir,defaultWidth:"wide"}),quarter:U({values:or,defaultWidth:"wide",argumentCallback:n=>n-1}),month:U({values:cr,defaultWidth:"wide"}),day:U({values:lr,defaultWidth:"wide"}),dayPeriod:U({values:ur,defaultWidth:"wide",formattingValues:dr,defaultFormattingWidth:"wide"})};function L(n){return(t,e={})=>{const r=e.width,s=r&&n.matchPatterns[r]||n.matchPatterns[n.defaultMatchWidth],a=t.match(s);if(!a)return null;const i=a[0],o=r&&n.parsePatterns[r]||n.parsePatterns[n.defaultParseWidth],d=Array.isArray(o)?mr(o,u=>u.test(i)):fr(o,u=>u.test(i));let c;c=n.valueCallback?n.valueCallback(d):d,c=e.valueCallback?e.valueCallback(c):c;const l=t.slice(i.length);return{value:c,rest:l}}}function fr(n,t){for(const e in n)if(Object.prototype.hasOwnProperty.call(n,e)&&t(n[e]))return e}function mr(n,t){for(let e=0;e<n.length;e++)if(t(n[e]))return e}function It(n){return(t,e={})=>{const r=t.match(n.matchPattern);if(!r)return null;const s=r[0],a=t.match(n.parsePattern);if(!a)return null;let i=n.valueCallback?n.valueCallback(a[0]):a[0];i=e.valueCallback?e.valueCallback(i):i;const o=t.slice(s.length);return{value:i,rest:o}}}const gr=/^(\d+)(th|st|nd|rd)?/i,br=/\d+/i,pr={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},wr={any:[/^b/i,/^(a|c)/i]},yr={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},vr={any:[/1/i,/2/i,/3/i,/4/i]},_r={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},Dr={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},Mr={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},Sr={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},zr={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},Ir={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},Ar={ordinalNumber:It({matchPattern:gr,parsePattern:br,valueCallback:n=>parseInt(n,10)}),era:L({matchPatterns:pr,defaultMatchWidth:"wide",parsePatterns:wr,defaultParseWidth:"any"}),quarter:L({matchPatterns:yr,defaultMatchWidth:"wide",parsePatterns:vr,defaultParseWidth:"any",valueCallback:n=>n+1}),month:L({matchPatterns:_r,defaultMatchWidth:"wide",parsePatterns:Dr,defaultParseWidth:"any"}),day:L({matchPatterns:Mr,defaultMatchWidth:"wide",parsePatterns:Sr,defaultParseWidth:"any"}),dayPeriod:L({matchPatterns:zr,defaultMatchWidth:"any",parsePatterns:Ir,defaultParseWidth:"any"})},At={code:"en-US",formatDistance:Ge,formatLong:nr,formatRelative:ar,localize:hr,match:Ar,options:{weekStartsOn:0,firstWeekContainsDate:1}};function Tr(n,t,e){const r=$e(),s=(e==null?void 0:e.locale)??r.locale??At,a=2520,i=ut(n,t);if(isNaN(i))throw new RangeError("Invalid time value");const o=Object.assign({},e,{addSuffix:e==null?void 0:e.addSuffix,comparison:i}),[d,c]=zt(e==null?void 0:e.in,...i>0?[t,n]:[n,t]),l=Ke(c,d),u=(Gt(c)-Gt(d))/1e3,h=Math.round((l-u)/60);let f;if(h<2)return e!=null&&e.includeSeconds?l<5?s.formatDistance("lessThanXSeconds",5,o):l<10?s.formatDistance("lessThanXSeconds",10,o):l<20?s.formatDistance("lessThanXSeconds",20,o):l<40?s.formatDistance("halfAMinute",0,o):l<60?s.formatDistance("lessThanXMinutes",1,o):s.formatDistance("xMinutes",1,o):h===0?s.formatDistance("lessThanXMinutes",1,o):s.formatDistance("xMinutes",h,o);if(h<45)return s.formatDistance("xMinutes",h,o);if(h<90)return s.formatDistance("aboutXHours",1,o);if(h<Kt){const w=Math.round(h/60);return s.formatDistance("aboutXHours",w,o)}else{if(h<a)return s.formatDistance("xDays",1,o);if(h<lt){const w=Math.round(h/Kt);return s.formatDistance("xDays",w,o)}else if(h<lt*2)return f=Math.round(h/lt),s.formatDistance("aboutXMonths",f,o)}if(f=Ye(c,d),f<12){const w=Math.round(h/lt);return s.formatDistance("xMonths",w,o)}else{const w=f%12,S=Math.trunc(f/12);return w<3?s.formatDistance("aboutXYears",S,o):w<9?s.formatDistance("overXYears",S,o):s.formatDistance("almostXYears",S+1,o)}}function te(n,t){return Tr(n,Re(n),t)}const ee={lessThanXSeconds:{standalone:{one:"weniger als 1 Sekunde",other:"weniger als {{count}} Sekunden"},withPreposition:{one:"weniger als 1 Sekunde",other:"weniger als {{count}} Sekunden"}},xSeconds:{standalone:{one:"1 Sekunde",other:"{{count}} Sekunden"},withPreposition:{one:"1 Sekunde",other:"{{count}} Sekunden"}},halfAMinute:{standalone:"eine halbe Minute",withPreposition:"einer halben Minute"},lessThanXMinutes:{standalone:{one:"weniger als 1 Minute",other:"weniger als {{count}} Minuten"},withPreposition:{one:"weniger als 1 Minute",other:"weniger als {{count}} Minuten"}},xMinutes:{standalone:{one:"1 Minute",other:"{{count}} Minuten"},withPreposition:{one:"1 Minute",other:"{{count}} Minuten"}},aboutXHours:{standalone:{one:"etwa 1 Stunde",other:"etwa {{count}} Stunden"},withPreposition:{one:"etwa 1 Stunde",other:"etwa {{count}} Stunden"}},xHours:{standalone:{one:"1 Stunde",other:"{{count}} Stunden"},withPreposition:{one:"1 Stunde",other:"{{count}} Stunden"}},xDays:{standalone:{one:"1 Tag",other:"{{count}} Tage"},withPreposition:{one:"1 Tag",other:"{{count}} Tagen"}},aboutXWeeks:{standalone:{one:"etwa 1 Woche",other:"etwa {{count}} Wochen"},withPreposition:{one:"etwa 1 Woche",other:"etwa {{count}} Wochen"}},xWeeks:{standalone:{one:"1 Woche",other:"{{count}} Wochen"},withPreposition:{one:"1 Woche",other:"{{count}} Wochen"}},aboutXMonths:{standalone:{one:"etwa 1 Monat",other:"etwa {{count}} Monate"},withPreposition:{one:"etwa 1 Monat",other:"etwa {{count}} Monaten"}},xMonths:{standalone:{one:"1 Monat",other:"{{count}} Monate"},withPreposition:{one:"1 Monat",other:"{{count}} Monaten"}},aboutXYears:{standalone:{one:"etwa 1 Jahr",other:"etwa {{count}} Jahre"},withPreposition:{one:"etwa 1 Jahr",other:"etwa {{count}} Jahren"}},xYears:{standalone:{one:"1 Jahr",other:"{{count}} Jahre"},withPreposition:{one:"1 Jahr",other:"{{count}} Jahren"}},overXYears:{standalone:{one:"mehr als 1 Jahr",other:"mehr als {{count}} Jahre"},withPreposition:{one:"mehr als 1 Jahr",other:"mehr als {{count}} Jahren"}},almostXYears:{standalone:{one:"fast 1 Jahr",other:"fast {{count}} Jahre"},withPreposition:{one:"fast 1 Jahr",other:"fast {{count}} Jahren"}}},Pr=(n,t,e)=>{let r;const s=e!=null&&e.addSuffix?ee[n].withPreposition:ee[n].standalone;return typeof s=="string"?r=s:t===1?r=s.one:r=s.other.replace("{{count}}",String(t)),e!=null&&e.addSuffix?e.comparison&&e.comparison>0?"in "+r:"vor "+r:r},jr={full:"EEEE, do MMMM y",long:"do MMMM y",medium:"do MMM y",short:"dd.MM.y"},Or={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},xr={full:"{{date}} 'um' {{time}}",long:"{{date}} 'um' {{time}}",medium:"{{date}} {{time}}",short:"{{date}} {{time}}"},Cr={date:V({formats:jr,defaultWidth:"full"}),time:V({formats:Or,defaultWidth:"full"}),dateTime:V({formats:xr,defaultWidth:"full"})},Er={lastWeek:"'letzten' eeee 'um' p",yesterday:"'gestern um' p",today:"'heute um' p",tomorrow:"'morgen um' p",nextWeek:"eeee 'um' p",other:"P"},Ur=(n,t,e,r)=>Er[n],Lr={narrow:["v.Chr.","n.Chr."],abbreviated:["v.Chr.","n.Chr."],wide:["vor Christus","nach Christus"]},kr={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1. Quartal","2. Quartal","3. Quartal","4. Quartal"]},Tt={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],wide:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"]},Fr={narrow:Tt.narrow,abbreviated:["Jan.","Feb.","März","Apr.","Mai","Juni","Juli","Aug.","Sep.","Okt.","Nov.","Dez."],wide:Tt.wide},Wr={narrow:["S","M","D","M","D","F","S"],short:["So","Mo","Di","Mi","Do","Fr","Sa"],abbreviated:["So.","Mo.","Di.","Mi.","Do.","Fr.","Sa."],wide:["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"]},Jr={narrow:{am:"vm.",pm:"nm.",midnight:"Mitternacht",noon:"Mittag",morning:"Morgen",afternoon:"Nachm.",evening:"Abend",night:"Nacht"},abbreviated:{am:"vorm.",pm:"nachm.",midnight:"Mitternacht",noon:"Mittag",morning:"Morgen",afternoon:"Nachmittag",evening:"Abend",night:"Nacht"},wide:{am:"vormittags",pm:"nachmittags",midnight:"Mitternacht",noon:"Mittag",morning:"Morgen",afternoon:"Nachmittag",evening:"Abend",night:"Nacht"}},Nr={narrow:{am:"vm.",pm:"nm.",midnight:"Mitternacht",noon:"Mittag",morning:"morgens",afternoon:"nachm.",evening:"abends",night:"nachts"},abbreviated:{am:"vorm.",pm:"nachm.",midnight:"Mitternacht",noon:"Mittag",morning:"morgens",afternoon:"nachmittags",evening:"abends",night:"nachts"},wide:{am:"vormittags",pm:"nachmittags",midnight:"Mitternacht",noon:"Mittag",morning:"morgens",afternoon:"nachmittags",evening:"abends",night:"nachts"}},$r={ordinalNumber:n=>Number(n)+".",era:U({values:Lr,defaultWidth:"wide"}),quarter:U({values:kr,defaultWidth:"wide",argumentCallback:n=>n-1}),month:U({values:Tt,formattingValues:Fr,defaultWidth:"wide"}),day:U({values:Wr,defaultWidth:"wide"}),dayPeriod:U({values:Jr,defaultWidth:"wide",formattingValues:Nr,defaultFormattingWidth:"wide"})},Rr=/^(\d+)(\.)?/i,Hr=/\d+/i,Vr={narrow:/^(v\.? ?Chr\.?|n\.? ?Chr\.?)/i,abbreviated:/^(v\.? ?Chr\.?|n\.? ?Chr\.?)/i,wide:/^(vor Christus|vor unserer Zeitrechnung|nach Christus|unserer Zeitrechnung)/i},Br={any:[/^v/i,/^n/i]},qr={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](\.)? Quartal/i},Qr={any:[/1/i,/2/i,/3/i,/4/i]},Xr={narrow:/^[jfmasond]/i,abbreviated:/^(j[aä]n|feb|mär[z]?|apr|mai|jun[i]?|jul[i]?|aug|sep|okt|nov|dez)\.?/i,wide:/^(januar|februar|märz|april|mai|juni|juli|august|september|oktober|november|dezember)/i},Yr={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^j[aä]/i,/^f/i,/^mär/i,/^ap/i,/^mai/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},Kr={narrow:/^[smdmf]/i,short:/^(so|mo|di|mi|do|fr|sa)/i,abbreviated:/^(son?|mon?|die?|mit?|don?|fre?|sam?)\.?/i,wide:/^(sonntag|montag|dienstag|mittwoch|donnerstag|freitag|samstag)/i},Zr={any:[/^so/i,/^mo/i,/^di/i,/^mi/i,/^do/i,/^f/i,/^sa/i]},Gr={narrow:/^(vm\.?|nm\.?|Mitternacht|Mittag|morgens|nachm\.?|abends|nachts)/i,abbreviated:/^(vorm\.?|nachm\.?|Mitternacht|Mittag|morgens|nachm\.?|abends|nachts)/i,wide:/^(vormittags|nachmittags|Mitternacht|Mittag|morgens|nachmittags|abends|nachts)/i},tn={any:{am:/^v/i,pm:/^n/i,midnight:/^Mitte/i,noon:/^Mitta/i,morning:/morgens/i,afternoon:/nachmittags/i,evening:/abends/i,night:/nachts/i}},en={ordinalNumber:It({matchPattern:Rr,parsePattern:Hr,valueCallback:n=>parseInt(n)}),era:L({matchPatterns:Vr,defaultMatchWidth:"wide",parsePatterns:Br,defaultParseWidth:"any"}),quarter:L({matchPatterns:qr,defaultMatchWidth:"wide",parsePatterns:Qr,defaultParseWidth:"any",valueCallback:n=>n+1}),month:L({matchPatterns:Xr,defaultMatchWidth:"wide",parsePatterns:Yr,defaultParseWidth:"any"}),day:L({matchPatterns:Kr,defaultMatchWidth:"wide",parsePatterns:Zr,defaultParseWidth:"any"}),dayPeriod:L({matchPatterns:Gr,defaultMatchWidth:"wide",parsePatterns:tn,defaultParseWidth:"any"})},re={code:"de",formatDistance:Pr,formatLong:Cr,formatRelative:Ur,localize:$r,match:en,options:{weekStartsOn:1,firstWeekContainsDate:4}},rn={lessThanXSeconds:{one:"moins d’une seconde",other:"moins de {{count}} secondes"},xSeconds:{one:"1 seconde",other:"{{count}} secondes"},halfAMinute:"30 secondes",lessThanXMinutes:{one:"moins d’une minute",other:"moins de {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"environ 1 heure",other:"environ {{count}} heures"},xHours:{one:"1 heure",other:"{{count}} heures"},xDays:{one:"1 jour",other:"{{count}} jours"},aboutXWeeks:{one:"environ 1 semaine",other:"environ {{count}} semaines"},xWeeks:{one:"1 semaine",other:"{{count}} semaines"},aboutXMonths:{one:"environ 1 mois",other:"environ {{count}} mois"},xMonths:{one:"1 mois",other:"{{count}} mois"},aboutXYears:{one:"environ 1 an",other:"environ {{count}} ans"},xYears:{one:"1 an",other:"{{count}} ans"},overXYears:{one:"plus d’un an",other:"plus de {{count}} ans"},almostXYears:{one:"presqu’un an",other:"presque {{count}} ans"}},nn=(n,t,e)=>{let r;const s=rn[n];return typeof s=="string"?r=s:t===1?r=s.one:r=s.other.replace("{{count}}",String(t)),e!=null&&e.addSuffix?e.comparison&&e.comparison>0?"dans "+r:"il y a "+r:r},sn={full:"EEEE d MMMM y",long:"d MMMM y",medium:"d MMM y",short:"dd/MM/y"},an={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},on={full:"{{date}} 'à' {{time}}",long:"{{date}} 'à' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},cn={date:V({formats:sn,defaultWidth:"full"}),time:V({formats:an,defaultWidth:"full"}),dateTime:V({formats:on,defaultWidth:"full"})},ln={lastWeek:"eeee 'dernier à' p",yesterday:"'hier à' p",today:"'aujourd’hui à' p",tomorrow:"'demain à' p'",nextWeek:"eeee 'prochain à' p",other:"P"},un=(n,t,e,r)=>ln[n],dn={narrow:["av. J.-C","ap. J.-C"],abbreviated:["av. J.-C","ap. J.-C"],wide:["avant Jésus-Christ","après Jésus-Christ"]},hn={narrow:["T1","T2","T3","T4"],abbreviated:["1er trim.","2ème trim.","3ème trim.","4ème trim."],wide:["1er trimestre","2ème trimestre","3ème trimestre","4ème trimestre"]},fn={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["janv.","févr.","mars","avr.","mai","juin","juil.","août","sept.","oct.","nov.","déc."],wide:["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"]},mn={narrow:["D","L","M","M","J","V","S"],short:["di","lu","ma","me","je","ve","sa"],abbreviated:["dim.","lun.","mar.","mer.","jeu.","ven.","sam."],wide:["dimanche","lundi","mardi","mercredi","jeudi","vendredi","samedi"]},gn={narrow:{am:"AM",pm:"PM",midnight:"minuit",noon:"midi",morning:"mat.",afternoon:"ap.m.",evening:"soir",night:"mat."},abbreviated:{am:"AM",pm:"PM",midnight:"minuit",noon:"midi",morning:"matin",afternoon:"après-midi",evening:"soir",night:"matin"},wide:{am:"AM",pm:"PM",midnight:"minuit",noon:"midi",morning:"du matin",afternoon:"de l’après-midi",evening:"du soir",night:"du matin"}},bn=(n,t)=>{const e=Number(n),r=t==null?void 0:t.unit;if(e===0)return"0";const s=["year","week","hour","minute","second"];let a;return e===1?a=r&&s.includes(r)?"ère":"er":a="ème",e+a},pn=["MMM","MMMM"],wn={preprocessor:(n,t)=>n.getDate()===1||!t.some(r=>r.isToken&&pn.includes(r.value))?t:t.map(r=>r.isToken&&r.value==="do"?{isToken:!0,value:"d"}:r),ordinalNumber:bn,era:U({values:dn,defaultWidth:"wide"}),quarter:U({values:hn,defaultWidth:"wide",argumentCallback:n=>n-1}),month:U({values:fn,defaultWidth:"wide"}),day:U({values:mn,defaultWidth:"wide"}),dayPeriod:U({values:gn,defaultWidth:"wide"})},yn=/^(\d+)(ième|ère|ème|er|e)?/i,vn=/\d+/i,_n={narrow:/^(av\.J\.C|ap\.J\.C|ap\.J\.-C)/i,abbreviated:/^(av\.J\.-C|av\.J-C|apr\.J\.-C|apr\.J-C|ap\.J-C)/i,wide:/^(avant Jésus-Christ|après Jésus-Christ)/i},Dn={any:[/^av/i,/^ap/i]},Mn={narrow:/^T?[1234]/i,abbreviated:/^[1234](er|ème|e)? trim\.?/i,wide:/^[1234](er|ème|e)? trimestre/i},Sn={any:[/1/i,/2/i,/3/i,/4/i]},zn={narrow:/^[jfmasond]/i,abbreviated:/^(janv|févr|mars|avr|mai|juin|juill|juil|août|sept|oct|nov|déc)\.?/i,wide:/^(janvier|février|mars|avril|mai|juin|juillet|août|septembre|octobre|novembre|décembre)/i},In={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^av/i,/^ma/i,/^juin/i,/^juil/i,/^ao/i,/^s/i,/^o/i,/^n/i,/^d/i]},An={narrow:/^[lmjvsd]/i,short:/^(di|lu|ma|me|je|ve|sa)/i,abbreviated:/^(dim|lun|mar|mer|jeu|ven|sam)\.?/i,wide:/^(dimanche|lundi|mardi|mercredi|jeudi|vendredi|samedi)/i},Tn={narrow:[/^d/i,/^l/i,/^m/i,/^m/i,/^j/i,/^v/i,/^s/i],any:[/^di/i,/^lu/i,/^ma/i,/^me/i,/^je/i,/^ve/i,/^sa/i]},Pn={narrow:/^(a|p|minuit|midi|mat\.?|ap\.?m\.?|soir|nuit)/i,any:/^([ap]\.?\s?m\.?|du matin|de l'après[-\s]midi|du soir|de la nuit)/i},jn={any:{am:/^a/i,pm:/^p/i,midnight:/^min/i,noon:/^mid/i,morning:/mat/i,afternoon:/ap/i,evening:/soir/i,night:/nuit/i}},On={ordinalNumber:It({matchPattern:yn,parsePattern:vn,valueCallback:n=>parseInt(n)}),era:L({matchPatterns:_n,defaultMatchWidth:"wide",parsePatterns:Dn,defaultParseWidth:"any"}),quarter:L({matchPatterns:Mn,defaultMatchWidth:"wide",parsePatterns:Sn,defaultParseWidth:"any",valueCallback:n=>n+1}),month:L({matchPatterns:zn,defaultMatchWidth:"wide",parsePatterns:In,defaultParseWidth:"any"}),day:L({matchPatterns:An,defaultMatchWidth:"wide",parsePatterns:Tn,defaultParseWidth:"any"}),dayPeriod:L({matchPatterns:Pn,defaultMatchWidth:"any",parsePatterns:jn,defaultParseWidth:"any"})},ne={code:"fr",formatDistance:nn,formatLong:cn,formatRelative:un,localize:wn,match:On,options:{weekStartsOn:1,firstWeekContainsDate:4}},xn=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/;class Cn extends j{unserialize(t){if(t==="0000-00-00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&xn.test(e))return e;if(t!==void 0)return null}serialize(){return this._value===null?"0000-00-00":this._value}toDateString(t){return!t||!(t instanceof Date)?null:t.toISOString().substring(0,10)}toDateObject(){return this._value?new Date(this._value):null}toRelative(t="en"){if(!this._value)return null;const e=t==="fr"?ne:t==="de"?re:At;return te(new Date(this._value),{addSuffix:!0,locale:e})}}class Pt extends j{unserialize(t){return t}serialize(){return this._value}}class En extends j{unserialize(t){return t}serialize(){return this._value}}class se extends j{unserialize(t){if(typeof t=="number")return t;if(typeof t=="string")return parseInt(t,10);if(t!==void 0)return null}serialize(){return typeof this._value=="number"?this._value.toString():this._value}}class Un extends Pt{}const Ln=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}\s[0-9]{2}\:[0-9]{2}\:[0-9]{2}$/;class kn extends j{unserialize(t){if(t==="0000-00-00 00:00:00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&Ln.test(e))return e;if(t!==void 0)return null}serialize(){return this._value===null?"0000-00-00 00:00:00":this._value}toDateString(t){if(!t||!(t instanceof Date))return null;const e=new Date(t);e.setMinutes(e.getMinutes()-e.getTimezoneOffset());const r=e.toISOString();return r.substring(0,10)+" "+r.substring(11,19)}toDateObject(){return this._value?new Date(this._value):null}toRelative(t="en"){if(!this._value)return null;const e=t==="fr"?ne:t==="de"?re:At;return te(new Date(this._value),{addSuffix:!0,locale:e})}getTimeStamp(){return this._value?new Date(this._value).getTime():null}getBlitzStamp(){return this._value?Math.floor((new Date(this._value).getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3):null}}class Fn extends j{async getObject(t){const e=this.serialize();if(!e)return null;const r=await k.get(this._type),s=r==null?void 0:r.memoryClient().get(e);return s||(await(r==null?void 0:r.get({skipCacheUpdateIfFound:!0,...t,raw:!1,blitzID:e}))??null)}unserialize(t){return t!=null&&typeof t!="string"?null:t}serialize(){return this._value}}class Wn extends j{async toUser(){const t=this.serialize();if(!t)return null;const e=await k.get("0BAUsers"),r=await(e==null?void 0:e.get({blitzID:t,skipCacheUpdateIfFound:!0}));return r?{id:t,username:r.username.value}:null}unserialize(t){return t}serialize(){return this._value}}class jt{constructor(t,e,r){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(r),this._valueSignal=new nt(this._value),this._syncSignal=new nt(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t):t instanceof Array?t:t===null?[]:void 0,e!==void 0&&!Array.isArray(e)&&(e=[])}catch{}return e&&(e=e.map(r=>J.createType(this._name,this._type,r)),e.forEach(r=>r.withObject(this._object))),e}serialize(){if(this._value!==void 0)return this._value.map(t=>t.serialize())}async performAction(t){var a,i,o,d,c,l,u,h,f,w,S,I;const e=new W({action:"edit",data:{[this._name]:{[t.action]:t.value}},model:(i=(a=this._object)==null?void 0:a.model)==null?void 0:i.getName(),blitzID:(o=this._object)==null?void 0:o._blitzID.value}),r=await R.create().run([e]);if(r[0].status!==C.Success&&r[0].status!==C.Notice)throw new Error(r[0].message??"Unknown Error! Please try again.");for(const x of((c=(d=this._object)==null?void 0:d._editURLs)==null?void 0:c.value)??[])await p.queue.addJob(x,e.toObject());const s=await((u=(l=this._object)==null?void 0:l.model)==null?void 0:u.get({blitzID:this._object._blitzID.value,forceLocal:!0,raw:!0}));s&&Array.isArray(s[this._name])&&(this.value=s[this._name]),(f=(h=this._object)==null?void 0:h.model)==null||f.memoryClient().emit(e),(w=this._object)==null||w.dispatchEvent("edit",e.data),(I=(S=this._object)==null?void 0:S.model)==null||I.setLastTransactionHash(e.hash)}async add(t){await this.performAction({action:"add",value:J.createType(this._name,this._type,t).serialize()})}async remove(t){await this.performAction({action:"remove",value:J.createType(this._name,this._type,t).serialize()})}withObject(t){this._object=t,this._value!==void 0&&this._value.forEach(e=>e.withObject(t))}subscribe(t,e=!0){var s,a;const r=this._valueSignal.subscribe(t,e);return this._value===void 0&&((a=(s=this._object)==null?void 0:s.model)==null||a.get({blitzID:this._object._blitzID.value,forceHttp:!0,query:{manyToMany:"object"}}).then(i=>{(i==null?void 0:i[this._name]._value)!==void 0&&this._valueSignal.emit()})),r}syncStatus(t){var s;const e=this._syncSignal.get()!==null,r=this._syncSignal.subscribe(t,e);return e||p.queue.getJobsForObject((s=this._object)==null?void 0:s._blitzID.value).then(a=>{const i=a.filter(u=>{var h;return u.transaction.action===T.Edit&&((h=u.transaction.data)==null?void 0:h[this._name])!==void 0});let o=y.Pending,d;const c=i.find(u=>u.status===y.Failed),l=i.find(u=>u.status===y.Conflict);c?(o=y.Failed,d=c):l?(o=y.Conflict,d=l):i.every(u=>u.status===y.Completed)&&(o=y.Completed),this._syncSignal.set({status:o,job:d},!1),t(this._syncSignal.get())}),r}getDetails(){var t,e;return((e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttributeDetails(this._name))||null}}class ae extends jt{unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t):t instanceof Array?t:t===null?[]:void 0,e!==void 0&&!Array.isArray(e)&&(e=[])}catch{}return e}serialize(){return this._value}async add(t){await this.performAction({action:"add",value:t})}async remove(t){await this.performAction({action:"remove",value:t})}withObject(t){this._object=t}async getObjects(t){const e=this.serialize();if(!Array.isArray(e))return[];const r=await k.get(this._type),s=r==null?void 0:r.memoryClient(),a=[];for(const i of e){if(!i._blitzID)continue;const o=s==null?void 0:s.get(i._blitzID);if(o){a.push(o);continue}const d=await(r==null?void 0:r.get({skipCacheUpdateIfFound:!0,...t,raw:!1,blitzID:i._blitzID}));d&&a.push(d)}return a}}function Jn(n){return n&&n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n)}function Nn(n){return n}function $n(n,t){t=t||{};const e=t.delimiter||".",r=t.maxDepth,s=t.transformKey||Nn,a={};function i(o,d,c){c=c||1,Object.keys(o).forEach(function(l){const u=o[l],h=t.safe&&Array.isArray(u),f=Object.prototype.toString.call(u),w=Jn(u),S=f==="[object Object]"||f==="[object Array]",I=d?d+e+s(l):s(l);if(!h&&!w&&S&&Object.keys(u).length&&(!t.maxDepth||c<r))return i(u,I,c+1);a[I]=u})}return i(n),a}class Rn extends j{unserialize(t){if(t!==null&&typeof t=="object")return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){let e=!0;try{JSON.parse(t)}catch{e=!1}return e}keys(){return Object.keys(this._value??{})}flat(){return $n(this._value??{})}groupBy(t){if(typeof t!="function")throw new Error("Callback function is not a function!");return Object.groupBy(this._value??{},t)}}class Hn extends j{unserialize(t){if(typeof t=="string")return{content:t,language:null};if(t!==null&&typeof t=="object"&&t.content)return{content:t.content,language:t.language??null};if(t!==void 0)return null}serialize(){return this._value}getLanguage(){var t;return((t=this._value)==null?void 0:t.language)||null}getContent(){var t;return((t=this._value)==null?void 0:t.content)||null}}class Vn extends j{unserialize(t){return t}serialize(){return this._value}getOptions(){var t,e,r;return((r=(e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttributeDetails(this._name))==null?void 0:r.options)??[]}validate(t){return this.getOptions().includes(t)}}class Ot extends j{unserialize(t){if(typeof t=="number")return t;if(typeof t=="string")return parseFloat(t);if(t!==void 0)return null}serialize(){return typeof this._value=="number"?this._value.toString():this._value}}class Bn extends se{}class qn extends Ot{}class Qn extends Ot{toPercentage(){return this._value!=null?(this._value*100).toString()+"%":null}}const ie=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;class Xn extends j{unserialize(t){if(t!=null&&ie.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return ie.test(t)}}const oe=/^\+[1-9]{1,3}\-[0-9]{7,14}$/;class Yn extends j{unserialize(t){if(t!=null&&oe.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return oe.test(t)}getCallingCode(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[0].substring(1)}getPhoneNumber(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[1]}}const ce=/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/;class Kn extends j{unserialize(t){if(t!=null&&ce.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return ce.test(t)}getUrlObject(){return this._value?new URL(this._value):null}getOrigin(){return this._value?new URL(this._value).origin:null}getProtocol(){return this._value?new URL(this._value).protocol:null}getPathname(){return this._value?new URL(this._value).pathname:null}getHostname(){return this._value?new URL(this._value).hostname:null}getSearch(){return this._value?new URL(this._value).search:null}}class Zn extends j{unserialize(t){const e=t instanceof Array?t[0]:t;if(e!==null&&typeof e=="object"&&e.base!=null&&e.version!=null)return t;if(e!==void 0)return null}serialize(){return this._value}getUrl(t){const e=this._value instanceof Array?this._value[0]:this._value;return e!==null&&typeof e=="object"&&e.base!=null&&e[t]!=null?e.base+e[t].substring(1):null}}class Gn extends j{unserialize(t){if(t!==null&&typeof t=="object"&&t.url!=null)return t;if(t!==void 0)return null}serialize(){return this._value}getUrl(){var t;return((t=this._value)==null?void 0:t.url)??null}}class ts extends j{unserialize(t){if(t!==null&&typeof t=="object"&&t.url!=null)return t;if(t!==void 0)return null}serialize(){return this._value}getUrl(){var t;return((t=this._value)==null?void 0:t.url)??null}}class es extends j{unserialize(t){if(t!==null&&typeof t=="object"&&t.lat&&t.long)return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!e.lat||!e.long)return!1;const r=parseFloat(e.lat);if(isNaN(r)||r<-90||r>90)return!1;const s=parseFloat(e.long);return!(isNaN(s)||s<-180||s>180)}getFormattedAddress(){if(!this._value)return"";const t=[];this._value.venue&&t.push(this._value.venue),this._value.street&&t.push(this._value.street);const e=[];return this._value.zip&&e.push(this._value.zip),this._value.city&&e.push(this._value.city),e.length>0&&t.push(e.join(" ")),this._value.nation&&t.push(this._value.nation),t.join(", ")}async geocodeAddress(t,e){if(!t)throw new Error("Address is required for geocoding.");if(!e)throw new Error("Google Maps API key is required for geocoding.");try{const s=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(t)}&key=${e}`)).json();if(s.status==="OK"&&s.results&&s.results.length>0){const a=s.results[0].geometry.location;return{lat:a.lat.toString(),long:a.lng.toString()}}return null}catch(r){return console.error("Geocoding error:",r.message),null}}}class J{static createType(t,e,r){return t.endsWith("_fk")?new Fn(t,e,r):t==="_userID"?new Wn(t,e,r):e==="int"||["_blitzstamp"].includes(t)?new se(t,"int",r):e==="tinyint"?new Bn(t,e,r):e==="double"?new qn(t,e,r):e==="float"?new Ot(t,e,r):e==="percentage"?new Qn(t,e,r):e==="varchar"?new Un(t,e,r):e==="text"?new Pt(t,e,r):e==="htmlText"?new En(t,e,r):e==="enum"?new Vn(t,e,r):e==="json"?new Rn(t,e,r):e==="boolean"?new Yt(t,e,r):e==="datetime"||["_publishingdate","_modified","_expiration"].includes(t)?new kn(t,"datetime",r):e==="date"?new Cn(t,e,r):e==="code"?new Hn(t,e,r):e==="email"?new Xn(t,e,r):e==="phone"?new Yn(t,e,r):e==="url"?new Kn(t,e,r):e==="image"?new Zn(t,e,r):e==="video"?new Gn(t,e,r):e==="file"?new ts(t,e,r):e==="location"?new es(t,e,r):new st(t,e,r)}static createFrom(t,e,r){return Array.isArray(e)?this.createMany(t,e[0],r):this.createType(t,e,r)}static createMany(t,e,r){return t.endsWith("_mtm")?new ae(t,e,r):new jt(t,e,r)}static unserialize(t,e){var a,i,o;const r={},s=[...Object.keys(t),...Object.keys(e)].filter((d,c,l)=>l.indexOf(d)===c);for(const d of s)Array.isArray((a=t[d])==null?void 0:a.type)?r[d]=J.createMany(d,((i=t[d])==null?void 0:i.type[0])??"anonymous",e[d]):r[d]=J.createType(d,((o=t[d])==null?void 0:o.type)??"anonymous",e[d]);return r}static serialize(t){const e={};for(const r in t)e[r]=t[r].serialize();return e}}class Y{constructor({model:t,attributes:e}){m(this,"_model");m(this,"_attributes");m(this,"listeners",new Map);m(this,"editQueue",Promise.resolve());this._model=t,this._attributes=e}get model(){return this._model}getAttribute(t){return this._attributes[t]}hasAttribute(t){return this._attributes.hasOwnProperty(t)}edit(t,e,r){return this.enqueueEditOperation(async()=>{var c,l,u,h;const s=(l=(c=this.model)==null?void 0:c.getAttributeDetails(t))==null?void 0:l.type,a=J.createType(t,s,e).serialize(),i=r?J.createType(t,s,r).serialize():this.getAttribute(t).serialize(),o=new W({action:"edit",data:{[t]:{prev:i,new:a}},model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),d=await R.create().run([o]);if(d[0].status!==C.Success&&d[0].status!==C.Notice)throw new Error(d[0].message??"Unknown Error! Please try again.");this._attributes[t].value=a;for(const f of this.getAttribute("_editURLs").value)await p.queue.addJob(f,o.toObject());(u=this.model)==null||u.memoryClient().emit(o),this.dispatchEvent("edit",o.data),(h=this.model)==null||h.setLastTransactionHash(o.hash)})}async delete(){var s,a;const t=new W({action:"delete",model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),e=await R.create().run([t]);if(e[0].status!==C.Success)throw new Error(e[0].message??"Unknown Error! Please try again.");const r=(s=this.model)==null?void 0:s.memoryClient();r==null||r.delete(this.getAttribute("_blitzID").value);for(const i of this.getAttribute("_editURLs").value)await p.queue.addJob(i,t.toObject());r==null||r.emit(t),this.dispatchEvent("delete",null),(a=this.model)==null||a.setLastTransactionHash(t.hash)}async addUserPermission(t){if(!t||t.length===0)throw new Error("Users missing!");const e=this.getAttribute("_blitzID").value,r={blitzIDs:[e],users:t.reduce((o,d)=>({...o,[`#${d.id}`]:d.permission}),{})},s=new W({action:"addObjectUserPermission",model:this.model.getName(),blitzID:e,data:r,hash:tt(r)}),a=[];for(const o of this.getAttribute("_editURLs").value)a.push(await Je.send({url:o,transaction:s.toObject()},_._globalHeaders));const i=a.find(o=>o.status!==Q.Success);if(i)throw new Error(i.message)}toObject(){const t={};for(const e in this._attributes)t[e]=this._attributes[e].serialize();return t}addEventListener(t,e){var r;this.listeners.has(t)||this.listeners.set(t,[]),(r=this.listeners.get(t))==null||r.push(e)}removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(r=>e!==r))}dispatchEvent(t,e){var r;this.listeners.has(t)&&((r=this.listeners.get(t))==null||r.forEach(s=>s(e)))}enqueueEditOperation(t){return new Promise((e,r)=>{this.editQueue=this.editQueue.then(async()=>{try{const s=await t();e(s)}catch(s){r(s)}})})}}class xt{static transformBlitzDataOptions(t){if(typeof t>"u")throw new Error("Configuration is required.");if(typeof t=="string")t={clusters:this.transformClusterOptions(t)};else if(Array.isArray(t))t={clusters:this.transformClusterOptions(t)};else if(typeof t=="object"&&!Array.isArray(t))t.clusters=this.transformClusterOptions(t.clusters);else throw new Error("Unknown configuration type.");if(t.assetsPath||(t.assetsPath=""),t.sync?typeof t.sync=="string"&&(t.sync={level:t.sync}):t.sync={level:"full"},t.sync.level==="partial")throw new Error("Partial sync type not supported yet!");return t.sync.level==="cache"&&(t.sync.ttl||(t.sync.ttl=30*1e3)),t.sync.level==="full"&&(t.sync.interval||(t.sync.interval=30*1e3)),t.flush||(t.flush={type:["version"]}),t.flush.type.includes("interval")&&(t.flush.interval||(t.flush.interval=30)),t.flush.type.includes("size")&&(t.flush.size||(t.flush.size=128)),t}static transformClusterOptions(t){if(typeof t>"u")throw new Error("Clusters are required.");if(typeof t=="string")t={default:{readURL:[t],addURL:[t]}};else if(Array.isArray(t))t={default:{readURL:t,addURL:t}};else if(typeof t=="object")for(const e of Object.keys(t)){if(typeof t[e]=="string"||Array.isArray(t[e])){const r=Array.isArray(t[e])?t[e]:[t[e]];t[e]={readURL:r,addURL:r};continue}typeof t[e]=="object"&&(typeof t[e].readURL=="string"&&(t[e].readURL=[t[e].readURL]),typeof t[e].addURL=="string"&&(t[e].addURL=[t[e].addURL]))}else throw new Error("Unknown cluster configuration type.");return t}}const rs={get(n,t){if(Reflect.has(n,t)){const e=Reflect.get(n,t);return e instanceof Function?e.bind(n):e}return n._attributes[t]},set(n,t,e){throw new Error("Setting values directly not supported. Please use `edit` method to change a value for an attribute.")}};class le{static create(t,e,r){const s=e.getAttributesDetails()??{},a=J.unserialize(s,r),i=new Proxy(new t({model:e,attributes:a}),rs);for(const o in a)a[o].withObject(i);return e.memoryClient().update(i)}}class Ct extends Y{static async model(){if(typeof this.modelName!="string")throw new Error(`${this.name}.modelName is not a string, please provide a valid model name.`);const t=this.modelName==="_Model"?p._Model:await p._Model.get(this.modelName);return t.setReturnType(this),t}static async get(t){return(await this.model()).get(t)}static async exists(t){return(await this.model()).exists(t)}static async add(t,e=[]){return(await this.model()).add(t,e)}static async list(t={}){return(await this.model()).list(t)}}m(Ct,"modelName");const ht=class ht extends Ct{constructor({model:e,attributes:r}){super({model:e,attributes:r});m(this,"clusterManager");m(this,"lastTransactionHash",null);m(this,"returnType",Y);this.clusterManager=p.clusterManager}idbClient(){return new We(this)}memoryClient(){return new ct(this)}getName(){return this._attributes._blitzID.value}getLastTransactionHash(){return this.lastTransactionHash}setLastTransactionHash(e){this.lastTransactionHash=e}setReturnType(e){this.returnType=e}async exists(e){return!!await this.get(e)}async add(e,r=[]){const s=this.resolveClusters(r),a=this.getAttributesDetails()??{},i=new W({action:"add",data:J.serialize(J.unserialize(a,e)),model:this.getName()}),o=await p.getCurrentUser(),d=i.clone();d.data={...d.data,_userID:o.id};const c=await R.create().run([d]);if(c[0].status!==C.Success)throw new Error(c[0].message??"Unknown Error! Please try again.");for(const l of s)for(const u of l.options.addURL)await p.queue.addJob(u,i.toObject());return this.memoryClient().emit(i),this.setLastTransactionHash(i.hash),le.create(this.returnType,this,d.data)}async get(e){const r=typeof e=="string"?{blitzID:e}:e,a=(await G.create().model(this).clusters(this.resolveClusters(r.clusters??[])).raw(r.raw??!1).get(r.blitzID).query({returnType:this.returnType??Y}).forceHttp(r.forceHttp??!1).forceLocal(r.forceLocal??!1).skipCacheUpdateIfFound(r.skipCacheUpdateIfFound??!1).signal(r.signal).getQuery(r.query??{}).perform())[0]??null;if(!a&&this.returnType===ht)throw new Error(`Model with blitzID "${e}" does not exists or you don't have enough permission to view it.`);return a||null}async list(e={}){return await G.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??Y,customSort:e.customSort,customSortDirection:e.customSortDirection,var:e.var,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).signal(e.signal).perform()}subscribeToList(e={},r,s=!1){const a=G.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??Y,customSort:e.customSort,customSortDirection:e.customSortDirection,var:e.var,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).performSignal(s),i=a.subscribe(r,a.get()!==null),o=ct.channel.filterPipe(d=>d.model===this.getName()).subscribe(d=>{if(d.action===T.Add)this.list({...e,forceLocal:!0}).then(c=>{const l=e.raw?c.findIndex(u=>u._blitzID===d.blitzID):c.findIndex(u=>u.getAttribute("_blitzID").value===d.blitzID);l>-1&&a.set({items:c,update:{action:T.Add,object:c[l],index:l}})});else if(d.action===T.Edit){const c=a.get();if(!c)return;const l=e.raw?c.items.findIndex(u=>u._blitzID===d.blitzID):c.items.findIndex(u=>u.getAttribute("_blitzID").value===d.blitzID);l>-1&&this.list({...e,forceLocal:!0}).then(u=>{const h=e.raw?u.findIndex(f=>f._blitzID===d.blitzID):u.findIndex(f=>f.getAttribute("_blitzID").value===d.blitzID);a.set({items:u,update:{action:T.Edit,object:h>-1?u[h]:c.items[l],index:h>-1?h:l}})})}else if(d.action===T.Delete){const c=a.get();if(!c)return;if(e.raw){const l=c.items.findIndex(u=>u._blitzID===d.blitzID);l>-1&&a.set({items:c.items.filter(u=>u._blitzID!==d.blitzID),update:{action:T.Delete,object:c.items[l],index:l}})}else{const l=c.items.findIndex(u=>u.getAttribute("_blitzID").value===d.blitzID);l>-1&&a.set({items:c.items.filter(u=>u.getAttribute("_blitzID").value!==d.blitzID),update:{action:T.Delete,object:c.items[l],index:l}})}}});return()=>{i(),o()}}async sync(){const e=this.getName();if(e){const r=Date.now()/1e3,s=D.getLastSyncedAt(e)??0,a=30;r-s>a&&await et.create().run(e)}}getAttributesDetails(){var e;return((e=this._attributes.attributes)==null?void 0:e.value)??null}getAttributeDetails(e){var r,s;return((s=(r=this._attributes.attributes)==null?void 0:r.value)==null?void 0:s[e])??null}resolveClusters(e){return Object.values(e.length===0?this.clusterManager.all():this.clusterManager.get(e))}setClusters(e){this.clusterManager=new Nt;const r=xt.transformClusterOptions(e);for(const s of Object.keys(r))this.clusterManager.register(s,r[s])}getClusterManager(){return this.clusterManager}static async get(e){return super.get(e)}static async list(e={}){return super.list(e)}};m(ht,"modelName","_Model");let k=ht;class Et{static extractModelName(t){const s=new URL(t).pathname.split("/").filter(a=>a!=="").pop();if(!s&&!(s!=null&&s.endsWith(".json")))throw new Error("Model name not found in the URL.");return s.slice(0,s.indexOf(".json"))}static extractConditions(t){const e=new URL(t);return JSON.parse(e.searchParams.get("conditions")||"[]")}}var ue={exports:{}},de={exports:{}};(function(){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,r){return e<<r|e>>>32-r},rotr:function(e,r){return e<<32-r|e>>>r},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var r=0;r<e.length;r++)e[r]=t.endian(e[r]);return e},randomBytes:function(e){for(var r=[];e>0;e--)r.push(Math.floor(Math.random()*256));return r},bytesToWords:function(e){for(var r=[],s=0,a=0;s<e.length;s++,a+=8)r[a>>>5]|=e[s]<<24-a%32;return r},wordsToBytes:function(e){for(var r=[],s=0;s<e.length*32;s+=8)r.push(e[s>>>5]>>>24-s%32&255);return r},bytesToHex:function(e){for(var r=[],s=0;s<e.length;s++)r.push((e[s]>>>4).toString(16)),r.push((e[s]&15).toString(16));return r.join("")},hexToBytes:function(e){for(var r=[],s=0;s<e.length;s+=2)r.push(parseInt(e.substr(s,2),16));return r},bytesToBase64:function(e){for(var r=[],s=0;s<e.length;s+=3)for(var a=e[s]<<16|e[s+1]<<8|e[s+2],i=0;i<4;i++)s*8+i*6<=e.length*8?r.push(n.charAt(a>>>6*(3-i)&63)):r.push("=");return r.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var r=[],s=0,a=0;s<e.length;a=++s%4)a!=0&&r.push((n.indexOf(e.charAt(s-1))&Math.pow(2,-2*a+8)-1)<<a*2|n.indexOf(e.charAt(s))>>>6-a*2);return r}};de.exports=t})();var ns=de.exports,Ut={utf8:{stringToBytes:function(n){return Ut.bin.stringToBytes(unescape(encodeURIComponent(n)))},bytesToString:function(n){return decodeURIComponent(escape(Ut.bin.bytesToString(n)))}},bin:{stringToBytes:function(n){for(var t=[],e=0;e<n.length;e++)t.push(n.charCodeAt(e)&255);return t},bytesToString:function(n){for(var t=[],e=0;e<n.length;e++)t.push(String.fromCharCode(n[e]));return t.join("")}}},he=Ut;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var ss=function(n){return n!=null&&(fe(n)||as(n)||!!n._isBuffer)};function fe(n){return!!n.constructor&&typeof n.constructor.isBuffer=="function"&&n.constructor.isBuffer(n)}function as(n){return typeof n.readFloatLE=="function"&&typeof n.slice=="function"&&fe(n.slice(0,0))}(function(){var n=ns,t=he.utf8,e=ss,r=he.bin,s=function(a,i){a.constructor==String?i&&i.encoding==="binary"?a=r.stringToBytes(a):a=t.stringToBytes(a):e(a)?a=Array.prototype.slice.call(a,0):!Array.isArray(a)&&a.constructor!==Uint8Array&&(a=a.toString());for(var o=n.bytesToWords(a),d=a.length*8,c=1732584193,l=-271733879,u=-1732584194,h=271733878,f=0;f<o.length;f++)o[f]=(o[f]<<8|o[f]>>>24)&16711935|(o[f]<<24|o[f]>>>8)&4278255360;o[d>>>5]|=128<<d%32,o[(d+64>>>9<<4)+14]=d;for(var w=s._ff,S=s._gg,I=s._hh,x=s._ii,f=0;f<o.length;f+=16){var Lt=c,kt=l,Ft=u,Wt=h;c=w(c,l,u,h,o[f+0],7,-680876936),h=w(h,c,l,u,o[f+1],12,-389564586),u=w(u,h,c,l,o[f+2],17,606105819),l=w(l,u,h,c,o[f+3],22,-1044525330),c=w(c,l,u,h,o[f+4],7,-176418897),h=w(h,c,l,u,o[f+5],12,1200080426),u=w(u,h,c,l,o[f+6],17,-1473231341),l=w(l,u,h,c,o[f+7],22,-45705983),c=w(c,l,u,h,o[f+8],7,1770035416),h=w(h,c,l,u,o[f+9],12,-1958414417),u=w(u,h,c,l,o[f+10],17,-42063),l=w(l,u,h,c,o[f+11],22,-1990404162),c=w(c,l,u,h,o[f+12],7,1804603682),h=w(h,c,l,u,o[f+13],12,-40341101),u=w(u,h,c,l,o[f+14],17,-1502002290),l=w(l,u,h,c,o[f+15],22,1236535329),c=S(c,l,u,h,o[f+1],5,-165796510),h=S(h,c,l,u,o[f+6],9,-1069501632),u=S(u,h,c,l,o[f+11],14,643717713),l=S(l,u,h,c,o[f+0],20,-373897302),c=S(c,l,u,h,o[f+5],5,-701558691),h=S(h,c,l,u,o[f+10],9,38016083),u=S(u,h,c,l,o[f+15],14,-660478335),l=S(l,u,h,c,o[f+4],20,-405537848),c=S(c,l,u,h,o[f+9],5,568446438),h=S(h,c,l,u,o[f+14],9,-1019803690),u=S(u,h,c,l,o[f+3],14,-187363961),l=S(l,u,h,c,o[f+8],20,1163531501),c=S(c,l,u,h,o[f+13],5,-1444681467),h=S(h,c,l,u,o[f+2],9,-51403784),u=S(u,h,c,l,o[f+7],14,1735328473),l=S(l,u,h,c,o[f+12],20,-1926607734),c=I(c,l,u,h,o[f+5],4,-378558),h=I(h,c,l,u,o[f+8],11,-2022574463),u=I(u,h,c,l,o[f+11],16,1839030562),l=I(l,u,h,c,o[f+14],23,-35309556),c=I(c,l,u,h,o[f+1],4,-1530992060),h=I(h,c,l,u,o[f+4],11,1272893353),u=I(u,h,c,l,o[f+7],16,-155497632),l=I(l,u,h,c,o[f+10],23,-1094730640),c=I(c,l,u,h,o[f+13],4,681279174),h=I(h,c,l,u,o[f+0],11,-358537222),u=I(u,h,c,l,o[f+3],16,-722521979),l=I(l,u,h,c,o[f+6],23,76029189),c=I(c,l,u,h,o[f+9],4,-640364487),h=I(h,c,l,u,o[f+12],11,-421815835),u=I(u,h,c,l,o[f+15],16,530742520),l=I(l,u,h,c,o[f+2],23,-995338651),c=x(c,l,u,h,o[f+0],6,-198630844),h=x(h,c,l,u,o[f+7],10,1126891415),u=x(u,h,c,l,o[f+14],15,-1416354905),l=x(l,u,h,c,o[f+5],21,-57434055),c=x(c,l,u,h,o[f+12],6,1700485571),h=x(h,c,l,u,o[f+3],10,-1894986606),u=x(u,h,c,l,o[f+10],15,-1051523),l=x(l,u,h,c,o[f+1],21,-2054922799),c=x(c,l,u,h,o[f+8],6,1873313359),h=x(h,c,l,u,o[f+15],10,-30611744),u=x(u,h,c,l,o[f+6],15,-1560198380),l=x(l,u,h,c,o[f+13],21,1309151649),c=x(c,l,u,h,o[f+4],6,-145523070),h=x(h,c,l,u,o[f+11],10,-1120210379),u=x(u,h,c,l,o[f+2],15,718787259),l=x(l,u,h,c,o[f+9],21,-343485551),c=c+Lt>>>0,l=l+kt>>>0,u=u+Ft>>>0,h=h+Wt>>>0}return n.endian([c,l,u,h])};s._ff=function(a,i,o,d,c,l,u){var h=a+(i&o|~i&d)+(c>>>0)+u;return(h<<l|h>>>32-l)+i},s._gg=function(a,i,o,d,c,l,u){var h=a+(i&d|o&~d)+(c>>>0)+u;return(h<<l|h>>>32-l)+i},s._hh=function(a,i,o,d,c,l,u){var h=a+(i^o^d)+(c>>>0)+u;return(h<<l|h>>>32-l)+i},s._ii=function(a,i,o,d,c,l,u){var h=a+(o^(i|~d))+(c>>>0)+u;return(h<<l|h>>>32-l)+i},s._blocksize=16,s._digestsize=16,ue.exports=function(a,i){if(a==null)throw new Error("Illegal argument "+a);var o=n.wordsToBytes(s(a,i));return i&&i.asBytes?o:i&&i.asString?r.bytesToString(o):n.bytesToHex(o)}})();var is=ue.exports;const os=Ce(is);class G{constructor(){m(this,"_clusters");m(this,"_urls");m(this,"_model");m(this,"_query");m(this,"_raw",!1);m(this,"_forceHttp",!1);m(this,"_forceLocal",!1);m(this,"_skipCacheUpdateIfFound",!1);m(this,"_get");m(this,"_getQuery");m(this,"_signal")}static create(){return new G}model(t){return this._model=t,this}clusters(t){return this._clusters=t,this}signal(t){return this._signal=t,this}urls(t){return this._urls=t,this}query(t){var r,s;this._query=t;const e=(r=this._model)==null?void 0:r.getAttributesDetails();if((s=this._query)!=null&&s.conditions&&e)for(const a of this._query.conditions){const i=a[0];a.length===3&&e[i]!==void 0&&typeof e[i].type=="string"&&(a[1]==="IN"&&Array.isArray(a[2])?a[2]=a[2].map(o=>J.createType(i,e[i].type,o).serialize()):a[2]=J.createType(i,e[i].type,a[2]).serialize())}return this}raw(t){return this._raw=t,this}forceHttp(t){return this._forceHttp=t,this}forceLocal(t){return this._forceLocal=t,this}skipCacheUpdateIfFound(t){return this._skipCacheUpdateIfFound=t,this}get(t){return this._get=t,this}getQuery(t){return this._getQuery=t,this}convertObjects(t){var r;const e=[];for(const s of t)e.push(le.create(((r=this._query)==null?void 0:r.returnType)??Y,this._model,s));return e}async perform(){var e;let t=this._forceHttp&&!this._forceLocal?[]:await this.performIndexedDb();if(!this._forceLocal){if(p.options.sync.level==="full"&&t.length===0)t=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp())),t=await this.filterExpiredObjects(t),t.length>0&&await this._model.idbClient().save(t);else if(p.options.sync.level==="cache"){const r=this._skipCacheUpdateIfFound&&t.length>0?!1:this.shouldSendHttpRequest();if(r||t.length===0){const s=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));(s.length>0||this._forceHttp)&&(t=await this.filterExpiredObjects(s),t.length>0&&await this._model.idbClient().save(t)),r&&((e=this._model)==null?void 0:e.getName())!=="_Model"&&D.setListCallLastTimeStamp(this.hash(),new Date().getTime())}}}return this._raw?t:this.convertObjects(t)}performSignal(t=!1){const e=new nt(null);return(async()=>{var i;if(!t){e.set({items:await this.perform()});return}const r=await this.performMemory();e.set({items:this._raw?r:this.convertObjects(r),nextSource:"local database"});const s=await this.performIndexedDb();e.set({items:this._raw?s:this.convertObjects(s),nextSource:"server"});let a=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));a=await this.filterExpiredObjects(a),a.length>0&&await((i=this._model)==null?void 0:i.idbClient().save(a)),e.set({items:this._raw?a:this.convertObjects(a)})})(),e}async performHttp(){return(await Promise.all(this._urls?this._urls.map(e=>this.performSingleUrlHttp(e)):this._clusters.map(e=>this.performSingleClusterHttp(e)))).flat()}async performSingleClusterHttp(t){var r,s;const e={};for(let a=0;a<t.options.readURL.length;a++){const i=t.getNextReadURL();try{const o=this._get?await X.get({baseUrl:i,modelName:this._model.getName(),blitzID:this._get,query:this._getQuery},this._signal):await X.list({endpoint:{baseUrl:i,modelName:this._model.getName(),query:this._query}},this._signal);for(const d of o){d._clusters=[t.name],d._editURLs=JSON.parse(JSON.stringify(t.options.readURL));for(const c in d)if(c.endsWith("_fk")&&d[c]!==null&&typeof d[c]=="object"&&d[c]._blitzID){const l=(s=(r=this._model)==null?void 0:r.getAttributeDetails(c))==null?void 0:s.type;if(l&&l!=="_Model"){const u=await k.get(l);u&&await u.idbClient().save([d[c]],!0)}d[c]=d[c]._blitzID}else c.endsWith("_mtm")&&Array.isArray(d[c])&&(d[c]=d[c].map((l,u)=>({_blitzID:typeof l=="string"?l:l._blitzID,_mtmSort:typeof l=="string"?(d[c].length-u)*15:l._mtmSort})))}return o}catch(o){e[i]=(o==null?void 0:o.stack)??(o==null?void 0:o.message)??o}}throw new Error(`All read URLs failed for cluster "${t.name}". Errors: ${JSON.stringify(e)}`)}async performSingleUrlHttp(t){return(await X.list({fullUrl:t},this._signal)).map(r=>(r.cluster=[],r._editURLs=[t],r))}async performIndexedDb(){var r,s;const t=this._model.idbClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(r=this._getQuery)==null?void 0:r.var,manyToMany:(s=this._getQuery)==null?void 0:s.manyToMany});const e=this._urls?this._urls.map(a=>Et.extractConditions(a)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}async performMemory(){var r,s;const t=this._model.memoryClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(r=this._getQuery)==null?void 0:r.var,manyToMany:(s=this._getQuery)==null?void 0:s.manyToMany});const e=this._urls?this._urls.map(a=>Et.extractConditions(a)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}mergeObjects(t){const e=[];for(const r of t){const s=e.find(a=>a._blitzID===r._blitzID);s?(s._clusters=[...s._clusters,...r._clusters].filter((a,i,o)=>o.indexOf(a)===i),s._editURLs=[...s._editURLs,...r._editURLs].filter((a,i,o)=>o.indexOf(a)===i)):e.push(r)}return e}async filterQueuedObjects(t){var s;const e=await p.queue.getJobs(),r=[];for(const a of t)if(!e.find(i=>i.transaction.action===T.Delete&&i.transaction.blitzID===a._blitzID))if(!e.find(i=>i.transaction.action===T.Edit&&i.transaction.blitzID===a._blitzID&&i.status!==y.Completed))r.push(a);else{const i=await((s=this._model)==null?void 0:s.get({blitzID:a._blitzID,raw:!0,forceLocal:!0}));i?r.push(i):r.push(a)}return r}async filterExpiredObjects(t){var s;const e=D.getCurrentUser();if(!e||!e.id)return t;const r=[];try{for(const a of t){if(typeof a._expiration=="string"&&a._expiration!==""&&a._expiration!=="0000-00-00 00:00:00"&&e.id!==a._userID){const i=Date.now(),o=new Date(a._expiration).getTime();if(i>o){await((s=this._model)==null?void 0:s.idbClient().delete(a._blitzID));continue}}r.push(a)}}catch(a){return console.error("Error handling expired objects:",a.stack),t}return r}shouldSendHttpRequest(){var e;if(p.options.sync.level!=="cache"||((e=this._model)==null?void 0:e.getName())==="_Model")return!1;const t=D.getListCallLastTimeStamp(this.hash());return t?new Date().getTime()-t>p.options.sync.ttl:!0}hash(){var t,e;return os(JSON.stringify({clusters:((t=this._clusters)==null?void 0:t.map(r=>r.name))??[],blitzId:this._get,urls:this._urls,modelName:(e=this._model)==null?void 0:e.getName(),listQuery:this._query,getQuery:this._getQuery}))}}const cs=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,me=n=>{if(typeof n!="string")throw new TypeError("Invalid argument expected string");const t=n.match(cs);if(!t)throw new Error(`Invalid argument not valid semver ('${n}' received)`);return t.shift(),t},ge=n=>n==="*"||n==="x"||n==="X",be=n=>{const t=parseInt(n,10);return isNaN(t)?n:t},ls=(n,t)=>typeof n!=typeof t?[String(n),String(t)]:[n,t],us=(n,t)=>{if(ge(n)||ge(t))return 0;const[e,r]=ls(be(n),be(t));return e>r?1:e<r?-1:0},pe=(n,t)=>{for(let e=0;e<Math.max(n.length,t.length);e++){const r=us(n[e]||"0",t[e]||"0");if(r!==0)return r}return 0},ds=(n,t)=>{const e=me(n),r=me(t),s=e.pop(),a=r.pop(),i=pe(e,r);return i!==0?i:s&&a?pe(s.split("."),a.split(".")):s||a?s?-1:1:0},we=(n,t,e)=>{hs(e);const r=ds(n,t);return ye[e].includes(r)},ye={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},ve=Object.keys(ye),hs=n=>{if(typeof n!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof n}`);if(ve.indexOf(n)===-1)throw new Error(`Invalid operator, expected one of ${ve.join("|")}`)};class fs{constructor(t){m(this,"options");this.options=t}async perform(){if(this.options.type.includes("version")){const t=D.get("version");if(!t||we(p.VERSION,t,">")){const e=p.VERSION.split(".")[1],r=t==null?void 0:t.split(".")[1];if(!r||we(e,r,">")){await this.flush(),D.setLastSyncedAt(Math.floor(Date.now()/1e3)),D.set("version",p.VERSION);return}else D.set("version",p.VERSION)}}if(this.options.type.includes("interval")&&this.options.interval){const t=D.get("lastFlush");if(!t)D.set("lastFlush",Date.now().toString());else if(Math.floor((Date.now()-parseInt(t))/864e5)>=this.options.interval){await this.flush(),D.set("lastFlush",Date.now().toString()),D.setLastSyncedAt(Math.floor(Date.now()/1e3)),D.set("version",p.VERSION);return}}if(this.options.type.includes("size")&&this.options.size&&navigator.storage&&navigator.storage.estimate)try{const t=await navigator.storage.estimate();if(t.usage&&Math.floor(t.usage/1e6)>=this.options.size){await this.flush(),D.setLastSyncedAt(Math.floor(Date.now()/1e3)),D.set("version",p.VERSION);return}}catch(t){console.error("Error getting storage estimate:",t.message)}}async flush(){const t=[...(await indexedDB.databases()).filter(e=>{var r;return(r=e.name)==null?void 0:r.startsWith("bdt")}).map(e=>e.name),...D.getDatabases(),"_Model","_Project","db_master",A.name].filter((e,r,s)=>s.findIndex(a=>a===e)===r);for(const e of t)await yt(e);D.clear()}}const P=class P{static get VERSION(){return"1.2.2"}static async initialize(t){if(this.initialized){console.log("%c⚠️ Warning: Library has already been initialized! Skipping the initialization steps.","background: #FFF3CD; color: #856404; font-weight: bold;"),console.groupCollapsed("%cStack Trace","background: #FFF3CD; color: #856404; font-weight: bold; font-style: italic;"),console.log("Options",t),console.trace(),console.groupEnd();return}this.initialized=!0;const e=xt.transformBlitzDataOptions(t);this.options=e,e.clusters&&P.setClusters(e.clusters),await new fs(this.options.flush).perform(),await new Dt().ping(),this.queue=await new ke().init(),P._Model=new k({model:void 0,attributes:{_blitzID:new st("_blitzID","string","_Model"),searchable:new st("searchable","json",void 0),attributes:new st("attributes","json",{name:{label:"Name",type:"varchar"},label:{label:"Label",type:"texti18n"},modelpermission:{label:"Model Permission",type:"tinyint"},hasuserpermissions:{label:"Has User Permissions",type:"boolean"},subscriberemails:{label:"Subscriber Emails",type:"text"},haslogs:{label:"Has Logs",type:"boolean"},cache:{label:"Cache",name:"cache",type:"boolean"},hasprojects:{label:"Has Projects",type:"boolean"},attributes:{label:"Attributes",type:"json"},objectpermissionoptions:{label:"Object Permission Options",type:"int"},haspublishingdate:{label:"Has Publishing Date",type:"boolean"}}),_editURLs:new st("_editURLs","json",[]),haspublishingdate:new Yt("haspublishingdate","boolean",!1)}}),P._Model.setReturnType(k),t&&typeof t!="string"&&!Array.isArray(t)&&t.uiManager&&(this.ui=new t.uiManager(this,t.uiManagerSettings));try{await P.getCurrentUser()}catch(r){console.error("Error fetching current user:",r.stack)}if(e.sync.level==="full"){const r=et.create();await r.run(),r.runAtInterval(e.sync.interval)}else e.sync.level==="cache"&&await et.create().run(void 0,"delete")}static setClusters(t){t=xt.transformClusterOptions(t);for(const e of Object.keys(t))P.clusterManager.register(e,t[e])}static async list(t){const e=Et.extractModelName(t);if(!await P._Model.exists(e))throw new Error(`Model "${e}" does not exist.`);return G.create().model(await P._Model.get(e)).urls([t]).query({}).perform()}static async uploader(t){return await X.upload({baseUrl:P.clusterManager.toArray()[0].getNextReadURL(),image:t})}static async uploaderVideo(t){return await X.uploadVideo({baseUrl:P.clusterManager.toArray()[0].getNextReadURL(),video:t})}static async uploaderFile(t){return await X.uploadFile({baseUrl:P.clusterManager.toArray()[0].getNextReadURL(),file:t})}static async listProjectUsers(t){if(!t)throw new Error("Project ID required!");const e=D.getProjectUsers(t);if(e!==null&&typeof e=="object"){const o=Date.now(),d=864e5;if(o<e.lastSaved+d)return e.users}const r=O.sanitizeBaseUrl(P.clusterManager.toArray()[0].getNextReadURL()),s=new URL(r).origin!==window.location.origin?"?enableCors=1":"",a=await _.create().url(r+`api/listProjectUsers/${t}.json${s}`).get();if(a.error)throw new Error(a.error);if(a.errors instanceof Array&&a.errors.length>0)throw new Error(a.errors.map(o=>o.message||o).join(" | "));const i={lastSaved:Date.now(),users:(a.users||[]).map(o=>({id:o._blitzID,username:o.username}))};return D.setProjectUsers(t,i),i.users}static async getCurrentUser(){var d;const t=D.getCurrentUser();if(t)return t;const e=O.sanitizeBaseUrl(P.clusterManager.toArray()[0].getNextReadURL()),r=new URL(e).origin!==window.location.origin?"?enableCors=1":"",s=await _.create().url(e+"api/ping.json"+r).get();if(s.error)throw new Error(s.error);if(!s.userhash){const c={id:"public",username:"Public"};return D.setCurrentUser(c),c}const a=await k.get("0BAUsers"),i=await(a==null?void 0:a.get(s.userhash));if(!i||!((d=i.username)!=null&&d.value))throw new Error("Could not get user object!");const o={id:s.userhash,username:i.username.value};return D.setCurrentUser(o),o}static refreshCurrentUser(){D.setCurrentUser(null)}static addEventListener(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}static hasEventListener(t){return this.listeners.has(t)?this.listeners.get(t).length>0:!1}static removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(r=>e!==r))}static dispatchEvent(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(r=>r(e))}};m(P,"clusterManager",new Nt),m(P,"_Model"),m(P,"objects",new Map),m(P,"options"),m(P,"queue"),m(P,"ui"),m(P,"listeners",new Map),m(P,"initialized",!1);let p=P;z.BDCustomObject=Ct,z.BDModel=k,z.BDObject=Y,z.BlitzData=p,z.DataType=j,z.HttpRequest=_,z.JobStatus=y,z.LocalStorageRepository=D,z.ManyForeignKeyType=ae,z.ManyType=jt,z.TextType=Pt,z.blitzhash=tt,z.blitzstamp=Z,z.sleep=Qt,Object.defineProperty(z,Symbol.toStringTag,{value:"Module"})});
