(function(I,D){typeof exports=="object"&&typeof module<"u"?D(exports):typeof define=="function"&&define.amd?define(["exports"],D):(I=typeof globalThis<"u"?globalThis:I||self,D(I.BlitzData={}))})(this,function(I){"use strict";var is=Object.defineProperty;var ns=(I,D,$)=>D in I?is(I,D,{enumerable:!0,configurable:!0,writable:!0,value:$}):I[D]=$;var m=(I,D,$)=>(ns(I,typeof D!="symbol"?D+"":D,$),$);const V=class V{constructor(){m(this,"_method");m(this,"_url");m(this,"_headers",{});m(this,"_body");m(this,"_signal")}static create(){const t=new V;return V._globalHeaders&&t.headers(V._globalHeaders),t}static globalHeaders(t){V._globalHeaders=t}method(t){return this._method=t,this}url(t){return this._url=t,this}header(t,e){return this._headers[t]=e,this}headers(t){for(const e in t)this.header(e,t[e]);return this}body(t){return this._body=t,this}signal(t){return this._signal=t,this}async send(){const t=await fetch(this._url,{method:this._method,headers:this._headers,body:this._body?this._body instanceof FormData?this._body:JSON.stringify(this._body):void 0,signal:this._signal?this._signal:void 0});if(!t.ok)throw new Error(`HTTP request failed with status code ${t.status}. Status text: ${t.statusText} and response: ${await t.text()}`);return await t.json()}async get(){return await this.method("GET").send()}async post(){return await this.method("POST").send()}};m(V,"_globalHeaders",{});let D=V;class ${constructor(t,e){m(this,"name");m(this,"options");m(this,"cursors",{readURL:0});this.name=t,this.options=e}getNextReadURL(){this.cursors.readURL>=this.options.readURL.length&&(this.cursors.readURL=0);const t=this.options.readURL[this.cursors.readURL];return this.cursors.readURL++,t}}class Et{constructor(){m(this,"clusters",{})}register(t,e){this.clusters[t]=new $(t,e)}get(t){if(!Array.isArray(t)){if(this.clusters[t]===void 0)throw new Error(`cluster "${t}" not found.`);return this.clusters[t]}const e={};for(const s of t)e[s]=this.get(s);return e}names(){return Object.keys(this.clusters)}all(){return this.clusters}toArray(){return Object.values(this.clusters)}random(){const t=this.names(),e=t[Math.floor(Math.random()*t.length)];return this.get(e)}}const ie=(a,t)=>t.some(e=>a instanceof e);let jt,xt;function ne(){return jt||(jt=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ae(){return xt||(xt=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const Ut=new WeakMap,at=new WeakMap,Ct=new WeakMap,ot=new WeakMap,ct=new WeakMap;function oe(a){const t=new Promise((e,s)=>{const r=()=>{a.removeEventListener("success",i),a.removeEventListener("error",n)},i=()=>{e(W(a.result)),r()},n=()=>{s(a.error),r()};a.addEventListener("success",i),a.addEventListener("error",n)});return t.then(e=>{e instanceof IDBCursor&&Ut.set(e,a)}).catch(()=>{}),ct.set(t,a),t}function ce(a){if(at.has(a))return;const t=new Promise((e,s)=>{const r=()=>{a.removeEventListener("complete",i),a.removeEventListener("error",n),a.removeEventListener("abort",n)},i=()=>{e(),r()},n=()=>{s(a.error||new DOMException("AbortError","AbortError")),r()};a.addEventListener("complete",i),a.addEventListener("error",n),a.addEventListener("abort",n)});at.set(a,t)}let lt={get(a,t,e){if(a instanceof IDBTransaction){if(t==="done")return at.get(a);if(t==="objectStoreNames")return a.objectStoreNames||Ct.get(a);if(t==="store")return e.objectStoreNames[1]?void 0:e.objectStore(e.objectStoreNames[0])}return W(a[t])},set(a,t,e){return a[t]=e,!0},has(a,t){return a instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in a}};function le(a){lt=a(lt)}function ue(a){return a===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...e){const s=a.call(ut(this),t,...e);return Ct.set(s,t.sort?t.sort():[t]),W(s)}:ae().includes(a)?function(...t){return a.apply(ut(this),t),W(Ut.get(this))}:function(...t){return W(a.apply(ut(this),t))}}function de(a){return typeof a=="function"?ue(a):(a instanceof IDBTransaction&&ce(a),ie(a,ne())?new Proxy(a,lt):a)}function W(a){if(a instanceof IDBRequest)return oe(a);if(ot.has(a))return ot.get(a);const t=de(a);return t!==a&&(ot.set(a,t),ct.set(t,a)),t}const ut=a=>ct.get(a);function dt(a,t,{blocked:e,upgrade:s,blocking:r,terminated:i}={}){const n=indexedDB.open(a,t),o=W(n);return s&&n.addEventListener("upgradeneeded",d=>{s(W(n.result),d.oldVersion,d.newVersion,W(n.transaction),d)}),e&&n.addEventListener("blocked",d=>e(d.oldVersion,d.newVersion,d)),o.then(d=>{i&&d.addEventListener("close",()=>i()),r&&d.addEventListener("versionchange",l=>r(l.oldVersion,l.newVersion,l))}).catch(()=>{}),o}function ht(a,{blocked:t}={}){const e=indexedDB.deleteDatabase(a);return t&&e.addEventListener("blocked",s=>t(s.oldVersion,s)),W(e).then(()=>{})}const he=["get","getKey","getAll","getAllKeys","count"],fe=["put","add","delete","clear"],ft=new Map;function Lt(a,t){if(!(a instanceof IDBDatabase&&!(t in a)&&typeof t=="string"))return;if(ft.get(t))return ft.get(t);const e=t.replace(/FromIndex$/,""),s=t!==e,r=fe.includes(e);if(!(e in(s?IDBIndex:IDBObjectStore).prototype)||!(r||he.includes(e)))return;const i=async function(n,...o){const d=this.transaction(n,r?"readwrite":"readonly");let l=d.store;return s&&(l=l.index(o.shift())),(await Promise.all([l[e](...o),r&&d.done]))[0]};return ft.set(t,i),i}le(a=>({...a,get:(t,e,s)=>Lt(t,e)||a.get(t,e,s),has:(t,e)=>!!Lt(t,e)||a.has(t,e)}));const A={name:"bd-queue",store:"jobs",timeIndex:"time",objectIndex:"object"};var y=(a=>(a.Pending="pending",a.Completed="completed",a.Failed="failed",a.Conflict="conflict",a))(y||{}),H=(a=>(a.Success="success",a.Exception="exception",a.Failed="failed",a.Conflict="conflict",a))(H||{}),S=(a=>(a.Add="add",a.Edit="edit",a.Delete="delete",a))(S||{}),N="SharedWorker"in globalThis,me=class{constructor(a){m(this,"ActualWorker");this.ActualWorker=a}get onmessage(){var a;return N?(a=this.ActualWorker)==null?void 0:a.port.onmessage:this.ActualWorker.onmessage}set onmessage(a){N?this.ActualWorker.port.onmessage=a:this.ActualWorker.onmessage=a}get onmessageerror(){var a;return N?(a=this.ActualWorker)==null?void 0:a.port.onmessageerror:this.ActualWorker.onmessageerror}set onmessageerror(a){N?this.ActualWorker.port.onmessageerror=a:this.ActualWorker.onmessageerror=a}start(){var a;if(N)return(a=this.ActualWorker)==null?void 0:a.port.start()}postMessage(a,t){var e;return N?(e=this.ActualWorker)==null?void 0:e.port.postMessage(a,t):this.ActualWorker.postMessage(a,t)}terminate(){var a;return N?(a=this.ActualWorker)==null?void 0:a.port.close():this.ActualWorker.terminate()}close(){return this.terminate()}get port(){return N?this.ActualWorker.port:this.ActualWorker}get onerror(){return this.ActualWorker.onerror}set onerror(a){this.ActualWorker.onerror=a}addEventListener(a,t,e){var s;return N&&a!=="error"?(s=this.ActualWorker)==null?void 0:s.port.addEventListener(a,t,e):this.ActualWorker.addEventListener(a,t,e)}removeEventListener(a,t,e){var s;return N&&a!=="error"?(s=this.ActualWorker)==null?void 0:s.port.removeEventListener(a,t,e):this.ActualWorker.removeEventListener(a,t,e)}dispatchEvent(a){return this.ActualWorker.dispatchEvent(a)}},ge=class extends me{constructor(a,t){let e;N?e=new SharedWorker(a,t):e=new Worker(a,t),super(e)}};function be(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Mt={};/*! crc32.js (C) 2014-present SheetJS -- http://sheetjs.com */(function(a){(function(t){t(typeof DO_NOT_EXPORT_CRC>"u"?a:{})})(function(t){t.version="1.2.2";function e(){for(var g=0,F=new Array(256),b=0;b!=256;++b)g=b,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,g=g&1?-306674912^g>>>1:g>>>1,F[b]=g;return typeof Int32Array<"u"?new Int32Array(F):F}var s=e();function r(g){var F=0,b=0,_=0,v=typeof Int32Array<"u"?new Int32Array(4096):new Array(4096);for(_=0;_!=256;++_)v[_]=g[_];for(_=0;_!=256;++_)for(b=g[_],F=256+_;F<4096;F+=256)b=v[F]=b>>>8^g[b&255];var C=[];for(_=1;_!=16;++_)C[_-1]=typeof Int32Array<"u"?v.subarray(_*256,_*256+256):v.slice(_*256,_*256+256);return C}var i=r(s),n=i[0],o=i[1],d=i[2],l=i[3],c=i[4],u=i[5],h=i[6],f=i[7],w=i[8],T=i[9],z=i[10],O=i[11],zt=i[12],At=i[13],St=i[14];function Tt(g,F){for(var b=F^-1,_=0,v=g.length;_<v;)b=b>>>8^s[(b^g.charCodeAt(_++))&255];return~b}function ss(g,F){for(var b=F^-1,_=g.length-15,v=0;v<_;)b=St[g[v++]^b&255]^At[g[v++]^b>>8&255]^zt[g[v++]^b>>16&255]^O[g[v++]^b>>>24]^z[g[v++]]^T[g[v++]]^w[g[v++]]^f[g[v++]]^h[g[v++]]^u[g[v++]]^c[g[v++]]^l[g[v++]]^d[g[v++]]^o[g[v++]]^n[g[v++]]^s[g[v++]];for(_+=15;v<_;)b=b>>>8^s[(b^g[v++])&255];return~b}function rs(g,F){for(var b=F^-1,_=0,v=g.length,C=0,Ot=0;_<v;)C=g.charCodeAt(_++),C<128?b=b>>>8^s[(b^C)&255]:C<2048?(b=b>>>8^s[(b^(192|C>>6&31))&255],b=b>>>8^s[(b^(128|C&63))&255]):C>=55296&&C<57344?(C=(C&1023)+64,Ot=g.charCodeAt(_++)&1023,b=b>>>8^s[(b^(240|C>>8&7))&255],b=b>>>8^s[(b^(128|C>>2&63))&255],b=b>>>8^s[(b^(128|Ot>>6&15|(C&3)<<4))&255],b=b>>>8^s[(b^(128|Ot&63))&255]):(b=b>>>8^s[(b^(224|C>>12&15))&255],b=b>>>8^s[(b^(128|C>>6&63))&255],b=b>>>8^s[(b^(128|C&63))&255]);return~b}t.table=s,t.bstr=Tt,t.buf=ss,t.str=rs})})(Mt);function Y(){return Math.floor((new Date().getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3)}function mt(a){return Y().toString(36)+"-"+Mt.str(JSON.stringify(a)).toString(36)}function Ft(a){return new Promise(t=>{setTimeout(t,a)})}class R{constructor(t){m(this,"action");m(this,"blitzstamp");m(this,"hash");m(this,"hashAlgo");m(this,"blitzID");m(this,"userhash");m(this,"model");m(this,"data");var e;this.action=t.action,this.blitzstamp=t.blitzstamp??Y(),this.hash=t.hash??mt(t.data===void 0?{blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}:{...t.data,blitzID:t.blitzID,milliseconds:new Date().getTime(),rand:Math.random()}),this.hashAlgo=t.hashAlgo??"b-crc32",this.blitzID=t.blitzID??((e=t.data)==null?void 0:e._blitzID)??this.hash,this.model=t.model,this.data=t.data??{},this.userhash=t.userhash}toObject(){return{action:this.action,blitzstamp:this.blitzstamp,hash:this.hash,hashAlgo:this.hashAlgo,blitzID:this.blitzID,model:this.model,data:this.data,userhash:this.userhash}}clone(){return new R({action:this.action,model:this.model,blitzID:this.blitzID,blitzstamp:this.blitzstamp,data:this.data,hash:this.hash,hashAlgo:this.hashAlgo,userhash:this.userhash})}static fromObject(t){var e;return new R({action:t.action,blitzstamp:t.blitzstamp,hash:t.hash,hashAlgo:t.hashAlgo,blitzID:t.blitzID??((e=t.data)==null?void 0:e._blitzID)??t.blitzID,model:t.model,data:t.data,userhash:t.userhash})}}var E=(a=>(a.Success="success",a.Notice="notice",a.Error="error",a.Exception="exception",a))(E||{});class P{constructor(t,e,s,r=null,i){m(this,"blitzID");m(this,"hash");m(this,"message");m(this,"conflict");m(this,"replicaUrl",null);m(this,"status");this.blitzID=t,this.hash=e,this.status=s,this.message=r,this.conflict=i}setReplicaUrl(t){this.replicaUrl=t}isConflict(){return typeof this.conflict<"u"&&this.conflict!==null}}class tt extends Array{get(t){return this.find(e=>e.hash===t)}has(t){return this.some(e=>e.hash===t)}isSuccessful(t){var e;if(t){const s=(e=this.get(t))==null?void 0:e.status;return s?s==="success"||s==="notice":!1}return this.every(s=>s.status)}isFailed(t){var e;if(t){const s=(e=this.get(t))==null?void 0:e.status;return s?s==="error":!0}return this.every(s=>!s.status)}successful(){return new tt(...this.filter(t=>t.status))}failed(){return new tt(...this.filter(t=>!t.status))}}class L{static createListEndpoint(t,e,s){var n;const r=`${L.sanitizeBaseUrl(t)}api/list/${e}.json`,i=new URLSearchParams;return new URL(t).origin!==window.location.origin&&i.append("enableCors","1"),i.append("fkOptions",JSON.stringify({_userID:"blitzID"})),(n=s.conditions)!=null&&n.length&&i.append("conditions",JSON.stringify(s.conditions)),s.limit&&i.append("limit",s.limit.toString()),s.customSort&&i.append("customSort",s.customSort),s.customSortDirection&&i.append("customSortDirection",s.customSortDirection),s.var&&s.var.length>0&&i.append("var",JSON.stringify(s.var)),s.manyToMany&&i.append("manyToMany",s.manyToMany),`${r}?${i.toString()}`}static createGetEndpoint(t,e,s,r){const i=`${L.sanitizeBaseUrl(t)}api/list/${e}/_blitzID/${s}.json`,n=new URLSearchParams;return new URL(t).origin!==window.location.origin&&n.append("enableCors","1"),n.append("fkOptions",JSON.stringify({_userID:"blitzID"})),r.var&&r.var.length>0&&n.append("var",JSON.stringify(r.var)),r.manyToMany&&n.append("manyToMany",r.manyToMany),`${i}?${n.toString()}`}static createPostEndpoint(t){return`${L.sanitizeBaseUrl(t)}api/post.json`}static createPingEndpoint(t){return`${L.sanitizeBaseUrl(t)}api/ping.json`}static createListLogsEndpoint(t){var i,n;const e=t.type==="delete"?"listDeletedLogs":"listLogs",s=t.model?`${L.sanitizeBaseUrl(t.baseUrl)}api/${e}/${t.model}.json`:`${L.sanitizeBaseUrl(t.baseUrl)}api/${e}.json`,r=new URLSearchParams;return((i=t.query)==null?void 0:i.from)!==void 0&&r.append("from",t.query.from.toString()),(n=t.query)!=null&&n.models&&!t.model&&r.append("models",JSON.stringify(t.query.models)),`${s}?${r.toString()}`}static createUploaderEndpoint(t){const e=new URL(t).origin!==window.location.origin?"?enableCors=1":"";return`${L.sanitizeBaseUrl(t)}uploader/index`+e}static sanitizeBaseUrl(t){const e=new URL(t);if(!e.origin||!e.pathname||!e.protocol.match(/^https?:$/))throw new Error(`Supplied base URL is invalid: ${t}`);return e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),e.toString()}}class Q{static async list(t,e){if(!t.endpoint&&!t.fullUrl)throw new Error("Either baseUrl or fullUrl must be provided.");const s=await D.create().url(t.fullUrl?t.fullUrl:L.createListEndpoint(t.endpoint.baseUrl,t.endpoint.modelName,t.endpoint.query)).signal(e).get();if(!Array.isArray(s.items)&&Array.isArray(s.errors))throw new Error(s.errors.map(r=>(r==null?void 0:r.message)??r).join(" | "));return s.items??[]}static async get(t,e){const s=await D.create().url(L.createGetEndpoint(t.baseUrl,t.modelName,t.blitzID,t.query)).signal(e).get();if(!Array.isArray(s.items)&&Array.isArray(s.errors))throw new Error(s.errors.map(r=>(r==null?void 0:r.message)??r).join(" | "));return s.items??[]}static async post(t){const e=await D.create().url(L.createPostEndpoint(t.baseUrl)).body(t.transactions).post();if((typeof e.error=="string"||e.errors instanceof Array)&&!(e.results instanceof Object))throw new Error(e.error??e.errors.join(" | "));return e}static async listLogs(t){const e=await D.create().url(L.createListLogsEndpoint(t)).get();if(!(e.transactions instanceof Array)&&(typeof e.error=="string"||e.errors instanceof Array))throw new Error(e.error??e.errors.map(s=>(s==null?void 0:s.message)??s).join(" | "));return{transactions:e.transactions,userID:e.userID,userhash:e.userhash,lastTimestamp:e.lastTimestamp}}static upload(t){const e=new FormData;return e.append("image",t.image),D.create().url(L.createUploaderEndpoint(t.baseUrl)).body(e).header("Accept","application/json").post()}static async ping({baseUrl:t}){return await D.create().url(L.createPingEndpoint(t)).get()}}class gt{constructor(){m(this,"_query");m(this,"_model");m(this,"_type")}static create(){return new gt}query(t){return this._query=t,this}model(t){return this._model=t,this}type(t){return this._type=t,this}async perform(){const t=p.clusterManager.toArray().map(r=>r.getNextReadURL()),e=await Promise.all(t.map(r=>Q.listLogs({baseUrl:r,query:this._query,model:this._model,type:this._type})));return{transactions:[].concat(...e.map(r=>r.transactions)).filter((r,i,n)=>n.findIndex(o=>o.hash===r.hash)===i).filter(r=>typeof r=="object"&&!Array.isArray(r)),userID:e[0].userID,userhash:e[0].userhash,lastTimestamp:e[0].lastTimestamp}}}class bt{async ping(){const t=await this.openConnection(),e=["sync_transactions","evaluated_transactions"];for(const s of e)if(!t.objectStoreNames.contains(s))return t.close(),console.log(`There's missing stores, recreating the database. Available stores: ${t.objectStoreNames}`),await ht("db_master"),await this.ping();t.close()}async openConnection(){return await dt("db_master",1,{upgrade:(t,e,s,r,i)=>{s===1&&(t.createObjectStore("sync_transactions",{autoIncrement:!1,keyPath:"hash"}),t.createObjectStore("evaluated_transactions",{autoIncrement:!1,keyPath:"hash"}))}})}}class j{static getKey(t){return`BlitzData.${t}`}static get(t){return localStorage.getItem(this.getKey(t))}static set(t,e){localStorage.setItem(this.getKey(t),e)}static has(t){return Object.hasOwn(localStorage,this.getKey(t))}static remove(t){localStorage.removeItem(this.getKey(t))}static clear(){const t=Object.keys(localStorage);for(const e of t)e.startsWith("BlitzData.")&&localStorage.removeItem(e)}static getLastSyncedAt(t){const e=this.get(t?`${t}.lastSyncedAt`:"lastSyncedAt");return e?parseInt(e):null}static setLastSyncedAt(t,e){this.set(e?`${e}.lastSyncedAt`:"lastSyncedAt",t.toString())}static getCurrentUser(){const t=this.get("currentUser");return t?JSON.parse(t):null}static setCurrentUser(t){t?this.set("currentUser",JSON.stringify(t)):this.remove("currentUser")}static getProjectUsers(t){const e=this.get("projectUsers."+t);return e?JSON.parse(e):null}static setProjectUsers(t,e){const s="projectUsers."+t;e?this.set(s,JSON.stringify(e)):this.remove(s)}static getDatabases(){return JSON.parse(this.get("databases")??"[]")}static setDatabases(t){this.set("databases",JSON.stringify(t))}static getListCallLastTimeStamp(t){const e=this.get(`cache.listCall.${t}.lastTimeStamp`);return e?Number(e):null}static setListCallLastTimeStamp(t,e){this.set(`cache.listCall.${t}.lastTimeStamp`,String(e))}}class et{constructor(){m(this,"client",new bt)}static create(){return new et}async all(){const t=await this.client.openConnection(),e=await t.getAll("sync_transactions");return t.close(),e}async put(t){const e=await this.client.openConnection();await e.put("sync_transactions",t),e.close()}async putMultiple(t){for(const e of t)await this.put(e)}async delete(t){const e=await this.client.openConnection();await e.delete("sync_transactions",t),e.close()}}class K{static create(){return new K}async run(t,e){if(!navigator.onLine)return;const s=p.options.sync.startDate instanceof Date&&t!=="_Model"?Math.floor(p.options.sync.startDate.getTime()/1e3):0,r=j.getLastSyncedAt(t)??s,{transactions:i,lastTimestamp:n}=await gt.create().type(e).query({from:r,models:t?[t]:p.options.sync.models??["_Project",...(await M.list()).map(d=>d.getName()).filter(d=>d.startsWith("bdt")&&!["bdt24prszej_appfiles","bdt24prszej_apps"].includes(d))]}).perform(),o=et.create();await o.putMultiple(i),j.setLastSyncedAt(n??Math.floor(Date.now()/1e3),t),await J.create().run((await o.all()).map(d=>R.fromObject(d))),r!==n&&await this.run(t,e)}async runAtInterval(t){for(;;)await Ft(t),await this.run()}}class J{static create(){return new J}async run(t){const e=new tt,s=et.create(),r={add:1,edit:2,delete:3},i=await new bt().openConnection();t=t.sort((n,o)=>r[n.action]-r[o.action]);for(const n of t){let o;n.model==="@Model"?n.model="_Model":n.model==="@Project"&&(n.model="_Project");try{if(n.action==="add")o=await this.processAddTransaction(n);else if(n.action==="edit")o=await this.processEditTransaction(n,i);else if(n.action==="delete")o=await this.processDeleteTransaction(n);else throw new Error(`Unknown action "${n.action}" on transaction ${n.hash}`);await i.put("evaluated_transactions",n.toObject())}catch(d){o=new P(n.blitzID,n.hash,E.Error,d.message)}e.push(o),await s.delete(n.hash)}return i.close(),e}async processAddTransaction(t){var n;const e=await M.get(t.model),s=e.idbClient();if(await s.find(t.hash))return new P(t.hash,t.hash,E.Error,`Object with ${t.hash} already exists on ${t.model} model.`);const r=e.getClusterManager(),i={_blitzID:t.hash,_blitzstamp:t.blitzstamp.toString(),_sort:t.blitzstamp.toString(),_clusters:r.names(),_editURLs:r.toArray().map(o=>o.options.addURL).flat(),...(()=>{const o={};for(const[d,l]of Object.entries(t.data)){const c=e.getAttributeDetails(d);if(c&&Array.isArray(c.type)&&l!==void 0){const u=typeof l=="string"?JSON.parse(l):l;d.endsWith("_mtm")?o[d]=u.map((f,w)=>({_blitzID:typeof f=="string"?f:f._blitzID,_mtmSort:typeof f=="string"?(u.length-w)*15:f._mtmSort})):o[d]=u}else o[d]=l}return o})()};if(((n=e.haspublishingdate)==null?void 0:n.value)==="1"&&typeof t.data._publishingdate>"u"&&typeof t.blitzstamp=="number"){const o=new Date;o.setTime(t.blitzstamp*1e3+new Date("2021-01-01T00:00:00Z").getTime()),o.setMinutes(o.getMinutes()-o.getTimezoneOffset()),i._publishingdate=o.toISOString().slice(0,19).replace("T"," ")}return!i._userID&&t.userhash&&(i._userID=t.userhash),t.data=i,await s.create(i),new P(t.hash,t.hash,E.Success)}async processEditTransaction(t,e){var l;const s=await M.get(t.model),r=s.idbClient(),i=Object.keys(t.data);if(i.length!==1)return new P(t.blitzID,t.hash,E.Error,i.length>1?"Can not edit more than one attribute at once.":"Attribute not provided to perform edit.");if(await e.get("evaluated_transactions",t.hash))return new P(t.blitzID,t.hash,E.Notice,`Transaction ${t.hash} already processed.`);const n=await r.find(t.blitzID);if(!n)return new P(t.blitzID,t.hash,E.Notice,`Object with ${t.blitzID} does not exists.`);if(n._savetimestamp&&n._savetimestamp>t.blitzstamp)return new P(t.blitzID,t.hash,E.Notice,"Old transaction.");const o=i.shift(),d=(l=s.getAttributeDetails(o))==null?void 0:l.type;if(Array.isArray(d))if(Object.hasOwn(t.data[o],"add")){n[o]=n[o]??[];const c=t.data[o].add;o.endsWith("_mtm")?n[o].push({_blitzID:typeof c=="string"?c:c._blitzID,_mtmSort:typeof c=="string"?n[o].length?Math.max(...n[o].map(h=>h._mtmSort))+15:15:c._mtmSort}):n[o].push(c)}else if(Object.hasOwn(t.data[o],"remove")&&Array.isArray(n[o])){const c=t.data[o].remove;o.endsWith("_mtm")?n[o].splice(n[o].findIndex(h=>h._blitzID===c),1):n[o].splice(n[o].findIndex(h=>h===c),1)}else return new P(t.blitzID,t.hash,E.Error,`Invalid operation for array attribute ${o}.`);else{const c=t.data[o];if(n[o]===c.new)return new P(t.blitzID,t.hash,E.Notice,"Conflict");n[o]=c.new}return await r.update(n),new P(t.blitzID,t.hash,E.Success)}async processDeleteTransaction(t){const s=(await M.get(t.model)).idbClient();return await s.find(t.blitzID)?(await s.delete(t.blitzID),new P(t.blitzID,t.hash,E.Success)):new P(t.blitzID,t.hash,E.Error,`Object with ${t.blitzID} does not exists.`)}}class pe{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(A.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(A.store,t.id))}async _getCompletedReplicatedJobs(t){var i;const e=[],s=(i=this._db)==null?void 0:i.transaction(A.store,"readonly").store;let r=await(s==null?void 0:s.openCursor(null,"next"));for(;r;)r.value.status===y.Completed&&r.value.url!==t.url&&r.value.transaction.action===S.Edit&&r.value.transaction.blitzID===t.transaction.blitzID&&r.value.transaction.hash===t.transaction.hash&&e.push(r.value),r=await r.continue();return e}async _getFutureJobs(t,e){var o;const s=[],r=(o=this._db)==null?void 0:o.transaction(A.store,"readonly").store,i=IDBKeyRange.lowerBound(t.createdAt,!0);let n=await(r==null?void 0:r.index(A.timeIndex).openCursor(i,"next"));for(;n;)n.value.status===y.Conflict&&n.value.url===t.url&&n.value.transaction.action===S.Edit&&n.value.transaction.blitzID===t.transaction.blitzID&&Object.keys(n.value.transaction.data)[0]===e&&s.push(n.value),n=await n.continue();return s}async _mergeWithFutureEditJobs(t,e){var i,n;const s=await this._getFutureJobs(t,e);let r=t;if(s.length>0){const o=s[s.length-1];if(o&&((i=o.transaction.data)!=null&&i[e].new)){r=await this._updateJob({...t,transaction:{...t.transaction,data:{[e]:{prev:(n=t.transaction.data)==null?void 0:n[e].prev,new:o.transaction.data[e].new}}}});for(const d of s)await this._deleteJob(d)}}return r}async prompt(t){var i;const e=Object.keys(t.transaction.data)[0];let s=await this._mergeWithFutureEditJobs(t,e);const r=`There was a conflict.
The data got changed to "${s.message}".
Do you still want to perform your change to "${(i=s.transaction.data)==null?void 0:i[e].new}"?`;confirm(r)?s=await this.force(s):await this.revert(s),p.dispatchEvent("queue:conflict",s)}async force(t){var i;const e=Object.keys(t.transaction.data)[0],s=await this._getFutureJobs(t,e),r=await this._updateJob({...t,status:y.Pending,transaction:{...t.transaction,data:{[e]:{prev:t.message,new:(i=t.transaction.data)==null?void 0:i[e].new}}}});for(const n of s)await this._updateJob({...n,status:y.Pending});return r}async revert(t){var n;const e=Object.keys(t.transaction.data)[0],s=new R({action:"edit",model:t.transaction.model,blitzID:t.transaction.blitzID,data:{[e]:{prev:(n=t.transaction.data)==null?void 0:n[e].new,new:t.message}}});await J.create().run([s]);const r=await this._getFutureJobs(t,e),i=await this._getCompletedReplicatedJobs(t);for(const o of[t,...r])await this._deleteJob(o);if(i.length>0){const o=i.map(d=>d.url).filter((d,l,c)=>c.findIndex(u=>u===d)===l);for(const d of o)await p.queue.addJob(d,s.toObject())}}}class ye{constructor(t){m(this,"_db");this._db=t}async _updateJob(t){var e;return await((e=this._db)==null?void 0:e.put(A.store,t)),t}async _deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(A.store,t.id))}async _getFutureJobs(t){var n;const e=[],s=(n=this._db)==null?void 0:n.transaction(A.store,"readonly").store,r=IDBKeyRange.lowerBound(t.createdAt,!0);let i=await(s==null?void 0:s.index(A.timeIndex).openCursor(r,"next"));for(;i;)i.value.url===t.url&&i.value.transaction.blitzID===t.transaction.blitzID&&e.push(i.value),i=await i.continue();return e}async retry(t){for(const e of t)await this._updateJob({...e,status:y.Pending})}async revert(t){var s,r;t.sort((i,n)=>i.createdAt-n.createdAt);const e=t[0];if(e){if(e.transaction.action===S.Add){await J.create().run([new R({action:"delete",model:e.transaction.model,blitzID:e.transaction.blitzID})]);const i=await this._getFutureJobs(e);for(const n of[e,...i])await this._deleteJob(n)}else if(e.transaction.action===S.Delete)await this._deleteJob(e),await M.get(e.transaction.model).then(i=>i==null?void 0:i.get(e.transaction.blitzID));else if(e.transaction.action===S.Edit){const i=Object.keys(e.transaction.data??{})[0];if(!i||((s=e.transaction.data)==null?void 0:s[i].new)===void 0||((r=e.transaction.data)==null?void 0:r[i].prev)===void 0)return;const n=new R({action:"edit",model:e.transaction.model,blitzID:e.transaction.blitzID,data:{[i]:{prev:e.transaction.data[i].new,new:e.transaction.data[i].prev}}});await J.create().run([n]);for(const o of t)await this._deleteJob(o)}}}async getAll(){var r;const t={},e=(r=this._db)==null?void 0:r.transaction(A.store,"readonly").store;let s=await(e==null?void 0:e.index(A.timeIndex).openCursor(null,"next"));for(;s;){if(s.value.status!==y.Completed){if(t[s.value.url]||(t[s.value.url]=[]),s.value.transaction.action===S.Add||s.value.transaction.action===S.Delete)t[s.value.url].push([s.value]);else if(s.value.transaction.action===S.Edit){const i=Object.keys(s.value.transaction.data??{})[0],n=s.value.transaction.blitzID,o=t[s.value.url].findIndex(d=>d[0].transaction.action===S.Edit&&d[0].transaction.blitzID===n&&Object.keys(d[0].transaction.data??{})[0]===i);o===-1?t[s.value.url].push([s.value]):t[s.value.url][o].push(s.value)}}s=await s.continue()}return t}}const we="/queue-worker.js";class _e{constructor(){m(this,"_db",null);m(this,"conflictHandler",null);m(this,"failedHandler",null)}_handleWorkerMessage(t){var s;const e=t.data;e.status===y.Completed?p.dispatchEvent("queue:success",e):e.status===y.Failed?p.dispatchEvent("queue:failure",e):e.status===y.Conflict&&(document.hidden||(s=p.queue.conflictHandler)==null||s.prompt(e)),p._Model.get(e.transaction.model).then(r=>{var i;return(i=r==null?void 0:r.memoryClient().get(e.transaction.blitzID))==null?void 0:i.dispatchEvent("syncStatusChange",e)}),p.queue.updateSyncStatus(e)}async updateSyncStatus(t,e){if(t.transaction.action!==S.Edit)return;const s=await p._Model.get(t.transaction.model),r=s==null?void 0:s.memoryClient().get(t.transaction.blitzID);if(!r)return;const i=Object.keys(t.transaction.data??{})[0];if(!i)return;const n=r[i];if(!(!n||!Object.hasOwn(n,"_syncSignal")))if(e)n._syncSignal.set({status:e});else{const d=(await p.queue.getJobsForObject(t.transaction.blitzID)).filter(h=>{var f;return h.transaction.action===S.Edit&&((f=h.transaction.data)==null?void 0:f[i])!==void 0});let l=y.Pending,c;const u=d.find(h=>h.status===y.Failed);u?(l=y.Failed,c=u.message):d.find(h=>h.status===y.Conflict)?l=y.Conflict:d.every(h=>h.status===y.Completed)&&(l=y.Completed),n._syncSignal.set({status:l,message:c})}}async init(){if(this._db=await dt(A.name,1,{upgrade:e=>{const s=e.createObjectStore(A.store,{keyPath:"id"});s.createIndex(A.timeIndex,"createdAt"),s.createIndex(A.objectIndex,"transaction.blitzID")}}),!this._db.objectStoreNames.contains(A.store))return await ht(A.name),await this.init();this.conflictHandler=new pe(this._db),this.failedHandler=new ye(this._db);const t=new ge(p.options.assetsPath+we,{});return t.port.onmessage=this._handleWorkerMessage,window.addEventListener("beforeunload",()=>t.port.postMessage({type:"close"})),D._globalHeaders&&t.port.postMessage({type:"headers",data:D._globalHeaders}),this}async addJob(t,e){var r;const s={id:crypto.randomUUID(),url:t,transaction:e,status:y.Pending,createdAt:Date.now(),attempts:0,priority:1};await((r=this._db)==null?void 0:r.add(A.store,s)),await this.updateSyncStatus(s,s.status)}async deleteJob(t){var e;await((e=this._db)==null?void 0:e.delete(A.store,t.id))}async getJobs(){var t;return await((t=this._db)==null?void 0:t.getAll(A.store))}async getJobsForObject(t){var e;return await((e=this._db)==null?void 0:e.getAllFromIndex(A.store,A.objectIndex,t))}}const Z={a:["à","á","â","ä"],c:["ç"],e:["è","é","ê"],o:["ö","ó","ò","ô","õ"],oe:["œ"],ss:["ß"],u:["ü"]};class st{constructor(){m(this,"children");m(this,"isEndOfWord");m(this,"items");this.children={},this.isEndOfWord=!1,this.items=[]}}class kt{constructor(t,e){m(this,"root");if(this.root=new st,!e)return;const s=this.getWordFrequency(t,e);for(const r in s)this.insert(r,s[r].items)}_loadFromJson(t,e){Object.keys(t).forEach(s=>{typeof t[s]=="string"||typeof t[s]=="boolean"||(e.children[s]||(e.children[s]=new st),t[s].hasOwnProperty("isEndOfWord")&&t[s].isEndOfWord&&(e.children[s].isEndOfWord=!0,e.children[s].items=t[s].items),this._loadFromJson(t[s],e.children[s]))})}loadFromJson(t){return this.root=new st,this._loadFromJson(t,this.root),this}toJson(){const t=e=>{let s={};for(const r in e.children)s[r]=t(e.children[r]);return e.isEndOfWord&&(s.isEndOfWord=!0,s.items=e.items),s};return t(this.root)}getWordFrequency(t,e){const s={},r=t.getAttributes();return e.forEach(i=>{r==null||r.forEach(n=>{if(!i[n])return;i[n].toString().toLowerCase().split(" ").forEach(d=>{d!==""&&(s[d]?s[d].items.push(i._blitzID):s[d]={items:[i._blitzID]})})})}),s}getVariants(t){const e=Z[t],s=[t];return e&&s.push(...e),s}generateAllPermutations(t,e,s,r,i){if(e===s.length){i.push(t);return}const n=s[e],o=e!==s.length-1?n+s[e+1]:void 0;if(!Z[n]&&!(o&&Z[o])){this.generateAllPermutations(t+n,e+1,s,r,i);return}if(Z[n]){const d=r[n];for(const l of d)this.generateAllPermutations(t+l,e+1,s,r,i)}if(o&&Z[o]){const d=r[o];for(const l of d)this.generateAllPermutations(t+l,e+2,s,r,i)}}normalizeQuery(t){const e=/u|e|a|o|c|ss|oe/g,s=t.toLowerCase().match(e);if(!s)return[t.toLowerCase()];const r={};s.forEach(n=>{r[n]=this.getVariants(n)});const i=[];return this.generateAllPermutations("",0,t,r,i),i}insert(t,e){let s=this.root;for(const r of t)s.children[r]||(s.children[r]=new st),s=s.children[r];s.isEndOfWord=!0,s.items=e}addToSet(t,e){const s=this.normalizeQuery(t);for(const r of s)this._search(r).forEach(n=>{e.add(n)})}search(t){const e=t==null?void 0:t.toLowerCase().split(" ");let s=new Set;return this.addToSet(e[0],s),e.slice(1).forEach(r=>{const i=new Set;this.addToSet(r,i);for(const n of s)i.has(n)||s.delete(n)}),Array.from(s)}_search(t){let e=this.root;for(const r of t){if(!e.children[r])return[];e=e.children[r]}const s=[];return t===""?this.collectWords(e,"",s):this.collectWords(e,t,s),s}collectWords(t,e,s){t.isEndOfWord&&s.push(...t.items);for(const r in t.children){const i=t.children[r],n=e+r;this.collectWords(i,n,s)}}}function Rt(a,t,e){var r;let s=!0;for(const i of t){if(!s)return!1;const[n,o,d]=i,l=(r=e==null?void 0:e[n])==null?void 0:r.type;let c=a[n],u=d;switch(typeof c=="string"&&(l==="datetime"||l==="date"||n==="_publishingdate")&&(c=new Date(c).getTime()),typeof u=="string"&&(l==="datetime"||l==="date"||n==="_publishingdate")&&(u=new Date(u).getTime()),o){case"LIKE":const h=`${u}`.startsWith("%"),f=`${u}`.endsWith("%"),w=`${u}`.replaceAll("%","");h===f?s=`${c}`.includes(w):h?s=`${c}`.endsWith(w):f&&(s=`${c}`.startsWith(w));break;case"IN":s=(Array.isArray(u)?u:[u]).includes(c);break;case"=":s=c===u;break;case"!=":s=c!==u;break;case">":s=c>u;break;case"<":s=c<u;break;case">=":s=c>=u;break;case"<=":s=c<=u;break;default:s=!0;break}}return s}class ve{constructor(t){m(this,"model");this.model=t,this.ping()}async ping(){(await this.connect()).close()}async query(t,e){const s=await this.connect(),r=s.transaction("objects","readonly").store,i=t.customSort&&Array.from(r.indexNames).includes(t.customSort)?t.customSort:"sorted",n=t.customSortDirection==="ASC"?"next":"prev";let o=await r.index(i).openCursor(null,n);const d=this.model.getAttributesDetails()??void 0;let l=[];for(;o;){if(e&&!e.includes(o.value.blitzID)){o=await o.continue();continue}if(Rt(o.value,t.conditions??[],d)&&(l.push(o.value),t.limit&&l.length>=t.limit))break;o=await o.continue()}if(s.close(),t.var&&t.var.length>0){const u=["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var];for(const h of l)for(const f in h)u.includes(f)||delete h[f]}return l}async search(t,e){const s=await this.connect(),r=new kt(this.model).loadFromJson(s.get("tree",this.model.getName()));s.close();const i=r.search(t);return t!==""&&i.length===0?[]:this.query({conditions:e},i)}async save(t,e=!1){const s=await this.connect();for(const r of t){let i={...r};const n=await s.get("objects",i._blitzID);if(n)i={...n,...i};else if(e)continue;i._savetimestamp=Y(),await s.put("objects",i)}s.close()}async connect(){const t=this.model.getAttributesDetails();return await dt(this.model.getName(),1,{upgrade:(s,r,i,n,o)=>{const d=j.getDatabases();if(d.includes(s.name)||(d.push(s.name),j.setDatabases(d)),i!==1)return;s.createObjectStore("tree",{keyPath:"name"});const l=s.createObjectStore("objects",{keyPath:"_blitzID"});if(t)for(const c in t)(t[c].type==="date"||c.includes("_fk"))&&l.createIndex(c,c,{unique:!1});l.createIndex("sorted","_blitzstamp")}})}async find(t){const e=await this.connect(),s=e.get("objects",t);return e.close(),s}async create(t){const e=await this.connect();await e.put("objects",t),this.updateTree(),e.close()}async update(t){const e=await this.connect();await e.put("objects",t),this.updateTree(),e.close()}async delete(t){const e=await this.connect();await e.delete("objects",t),this.updateTree(),e.close()}async updateTree(){const t=await this.connect(),e=await t.getAll("objects");await t.put("tree",{name:this.model.getName(),tree:new kt(this.model,e).toJson()}),t.close()}}class pt{constructor(){m(this,"_subscribers");m(this,"_cleanUp",()=>{});this._subscribers=new Set}emit(t){for(const e of this._subscribers)e(t)}subscribe(t){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),()=>{this._subscribers.delete(t),this._cleanUp()}}filterPipe(t){const e=new pt;return e._cleanUp=this.subscribe(s=>{t(s)&&e.emit(s)}),e}}const it=class it{constructor(t){m(this,"model");this.model=t,p.objects.has(this.model.getName())||p.objects.set(this.model.getName(),new Map)}getAll(){return p.objects.get(this.model.getName())}get(t){return this.getAll().get(t)}update(t){var i;const e=this.getAll();if(!e.has(t._blitzID.value))return e.set(t._blitzID.value,t),t;const s=e.get(t._blitzID.value),r=Object.keys(this.model.getAttributesDetails()??{});for(const n of r){const o=(i=t[n])==null?void 0:i._value;if(o!==void 0){const d=s[n];d&&(d._value=o,d._valueSignal.set(o,!1))}}return s}delete(t){const e=this.getAll();e.has(t)&&e.delete(t)}emit(t){it.channel.emit(t)}async query(t={}){const e=[],s=Array.from(this.getAll().values()).map(l=>l.toObject()),r=this.model.getAttributesDetails()??void 0,i=Object.keys(r??{}),n=t.customSort&&i.includes(t.customSort)?t.customSort:"_blitzstamp",o=t.customSortDirection??"DESC";s.sort((l,c)=>{try{const u=parseInt(l[n]),h=parseInt(c[n]);if(u<h)return o==="ASC"?-1:1;if(u>h)return o==="ASC"?1:-1}catch{}return 0});for(const l of s)if(Rt(l,t.conditions??[],r)&&(e.push(l),t.limit&&e.length>=t.limit))break;if(t.var&&t.var.length>0){const l=["_blitzID","_localID","@permissions","_sort","_clusters","_editURLs","_savetimestamp",...t.var];for(const c of e)for(const u in c)l.includes(u)||delete c[u]}return e}};m(it,"channel",new pt);let rt=it;class De{static async send(t,e){try{const s=new URL(t.url).origin!==self.location.origin?"?enableCors=1":"",r=await globalThis.fetch(t.url+"/api/post.json"+s,{method:"POST",headers:{"Content-Type":"application/json",...e??{}},body:JSON.stringify([t.transaction])});if(!r.ok)throw new Error(`HTTP request failed with status ${r.status}`+(r.statusText?`: ${r.statusText}`:""));const i=await r.json();if(!i||!i.results)throw new Error("No response returned!");const n=i.results[t.transaction.hash];if(!n)throw new Error("No result returned for this job!");if(n.s||n.s0||n.s1||n.n)return{status:H.Success};if(n.conflict){const o=Object.keys(t.transaction.data)[0],d=n.conflict[o];if(!d)throw new Error("No previous value found in conflict result!");return{status:H.Conflict,message:d}}else if(n.e)return{status:H.Failed,message:n.e};return{status:H.Exception,message:i.error??(Array.isArray(i.errors)?i.errors.map(o=>(o==null?void 0:o.message)??o).join(" | "):"Unknown error!")}}catch(s){return{status:H.Exception,message:s.message}}}}class G{constructor(t){m(this,"_value");m(this,"_subscribers");this._value=t,this._subscribers=new Set}get(){return this._value}set(t,e=!0){this._value!==t&&(this._value=t,e&&this.emit())}emit(){for(const t of this._subscribers)t(this._value)}subscribe(t,e=!0){if(typeof t!="function")throw new Error("Subscriber must be a function");return this._subscribers.add(t),e&&t(this._value),()=>this._subscribers.delete(t)}}class x{constructor(t,e,s){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(s),this._valueSignal=new G(this._value),this._syncSignal=new G(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}withValue(t){return this.value=t,this}withObject(t){return this._object=t,this}async edit(t,e){if(!this._object)throw new Error("Can not edit attribute, object is not set.");return this._object.edit(this._name,t,e)}subscribe(t,e=!0){var r,i;const s=this._valueSignal.subscribe(t,e);return this._value===void 0&&((i=(r=this._object)==null?void 0:r.model)==null||i.get({blitzID:this._object._blitzID.value,forceHttp:!0}).then(n=>{(n==null?void 0:n[this._name]._value)!==void 0&&this._valueSignal.emit()})),s}syncStatus(t){var r;const e=this._syncSignal.get()!==null,s=this._syncSignal.subscribe(t,e);return e||p.queue.getJobsForObject((r=this._object)==null?void 0:r._blitzID.value).then(i=>{let n=y.Pending,o;const d=i.filter(c=>{var u;return c.transaction.action===S.Edit&&((u=c.transaction.data)==null?void 0:u[this._name])!==void 0}),l=d.find(c=>c.status===y.Failed);l?(n=y.Failed,o=l.message):d.find(c=>c.status===y.Conflict)?n=y.Conflict:d.every(c=>c.status===y.Completed)&&(n=y.Completed),this._syncSignal.set({status:n,message:o},!1),t(this._syncSignal.get())}),s}}class X extends x{unserialize(t){return t}serialize(){return this._value}}class Pt extends x{unserialize(t){if(typeof t=="boolean")return t;if(typeof t=="string"&&["0","1"].includes(t))return t==="1";if(typeof t=="number"&&[0,1].includes(t))return t===1;if(t!==void 0)return null}serialize(){return typeof this._value=="boolean"?this._value?"1":"0":this._value}}const Ie=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}$/;class ze extends x{unserialize(t){if(t==="0000-00-00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&Ie.test(e))return e;if(t!==void 0)return null}serialize(){return this._value===null?"0000-00-00":this._value}toDateString(t){return!t||!(t instanceof Date)?null:t.toISOString().substring(0,10)}toDateObject(){return this._value?new Date(this._value):null}}class Nt extends x{unserialize(t){return t}serialize(){return this._value}}class Ae extends x{unserialize(t){return t}serialize(){return this._value}}class Jt extends x{unserialize(t){if(typeof t=="number")return t;if(typeof t=="string")return parseInt(t,10);if(t!==void 0)return null}serialize(){return typeof this._value=="number"?this._value.toString():this._value}}class Se extends Nt{}const Te=/^[0-9]{4}\-[0-9]{2}\-[0-9]{2}\s[0-9]{2}\:[0-9]{2}\:[0-9]{2}$/;class Oe extends x{unserialize(t){if(t==="0000-00-00 00:00:00")return null;const e=t instanceof Date?this.toDateString(t):t;if(e!=null&&Te.test(e))return e;if(t!==void 0)return null}serialize(){return this._value===null?"0000-00-00 00:00:00":this._value}toDateString(t){if(!t||!(t instanceof Date))return null;const e=new Date(t);e.setMinutes(e.getMinutes()-e.getTimezoneOffset());const s=e.toISOString();return s.substring(0,10)+" "+s.substring(11,19)}toDateObject(){return this._value?new Date(this._value):null}getTimeStamp(){return this._value?new Date(this._value).getTime():null}getBlitzStamp(){return this._value?Math.floor((new Date(this._value).getTime()-new Date("2021-01-01T00:00:00Z").getTime())/1e3):null}}class Ee extends x{async getObject(t){const e=this.serialize();if(!e)return null;const s=await M.get(this._type),r=s==null?void 0:s.memoryClient().get(e);return r||(await(s==null?void 0:s.get({skipCacheUpdateIfFound:!0,...t,raw:!1,blitzID:e}))??null)}unserialize(t){return t!=null&&typeof t!="string"?null:t}serialize(){return this._value}}class je extends x{async toUser(){const t=this.serialize();if(!t)return null;const e=await M.get("0BAUsers"),s=await(e==null?void 0:e.get({blitzID:t,skipCacheUpdateIfFound:!0}));return s?{id:t,username:s.username.value}:null}unserialize(t){return t}serialize(){return this._value}}class yt{constructor(t,e,s){m(this,"_object");m(this,"_name");m(this,"_type");m(this,"_value");m(this,"_valueSignal");m(this,"_syncSignal");this._name=t,this._type=e,this._value=this.unserialize(s),this._valueSignal=new G(this._value),this._syncSignal=new G(null)}get value(){return this._value}set value(t){this._value=this.unserialize(t),this._valueSignal.set(this._value)}unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t):t instanceof Array?t:t===null?[]:void 0,e!==void 0&&!Array.isArray(e)&&(e=[])}catch{}return e&&(e=e.map(s=>k.createType(this._name,this._type,s)),e.forEach(s=>s.withObject(this._object))),e}serialize(){if(this._value!==void 0)return this._value.map(t=>t.serialize())}async performAction(t){var i,n,o,d,l,c,u,h,f,w,T,z;const e=new R({action:"edit",data:{[this._name]:{[t.action]:t.value}},model:(n=(i=this._object)==null?void 0:i.model)==null?void 0:n.getName(),blitzID:(o=this._object)==null?void 0:o._blitzID.value}),s=await J.create().run([e]);if(s[0].status!==E.Success&&s[0].status!==E.Notice)throw new Error(s[0].message??"Unknown Error! Please try again.");for(const O of((l=(d=this._object)==null?void 0:d._editURLs)==null?void 0:l.value)??[])await p.queue.addJob(O,e.toObject());const r=await((u=(c=this._object)==null?void 0:c.model)==null?void 0:u.get({blitzID:this._object._blitzID.value,forceLocal:!0,raw:!0}));r&&Array.isArray(r[this._name])&&(this.value=r[this._name]),(f=(h=this._object)==null?void 0:h.model)==null||f.memoryClient().emit(e),(w=this._object)==null||w.dispatchEvent("edit",e.data),(z=(T=this._object)==null?void 0:T.model)==null||z.setLastTransactionHash(e.hash)}async add(t){await this.performAction({action:"add",value:k.createType(this._name,this._type,t).serialize()})}async remove(t){await this.performAction({action:"remove",value:k.createType(this._name,this._type,t).serialize()})}withObject(t){this._object=t,this._value!==void 0&&this._value.forEach(e=>e.withObject(t))}subscribe(t,e=!0){var r,i;const s=this._valueSignal.subscribe(t,e);return this._value===void 0&&((i=(r=this._object)==null?void 0:r.model)==null||i.get({blitzID:this._object._blitzID.value,forceHttp:!0,query:{manyToMany:"object"}}).then(n=>{(n==null?void 0:n[this._name]._value)!==void 0&&this._valueSignal.emit()})),s}syncStatus(t){var r;const e=this._syncSignal.get()!==null,s=this._syncSignal.subscribe(t,e);return e||p.queue.getJobsForObject((r=this._object)==null?void 0:r._blitzID.value).then(i=>{let n=y.Pending,o;const d=i.filter(c=>{var u;return c.transaction.action===S.Edit&&((u=c.transaction.data)==null?void 0:u[this._name])!==void 0}),l=d.find(c=>c.status===y.Failed);l?(n=y.Failed,o=l.message):d.find(c=>c.status===y.Conflict)?n=y.Conflict:d.every(c=>c.status===y.Completed)&&(n=y.Completed),this._syncSignal.set({status:n,message:o},!1),t(this._syncSignal.get())}),s}}class Wt extends yt{unserialize(t){let e;try{e=typeof t=="string"?JSON.parse(t):t instanceof Array?t:t===null?[]:void 0,e!==void 0&&!Array.isArray(e)&&(e=[])}catch{}return e}serialize(){return this._value}async add(t){await this.performAction({action:"add",value:t})}async remove(t){await this.performAction({action:"remove",value:t})}withObject(t){this._object=t}async getObjects(t){const e=this.serialize();if(!Array.isArray(e))return[];const s=await M.get(this._type),r=s==null?void 0:s.memoryClient(),i=[];for(const n of e){if(!n._blitzID)continue;const o=r==null?void 0:r.get(n._blitzID);if(o){i.push(o);continue}const d=await(s==null?void 0:s.get({skipCacheUpdateIfFound:!0,...t,raw:!1,blitzID:n._blitzID}));d&&i.push(d)}return i}}function xe(a){return a&&a.constructor&&typeof a.constructor.isBuffer=="function"&&a.constructor.isBuffer(a)}function Ue(a){return a}function Ce(a,t){t=t||{};const e=t.delimiter||".",s=t.maxDepth,r=t.transformKey||Ue,i={};function n(o,d,l){l=l||1,Object.keys(o).forEach(function(c){const u=o[c],h=t.safe&&Array.isArray(u),f=Object.prototype.toString.call(u),w=xe(u),T=f==="[object Object]"||f==="[object Array]",z=d?d+e+r(c):r(c);if(!h&&!w&&T&&Object.keys(u).length&&(!t.maxDepth||l<s))return n(u,z,l+1);i[z]=u})}return n(a),i}class Le extends x{unserialize(t){if(t!==null&&typeof t=="object")return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){let e=!0;try{JSON.parse(t)}catch{e=!1}return e}keys(){return Object.keys(this._value??{})}flat(){return Ce(this._value??{})}groupBy(t){if(typeof t!="function")throw new Error("Callback function is not a function!");return Object.groupBy(this._value??{},t)}}class Me extends x{unserialize(t){if(typeof t=="string")return{content:t,language:null};if(t!==null&&typeof t=="object"&&t.content)return{content:t.content,language:t.language??null};if(t!==void 0)return null}serialize(){return this._value}getLanguage(){var t;return((t=this._value)==null?void 0:t.language)||null}getContent(){var t;return((t=this._value)==null?void 0:t.content)||null}}class Fe extends x{unserialize(t){return t}serialize(){return this._value}getOptions(){var t,e,s;return((s=(e=(t=this._object)==null?void 0:t.model)==null?void 0:e.getAttributeDetails(this._name))==null?void 0:s.options)??[]}validate(t){return this.getOptions().includes(t)}}class wt extends x{unserialize(t){if(typeof t=="number")return t;if(typeof t=="string")return parseFloat(t);if(t!==void 0)return null}serialize(){return typeof this._value=="number"?this._value.toString():this._value}}class ke extends Jt{}class Re extends wt{}class Pe extends wt{toPercentage(){return this._value!=null?(this._value*100).toString()+"%":null}}const $t=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;class Ne extends x{unserialize(t){if(t!=null&&$t.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return $t.test(t)}}const Ht=/^\+[1-9]{1,3}\-[0-9]{7,14}$/;class Je extends x{unserialize(t){if(t!=null&&Ht.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return Ht.test(t)}getCallingCode(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[0].substring(1)}getPhoneNumber(){if(!this._value)return null;const t=this._value.split("-");return t.length<2?null:t[1]}}const Bt=/^https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)$/;class We extends x{unserialize(t){if(t!=null&&Bt.test(t))return t;if(t!==void 0)return null}serialize(){return this._value}validate(t){return Bt.test(t)}getUrlObject(){return this._value?new URL(this._value):null}getOrigin(){return this._value?new URL(this._value).origin:null}getProtocol(){return this._value?new URL(this._value).protocol:null}getPathname(){return this._value?new URL(this._value).pathname:null}getHostname(){return this._value?new URL(this._value).hostname:null}getSearch(){return this._value?new URL(this._value).search:null}}class $e extends x{unserialize(t){const e=t instanceof Array?t[0]:t;if(e!==null&&typeof e=="object"&&e.base!=null&&e.version!=null)return t;if(e!==void 0)return null}serialize(){return this._value}getUrl(t){const e=this._value instanceof Array?this._value[0]:this._value;return e!==null&&typeof e=="object"&&e.base!=null&&e[t]!=null?e.base+e[t].substring(1):null}}class He extends x{unserialize(t){if(t!==null&&typeof t=="object"&&t.lat&&t.long)return t;if(t!==void 0)return null}serialize(){return this._value?this._value:null}validate(t){if(typeof t!="object"||t===null)return!1;const e=t;if(!e.lat||!e.long)return!1;const s=parseFloat(e.lat);if(isNaN(s)||s<-90||s>90)return!1;const r=parseFloat(e.long);return!(isNaN(r)||r<-180||r>180)}getFormattedAddress(){if(!this._value)return"";const t=[];this._value.venue&&t.push(this._value.venue),this._value.street&&t.push(this._value.street);const e=[];return this._value.zip&&e.push(this._value.zip),this._value.city&&e.push(this._value.city),e.length>0&&t.push(e.join(" ")),this._value.nation&&t.push(this._value.nation),t.join(", ")}async geocodeAddress(t,e){if(!t)throw new Error("Address is required for geocoding.");if(!e)throw new Error("Google Maps API key is required for geocoding.");try{const r=await(await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(t)}&key=${e}`)).json();if(r.status==="OK"&&r.results&&r.results.length>0){const i=r.results[0].geometry.location;return{lat:i.lat.toString(),long:i.lng.toString()}}return null}catch(s){return console.error("Geocoding error:",s.message),null}}}class k{static createType(t,e,s){return t.endsWith("_fk")?new Ee(t,e,s):t==="_userID"?new je(t,e,s):e==="int"||["_blitzstamp"].includes(t)?new Jt(t,"int",s):e==="tinyint"?new ke(t,e,s):e==="double"?new Re(t,e,s):e==="float"?new wt(t,e,s):e==="percentage"?new Pe(t,e,s):e==="varchar"?new Se(t,e,s):e==="text"?new Nt(t,e,s):e==="htmlText"?new Ae(t,e,s):e==="enum"?new Fe(t,e,s):e==="json"?new Le(t,e,s):e==="boolean"?new Pt(t,e,s):e==="datetime"||["_publishingdate","_modified"].includes(t)?new Oe(t,"datetime",s):e==="date"?new ze(t,e,s):e==="code"?new Me(t,e,s):e==="email"?new Ne(t,e,s):e==="phone"?new Je(t,e,s):e==="url"?new We(t,e,s):e==="image"?new $e(t,e,s):e==="location"?new He(t,e,s):new X(t,e,s)}static createFrom(t,e,s){return Array.isArray(e)?this.createMany(t,e[0],s):this.createType(t,e,s)}static createMany(t,e,s){return t.endsWith("_mtm")?new Wt(t,e,s):new yt(t,e,s)}static unserialize(t,e){var i,n,o;const s={},r=[...Object.keys(t),...Object.keys(e)].filter((d,l,c)=>c.indexOf(d)===l);for(const d of r)Array.isArray((i=t[d])==null?void 0:i.type)?s[d]=k.createMany(d,((n=t[d])==null?void 0:n.type[0])??"anonymous",e[d]):s[d]=k.createType(d,((o=t[d])==null?void 0:o.type)??"anonymous",e[d]);return s}static serialize(t){const e={};for(const s in t)e[s]=t[s].serialize();return e}}class B{constructor({model:t,attributes:e}){m(this,"_model");m(this,"attributes");m(this,"listeners",new Map);m(this,"editQueue",Promise.resolve());this._model=t,this.attributes=e}get model(){return this._model}getAttribute(t){return this.attributes[t]}hasAttribute(t){return this.attributes.hasOwnProperty(t)}edit(t,e,s){return this.enqueueEditOperation(async()=>{var l,c,u,h;const r=(c=(l=this.model)==null?void 0:l.getAttributeDetails(t))==null?void 0:c.type,i=k.createType(t,r,e).serialize(),n=s?k.createType(t,r,s).serialize():this.getAttribute(t).serialize(),o=new R({action:"edit",data:{[t]:{prev:n,new:i}},model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),d=await J.create().run([o]);if(d[0].status!==E.Success&&d[0].status!==E.Notice)throw new Error(d[0].message??"Unknown Error! Please try again.");this.attributes[t].value=i;for(const f of this.getAttribute("_editURLs").value)await p.queue.addJob(f,o.toObject());(u=this.model)==null||u.memoryClient().emit(o),this.dispatchEvent("edit",o.data),(h=this.model)==null||h.setLastTransactionHash(o.hash)})}async delete(){var r,i;const t=new R({action:"delete",model:this.model.getName(),blitzID:this.getAttribute("_blitzID").value}),e=await J.create().run([t]);if(e[0].status!==E.Success)throw new Error(e[0].message??"Unknown Error! Please try again.");const s=(r=this.model)==null?void 0:r.memoryClient();s==null||s.delete(this.getAttribute("_blitzID").value);for(const n of this.getAttribute("_editURLs").value)await p.queue.addJob(n,t.toObject());s==null||s.emit(t),this.dispatchEvent("delete",null),(i=this.model)==null||i.setLastTransactionHash(t.hash)}async addUserPermission(t){if(!t||t.length===0)throw new Error("Users missing!");const e=this.getAttribute("_blitzID").value,s={blitzIDs:[e],users:t.reduce((o,d)=>({...o,[`#${d.id}`]:d.permission}),{})},r=new R({action:"addObjectUserPermission",model:this.model.getName(),blitzID:e,data:s,hash:mt(s)}),i=[];for(const o of this.getAttribute("_editURLs").value)i.push(await De.send({url:o,transaction:r.toObject()},D._globalHeaders));const n=i.find(o=>o.status!==H.Success);if(n)throw new Error(n.message)}toObject(){const t={};for(const e in this.attributes)t[e]=this.attributes[e].serialize();return t}addEventListener(t,e){var s;this.listeners.has(t)||this.listeners.set(t,[]),(s=this.listeners.get(t))==null||s.push(e)}removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(s=>e!==s))}dispatchEvent(t,e){var s;this.listeners.has(t)&&((s=this.listeners.get(t))==null||s.forEach(r=>r(e)))}enqueueEditOperation(t){return new Promise((e,s)=>{this.editQueue=this.editQueue.then(async()=>{try{const r=await t();e(r)}catch(r){s(r)}})})}}class _t{static transformBlitzDataOptions(t){if(typeof t>"u")throw new Error("Configuration is required.");if(typeof t=="string")t={clusters:this.transformClusterOptions(t)};else if(Array.isArray(t))t={clusters:this.transformClusterOptions(t)};else if(typeof t=="object"&&!Array.isArray(t))t.clusters=this.transformClusterOptions(t.clusters);else throw new Error("Unknown configuration type.");if(t.assetsPath||(t.assetsPath=""),t.sync?typeof t.sync=="string"&&(t.sync={level:t.sync}):t.sync={level:"full"},t.sync.level==="partial")throw new Error("Partial sync type not supported yet!");return t.sync.level==="cache"&&(t.sync.ttl||(t.sync.ttl=30*1e3)),t.sync.level==="full"&&(t.sync.interval||(t.sync.interval=30*1e3)),t}static transformClusterOptions(t){if(typeof t>"u")throw new Error("Clusters are required.");if(typeof t=="string")t={default:{readURL:[t],addURL:[t]}};else if(Array.isArray(t))t={default:{readURL:t,addURL:t}};else if(typeof t=="object")for(const e of Object.keys(t)){if(typeof t[e]=="string"||Array.isArray(t[e])){const s=Array.isArray(t[e])?t[e]:[t[e]];t[e]={readURL:s,addURL:s};continue}typeof t[e]=="object"&&(typeof t[e].readURL=="string"&&(t[e].readURL=[t[e].readURL]),typeof t[e].addURL=="string"&&(t[e].addURL=[t[e].addURL]))}else throw new Error("Unknown cluster configuration type.");return t}}const Be={get(a,t){if(Reflect.has(a,t)){const e=Reflect.get(a,t);return e instanceof Function?e.bind(a):e}return a.attributes[t]},set(a,t,e){throw new Error("Setting values directly not supported. Please use `edit` method to change a value for an attribute.")}};class Vt{static create(t,e,s){const r=e.getAttributesDetails()??{},i=k.unserialize(r,s),n=new Proxy(new t({model:e,attributes:i}),Be);for(const o in i)i[o].withObject(n);return e.memoryClient().update(n)}}class vt extends B{static async model(){if(typeof this.modelName!="string")throw new Error(`${this.name}.modelName is not a string, please provide a valid model name.`);const t=this.modelName==="_Model"?p._Model:await p._Model.get(this.modelName);return t.setReturnType(this),t}static async get(t){return(await this.model()).get(t)}static async exists(t){return(await this.model()).exists(t)}static async add(t,e=[]){return(await this.model()).add(t,e)}static async list(t={}){return(await this.model()).list(t)}}m(vt,"modelName");const nt=class nt extends vt{constructor({model:e,attributes:s}){super({model:e,attributes:s});m(this,"clusterManager");m(this,"lastTransactionHash",null);m(this,"returnType",B);this.clusterManager=p.clusterManager}idbClient(){return new ve(this)}memoryClient(){return new rt(this)}getName(){return this.attributes._blitzID.value}getLastTransactionHash(){return this.lastTransactionHash}setLastTransactionHash(e){this.lastTransactionHash=e}setReturnType(e){this.returnType=e}async exists(e){return!!await this.get(e)}async add(e,s=[]){const r=this.resolveClusters(s),i=this.getAttributesDetails()??{},n=new R({action:"add",data:k.serialize(k.unserialize(i,e)),model:this.getName()}),o=await p.getCurrentUser(),d=n.clone();d.data={...d.data,_userID:o.id};const l=await J.create().run([d]);if(l[0].status!==E.Success)throw new Error(l[0].message??"Unknown Error! Please try again.");for(const c of r)for(const u of c.options.addURL)await p.queue.addJob(u,n.toObject());return this.memoryClient().emit(n),this.setLastTransactionHash(n.hash),Vt.create(this.returnType,this,d.data)}async get(e){const s=typeof e=="string"?{blitzID:e}:e,i=(await q.create().model(this).clusters(this.resolveClusters(s.clusters??[])).raw(s.raw??!1).get(s.blitzID).query({returnType:this.returnType??B}).forceHttp(s.forceHttp??!1).forceLocal(s.forceLocal??!1).skipCacheUpdateIfFound(s.skipCacheUpdateIfFound??!1).getQuery(s.query??{}).perform())[0]??null;if(!i&&this.returnType===nt)throw new Error(`Model with blitzID "${e}" does not exists or you don't have enough permission to view it.`);return i||null}async list(e={}){return await q.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??B,customSort:e.customSort,customSortDirection:e.customSortDirection,var:e.var,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).perform()}subscribeToList(e={},s,r=!1){const i=q.create().model(this).clusters(this.resolveClusters(e.clusters??[])).raw(e.raw??!1).query({conditions:e.conditions,limit:e.limit,returnType:e.returnType??this.returnType??B,customSort:e.customSort,customSortDirection:e.customSortDirection,var:e.var,manyToMany:e.manyToMany}).forceHttp(e.forceHttp??!1).forceLocal(e.forceLocal??!1).skipCacheUpdateIfFound(e.skipCacheUpdateIfFound??!1).performSignal(r),n=i.subscribe(s,i.get()!==null),o=rt.channel.filterPipe(d=>d.model===this.getName()).subscribe(d=>{if(d.action===S.Add)this.list({...e,forceLocal:!0}).then(l=>{const c=e.raw?l.findIndex(u=>u._blitzID===d.blitzID):l.findIndex(u=>u.getAttribute("_blitzID").value===d.blitzID);c>-1&&i.set({items:l,update:{action:S.Add,object:l[c],index:c}})});else if(d.action===S.Edit){const l=i.get();if(!l)return;const c=e.raw?l.items.findIndex(u=>u._blitzID===d.blitzID):l.items.findIndex(u=>u.getAttribute("_blitzID").value===d.blitzID);c>-1&&this.list({...e,forceLocal:!0}).then(u=>{const h=e.raw?u.findIndex(f=>f._blitzID===d.blitzID):u.findIndex(f=>f.getAttribute("_blitzID").value===d.blitzID);i.set({items:u,update:{action:S.Edit,object:h>-1?u[h]:l.items[c],index:h>-1?h:c}})})}else if(d.action===S.Delete){const l=i.get();if(!l)return;if(e.raw){const c=l.items.findIndex(u=>u._blitzID===d.blitzID);c>-1&&i.set({items:l.items.filter(u=>u._blitzID!==d.blitzID),update:{action:S.Delete,object:l.items[c],index:c}})}else{const c=l.items.findIndex(u=>u.getAttribute("_blitzID").value===d.blitzID);c>-1&&i.set({items:l.items.filter(u=>u.getAttribute("_blitzID").value!==d.blitzID),update:{action:S.Delete,object:l.items[c],index:c}})}}});return()=>{n(),o()}}async sync(){const e=this.getName();if(e){const s=Date.now()/1e3,r=j.getLastSyncedAt(e)??0,i=30;s-r>i&&await K.create().run(e)}}getAttributes(){var e;return((e=this.attributes.searchable)==null?void 0:e.value)??[]}getAttributesDetails(){var e;return((e=this.attributes.attributes)==null?void 0:e.value)??null}getAttributeDetails(e){var s,r;return((r=(s=this.attributes.attributes)==null?void 0:s.value)==null?void 0:r[e])??null}resolveClusters(e){return Object.values(e.length===0?this.clusterManager.all():this.clusterManager.get(e))}setClusters(e){this.clusterManager=new Et;const s=_t.transformClusterOptions(e);for(const r of Object.keys(s))this.clusterManager.register(r,s[r])}getClusterManager(){return this.clusterManager}static async get(e){return super.get(e)}static async list(e={}){return super.list(e)}};m(nt,"modelName","_Model");let M=nt;class Dt{static extractModelName(t){const r=new URL(t).pathname.split("/").filter(i=>i!=="").pop();if(!r&&!(r!=null&&r.endsWith(".json")))throw new Error("Model name not found in the URL.");return r.slice(0,r.indexOf(".json"))}static extractConditions(t){const e=new URL(t);return JSON.parse(e.searchParams.get("conditions")||"[]")}}var qt={exports:{}},Qt={exports:{}};(function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t={rotl:function(e,s){return e<<s|e>>>32-s},rotr:function(e,s){return e<<32-s|e>>>s},endian:function(e){if(e.constructor==Number)return t.rotl(e,8)&16711935|t.rotl(e,24)&4278255360;for(var s=0;s<e.length;s++)e[s]=t.endian(e[s]);return e},randomBytes:function(e){for(var s=[];e>0;e--)s.push(Math.floor(Math.random()*256));return s},bytesToWords:function(e){for(var s=[],r=0,i=0;r<e.length;r++,i+=8)s[i>>>5]|=e[r]<<24-i%32;return s},wordsToBytes:function(e){for(var s=[],r=0;r<e.length*32;r+=8)s.push(e[r>>>5]>>>24-r%32&255);return s},bytesToHex:function(e){for(var s=[],r=0;r<e.length;r++)s.push((e[r]>>>4).toString(16)),s.push((e[r]&15).toString(16));return s.join("")},hexToBytes:function(e){for(var s=[],r=0;r<e.length;r+=2)s.push(parseInt(e.substr(r,2),16));return s},bytesToBase64:function(e){for(var s=[],r=0;r<e.length;r+=3)for(var i=e[r]<<16|e[r+1]<<8|e[r+2],n=0;n<4;n++)r*8+n*6<=e.length*8?s.push(a.charAt(i>>>6*(3-n)&63)):s.push("=");return s.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/ig,"");for(var s=[],r=0,i=0;r<e.length;i=++r%4)i!=0&&s.push((a.indexOf(e.charAt(r-1))&Math.pow(2,-2*i+8)-1)<<i*2|a.indexOf(e.charAt(r))>>>6-i*2);return s}};Qt.exports=t})();var Ve=Qt.exports,It={utf8:{stringToBytes:function(a){return It.bin.stringToBytes(unescape(encodeURIComponent(a)))},bytesToString:function(a){return decodeURIComponent(escape(It.bin.bytesToString(a)))}},bin:{stringToBytes:function(a){for(var t=[],e=0;e<a.length;e++)t.push(a.charCodeAt(e)&255);return t},bytesToString:function(a){for(var t=[],e=0;e<a.length;e++)t.push(String.fromCharCode(a[e]));return t.join("")}}},Kt=It;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var qe=function(a){return a!=null&&(Zt(a)||Qe(a)||!!a._isBuffer)};function Zt(a){return!!a.constructor&&typeof a.constructor.isBuffer=="function"&&a.constructor.isBuffer(a)}function Qe(a){return typeof a.readFloatLE=="function"&&typeof a.slice=="function"&&Zt(a.slice(0,0))}(function(){var a=Ve,t=Kt.utf8,e=qe,s=Kt.bin,r=function(i,n){i.constructor==String?n&&n.encoding==="binary"?i=s.stringToBytes(i):i=t.stringToBytes(i):e(i)?i=Array.prototype.slice.call(i,0):!Array.isArray(i)&&i.constructor!==Uint8Array&&(i=i.toString());for(var o=a.bytesToWords(i),d=i.length*8,l=1732584193,c=-271733879,u=-1732584194,h=271733878,f=0;f<o.length;f++)o[f]=(o[f]<<8|o[f]>>>24)&16711935|(o[f]<<24|o[f]>>>8)&4278255360;o[d>>>5]|=128<<d%32,o[(d+64>>>9<<4)+14]=d;for(var w=r._ff,T=r._gg,z=r._hh,O=r._ii,f=0;f<o.length;f+=16){var zt=l,At=c,St=u,Tt=h;l=w(l,c,u,h,o[f+0],7,-680876936),h=w(h,l,c,u,o[f+1],12,-389564586),u=w(u,h,l,c,o[f+2],17,606105819),c=w(c,u,h,l,o[f+3],22,-1044525330),l=w(l,c,u,h,o[f+4],7,-176418897),h=w(h,l,c,u,o[f+5],12,1200080426),u=w(u,h,l,c,o[f+6],17,-1473231341),c=w(c,u,h,l,o[f+7],22,-45705983),l=w(l,c,u,h,o[f+8],7,1770035416),h=w(h,l,c,u,o[f+9],12,-1958414417),u=w(u,h,l,c,o[f+10],17,-42063),c=w(c,u,h,l,o[f+11],22,-1990404162),l=w(l,c,u,h,o[f+12],7,1804603682),h=w(h,l,c,u,o[f+13],12,-40341101),u=w(u,h,l,c,o[f+14],17,-1502002290),c=w(c,u,h,l,o[f+15],22,1236535329),l=T(l,c,u,h,o[f+1],5,-165796510),h=T(h,l,c,u,o[f+6],9,-1069501632),u=T(u,h,l,c,o[f+11],14,643717713),c=T(c,u,h,l,o[f+0],20,-373897302),l=T(l,c,u,h,o[f+5],5,-701558691),h=T(h,l,c,u,o[f+10],9,38016083),u=T(u,h,l,c,o[f+15],14,-660478335),c=T(c,u,h,l,o[f+4],20,-405537848),l=T(l,c,u,h,o[f+9],5,568446438),h=T(h,l,c,u,o[f+14],9,-1019803690),u=T(u,h,l,c,o[f+3],14,-187363961),c=T(c,u,h,l,o[f+8],20,1163531501),l=T(l,c,u,h,o[f+13],5,-1444681467),h=T(h,l,c,u,o[f+2],9,-51403784),u=T(u,h,l,c,o[f+7],14,1735328473),c=T(c,u,h,l,o[f+12],20,-1926607734),l=z(l,c,u,h,o[f+5],4,-378558),h=z(h,l,c,u,o[f+8],11,-2022574463),u=z(u,h,l,c,o[f+11],16,1839030562),c=z(c,u,h,l,o[f+14],23,-35309556),l=z(l,c,u,h,o[f+1],4,-1530992060),h=z(h,l,c,u,o[f+4],11,1272893353),u=z(u,h,l,c,o[f+7],16,-155497632),c=z(c,u,h,l,o[f+10],23,-1094730640),l=z(l,c,u,h,o[f+13],4,681279174),h=z(h,l,c,u,o[f+0],11,-358537222),u=z(u,h,l,c,o[f+3],16,-722521979),c=z(c,u,h,l,o[f+6],23,76029189),l=z(l,c,u,h,o[f+9],4,-640364487),h=z(h,l,c,u,o[f+12],11,-421815835),u=z(u,h,l,c,o[f+15],16,530742520),c=z(c,u,h,l,o[f+2],23,-995338651),l=O(l,c,u,h,o[f+0],6,-198630844),h=O(h,l,c,u,o[f+7],10,1126891415),u=O(u,h,l,c,o[f+14],15,-1416354905),c=O(c,u,h,l,o[f+5],21,-57434055),l=O(l,c,u,h,o[f+12],6,1700485571),h=O(h,l,c,u,o[f+3],10,-1894986606),u=O(u,h,l,c,o[f+10],15,-1051523),c=O(c,u,h,l,o[f+1],21,-2054922799),l=O(l,c,u,h,o[f+8],6,1873313359),h=O(h,l,c,u,o[f+15],10,-30611744),u=O(u,h,l,c,o[f+6],15,-1560198380),c=O(c,u,h,l,o[f+13],21,1309151649),l=O(l,c,u,h,o[f+4],6,-145523070),h=O(h,l,c,u,o[f+11],10,-1120210379),u=O(u,h,l,c,o[f+2],15,718787259),c=O(c,u,h,l,o[f+9],21,-343485551),l=l+zt>>>0,c=c+At>>>0,u=u+St>>>0,h=h+Tt>>>0}return a.endian([l,c,u,h])};r._ff=function(i,n,o,d,l,c,u){var h=i+(n&o|~n&d)+(l>>>0)+u;return(h<<c|h>>>32-c)+n},r._gg=function(i,n,o,d,l,c,u){var h=i+(n&d|o&~d)+(l>>>0)+u;return(h<<c|h>>>32-c)+n},r._hh=function(i,n,o,d,l,c,u){var h=i+(n^o^d)+(l>>>0)+u;return(h<<c|h>>>32-c)+n},r._ii=function(i,n,o,d,l,c,u){var h=i+(o^(n|~d))+(l>>>0)+u;return(h<<c|h>>>32-c)+n},r._blocksize=16,r._digestsize=16,qt.exports=function(i,n){if(i==null)throw new Error("Illegal argument "+i);var o=a.wordsToBytes(r(i,n));return n&&n.asBytes?o:n&&n.asString?s.bytesToString(o):a.bytesToHex(o)}})();var Ke=qt.exports;const Ze=be(Ke);class q{constructor(){m(this,"_clusters");m(this,"_urls");m(this,"_model");m(this,"_query");m(this,"_raw",!1);m(this,"_forceHttp",!1);m(this,"_forceLocal",!1);m(this,"_skipCacheUpdateIfFound",!1);m(this,"_get");m(this,"_getQuery")}static create(){return new q}model(t){return this._model=t,this}clusters(t){return this._clusters=t,this}urls(t){return this._urls=t,this}query(t){var s,r;this._query=t;const e=(s=this._model)==null?void 0:s.getAttributesDetails();if((r=this._query)!=null&&r.conditions&&e)for(const i of this._query.conditions){const n=i[0];i.length===3&&e[n]!==void 0&&typeof e[n].type=="string"&&(i[1]==="IN"&&Array.isArray(i[2])?i[2]=i[2].map(o=>k.createType(n,e[n].type,o).serialize()):i[2]=k.createType(n,e[n].type,i[2]).serialize())}return this}raw(t){return this._raw=t,this}forceHttp(t){return this._forceHttp=t,this}forceLocal(t){return this._forceLocal=t,this}skipCacheUpdateIfFound(t){return this._skipCacheUpdateIfFound=t,this}get(t){return this._get=t,this}getQuery(t){return this._getQuery=t,this}convertObjects(t){var s;const e=[];for(const r of t)e.push(Vt.create(((s=this._query)==null?void 0:s.returnType)??B,this._model,r));return e}async perform(){var e;let t=this._forceHttp&&!this._forceLocal?[]:await this.performIndexedDb();if(!this._forceLocal){if(p.options.sync.level==="full"&&t.length===0)t=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp())),t.length>0&&await this._model.idbClient().save(t);else if(p.options.sync.level==="cache"){const s=this._skipCacheUpdateIfFound&&t.length>0?!1:this.shouldSendHttpRequest();if(s||t.length===0){const r=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));(r.length>0||this._forceHttp)&&(t=r,t.length>0&&await this._model.idbClient().save(t)),s&&((e=this._model)==null?void 0:e.getName())!=="_Model"&&j.setListCallLastTimeStamp(this.hash(),new Date().getTime())}}}return this._raw?t:this.convertObjects(t)}performSignal(t=!1){const e=new G(null);return(async()=>{var n;if(!t){e.set({items:await this.perform()});return}const s=await this.performMemory();e.set({items:this._raw?s:this.convertObjects(s),nextSource:"local database"});const r=await this.performIndexedDb();e.set({items:this._raw?r:this.convertObjects(r),nextSource:"server"});const i=await this.filterQueuedObjects(this.mergeObjects(await this.performHttp()));i.length>0&&await((n=this._model)==null?void 0:n.idbClient().save(i)),e.set({items:this._raw?i:this.convertObjects(i)})})(),e}async performHttp(){return(await Promise.all(this._urls?this._urls.map(e=>this.performSingleUrlHttp(e)):this._clusters.map(e=>this.performSingleClusterHttp(e)))).flat()}async performSingleClusterHttp(t){var s,r;const e={};for(let i=0;i<t.options.readURL.length;i++){const n=t.getNextReadURL();try{const o=this._get?await Q.get({baseUrl:n,modelName:this._model.getName(),blitzID:this._get,query:this._getQuery}):await Q.list({endpoint:{baseUrl:n,modelName:this._model.getName(),query:this._query}});for(const d of o){d._clusters=[t.name],d._editURLs=JSON.parse(JSON.stringify(t.options.readURL));for(const l in d)if(l.endsWith("_fk")&&d[l]!==null&&typeof d[l]=="object"&&d[l]._blitzID){const c=(r=(s=this._model)==null?void 0:s.getAttributeDetails(l))==null?void 0:r.type;if(c&&c!=="_Model"){const u=await M.get(c);u&&await u.idbClient().save([d[l]],!0)}d[l]=d[l]._blitzID}else l.endsWith("_mtm")&&Array.isArray(d[l])&&(d[l]=d[l].map((c,u)=>({_blitzID:typeof c=="string"?c:c._blitzID,_mtmSort:typeof c=="string"?(d[l].length-u)*15:c._mtmSort})))}return o}catch(o){e[n]=(o==null?void 0:o.stack)??(o==null?void 0:o.message)??o}}throw new Error(`All read URLs failed for cluster "${t.name}". Errors: ${JSON.stringify(e)}`)}async performSingleUrlHttp(t){return(await Q.list({fullUrl:t})).map(s=>(s.cluster=[],s._editURLs=[t],s))}async performIndexedDb(){var s,r;const t=this._model.idbClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(s=this._getQuery)==null?void 0:s.var,manyToMany:(r=this._getQuery)==null?void 0:r.manyToMany});const e=this._urls?this._urls.map(i=>Dt.extractConditions(i)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}async performMemory(){var s,r;const t=this._model.memoryClient();if(this._get)return await t.query({conditions:[["_blitzID","=",this._get]],limit:1,var:(s=this._getQuery)==null?void 0:s.var,manyToMany:(r=this._getQuery)==null?void 0:r.manyToMany});const e=this._urls?this._urls.map(i=>Dt.extractConditions(i)).flat():this._query.conditions;return await t.query({...this._query,conditions:e})}mergeObjects(t){const e=[];for(const s of t){const r=e.find(i=>i._blitzID===s._blitzID);r?(r._clusters=[...r._clusters,...s._clusters].filter((i,n,o)=>o.indexOf(i)===n),r._editURLs=[...r._editURLs,...s._editURLs].filter((i,n,o)=>o.indexOf(i)===n)):e.push(s)}return e}async filterQueuedObjects(t){var r;const e=await p.queue.getJobs(),s=[];for(const i of t)if(!e.find(n=>n.transaction.action===S.Delete&&n.transaction.blitzID===i._blitzID))if(!e.find(n=>n.transaction.action===S.Edit&&n.transaction.blitzID===i._blitzID&&n.status!==y.Completed))s.push(i);else{const n=await((r=this._model)==null?void 0:r.get({blitzID:i._blitzID,raw:!0,forceLocal:!0}));n?s.push(n):s.push(i)}return s}shouldSendHttpRequest(){var e;if(p.options.sync.level!=="cache"||((e=this._model)==null?void 0:e.getName())==="_Model")return!1;const t=j.getListCallLastTimeStamp(this.hash());return t?new Date().getTime()-t>p.options.sync.ttl:!0}hash(){var t,e;return Ze(JSON.stringify({clusters:((t=this._clusters)==null?void 0:t.map(s=>s.name))??[],blitzId:this._get,urls:this._urls,modelName:(e=this._model)==null?void 0:e.getName(),listQuery:this._query,getQuery:this.getQuery}))}}const Ge=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,Gt=a=>{if(typeof a!="string")throw new TypeError("Invalid argument expected string");const t=a.match(Ge);if(!t)throw new Error(`Invalid argument not valid semver ('${a}' received)`);return t.shift(),t},Xt=a=>a==="*"||a==="x"||a==="X",Yt=a=>{const t=parseInt(a,10);return isNaN(t)?a:t},Xe=(a,t)=>typeof a!=typeof t?[String(a),String(t)]:[a,t],Ye=(a,t)=>{if(Xt(a)||Xt(t))return 0;const[e,s]=Xe(Yt(a),Yt(t));return e>s?1:e<s?-1:0},te=(a,t)=>{for(let e=0;e<Math.max(a.length,t.length);e++){const s=Ye(a[e]||"0",t[e]||"0");if(s!==0)return s}return 0},ts=(a,t)=>{const e=Gt(a),s=Gt(t),r=e.pop(),i=s.pop(),n=te(e,s);return n!==0?n:r&&i?te(r.split("."),i.split(".")):r||i?r?-1:1:0},ee=(a,t,e)=>{es(e);const s=ts(a,t);return se[e].includes(s)},se={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},re=Object.keys(se),es=a=>{if(typeof a!="string")throw new TypeError(`Invalid operator type, expected string but got ${typeof a}`);if(re.indexOf(a)===-1)throw new Error(`Invalid operator, expected one of ${re.join("|")}`)},U=class U{static get VERSION(){return"1.1.23"}static async initialize(t){if(this.initialized){console.log("%c⚠️ Warning: Library has already been initialized! Skipping the initialization steps.","background: #FFF3CD; color: #856404; font-weight: bold;"),console.groupCollapsed("%cStack Trace","background: #FFF3CD; color: #856404; font-weight: bold; font-style: italic;"),console.log("Options",t),console.trace(),console.groupEnd();return}this.initialized=!0;const e=_t.transformBlitzDataOptions(t);this.options=e,e.clusters&&U.setClusters(e.clusters);const s=j.get("version");if(!s||ee(this.VERSION,s,">")){const r=this.VERSION.split(".")[1],i=s==null?void 0:s.split(".")[1];(!i||ee(r,i,">"))&&(await this.purge(),j.setLastSyncedAt(Math.floor(Date.now()/1e3))),j.set("version",this.VERSION)}if(await new bt().ping(),this.queue=await new _e().init(),U._Model=new M({model:void 0,attributes:{_blitzID:new X("_blitzID","string","_Model"),searchable:new X("searchable","json",void 0),attributes:new X("attributes","json",{name:{label:"Name",type:"varchar"},label:{label:"Label",type:"texti18n"},modelpermission:{label:"Model Permission",type:"tinyint"},hasuserpermissions:{label:"Has User Permissions",type:"boolean"},subscriberemails:{label:"Subscriber Emails",type:"text"},haslogs:{label:"Has Logs",type:"boolean"},cache:{label:"Cache",name:"cache",type:"boolean"},hasprojects:{label:"Has Projects",type:"boolean"},attributes:{label:"Attributes",type:"json"},objectpermissionoptions:{label:"Object Permission Options",type:"int"},haspublishingdate:{label:"Has Publishing Date",type:"boolean"}}),_editURLs:new X("_editURLs","json",[]),haspublishingdate:new Pt("haspublishingdate","boolean",!1)}}),U._Model.setReturnType(M),t&&typeof t!="string"&&!Array.isArray(t)&&t.uiManager&&(this.ui=new t.uiManager(this)),e.sync.level==="full"){const r=K.create();await r.run(),r.runAtInterval(e.sync.interval)}else e.sync.level==="cache"&&await K.create().run(void 0,"delete")}static async purge(){const e=[...(await indexedDB.databases()).filter(s=>{var r;return(r=s.name)==null?void 0:r.startsWith("bdt")}).map(s=>s.name),...j.getDatabases(),"_Model","_Project","db_master",A.name].filter((s,r,i)=>i.findIndex(n=>n===s)===r);for(const s of e)await ht(s);j.clear()}static purgeLocalStorage(){j.clear()}static setClusters(t){t=_t.transformClusterOptions(t);for(const e of Object.keys(t))U.clusterManager.register(e,t[e])}static async list(t){const e=Dt.extractModelName(t);if(!await U._Model.exists(e))throw new Error(`Model "${e}" does not exist.`);return q.create().model(await U._Model.get(e)).urls([t]).query({}).perform()}static async uploader(t){return await Q.upload({baseUrl:U.clusterManager.toArray()[0].getNextReadURL(),image:t})}static async listProjectUsers(t){if(!t)throw new Error("Project ID required!");const e=j.getProjectUsers(t);if(e!==null&&typeof e=="object"){const o=Date.now(),d=864e5;if(o<e.lastSaved+d)return e.users}const s=L.sanitizeBaseUrl(U.clusterManager.toArray()[0].getNextReadURL()),r=new URL(s).origin!==window.location.origin?"?enableCors=1":"",i=await D.create().url(s+`api/listProjectUsers/${t}.json${r}`).get();if(i.error)throw new Error(i.error);if(i.errors instanceof Array&&i.errors.length>0)throw new Error(i.errors.map(o=>o.message||o).join(" | "));const n={lastSaved:Date.now(),users:(i.users||[]).map(o=>({id:o._blitzID,username:o.username}))};return j.setProjectUsers(t,n),n.users}static async getCurrentUser(){var d;const t=j.getCurrentUser();if(t)return t;const e=L.sanitizeBaseUrl(U.clusterManager.toArray()[0].getNextReadURL()),s=new URL(e).origin!==window.location.origin?"?enableCors=1":"",r=await D.create().url(e+"api/ping.json"+s).get();if(r.error)throw new Error(r.error);if(!r.userhash){const l={id:"public",username:"Public"};return j.setCurrentUser(l),l}const i=await M.get("0BAUsers"),n=await(i==null?void 0:i.get(r.userhash));if(!n||!((d=n.username)!=null&&d.value))throw new Error("Could not get user object!");const o={id:r.userhash,username:n.username.value};return j.setCurrentUser(o),o}static addEventListener(t,e){this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(e)}static hasEventListener(t){return this.listeners.has(t)?this.listeners.get(t).length>0:!1}static removeEventListener(t,e){this.listeners.has(t)&&this.listeners.set(t,this.listeners.get(t).filter(s=>e!==s))}static dispatchEvent(t,e){this.listeners.has(t)&&this.listeners.get(t).forEach(s=>s(e))}};m(U,"clusterManager",new Et),m(U,"_Model"),m(U,"objects",new Map),m(U,"options"),m(U,"queue"),m(U,"ui"),m(U,"listeners",new Map),m(U,"initialized",!1);let p=U;I.BDCustomObject=vt,I.BDModel=M,I.BDObject=B,I.BlitzData=p,I.DataType=x,I.HttpRequest=D,I.JobStatus=y,I.LocalStorageRepository=j,I.ManyForeignKeyType=Wt,I.ManyType=yt,I.blitzhash=mt,I.blitzstamp=Y,I.sleep=Ft,Object.defineProperty(I,Symbol.toStringTag,{value:"Module"})});
